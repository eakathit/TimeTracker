<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TimeTracker Pro</title>

    <link href="style.css?v=1.4" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    

    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192.png" type="image/png">
    <meta name="theme-color" content="#4F46E5">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TimeTracker">
    <link rel="apple-touch-icon" href="icons/icon-180.png">

    <style>
        /* Modern Premium Palette */
        :root {
            --bg-color: #F8FAFC; /* Slate 50 */
            --card-bg: #FFFFFF;
            
            /* Premium Indigo Gradient */
            --primary-color: #4F46E5; /* Indigo 600 */
            --primary-gradient: linear-gradient(135deg, #4F46E5 0%, #4338CA 100%);
            --primary-light: #EEF2FF; /* Indigo 50 */
            
            /* Status Colors */
            --success-color: #10B981; /* Emerald 500 */
            --success-gradient: linear-gradient(135deg, #10B981 0%, #059669 100%);
            --danger-color: #EF4444; /* Red 500 */
            --danger-gradient: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            
            --text-primary: #1E293B; /* Slate 800 */
            --text-secondary: #64748B; /* Slate 500 */
            --border-color: #E2E8F0; /* Slate 200 */
        }

        body {
            font-family: 'Prompt', 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        /* Modern Card Styling */
        .card {
            background-color: var(--card-bg);
            border-radius: 24px;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.06); /* Soft Shadow */
            padding: 1.5rem;
            border: 1px solid rgba(255,255,255,0.5);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            box-shadow: 0 15px 35px -10px rgba(0, 0, 0, 0.08);
        }

        /* Gradient Buttons */
        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            border-radius: 16px;
            padding: 0.85rem 1.5rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
        }
        .btn-primary:active {
            transform: translateY(0);
        }

        /* Page Animations */
        .page { display: none; }
        .page.active { display: block; animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Glassmorphism Bottom Nav */
        .bottom-nav { 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(226, 232, 240, 0.6);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.02);
            padding-bottom: env(safe-area-inset-bottom);
            height: calc(4.5rem + env(safe-area-inset-bottom));
        }
        
        .bottom-nav .nav-item {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .bottom-nav .nav-item.active svg { 
            color: var(--primary-color);
            transform: translateY(-2px);
            filter: drop-shadow(0 4px 6px rgba(79, 70, 229, 0.2));
        }
        .bottom-nav .nav-item.active span { 
            color: var(--primary-color); 
            font-weight: 600; 
        }
        
        /* Modern Sidebar */
        aside {
            background-color: white;
            box-shadow: 4px 0 24px rgba(0,0,0,0.02);
        }
        aside .nav-item.active {
            background-color: var(--primary-light);
            color: var(--primary-color);
            border-right: 3px solid var(--primary-color);
        }

        /* Check-in Button Animation */
        .checkin-btn-anim { animation: pulse-blue 2.5s infinite; }
        @keyframes pulse-blue {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 20px rgba(79, 70, 229, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }

        .checkout-btn-anim { animation: pulse-red 2.5s infinite; }
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .completed-btn-anim { animation: pulse-green 2.5s infinite; }
        @keyframes pulse-green {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        /* Inputs & Forms */
        input[type="text"], input[type="date"], input[type="time"], input[type="datetime-local"], input[type="month"], select, textarea {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            transition: all 0.2s;
            background-color: #F8FAFC;
        }
        input:focus, select:focus, textarea:focus {
            background-color: #FFFFFF;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
        }

        /* Modals with Blur */
        #modal-overlay, #confirm-overlay, #leave-overlay, #profile-edit-overlay, #ot-overlay, .modal-overlay {
            backdrop-filter: blur(4px);
            background-color: rgba(15, 23, 42, 0.4);
        }

        /* Hide Scrollbar but allow scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Custom Gradients for specific buttons */
        .bg-gradient-primary { background: var(--primary-gradient); }
        .bg-gradient-danger { background: var(--danger-gradient); }
        .bg-gradient-success { background: var(--success-gradient); }

        /* Helpers */
        .text-primary-custom { color: var(--primary-color); }
        .bg-primary-light { background-color: var(--primary-light); }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- Login Page -->
    <div id="login-page" class="hidden page min-h-screen flex flex-col items-center justify-center p-6 bg-slate-50 relative overflow-hidden">
        <!-- Background Decoration -->
        <div class="absolute top-[-10%] right-[-10%] w-64 h-64 bg-indigo-200 rounded-full blur-[80px] opacity-40"></div>
        <div class="absolute bottom-[-10%] left-[-10%] w-64 h-64 bg-blue-200 rounded-full blur-[80px] opacity-40"></div>

        <div class="w-full max-w-sm text-center relative z-10">
            <div class="bg-white p-8 rounded-[32px] shadow-premium">
                <div class="mb-6 inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-indigo-500 to-blue-600 text-white shadow-lg shadow-indigo-500/30">
                    <svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
                </div>
                <h1 class="text-3xl font-bold text-slate-800 mb-2">ยินดีต้อนรับ</h1>
                <p class="text-slate-500 mb-8 font-medium">ระบบบันทึกเวลาทำงานอัจฉริยะ</p>
                
                <button id="google-login-btn" class="group relative w-full flex items-center justify-center py-4 px-4 border border-slate-200 hover:border-slate-300 bg-white rounded-2xl transition-all duration-200 hover:shadow-md hover:bg-slate-50">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-4">
                       <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.108-11.283-7.481l-6.571,4.819C9.656,39.663,16.318,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                    </div>
                    <span class="text-slate-600 font-bold group-hover:text-slate-800">เข้าสู่ระบบด้วย Google</span>
                </button>
            </div>
            <p class="mt-6 text-slate-400 text-xs">© 2024 TimeTracker Pro System</p>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="min-h-screen flex flex-col items-center justify-center bg-slate-50 z-50">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
            <div class="mt-4 text-indigo-600 font-medium animate-pulse">กำลังโหลด...</div>
        </div>
    </div>

    <div id="app-container" class="flex flex-col md:flex-row pb-24 md:pb-0 h-screen overflow-hidden" style="display: none;">
        
        <!-- Sidebar (Desktop) -->
        <aside class="hidden md:flex flex-col w-72 h-screen fixed top-0 left-0 bg-white border-r border-slate-200 p-6 z-20 shadow-sm">
            <div class="flex items-center gap-3 mb-10 px-2">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-blue-600 flex items-center justify-center text-white shadow-md">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
                </div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">TimeTracker</h1>
            </div>
            
            <nav class="flex flex-col space-y-1.5 flex-1">
                <a href="#" class="nav-item flex items-center gap-3.5 p-3.5 rounded-2xl text-slate-500 hover:bg-slate-50 transition-all group" data-page="check-in-out-page">
                    <svg class="w-6 h-6 group-hover:text-indigo-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="font-semibold group-hover:text-slate-900 transition-colors">ลงเวลาเข้างาน</span>
                </a>
                
                <a href="#" id="report-or-admin-nav-sidebar" class="nav-item flex items-center gap-3.5 p-3.5 rounded-2xl text-slate-500 hover:bg-slate-50 transition-all group" data-page="report-page">
                    <svg class="w-6 h-6 group-hover:text-indigo-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span class="font-semibold group-hover:text-slate-900 transition-colors">รายงานประจำวัน</span>
                </a>

                <a href="#" id="calendar-or-admin-nav-sidebar" class="nav-item flex items-center gap-3.5 p-3.5 rounded-2xl text-slate-500 hover:bg-slate-50 transition-all group" data-page="calendar-page">
                    <svg class="w-6 h-6 group-hover:text-indigo-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span class="font-semibold group-hover:text-slate-900 transition-colors">ปฏิทินงาน</span>
                </a>

                <a href="#" class="nav-item flex items-center gap-3.5 p-3.5 rounded-2xl text-slate-500 hover:bg-slate-50 transition-all group" data-page="profile-page">
                    <svg class="w-6 h-6 group-hover:text-indigo-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <span class="font-semibold group-hover:text-slate-900 transition-colors">โปรไฟล์ของฉัน</span>
                </a>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main id="main-content" class="flex-1 h-screen overflow-y-auto bg-[#F8FAFC] scroll-smooth">
            <div class="max-w-3xl mx-auto p-4 md:p-8 space-y-6 pb-28 md:pb-8">
        
                <!-- Page: Check In / Out -->
                <div id="check-in-out-page" class="page space-y-6">
                    <!-- Header -->
                    <div class="flex justify-between items-end relative">
                        <div>
                            <p class="text-slate-500 text-sm font-medium mb-1">ยินดีต้อนรับกลับ,</p>
                            <h2 id="user-display-name" class="text-2xl md:text-3xl font-bold text-slate-800 tracking-tight"></h2>
                        </div>
                        
                        <button id="notification-bell-btn" class="relative p-2.5 rounded-full bg-white text-slate-500 shadow-sm border border-slate-100 hover:bg-slate-50 hover:text-indigo-600 transition-all">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.405L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            <span id="notification-badge" class="hidden absolute -top-1 -right-1 inline-flex items-center justify-center w-5 h-5 text-[10px] font-bold text-white bg-red-500 rounded-full shadow-sm border-2 border-white">0</span>
                        </button>

                        <!-- Notification Modal -->
                        <div id="notification-modal" class="hidden absolute right-0 top-16 w-80 bg-white/90 backdrop-blur-xl rounded-2xl shadow-xl z-50 border border-slate-200 animate-in fade-in zoom-in-95 duration-200">
                            <div class="p-4 border-b border-slate-100/50">
                                <h3 class="font-bold text-slate-800">การแจ้งเตือนวันนี้</h3>
                            </div>
                            <div id="notification-list" class="max-h-80 overflow-y-auto p-4 space-y-3 no-scrollbar">
                                <p id="no-notifications-msg" class="text-center text-slate-400 text-sm">วันนี้ไม่มีการแจ้งเตือน</p>
                            </div>
                        </div>
                    </div>

                    <!-- Main Action Card -->
                    <div class="card text-center relative overflow-hidden group">
                        <!-- BG Decoration -->
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-blue-500 to-indigo-500"></div>
                        
                        <div class="relative z-10 py-4">
                            <p class="text-slate-400 text-sm font-medium uppercase tracking-wide">เวลาปัจจุบัน</p>
                            <p id="current-time" class="text-6xl md:text-7xl font-bold text-slate-800 my-6 font-mono tracking-tighter"></p>
                            
                            <!-- Check In Button -->
                            <button id="checkin-btn" class="relative group/btn mx-auto w-56 h-56 rounded-full flex flex-col items-center justify-center transition-all duration-500 checkin-btn-anim">
                                <div class="absolute inset-0 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-full shadow-[0_20px_50px_rgba(79,70,229,0.3)] group-hover/btn:shadow-[0_20px_60px_rgba(79,70,229,0.5)] transition-all duration-500"></div>
                                <div class="relative z-10 flex flex-col items-center">
                                    <svg class="w-20 h-20 text-white drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                    <span class="text-2xl font-bold text-white mt-3 tracking-wide drop-shadow-sm">Check In</span>
                                    <span class="text-indigo-100 text-sm mt-1">ลงเวลาเข้างาน</span>
                                </div>
                            </button>

                            <!-- Check Out Button -->
                            <button id="checkout-btn" class="hidden relative group/btn mx-auto w-56 h-56 rounded-full flex flex-col items-center justify-center transition-all duration-500 checkout-btn-anim">
                                <div class="absolute inset-0 bg-gradient-to-br from-rose-500 to-red-600 rounded-full shadow-[0_20px_50px_rgba(239,68,68,0.3)] group-hover/btn:shadow-[0_20px_60px_rgba(239,68,68,0.5)] transition-all duration-500"></div>
                                <div class="relative z-10 flex flex-col items-center">
                                    <svg class="w-20 h-20 text-white drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                    <span class="text-2xl font-bold text-white mt-3 tracking-wide drop-shadow-sm">Check Out</span>
                                    <span class="text-rose-100 text-sm mt-1">ลงเวลาออกงาน</span>
                                </div>
                            </button>

                            <!-- OT Request Button -->
                            <button id="request-ot-btn" class="hidden mx-auto mt-8 py-3 px-6 bg-white border border-indigo-100 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 hover:border-indigo-200 transition-all shadow-sm flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                <span>ขออนุมัติ OT</span>
                            </button>
                        </div>
                    </div>

                    <!-- Work Status & Location -->
                    <div class="grid grid-cols-1 gap-4">
                        <div class="card p-5">
                            <h3 class="font-semibold text-slate-700 mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                                สถานที่ทำงาน
                            </h3>
                            <div id="work-type-selector" class="flex bg-slate-100 rounded-xl p-1.5 gap-1">
                                <button data-work-type="in_factory" class="work-type-btn flex-1 py-2.5 rounded-lg bg-white text-indigo-600 shadow-sm font-semibold transition-all text-sm">Factory</button>
                                <button data-work-type="on_site" class="work-type-btn flex-1 py-2.5 rounded-lg text-slate-500 hover:bg-slate-200/50 transition-all text-sm font-medium">On-site</button>
                            </div>
                            
                            <!-- Onsite Details Form -->
                            <div id="onsite-details-form" class="hidden mt-4 pt-4 border-t border-slate-100 space-y-4 animate-in slide-in-from-top-2 duration-200">
                                <div class="grid grid-cols-2 gap-3">
                                    <button id="role-member-btn" class="flex flex-col items-center justify-center p-4 bg-indigo-50 border-2 border-indigo-500 text-indigo-700 rounded-xl transition-all active-role">
                                        <svg class="w-6 h-6 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                                        <span class="font-bold text-sm">สแกน QR</span>
                                        <span class="text-xs opacity-70">สำหรับสมาชิก</span>
                                    </button>
                                    <button id="role-leader-btn" class="flex flex-col items-center justify-center p-4 bg-white border border-slate-200 text-slate-500 rounded-xl hover:bg-slate-50 transition-all">
                                        <svg class="w-6 h-6 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                        <span class="font-bold text-sm">สร้างห้อง</span>
                                        <span class="text-xs opacity-70">สำหรับหัวหน้า</span>
                                    </button>
                                </div>

                                <div id="member-section" class="space-y-3">
                                    <div id="reader" class="w-full rounded-2xl overflow-hidden bg-black hidden border-4 border-slate-800"></div>
                                    <button id="start-scan-btn" class="w-full btn-primary flex items-center justify-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                        เปิดกล้องสแกน
                                    </button>
                                    <p id="scan-status" class="text-center text-xs text-slate-400">กดปุ่มเพื่อเริ่มสแกน QR Code ของหัวหน้าทีม</p>
                                </div>

                                <div id="leader-section" class="hidden space-y-3">
                                    <input id="room-project-input" type="text" placeholder="ชื่อโครงการ / Project No." class="w-full">
                                    <input id="room-location-input" type="text" placeholder="ชื่อสถานที่ / ลูกค้า" class="w-full">
                                    
                                    <button id="create-room-btn" class="w-full btn-primary">สร้างห้อง Check-in</button>

                                    <div id="room-qr-container" class="hidden flex flex-col items-center bg-slate-50 p-6 rounded-2xl border border-dashed border-slate-300 mt-4">
                                        <p class="text-sm font-bold text-slate-700 mb-4">QR Code สำหรับทีม</p>
                                        <div id="qrcode" class="p-2 bg-white rounded-lg shadow-sm"></div>
                                        <p class="text-xs text-slate-400 mt-4">ให้สมาชิกสแกนเพื่อ Check-in</p>
                                        
                                        <div class="w-full mt-4 border-t border-slate-200 pt-3">
                                            <p class="text-xs font-bold text-slate-500 mb-2">สมาชิกที่เข้าร่วม:</p>
                                            <ul id="room-members-list" class="text-sm text-slate-700 space-y-1.5 text-center">
                                                <li class="text-slate-400 italic text-xs">รอสมาชิกสแกน...</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Location Status -->
                        <div id="location-status" class="flex items-center p-4 rounded-2xl bg-white border border-slate-100 shadow-sm text-slate-600 transition-colors">
                            <div id="location-icon" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center mr-4 text-slate-400 shrink-0">
                                <svg class="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            </div>
                            <span id="location-text" class="text-sm font-medium">กำลังตรวจสอบตำแหน่ง...</span>
                        </div>
                    </div>

                    <!-- Summary Today -->
                    <div class="card bg-gradient-to-br from-slate-800 to-slate-900 text-white !border-none !shadow-lg">
                        <h3 class="font-semibold mb-4 text-slate-200 flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                            สรุปวันนี้
                        </h3>
                        <div id="summary-card-content" class="grid grid-cols-3 gap-2 text-center divide-x divide-slate-700">
                            <div>
                                <span class="text-xs text-slate-400 block mb-1">เข้างาน</span>
                                <span id="summary-checkin-time" class="text-lg font-bold text-emerald-400">-</span>
                            </div>
                            <div>
                                <span class="text-xs text-slate-400 block mb-1">ออกงาน</span>
                                <span id="summary-checkout-time" class="text-lg font-bold text-rose-400">-</span>
                            </div>
                            <div>
                                <span class="text-xs text-slate-400 block mb-1">ชั่วโมง</span>
                                <span id="summary-work-hours" class="text-lg font-bold text-blue-400">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Report -->
                <div id="report-page" class="page space-y-6">
                    <h2 class="text-2xl font-bold text-slate-800">รายงานประจำวัน</h2>
                    
                    <div class="card space-y-5">
                        <!-- Date Picker -->
                        <div class="p-4 bg-amber-50/50 border border-amber-100 rounded-xl flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center shrink-0">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </div>
                            <div class="w-full">
                                <label class="text-xs font-bold text-amber-800 uppercase tracking-wide">เลือกวันที่</label>
                                <input type="date" id="report-date-input" class="w-full mt-1 p-0 border-none bg-transparent font-semibold text-slate-800 focus:ring-0 text-lg">
                            </div>
                        </div>

                        <div class="space-y-4">
                            <!-- Work Type -->
                            <div>
                                <label class="text-sm font-medium text-slate-600 mb-1.5 block">ประเภทงาน</label>
                                <div id="work-type-dropdown" class="relative">
                                    <button id="work-type-btn" type="button" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-left flex justify-between items-center focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all hover:bg-white hover:border-indigo-300">
                                        <span id="work-type-selected-text" class="text-slate-500">เลือกประเภทงาน...</span>
                                        <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <div id="work-type-panel" class="hidden absolute z-10 w-full mt-2 bg-white border border-slate-100 rounded-xl shadow-xl animate-in fade-in zoom-in-95 duration-100">
                                        <div class="p-2 border-b border-slate-50">
                                            <input id="work-type-search" type="text" placeholder="ค้นหา..." class="w-full p-2 border border-slate-200 rounded-lg text-sm">
                                        </div>
                                        <div id="work-type-options" class="max-h-60 overflow-y-auto p-1.5 space-y-1"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Project -->
                            <div>
                                <label class="text-sm font-medium text-slate-600 mb-1.5 block">โครงการ</label>
                                <div id="project-dropdown" class="relative">
                                    <button id="project-btn" type="button" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-left flex justify-between items-center focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all hover:bg-white hover:border-indigo-300">
                                        <span id="project-selected-text" class="text-slate-500">เลือกโครงการ...</span>
                                        <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <div id="project-panel" class="hidden absolute z-10 w-full mt-2 bg-white border border-slate-100 rounded-xl shadow-xl animate-in fade-in zoom-in-95 duration-100">
                                        <div class="p-2 border-b border-slate-50">
                                            <input id="project-search" type="text" placeholder="ค้นหา..." class="w-full p-2 border border-slate-200 rounded-lg text-sm">
                                        </div>
                                        <div id="project-options" class="max-h-60 overflow-y-auto p-1.5 space-y-1"></div>
                                    </div>
                                </div>
                                <div class="mt-2 text-xs text-indigo-500 font-medium flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    ใส่ "FAC" สำหรับงานทั่วไปที่ไม่ใช่ Project
                                </div>
                            </div>

                            <!-- Duration -->
                            <div>
                                <label class="text-sm font-medium text-slate-600 mb-1.5 block">ระยะเวลา</label>
                                <div id="duration-dropdown" class="relative">
                                    <button id="duration-btn" type="button" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-left flex justify-between items-center focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all hover:bg-white hover:border-indigo-300">
                                        <span id="duration-selected-text" class="text-slate-500">เลือกระยะเวลา...</span>
                                        <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <div id="duration-panel" class="hidden absolute z-10 w-full mt-2 bg-white border border-slate-100 rounded-xl shadow-xl animate-in fade-in zoom-in-95 duration-100">
                                        <div id="duration-options" class="p-1.5 space-y-1">
                                            <div class="duration-option p-2.5 rounded-lg hover:bg-indigo-50 text-slate-700 cursor-pointer text-sm">ทั้งวัน (08:30 - 17:30)</div>
                                            <div class="duration-option p-2.5 rounded-lg hover:bg-indigo-50 text-slate-700 cursor-pointer text-sm">ครึ่งวันเช้า (08:30 - 12:00)</div>
                                            <div class="duration-option p-2.5 rounded-lg hover:bg-indigo-50 text-slate-700 cursor-pointer text-sm">ครึ่งวันบ่าย (13:00 - 17:30)</div>
                                            <div class="duration-option p-2.5 rounded-lg hover:bg-indigo-50 text-slate-700 cursor-pointer text-sm font-medium text-indigo-600">กำหนดเวลาเอง</div>
                                        </div>
                                    </div>
                                </div>

                                <div id="custom-time-inputs" class="hidden mt-3 grid grid-cols-2 gap-3 p-4 bg-slate-50 rounded-xl border border-slate-200">
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase">เริ่ม</label>
                                        <input type="time" id="custom-time-start-input" class="w-full mt-1 bg-white">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase">สิ้นสุด</label>
                                        <input type="time" id="custom-time-end-input" class="w-full mt-1 bg-white">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button id="save-report-btn" class="btn-primary w-full mt-4 text-lg shadow-lg shadow-indigo-200">
                            บันทึกรายงาน
                        </button>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="font-semibold text-lg text-slate-700 mb-3 ml-1">รายงานที่ส่งแล้ว</h3>
                        <div id="sent-reports-container" class="space-y-3">
                            <!-- JS populated -->
                        </div>
                    </div>
                </div>

                <!-- Page: Calendar -->
                <div id="calendar-page" class="page space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-800">ปฏิทิน</h2>
                        <button id="show-leave-form-btn" class="py-2 px-4 bg-white border border-indigo-100 text-indigo-600 rounded-xl font-semibold shadow-sm hover:bg-indigo-50 transition-all text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            ยื่นใบลา
                        </button>
                    </div>
                    
                    <div class="card !p-6">
                        <!-- Calendar Header -->
                        <div class="flex justify-between items-center mb-6">
                            <button id="cal-prev-month" class="p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <h3 id="cal-month-year" class="text-lg font-bold text-slate-800"></h3>
                            <button id="cal-next-month" class="p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                        
                        <!-- Days Header -->
                        <div class="grid grid-cols-7 gap-1 text-center mb-2">
                            <span class="text-xs font-bold text-red-400">อา</span>
                            <span class="text-xs font-bold text-slate-400">จ</span>
                            <span class="text-xs font-bold text-slate-400">อ</span>
                            <span class="text-xs font-bold text-slate-400">พ</span>
                            <span class="text-xs font-bold text-slate-400">พฤ</span>
                            <span class="text-xs font-bold text-slate-400">ศ</span>
                            <span class="text-xs font-bold text-indigo-400">ส</span>
                        </div>
                        
                        <!-- Calendar Grid -->
                        <div id="cal-grid" class="grid grid-cols-7 gap-1">
                            <!-- JS populated -->
                        </div>

                        <!-- Details Section -->
                        <div id="cal-details-container" class="mt-6 pt-6 border-t border-slate-100 min-h-[100px]">
                            <p class="text-center text-slate-400 text-sm mt-4">เลือกวันที่เพื่อดูรายละเอียด</p>
                        </div>
                    </div> 
                </div>

                <!-- Page: Profile -->
                <div id="profile-page" class="page space-y-6">
                    <div class="card !p-0 overflow-hidden">
                        <!-- Profile Cover/Header -->
                        <div class="bg-gradient-to-r from-indigo-600 to-blue-500 h-32 relative">
                            <button id="profile-edit-btn" class="absolute top-4 right-4 p-2 bg-white/20 backdrop-blur-md rounded-full text-white hover:bg-white/30 transition">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" /></svg>
                            </button>
                        </div>
                        
                        <div class="px-6 pb-6 relative">
                            <div class="flex flex-col items-center -mt-12 mb-4">
                                <div class="p-1.5 bg-white rounded-full shadow-md">
                                    <img id="profile-page-pic" src="https://placehold.co/150x150/E2E8F0/475569?text=User" class="w-24 h-24 rounded-full object-cover bg-slate-100">
                                </div>
                                <h2 id="profile-page-name" class="text-xl font-bold text-slate-800 mt-3">กำลังโหลด...</h2>
                                <span id="profile-page-department" class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-xs font-semibold mt-1">...</span>
                            </div>

                            <!-- Quick Stats -->
                            <div class="grid grid-cols-3 gap-3 mb-6">
                                <div class="bg-slate-50 p-3 rounded-2xl text-center border border-slate-100">
                                    <p class="text-xs text-slate-500 font-medium mb-1">ชั่วโมงงาน</p>
                                    <p id="profile-summary-hours" class="text-xl font-bold text-slate-800">-</p> 
                                </div>
                                <div class="bg-slate-50 p-3 rounded-2xl text-center border border-slate-100">
                                    <p class="text-xs text-slate-500 font-medium mb-1">OT รวม</p>
                                    <p id="profile-summary-ot" class="text-xl font-bold text-indigo-600">-</p> 
                                </div>
                                <div class="bg-slate-50 p-3 rounded-2xl text-center border border-slate-100">
                                    <p class="text-xs text-slate-500 font-medium mb-1">วันทำงาน</p>
                                    <p id="profile-summary-days" class="text-xl font-bold text-emerald-600">-</p> 
                                </div>
                            </div>

                            <!-- History Buttons -->
                            <div class="grid grid-cols-2 gap-3">
                                <button id="btn-my-leave-history" class="py-3 px-4 rounded-xl bg-white border border-slate-200 text-slate-600 font-semibold text-sm hover:bg-slate-50 hover:text-indigo-600 transition flex items-center justify-center gap-2 shadow-sm">
                                    <svg class="w-5 h-5 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                    เช็ควันลา
                                </button>
                                <button id="btn-my-ot-history" class="py-3 px-4 rounded-xl bg-white border border-slate-200 text-slate-600 font-semibold text-sm hover:bg-slate-50 hover:text-orange-600 transition flex items-center justify-center gap-2 shadow-sm">
                                    <svg class="w-5 h-5 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    เช็ค OT
                                </button>
                            </div>
                        </div>
                    </div> 

                    <!-- Work History List -->
                    <div>
                        <div class="flex justify-between items-end mb-4 px-1">
                             <h3 class="font-bold text-lg text-slate-800">ประวัติการทำงาน</h3>
                             <div class="relative">
                                <select id="history-range-select" class="appearance-none bg-white border border-slate-200 text-slate-600 text-xs font-bold py-2 pl-3 pr-8 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500 shadow-sm">
                                    <option value="7">7 วันล่าสุด</option>
                                    <option value="this_month">เดือนนี้</option>
                                    <option value="last_month">เดือนที่แล้ว</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400">
                                    <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                            </div>
                        </div>
                       
                        <div id="work-history-container" class="space-y-4">
                            <!-- JS populated -->
                        </div>
                    </div>

                    <button id="logout-btn" class="w-full py-4 rounded-2xl bg-rose-50 text-rose-600 font-bold hover:bg-rose-100 transition mt-8 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        ออกจากระบบ
                    </button>
                </div>

                <!-- Admin Dashboard (Placeholder structure to maintain logic) -->
                <div id="admin-dashboard-page" class="page space-y-6">
                    <h2 class="text-2xl font-bold text-slate-800">ผู้ดูแลระบบ</h2>
                    <div class="card">
                        <p class="text-slate-500">ส่วนจัดการสำหรับ Admin (โครงสร้างเดิม)</p>
                        <!-- Keep original IDs for admin logic -->
                        <div id="admin-controls-placeholder" class="mt-4">
                             <!-- Admin elements will be injected/manipulated by JS here if needed, or simply use existing structure -->
                             <button id="admin-go-to-calendar-btn" class="btn-primary w-full mb-4">จัดการปฏิทิน</button>
                             <!-- Add other admin IDs hidden or visible as needed -->
                             <input type="text" id="add-work-type-input" class="hidden">
                             <button id="add-work-type-btn" class="hidden"></button>
                             <!-- ... (Other admin elements matching your JS logic) ... -->
                             <!-- Note: For full admin UI update, similar premium styling should be applied to admin sections -->
                        </div>
                    </div>
                </div>

            </div>
        </main>
        
        <!-- Bottom Nav (Mobile) -->
        <nav class="fixed bottom-0 left-0 right-0 bottom-nav flex justify-around items-center md:hidden z-30">
            <a href="#" class="nav-item flex-1 flex flex-col items-center justify-center py-2 text-slate-400 active" data-page="check-in-out-page">
                <svg class="w-6 h-6 mb-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="text-[10px] font-medium">ลงเวลา</span>
            </a>
            
            <a href="#" id="report-or-admin-nav" class="nav-item flex-1 flex flex-col items-center justify-center py-2 text-slate-400" data-page="report-page">
                <svg class="w-6 h-6 mb-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span class="text-[10px] font-medium">รายงาน</span>
            </a>

            <a href="#" id="calendar-or-admin-nav" class="nav-item flex-1 flex flex-col items-center justify-center py-2 text-slate-400" data-page="calendar-page">
                 <svg class="w-6 h-6 mb-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span class="text-[10px] font-medium">ปฏิทิน</span>
            </a>

            <a href="#" class="nav-item flex-1 flex flex-col items-center justify-center py-2 text-slate-400" data-page="profile-page">
                <svg class="w-6 h-6 mb-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span class="text-[10px] font-medium">โปรไฟล์</span>
            </a>
        </nav>
    </div>

    <!-- Notifications Toast -->
    <div id="notification" class="fixed top-6 left-1/2 -translate-x-1/2 z-[60] flex items-center gap-3 bg-slate-800 text-white py-3 px-5 rounded-2xl shadow-2xl text-sm transition-all duration-500 opacity-0 -translate-y-full max-w-[90vw]">
        <span id="notification-icon" class="text-emerald-400"></span>
        <p id="notification-message" class="font-medium">แจ้งเตือน</p>
    </div>
    
    <!-- Modals (Structure kept, styled updated via global CSS) -->
    
    <!-- Edit Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div id="modal-overlay" class="absolute inset-0"></div>
        <div class="card relative z-10 w-full max-w-md max-h-[90vh] overflow-y-auto animate-in zoom-in-95 duration-200">
            <h3 class="text-xl font-bold mb-6 text-slate-800">แก้ไขข้อมูล</h3>
            <input type="hidden" id="edit-doc-id">
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">เวลาเข้างาน</label>
                    <input type="datetime-local" id="edit-checkin-time" class="w-full mt-1">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">เวลาออกงาน</label>
                    <input type="datetime-local" id="edit-checkout-time" class="w-full mt-1">
                </div>
                
                <hr class="border-slate-100 my-2">
                
                <!-- Admin specific inputs (need to ensure IDs match JS logic) -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">On-site Details</label>
                    <input type="text" id="edit-onsite-details" class="w-full mt-1">
                </div>
                
                <!-- Hidden structure for Admin dropdowns to prevent JS errors -->
                <div class="hidden">
                    <button id="edit-modal-work-type-btn"><span id="edit-modal-work-type-selected-text"></span></button>
                    <div id="edit-modal-work-type-panel"><input id="edit-modal-work-type-search"><div id="edit-modal-work-type-options"></div></div>
                    
                    <button id="edit-modal-project-btn"><span id="edit-modal-project-selected-text"></span></button>
                    <div id="edit-modal-project-panel"><input id="edit-modal-project-search"><div id="edit-modal-project-options"></div></div>
                    
                    <button id="edit-modal-duration-btn"><span id="edit-modal-duration-selected-text"></span></button>
                    <div id="edit-modal-duration-panel"><div id="edit-modal-duration-options"></div></div>
                    
                    <div id="edit-modal-custom-time-inputs"><input id="edit-modal-custom-time-start-input"><input id="edit-modal-custom-time-end-input"></div>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button id="cancel-edit-btn" class="py-2.5 px-5 bg-slate-100 text-slate-600 rounded-xl font-semibold hover:bg-slate-200 transition">ยกเลิก</button>
                    <button id="save-edit-btn" class="btn-primary py-2.5 px-6 rounded-xl">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div id="confirm-overlay" class="absolute inset-0"></div>
        <div class="bg-white rounded-3xl p-6 relative z-10 w-full max-w-sm shadow-2xl animate-in zoom-in-95 duration-200 text-center">
            <div class="w-16 h-16 bg-amber-100 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <h3 id="confirm-title" class="text-lg font-bold text-slate-800 mb-2">ยืนยันการทำรายการ</h3>
            <p id="confirm-message" class="text-slate-500 mb-6">คุณแน่ใจหรือไม่ที่จะดำเนินการต่อ?</p>
            <div class="flex gap-3">
                <button id="confirm-cancel-btn" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition">ยกเลิก</button>
                <button id="confirm-ok-btn" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">ตกลง</button>
            </div>
        </div>
    </div>

    <!-- Leave Request Modal -->
    <div id="leave-request-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div id="leave-overlay" class="absolute inset-0"></div>
        <div class="card relative z-10 w-full max-w-md animate-in zoom-in-95 duration-200">
            <h3 class="text-xl font-bold mb-6 text-slate-800">แบบฟอร์มขอลาหยุด</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">ประเภทการลา</label>
                    <select id="leave-type-select" class="w-full mt-1">
                        <option value="">-- เลือกประเภท --</option>
                        <option value="annual">ลาพักร้อน</option>
                        <option value="sick">ลาป่วย</option>
                        <option value="personal">ลากิจ</option>
                        <option value="maternity">ลาคลอด</option>
                    </select>
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">รูปแบบ</label>
                    <select id="leave-duration-type" class="w-full mt-1">
                        <option value="full_day">เต็มวัน</option>
                        <option value="hourly">รายชั่วโมง</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">เริ่มวันที่</label>
                        <input type="date" id="leave-start-date" class="w-full mt-1">
                    </div>
                    <div id="leave-end-date-wrapper">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">ถึงวันที่</label>
                        <input type="date" id="leave-end-date" class="w-full mt-1">
                    </div>
                </div>

                <div id="leave-hourly-inputs-wrapper" class="hidden grid grid-cols-2 gap-4 bg-slate-50 p-3 rounded-xl border border-slate-200">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">เวลาเริ่ม</label>
                        <input type="time" id="leave-start-time" class="w-full mt-1 bg-white">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">เวลาสิ้นสุด</label>
                        <input type="time" id="leave-end-time" class="w-full mt-1 bg-white">
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">เหตุผล</label>
                    <textarea id="leave-reason" rows="3" class="w-full mt-1" placeholder="ระบุเหตุผล..."></textarea>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button id="cancel-leave-btn" class="py-2.5 px-5 bg-slate-100 text-slate-600 rounded-xl font-semibold hover:bg-slate-200">ยกเลิก</button>
                    <button id="submit-leave-btn" class="btn-primary py-2.5 px-6 rounded-xl">ส่งคำขอ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- OT Request Modal -->
    <div id="ot-request-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div id="ot-overlay" class="absolute inset-0"></div>
        <div class="card relative z-10 w-full max-w-md animate-in zoom-in-95 duration-200">
            <h3 class="text-xl font-bold mb-6 text-slate-800">ขออนุมัติ OT</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">วันที่</label>
                    <input type="date" id="ot-request-date" class="w-full mt-1 bg-slate-100 text-slate-500" readonly>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">เริ่ม</label>
                        <input type="time" id="ot-start-time" class="w-full mt-1 bg-slate-100" readonly>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">สิ้นสุด</label>
                        <input type="time" id="ot-end-time" class="w-full mt-1">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">รายละเอียดงาน</label>
                    <textarea id="ot-reason" rows="3" class="w-full mt-1" placeholder="ระบุงานที่ทำ..."></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button id="cancel-ot-btn" class="py-2.5 px-5 bg-slate-100 text-slate-600 rounded-xl font-semibold hover:bg-slate-200">ยกเลิก</button>
                    <button id="submit-ot-btn" class="btn-primary py-2.5 px-6 rounded-xl">ส่งคำขอ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profile-edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div id="profile-edit-overlay" class="absolute inset-0"></div>
        <div class="card relative z-10 w-full max-w-md animate-in zoom-in-95 duration-200">
            <h3 class="text-xl font-bold mb-6 text-slate-800">แก้ไขข้อมูลส่วนตัว</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">ชื่อ-นามสกุล</label>
                    <input type="text" id="profile-edit-name-input" class="w-full mt-1">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">แผนก</label>
                    <select id="profile-edit-dept-input" class="w-full mt-1">
                        <option value="">-- เลือกแผนก --</option>
                        <option value="Mechanic">Mechanic</option>
                        <option value="Electrical">Electrical</option>
                        <option value="Design">Design</option>
                        <option value="Accounting">Accounting</option>
                        <option value="HR">HR</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button id="profile-edit-cancel-btn" class="py-2.5 px-5 bg-slate-100 text-slate-600 rounded-xl font-semibold hover:bg-slate-200">ยกเลิก</button>
                    <button id="profile-edit-save-btn" class="btn-primary py-2.5 px-6 rounded-xl">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modals -->
    <div id="my-leave-history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="card relative z-10 w-full max-w-md h-[70vh] flex flex-col animate-in zoom-in-95 duration-200">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-100">
                <h3 class="text-lg font-bold text-slate-800">ประวัติการลา</h3>
                <button class="close-modal-btn p-2 rounded-full hover:bg-slate-100 text-slate-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="my-leave-list-container" class="flex-1 overflow-y-auto space-y-3 pr-1 no-scrollbar"></div>
        </div>
    </div>

    <div id="my-ot-history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="card relative z-10 w-full max-w-md h-[70vh] flex flex-col animate-in zoom-in-95 duration-200">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-100">
                <h3 class="text-lg font-bold text-slate-800">ประวัติการขอ OT</h3>
                <button class="close-modal-btn p-2 rounded-full hover:bg-slate-100 text-slate-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="my-ot-list-container" class="flex-1 overflow-y-auto space-y-3 pr-1 no-scrollbar"></div>
        </div>
    </div>
    <!-- Scripts (External & Logic) -->
    <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-functions-compat.js"></script>
    <script src="firebase-config.js?v=1.3"></script>
    <script>

        function toLocalISOString(date) {
        if (!date) return ''; // สำหรับ handle ค่า null เช่น checkout ที่ยังไม่เกิด

        const d = new Date(date);
        
        // ดึงค่าตามโซนเวลาท้องถิ่น (Local Timezone)
        const year = d.getFullYear();
        const month = (d.getMonth() + 1).toString().padStart(2, '0'); // getMonth() เริ่มที่ 0
        const day = d.getDate().toString().padStart(2, '0');
        const hours = d.getHours().toString().padStart(2, '0');
        const minutes = d.getMinutes().toString().padStart(2, '0');

        // ส่งค่ากลับในฟอร์แมต YYYY-MM-DDTHH:MM
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function toLocalDateKey(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    </script>
<script>

document.addEventListener('DOMContentLoaded', function() {

    const loadScript = (src) => {
        return new Promise((resolve, reject) => {
            // เช็คว่าเคยโหลดไปหรือยัง ถ้ามีแล้วไม่ต้องโหลดซ้ำ
            if (document.querySelector(`script[src="${src}"]`)) {
                resolve();
                return;
            }
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    };

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            // สั่งให้ Browser โหลดไฟล์ sw.js มาทำงาน
            navigator.serviceWorker.register('/sw.js').then(function(registration) {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
    
    // --- Initialize Firebase & Config ---
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.app().functions('asia-southeast1');
    const storage = firebase.storage(); 
    
    if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
        console.log("🔧 Running in Development Mode (Using Emulators)");
        
        // Auth: Port 9099 (ตรงตามรูป)
        auth.useEmulator("http://127.0.0.1:9099");
        
        // Firestore: Port 8081 (★★★ แก้ตรงนี้จาก 8080 เป็น 8081 ★★★)
        db.useEmulator("127.0.0.1", 8081);
        
        // Functions: Port 5001 (ตรงตามรูป)
        functions.useEmulator("127.0.0.1", 5001);

        // Storage: Port 9199 (เพิ่มอันนี้ตามรูป เพื่อให้โหลดรูปได้)
        storage.useEmulator("127.0.0.1", 9199); 
    } else {
        console.log("🚀 Running in Production Mode (Real Database)");
    }

    const LEAVE_TYPE_MAP = { 
        'annual': 'ลาพักร้อน (Annual Leave)', 
        'sick': 'ลาป่วย (Sick Leave)', 
        'personal': 'ลากิจ (Personal Leave)',
        'maternity': 'ลาคลอด (Maternity Leave)' // เพิ่มบรรทัดนี้
    };
    
    const FACTORY_LOCATION = { latitude: 13.625, longitude: 101.025 };
    const ALLOWED_RADIUS_METERS = 200;

    // --- UI Elements ---
    const loadingSpinner = document.getElementById('loading-spinner');
    const loginPage = document.getElementById('login-page');
    const appContainer = document.getElementById('app-container');
    const lineLoginBtn = document.getElementById('line-login-btn');
    const checkinBtn = document.getElementById('checkin-btn');
    const checkoutBtn = document.getElementById('checkout-btn');
    const mainContent = document.getElementById('main-content');
    const locationStatusDiv = document.getElementById('location-status');
    const locationIcon = document.getElementById('location-icon');
    const locationText = document.getElementById('location-text');
    const workTypeButtons = document.querySelectorAll('.work-type-btn');
    const onsiteDetailsForm = document.getElementById('onsite-details-form');
    const onsiteLocationInput = document.getElementById('onsite-location-input');
    const photoUploadInput = document.getElementById('photo-upload-input');
    const photoPreview = document.getElementById('photo-preview');
    const summaryCheckinTime = document.getElementById('summary-checkin-time');
    const summaryCheckoutTime = document.getElementById('summary-checkout-time');
    const summaryWorkHours = document.getElementById('summary-work-hours');
    const pages = mainContent.querySelectorAll('.page');
    const navItems = document.querySelectorAll('.nav-item');
    const timeElement = document.getElementById('current-time');

    // --- UI Elements for Report Page ---
    const saveReportBtn = document.getElementById('save-report-btn');
    const reportDateInput = document.getElementById('report-date-input');
    const workTypeSelectedText = document.getElementById('work-type-selected-text');
    const projectSelectedText = document.getElementById('project-selected-text');
    const durationSelectedText = document.getElementById('duration-selected-text');
    const customTimeInputs = document.getElementById('custom-time-inputs');
    const customTimeStartInput = document.getElementById('custom-time-start-input');
    const customTimeEndInput = document.getElementById('custom-time-end-input');
    const summaryStartDateInput = document.getElementById('summary-start-date');
    const summaryEndDateInput = document.getElementById('summary-end-date');
    const summaryEmployeeFilterInput = document.getElementById('summary-employee-filter');
    const summaryStatusFilterSelect = document.getElementById('summary-status-filter');
    const applySummaryFiltersBtn = document.getElementById('apply-summary-filters-btn');
    const exportEmployeeSummaryBtn = document.getElementById('export-employee-summary-btn');    
    // 1. ดึง Elements
    const editUserSelect = document.getElementById('edit-user-select');
    const editDateSelect = document.getElementById('edit-date-select');
    const searchRecordBtn = document.getElementById('search-record-btn');
    const searchResultsContainer = document.getElementById('search-results-container');

    const editModal = document.getElementById('edit-modal');
    const modalOverlay = document.getElementById('modal-overlay');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const saveEditBtn = document.getElementById('save-edit-btn');

    // Input ภายใน Modal
    const editDocIdInput = document.getElementById('edit-doc-id');
    const editCheckinTimeInput = document.getElementById('edit-checkin-time');
    const editCheckoutTimeInput = document.getElementById('edit-checkout-time');
    const editOnsiteDetailsInput = document.getElementById('edit-onsite-details');
    // Elements สำหรับ Dropdown ใน Modal
    const editModalWorkTypeSelectedText = document.getElementById('edit-modal-work-type-selected-text');
    const editModalProjectSelectedText = document.getElementById('edit-modal-project-selected-text');
    const editModalDurationSelectedText = document.getElementById('edit-modal-duration-selected-text');
    const editModalCustomTimeInputs = document.getElementById('edit-modal-custom-time-inputs');
    const editModalCustomTimeStartInput = document.getElementById('edit-modal-custom-time-start-input');
    const editModalCustomTimeEndInput = document.getElementById('edit-modal-custom-time-end-input');
    // --- 1. ดึง Element ของฟอร์มใบลา ---
    const leaveRequestModal = document.getElementById('leave-request-modal');
    const leaveOverlay = document.getElementById('leave-overlay');
    const cancelLeaveBtn = document.getElementById('cancel-leave-btn');
    const submitLeaveBtn = document.getElementById('submit-leave-btn');
    // [ใหม่] ดึง Element ที่เพิ่มเข้ามา
    const leaveDurationType = document.getElementById('leave-duration-type');
    const leaveEndDateWrapper = document.getElementById('leave-end-date-wrapper');
    const leaveHourlyInputsWrapper = document.getElementById('leave-hourly-inputs-wrapper');
    const leaveStartTime = document.getElementById('leave-start-time');
    const leaveEndTime = document.getElementById('leave-end-time');
    // --- 2. ดึง Element ของ Input ---
    const leaveTypeSelect = document.getElementById('leave-type-select');
    const leaveStartDate = document.getElementById('leave-start-date');
    const leaveEndDate = document.getElementById('leave-end-date');
    const leaveReason = document.getElementById('leave-reason');
    // [NEW] Notification Elements
    const notificationBellBtn = document.getElementById('notification-bell-btn');
    const notificationModal = document.getElementById('notification-modal');
    const notificationBadge = document.getElementById('notification-badge');
    const notificationList = document.getElementById('notification-list');
    const noNotificationsMsg = document.getElementById('no-notifications-msg');
    // --- [เพิ่ม] ตัวแปรสำหรับ Modal แก้ไขโปรไฟล์ ---
    const profileEditModal = document.getElementById('profile-edit-modal');
    const profileEditBtn = document.getElementById('profile-edit-btn');
    const profileEditCancelBtn = document.getElementById('profile-edit-cancel-btn');
    const profileEditOverlay = document.getElementById('profile-edit-overlay');
    const profileEditNameInput = document.getElementById('profile-edit-name-input');
    const profileEditDeptInput = document.getElementById('profile-edit-dept-input');
    const profileEditSaveBtn = document.getElementById('profile-edit-save-btn');
    // [เพิ่มใหม่] --- UI Elements สำหรับขอ OT ---
    const requestOtBtn = document.getElementById('request-ot-btn');
    const otRequestModal = document.getElementById('ot-request-modal');
    const otOverlay = document.getElementById('ot-overlay');
    const cancelOtBtn = document.getElementById('cancel-ot-btn');
    const submitOtBtn = document.getElementById('submit-ot-btn');
    const otRequestDate = document.getElementById('ot-request-date');
    const otStartTime = document.getElementById('ot-start-time');
    const otEndTime = document.getElementById('ot-end-time');
    const otReason = document.getElementById('ot-reason');
    
        let html5QrCode;
        let currentRoomId = null;
        let roomUnsubscribe = null; // สำหรับยกเลิกการฟัง Realtime update

        // --- 1. การสลับ Role (Member / Leader) ---
        const roleMemberBtn = document.getElementById('role-member-btn');
        const roleLeaderBtn = document.getElementById('role-leader-btn');
        const memberSection = document.getElementById('member-section');
        const leaderSection = document.getElementById('leader-section');

        // CSS Class สำหรับปุ่มที่ถูกเลือก/ไม่ถูกเลือก
        const activeClass = ['border-sky-500', 'text-sky-600', 'bg-sky-50'];
        const inactiveClass = ['border-gray-300', 'text-gray-500', 'bg-white'];

    // (เพิ่มตัวแปรนี้ด้านบน) กำหนดค่าความแม่นยำสูงสุดที่ยอมรับได้ (เช่น 100 เมตร)
    const MAX_ACCEPTABLE_ACCURACY = 180;
    // --- App State ---
    let currentUser = null;
    let watchId = null;
    let latestPosition = null;
    let selectedWorkType = 'in_factory';
    let photoFile = null;
    let controlsInitialized = false;
    let currentUserData = null; 
    // [เพิ่มใหม่] ตัวแปรสำหรับเก็บเดือนที่ดูอยู่
    let currentDisplayDate = new Date();
    
    // [เพิ่มใหม่] สร้าง Cache เพื่อเก็บข้อมูลที่โหลดมา
    let calendarDataCache = {
        plans: new Map(),
        records: new Map(),
        users: new Map() // Map(userId -> userData)
    };

    // (วางโค้ดนี้ก่อน auth.onAuthStateChanged)
    function openProfileEditModal() {
    if (!currentUserData) return; // ตรวจสอบว่ามีข้อมูล User

    // 1. เติมข้อมูลเดิมลงในฟอร์ม
    profileEditNameInput.value = currentUserData.fullName || '';
    
    // [แก้ไข] ตรวจสอบ 'Unassigned' เพื่อแสดง Placeholder
    const currentDept = currentUserData.department;
    if (currentDept && currentDept !== 'Unassigned') {
        profileEditDeptInput.value = currentDept;
    } else {
        profileEditDeptInput.value = ''; // ตั้งเป็นค่าว่าง ("") เพื่อให้แสดง "-- เลือกฝ่าย/แผนก --"
    }

    // 2. แสดง Modal
    if (profileEditModal) profileEditModal.classList.remove('hidden');
}

    // --- [เพิ่ม] ฟังก์ชันปิด Modal ---
    function closeProfileEditModal() {
        if (profileEditModal) profileEditModal.classList.add('hidden');
    }

    // --- [เพิ่ม] ผูก Event Listener (ปุ่มเปิด/ปิด Modal) ---
    if (profileEditBtn) profileEditBtn.addEventListener('click', openProfileEditModal);
    if (profileEditCancelBtn) profileEditCancelBtn.addEventListener('click', closeProfileEditModal);
    if (profileEditOverlay) profileEditOverlay.addEventListener('click', closeProfileEditModal);

    // --- [เพิ่ม] Event Listener (ปุ่มบันทึก) ---
    if (profileEditSaveBtn) profileEditSaveBtn.addEventListener('click', async () => {
    if (!currentUser) return showNotification("ไม่พบข้อมูลผู้ใช้", "error");

    const newName = profileEditNameInput.value.trim();
    const newDept = profileEditDeptInput.value.trim();

    if (!newName || !newDept) {
        return showNotification("กรุณากรอกชื่อและแผนก", "warning");
    }

    profileEditSaveBtn.disabled = true;
    profileEditSaveBtn.textContent = 'กำลังบันทึก...';

    try {
        // [ ★★★ แก้ไข ★★★ ]
        // ข้อมูลที่จะอัปเดตมีแค่ 2 อย่างนี้เท่านั้น
        let updatedData = {
            fullName: newName,
            department: newDept
        };

        // (ลบส่วนที่เช็ก if (newProfilePicFile) ... และการอัปโหลด Storage ออกทั้งหมด)

        // 2. อัปเดตข้อมูล (ชื่อ/แผนก) ลง Firestore
        const userDocRef = db.collection('users').doc(currentUser.uid);
        await userDocRef.update(updatedData);

        // 3. อัปเดตข้อมูลในตัวแปร (Local State)
        currentUserData = { ...currentUserData, ...updatedData };

        // 4. อัปเดตหน้าเว็บ UI ทันที
        updateProfilePage(currentUserData); // (ฟังก์ชันนี้ยังต้องเรียกใช้)

        showNotification("บันทึกโปรไฟล์สำเร็จ!", "success");
        closeProfileEditModal();

    } catch (error) {
        console.error("Error saving profile:", error);
        showNotification("เกิดข้อผิดพลาดในการบันทึก: " + error.message, "error");
    } finally {
        profileEditSaveBtn.disabled = false;
        profileEditSaveBtn.textContent = 'บันทึก';
    }
});

async function initializeApp(user, userData) {
    console.log("Initializing App...");
    currentUserData = userData;

    // 1. อัปเดตข้อมูลพื้นฐานบน UI
    document.getElementById('user-display-name').textContent = userData.fullName || 'ผู้ใช้งาน';
    updateProfilePage(userData);

    // --- จัดการ Logic ของปุ่ม Navigation (Admin vs User) ---
    const reportNavButtonSidebar = document.getElementById('report-or-admin-nav-sidebar');
    const thirdNavButtonSidebar = document.getElementById('calendar-or-admin-nav-sidebar');
    const reportNavButton = document.getElementById('report-or-admin-nav');
    const thirdNavButton = document.getElementById('calendar-or-admin-nav');

    // ไอคอนสำหรับปุ่ม Dashboard (Admin)
    const dashboardIconSvg_BottomNav = `
    <svg class="w-7 h-7 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
    </svg>`;
    const dashboardIconSvg_Sidebar = `
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
    </svg>`;

    // ไอคอนสำหรับปุ่ม Calendar (User)
    const calendarIconSvg_BottomNav = `
    <svg class="w-7 h-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
    </svg>`;
    const calendarIconSvg_Sidebar = `
    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
    </svg>`;

    // ตั้งค่าปุ่มเมนูตาม Role
    if (currentUserData && currentUserData.role === 'admin') {
        // [FIX] ใช้ outerHTML แทน innerHTML เพื่อเปลี่ยนแค่ SVG โดยไม่ลบ Text
        if (thirdNavButtonSidebar) {
            thirdNavButtonSidebar.dataset.page = 'admin-dashboard-page';
            thirdNavButtonSidebar.querySelector('span').textContent = 'Dashboard';
            const oldIcon = thirdNavButtonSidebar.querySelector('svg');
            if (oldIcon) oldIcon.outerHTML = dashboardIconSvg_Sidebar;
        }
        if (thirdNavButton) {
            thirdNavButton.dataset.page = 'admin-dashboard-page';
            thirdNavButton.querySelector('span').textContent = 'Dashboard';
            const oldIcon = thirdNavButton.querySelector('svg');
            if (oldIcon) oldIcon.outerHTML = dashboardIconSvg_BottomNav;
        }
    } else {
        if (thirdNavButtonSidebar) {
            thirdNavButtonSidebar.dataset.page = 'calendar-page';
            thirdNavButtonSidebar.querySelector('span').textContent = 'ปฏิทิน';
            const oldIcon = thirdNavButtonSidebar.querySelector('svg');
            if (oldIcon) oldIcon.outerHTML = calendarIconSvg_Sidebar;
        }
        if (thirdNavButton) {
            thirdNavButton.dataset.page = 'calendar-page';
            thirdNavButton.querySelector('span').textContent = 'ปฏิทิน';
            const oldIcon = thirdNavButton.querySelector('svg');
            if (oldIcon) oldIcon.outerHTML = calendarIconSvg_BottomNav;
        }
    }

    // 2. แสดงหน้าจอหลักทันที
    //appContainer.style.display = 'block';
    // ลบ style none ที่เราใส่ไว้ใน HTML ออก (เผื่อกรณี CSS class ทำงานต่อ)
    appContainer.style.removeProperty('display'); 
    
    loadingSpinner.style.display = 'none';
    showPage('check-in-out-page');

    // ตั้งค่า Active Menu
    const allNavItems = document.querySelectorAll('.nav-item');
    allNavItems.forEach(n => n.classList.remove('active'));
    const checkInNavItems = document.querySelectorAll('.nav-item[data-page="check-in-out-page"]');
    checkInNavItems.forEach(n => n.classList.add('active'));

    // เริ่มต้นระบบ GPS และ Controls
    initializeControls();
    startWatchingPosition();

    // 3. โหลดข้อมูลเบื้องหลัง (Parallel)
    try {
        await Promise.all([
            checkUserWorkStatus(),
            loadDailyLeaveNotifications(),
            populateDropdownOptions()
        ]);
        console.log("Background data loaded successfully");
    } catch (error) {
        console.error("Error loading background data:", error);
    }
}
        auth.onAuthStateChanged(async (user) => {
    // 1. ซ่อน Login และแสดง Loading ระหว่างรอ
    loginPage.style.display = 'none';
    loadingSpinner.style.display = 'flex'; // โชว์ loading รอไว้ก่อน

    // เพิ่ม Try-Catch เพื่อป้องกันจอขาวหากเกิด Error
    try {
        if (user) {
            console.log("User authenticated:", user.uid);
            currentUser = user;
            
            const userDocRef = db.collection('users').doc(user.uid);
            
            // [แก้ไข] ลบ { source: 'server' } ออก เพื่อให้โหลดจาก Cache ได้ถ้าเน็ตไม่ดี (ลดโอกาสเกิด AbortError)
            // หรือถ้าอยากบังคับ Server จริงๆ ให้ใช้ try-catch ซ้อนอีกชั้น
            let userDoc;
            try {
                userDoc = await userDocRef.get(); 
            } catch (err) {
                console.warn("Load user failed, retrying...", err);
                // ถ้าโหลดไม่ได้จริงๆ ให้ลองโหลดอีกครั้งหรือใช้ค่าว่าง
                userDoc = await userDocRef.get({ source: 'cache' }); 
            }

            if (userDoc && userDoc.exists) {
                await initializeApp(user, userDoc.data());
            } else {
                // --- กรณี User ใหม่ ---
                console.log("Creating new user profile...");
                const newUserProfile = {
                    fullName: user.displayName || user.email || 'New User',
                    email: user.email || null,
                    profileImageUrl: user.photoURL || null,
                    department: 'Unassigned',
                    role: 'user',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await userDocRef.set(newUserProfile);
                await initializeApp(user, newUserProfile);
            }
        } else {
            // --- กรณี Logged out ---
            console.log("User logged out");
            stopWatchingPosition();
            currentUser = null;
            
            // แสดงหน้า Login
            appContainer.style.display = 'none'; // ซ่อนหน้าหลัก
            loginPage.style.display = 'flex';    // โชว์หน้า Login
            loadingSpinner.style.display = 'none'; // ซ่อน Loading
        }

    } catch (error) {
        // ★★★ ดักจับ Error ตรงนี้ เพื่อไม่ให้จอขาว ★★★
        console.error("Critical Init Error:", error);
        alert("เกิดข้อผิดพลาดในการเริ่มระบบ: " + error.message + "\n(กด OK เพื่อรีโหลด)");
        
        // ถ้า Error ให้ถอยกลับไปหน้า Login หรือรีโหลด
        auth.signOut();
        window.location.reload();
    }
});
        
        // โค้ดส่วนนี้จะ "ประมวลผล" การ Login (ถ้ามี) และผลลัพธ์ของมันจะถูก "ดักจับ" 
        // โดย onAuthStateChanged (ที่อยู่ข้างบน) ซึ่งกำลังรอฟังอยู่แล้ว
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
          .then(() => {
            // เรียก getRedirectResult เพื่อประมวลผลการเด้งกลับจาก LINE/Google
            return auth.getRedirectResult(); 
          })
          .then((result) => {
            if (result.user) {
              console.log("เข้าสู่ระบบผ่าน Redirect สำเร็จ (ด้วย Local Persistence)");
            }
            // ไม่ต้องทำอะไรต่อ ... onAuthStateChanged (ข้างบน) จะจัดการเอง
          })
          .catch((error) => {
            console.error("Firebase Persistence Error:", error.code, error.message);
            if (error.code === 'auth/persistence-unavailable') {
              alert("เบราว์เซอร์ของคุณไม่อนุญาตให้จัดเก็บข้อมูล กรุณาปิดโหมด Private Browsing");
            } else {
              console.error("LINE/Google Redirect Error:", error.code, error.message);
            }
            // ถ้า Error, onAuthStateChanged (ข้างบน) ก็จะยังคงทำงาน
            // และแสดงหน้า Login ตามปกติ (เพราะ user = null)
          });

    // ... (วางโค้ดฟังก์ชันเดิมทั้งหมดที่นี่ ตั้งแต่ saveReportBtn.addEventListener จนถึง showNotification) ...
     // --- [ปรับปรุง] Logic การบันทึกรายงาน ---
    saveReportBtn.addEventListener('click', async () => {
        if (!currentUser) return alert("กรุณาเข้าสู่ระบบ");

        const selectedDateStr = reportDateInput.value; // รับค่าวันที่จาก Input
        if (!selectedDateStr) return alert("กรุณาเลือกวันที่");

        const workType = workTypeSelectedText.textContent;
        const project = projectSelectedText.textContent;
        const duration = durationSelectedText.textContent;
        let timeRange = duration;

        // Validation
        if (workType.includes('เลือก...')) return alert("กรุณาเลือกประเภทงาน");
        if (project.includes('เลือก...')) return alert("กรุณาเลือกโครงการ");
        if (duration.includes('เลือก...')) return alert("กรุณาเลือกระยะเวลา");

        if (duration === 'กำหนดเวลา') {
            if (!customTimeStartInput.value || !customTimeEndInput.value) {
                return alert("กรุณากรอกเวลา");
            }
            timeRange = `${customTimeStartInput.value} - ${customTimeEndInput.value}`;
        }
        
        saveReportBtn.disabled = true;
        saveReportBtn.textContent = 'กำลังบันทึก...';
        
        try {
            // ใช้ selectedDateStr แทน new Date()
            const workRecordDocId = `${currentUser.uid}_${selectedDateStr}`;
            const workRecordRef = db.collection('work_records').doc(workRecordDocId);
            
            const doc = await workRecordRef.get();
            
            // กรณีที่ 1: มีการ Check-in วันนั้นแล้ว -> อัปเดต report ใส่เข้าไป
            if (doc.exists) {
                await workRecordRef.update({
                    report: {
                        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        workType: workType,
                        project: project,
                        duration: timeRange
                    }
                });
            } 
            // กรณีที่ 2: ลืม Check-in ด้วย (ไม่มี Record เลย)
            else {
                // คุณต้องตัดสินใจว่าจะยอมให้สร้าง Record ใหม่ที่มีแต่ Report หรือไม่
                // ถ้าเอาแบบง่ายสุดคือยอมให้สร้าง โดยไม่มีข้อมูล GPS Check-in
                const confirmCreate = confirm(`ไม่พบข้อมูลการลงเวลาในวันที่ ${selectedDateStr}\nคุณต้องการสร้างรายงานโดยไม่มีเวลาเข้า-ออกงาน หรือไม่?`);
                
                if (!confirmCreate) {
                    saveReportBtn.disabled = false;
                    saveReportBtn.textContent = 'บันทึกข้อมูล';
                    return;
                }

                // สร้าง Record ใหม่ (Backdate)
                await workRecordRef.set({
                    userId: currentUser.uid,
                    date: firebase.firestore.Timestamp.fromDate(new Date(selectedDateStr)),
                    status: "no_checkin_report_only", // สถานะพิเศษ
                    checkIn: {
                        timestamp: firebase.firestore.Timestamp.fromDate(new Date(`${selectedDateStr}T08:30:00`)), // เวลาสมมติ
                        workType: "backdate_report",
                        location: null // ไม่มีพิกัด
                    },
                    report: {
                        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        workType: workType,
                        project: project,
                        duration: timeRange
                    }
                });
            }

            showNotification('บันทึกรายงานสำเร็จ!');
            // รีเฟรช UI
            loadReportForSelectedDate(); 
            
        } catch (error) {
            console.error("Error saving report: ", error);
            alert('เกิดข้อผิดพลาด: ' + error.message);
        } finally {
            saveReportBtn.disabled = false;
            // คืนค่าข้อความปุ่มตามสถานะ (ทำผ่าน loadReportForSelectedDate ได้)
        }
    });

    workTypeButtons.forEach(button => {
        button.addEventListener('click', () => {
            workTypeButtons.forEach(btn => {
                btn.classList.remove('bg-sky-500', 'text-white', 'shadow');
                btn.classList.add('text-gray-600');
            });
            button.classList.add('bg-sky-500', 'text-white', 'shadow');
            selectedWorkType = button.dataset.workType;
            onsiteDetailsForm.classList.toggle('hidden', selectedWorkType !== 'on_site');
        });
    });

    const populateDropdownOptions = async () => {
        const db = firebase.firestore();
        const configs = [
            { docId: 'workTypes', optionsId: 'work-type-options' },
            { docId: 'projects', optionsId: 'project-options' },
            { docId: 'workTypes', optionsId: 'delete-work-type-options' },
            { docId: 'projects', optionsId: 'delete-project-options' },
            { docId: 'workTypes', optionsId: 'edit-modal-work-type-options' },
            { docId: 'projects', optionsId: 'edit-modal-project-options' }
        ];

        for (const config of configs) {
            try {
                const doc = await db.collection('system_settings').doc(config.docId).get();
                if (!doc.exists) continue;

                const items = doc.data().names || [];
                const optionsContainer = document.getElementById(config.optionsId);
                const panel = optionsContainer.closest('.absolute');
                const selectedText = panel.previousElementSibling.querySelector('span');
                
                optionsContainer.innerHTML = '';

                items.forEach(name => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'p-2 rounded-lg hover:bg-sky-50 cursor-pointer text-sm';
                    optionDiv.textContent = name;
                    
                    optionDiv.addEventListener('click', () => {
                        selectedText.textContent = name;
                        selectedText.classList.remove('text-gray-500');
                        panel.classList.add('hidden');
                    });
                    optionsContainer.appendChild(optionDiv);
                });
            } catch (error) {
                console.error(`Error populating ${config.docId}:`, error);
            }
        }
    };

    function initializeControls() {
        if (controlsInitialized) return;
        
        const db = firebase.firestore();
        
        const dropdownConfigs = [
            { panelId: 'work-type-panel', selectBtnId: 'work-type-btn', searchId: 'work-type-search' },
            { panelId: 'project-panel', selectBtnId: 'project-btn', searchId: 'project-search' },
            { panelId: 'delete-work-type-panel', selectBtnId: 'delete-work-type-select-btn' },
            { panelId: 'delete-project-panel', selectBtnId: 'delete-project-select-btn' },
            { panelId: 'duration-panel', selectBtnId: 'duration-btn' },
            { panelId: 'edit-modal-work-type-panel', selectBtnId: 'edit-modal-work-type-btn', searchId: 'edit-modal-work-type-search' },
            { panelId: 'edit-modal-project-panel', selectBtnId: 'edit-modal-project-btn', searchId: 'edit-modal-project-search' },
            { panelId: 'edit-modal-duration-panel', selectBtnId: 'edit-modal-duration-btn' }
        ];

        dropdownConfigs.forEach(config => {
            const selectBtn = document.getElementById(config.selectBtnId);
            const panel = document.getElementById(config.panelId);

            if (!selectBtn || !panel) return;

            selectBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                
                const isCurrentlyHidden = panel.classList.contains('hidden');
                dropdownConfigs.forEach(otherConf => {
                    if (otherConf.panelId !== config.panelId) {
                        document.getElementById(otherConf.panelId)?.classList.add('hidden');
                    }
                });

                if (isCurrentlyHidden) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });
            
            panel.addEventListener('click', (e) => e.stopPropagation());

            if (config.searchId) {
                const searchInput = document.getElementById(config.searchId);
                const optionsContainer = panel.querySelector('.overflow-y-auto');
                if (searchInput && optionsContainer) {
                    searchInput.addEventListener('input', () => {
                        const filter = searchInput.value.toLowerCase();
                        for (const option of optionsContainer.children) {
                            option.style.display = option.textContent.toLowerCase().includes(filter) ? '' : 'none';
                        }
                    });
                }
            }
        });

        document.addEventListener('click', () => {
            dropdownConfigs.forEach(config => {
                document.getElementById(config.panelId)?.classList.add('hidden');
            });
        });
        

        const setupAdminAction = (btnId, valueSourceId, docId, action) => {
            const actionButton = document.getElementById(btnId);
            if (!actionButton) {
                console.error(`Button with ID ${btnId} not found.`);
                return;
            }

            actionButton.addEventListener('click', async () => {
                const isDelete = action === 'delete';
                const valueElement = document.getElementById(valueSourceId);
                if (!valueElement) {
                    console.error(`Value source with ID ${valueSourceId} not found.`);
                    alert('เกิดข้อผิดพลาด: ไม่พบ Element สำหรับอ่านค่า');
                    return;
                }

                const value = isDelete ? valueElement.textContent.trim() : valueElement.value.trim();

                if ((isDelete && value.includes('...')) || (!isDelete && !value)) {
                    showNotification(isDelete ? 'กรุณาเลือกรายการที่จะลบ' : 'กรุณากรอกข้อมูล', 'warning');
                    return;
                }

                if (isDelete) {
                    showConfirmDialog(
                        `คุณแน่ใจหรือไม่ว่าจะลบ "${value}"?`,
                        async () => { 
                            try {
                                actionButton.disabled = true;
                                actionButton.classList.add('opacity-50');

                                const docRef = db.collection('system_settings').doc(docId);
                                const updateAction = firebase.firestore.FieldValue.arrayRemove(value);
                                await docRef.update({ names: updateAction });

                                showNotification(`ลบ "${value}" สำเร็จ!`, 'success');
                                await populateDropdownOptions(); 

                                valueElement.textContent = `เลือก${docId === 'workTypes' ? 'ประเภทงาน' : 'โครงการ'}ที่จะลบ...`;
                                valueElement.classList.add('text-gray-500');

                            } catch (error) {
                                console.error(`Error deleting ${docId}:`, error);
                                showNotification('เกิดข้อผิดพลาดในการลบ', 'error');
                            } finally {
                                actionButton.disabled = false;
                                actionButton.classList.remove('opacity-50');
                            }
                        }
                    );
                } else { 
                    try {
                        actionButton.disabled = true;
                        actionButton.classList.add('opacity-50');

                        const docRef = db.collection('system_settings').doc(docId);
                        const updateAction = firebase.firestore.FieldValue.arrayUnion(value);
                        await docRef.update({ names: updateAction });

                        showNotification(`เพิ่ม "${value}" สำเร็จ!`, 'success');
                        await populateDropdownOptions();
                        valueElement.value = ''; 

                    } catch (error) {
                        console.error(`Error adding ${docId}:`, error);
                        showNotification('เกิดข้อผิดพลาดในการเพิ่ม', 'error');
                    } finally {
                        actionButton.disabled = false;
                        actionButton.classList.remove('opacity-50');
                    }
                }
            });
        };
        setupAdminAction('add-work-type-btn', 'add-work-type-input', 'workTypes', 'add');
        setupAdminAction('delete-work-type-btn', 'delete-work-type-selected-text', 'workTypes', 'delete');
        setupAdminAction('add-project-btn', 'add-project-input', 'projects', 'add');
        setupAdminAction('delete-project-btn', 'delete-project-selected-text', 'projects', 'delete');

        document.getElementById('duration-options').addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('duration-option')) {
                const selectedValue = e.target.textContent;
                durationSelectedText.textContent = selectedValue;
                durationSelectedText.classList.remove('text-gray-500');
                document.getElementById('duration-panel').classList.add('hidden');
                customTimeInputs.classList.toggle('hidden', selectedValue !== 'กำหนดเวลา');
            }
        });

        document.getElementById('edit-modal-duration-options').addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('duration-option')) {
                const selectedValue = e.target.textContent;
                editModalDurationSelectedText.textContent = selectedValue;
                editModalDurationSelectedText.classList.remove('text-gray-500');
                document.getElementById('edit-modal-duration-panel').classList.add('hidden');
                editModalCustomTimeInputs.classList.toggle('hidden', selectedValue !== 'กำหนดเวลา');
            }
        });

        document.getElementById('calendar-admin-add-holiday')?.addEventListener('click', () => {
            handleAddCalendarRule('holidays');
        });
        document.getElementById('calendar-admin-add-worksat')?.addEventListener('click', () => {
            handleAddCalendarRule('workingSaturdays');
        });
        // Event Delegation สำหรับปุ่มลบ
        document.getElementById('admin-calendar-controls-card')?.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.calendar-delete-btn');
            if (deleteBtn) {
                const date = deleteBtn.dataset.date;
                const type = deleteBtn.dataset.type;
                handleDeleteCalendarRule(type, date, deleteBtn);
            }
        });

        const adminSearchResultsContainer = document.getElementById('search-results-container');
        if (adminSearchResultsContainer) {
            adminSearchResultsContainer.addEventListener('click', (e) => {
                // ตรวจสอบว่าปุ่มที่คลิก (หรือแม่ของมัน) คือปุ่ม "แก้ไข" หรือไม่
                const editBtn = e.target.closest('.edit-record-btn');
                // ตรวจสอบว่าปุ่มที่คลิก (หรือแม่ของมัน) คือปุ่ม "เพิ่ม" หรือไม่
                const addBtn = e.target.closest('.add-record-btn');

                if (editBtn) {
                    // ถ้าใช่ปุ่ม "แก้ไข"
                    e.preventDefault(); // ป้องกันพฤติกรรมเริ่มต้น
                    const docId = editBtn.dataset.docId;
                    openEditModal(docId, null, null); // เรียก Modal โดยใช้ docId
                } else if (addBtn) {
                    // ถ้าใช่ปุ่ม "เพิ่ม"
                    e.preventDefault(); // ป้องกันพฤติกรรมเริ่มต้น
                    const userId = addBtn.dataset.userId;
                    const dateStr = addBtn.dataset.dateStr;
                    openEditModal(null, userId, dateStr); // เรียก Modal โดยใช้ userId และ date
                }
            });
        }
        
        const leaveHistorySearchBtn = document.getElementById('leave-history-search-btn');
        if (leaveHistorySearchBtn) {
            leaveHistorySearchBtn.addEventListener('click', loadLeaveHistory);
        }

        // ผูก Event ปุ่มค้นหาประวัติ OT
        const otHistorySearchBtn = document.getElementById('ot-history-search-btn');
        if (otHistorySearchBtn) {
            otHistorySearchBtn.addEventListener('click', loadOtHistory);
        }

        const leaveTabNav = document.getElementById('leave-tab-nav');
        if (leaveTabNav) {
            // ดึงปุ่มแท็บทั้งหมด (ปุ่ม <a>)
            const tabs = leaveTabNav.querySelectorAll('a.leave-tab-btn');
            // ดึงเนื้อหาแท็บทั้งหมด (div .leave-tab-content)
            const contents = leaveTabNav.closest('.card').querySelectorAll('.leave-tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = tab.dataset.target; // เช่น "leave-pending-content"

                    // 1. (รีเซ็ต) ซ่อนเนื้อหาทั้งหมด และ ลบคลาส active ออกจากแท็บทั้งหมด
                    tabs.forEach(t => {
                        // เปลี่ยนปุ่มแท็บอื่นให้เป็นสีเทา (ไม่ active)
                        t.classList.remove('border-sky-500', 'text-sky-600', 'font-semibold');
                        t.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                    });
                    contents.forEach(c => {
                        // ซ่อนเนื้อหาทั้งหมด
                        c.classList.add('hidden');
                    });

                    // 2. (ตั้งค่า) แสดงแท็บและเนื้อหาที่ถูกเลือก
                    
                    // ทำให้ปุ่มที่คลิกเป็นสีฟ้า (active)
                    tab.classList.add('border-sky-500', 'text-sky-600', 'font-semibold');
                    tab.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                    
                    // แสดงเนื้อหาที่ตรงกับปุ่มที่คลิก
                    const targetContent = document.getElementById(targetId);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        }

        
        const initializeProjectSummary = () => {
            const db = firebase.firestore();
            const projectSelect = document.getElementById('project-summary-select');
            const monthInput = document.getElementById('project-summary-month');
            const resultsContainer = document.getElementById('project-summary-results');
            const exportBtn = document.getElementById('export-project-summary-btn');

            const exportProjectSummaryToExcel = async () => {
                const selectedProject = projectSelect.value;
                const selectedMonth = monthInput.value;

                if (!selectedProject || !selectedMonth) {
                    alert('กรุณาเลือกเดือนและโครงการก่อน Export');
                    return;
                }
                
                const [year, month] = selectedMonth.split('-').map(Number);
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0, 23, 59, 59, 999);

                try {
                    const querySnapshot = await db.collection('work_records')
                                                  .where('report.project', '==', selectedProject)
                                                  .where('date', '>=', startDate) 
                                                  .where('date', '<=', endDate)
                                                  .orderBy('date', 'asc')
                                                  .get();
                    
                    if (querySnapshot.empty) {
                        alert('ไม่พบข้อมูลสำหรับ Export');
                        return;
                    }

                    const dataForExcel = [
                        ["วันที่", "ชื่อพนักงาน", "ประเภทงาน", "ระยะเวลา"]
                    ];
                    
                    const usersCache = {}; 

                    for (const doc of querySnapshot.docs) {
                        const record = doc.data();
                        const report = record.report; 
                        
                        let userName = usersCache[record.userId];
                        if (!userName) {
                            const userDoc = await db.collection('users').doc(record.userId).get();
                            userName = userDoc.exists ? userDoc.data().fullName : record.userId;
                            usersCache[record.userId] = userName;
                        }

                        const reportDate = record.date.toDate().toLocaleDateString('th-TH', {
                            year: 'numeric', month: 'long', day: 'numeric'
                        });
                        
                        dataForExcel.push([
                            reportDate,
                            userName,
                            report.workType,
                            report.duration
                        ]);
                    };

                    const ws = XLSX.utils.aoa_to_sheet(dataForExcel);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'สรุปโครงการ');
                    XLSX.writeFile(wb, `สรุปโครงการ_${selectedProject}_${selectedMonth}.xlsx`);

                } catch (error) {
                    console.error("Error exporting to Excel:", error);
                    alert("เกิดข้อผิดพลาดระหว่างการ Export ข้อมูล: " + error.message);
                }
            };
            
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            monthInput.value = `${year}-${month}`;

            const todayISO = new Date().toISOString().split('T')[0];
            summaryStartDateInput.value = todayISO;
            summaryEndDateInput.value = todayISO;

            applySummaryFiltersBtn.addEventListener('click', () => {
                loadEmployeeSummary(); 
            });

            // --- [จุดที่แก้ไข] เปลี่ยนการเรียกใช้ตรงๆ เป็นการโหลด Library ก่อน ---
            exportEmployeeSummaryBtn.addEventListener('click', async () => {
                showNotification('กำลังโหลดโมดูล Excel...', 'warning');
                try {
                    await loadScript("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js");
                } catch (e) {
                    alert("โหลดไม่สำเร็จ กรุณาเช็คอินเทอร์เน็ต");
                    return;
                }
                exportEmployeeSummaryToExcel();
            });
            // -------------------------------------------------------------

            const populateProjectOptions = async () => {
                try {
                    const doc = await db.collection('system_settings').doc('projects').get();
                    projectSelect.innerHTML = '<option value="">เลือกโครงการ...</option>';

                    if (doc.exists) {
                        const projects = doc.data().names || [];
                        projects.forEach(name => {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name;
                            projectSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error("Error populating project summary dropdown:", error);
                }
            };

            const fetchProjectData = async () => {
                const selectedProject = projectSelect.value;
                const selectedMonth = monthInput.value;

                if (!selectedProject || !selectedMonth) {
                    resultsContainer.innerHTML = '<p class="text-sm text-center text-gray-400 py-2">กรุณาเลือกเดือนและโครงการ</p>';
                    return;
                }
                
                resultsContainer.innerHTML = '<p class="text-sm text-center text-gray-500 py-2">กำลังค้นหาข้อมูล...</p>';
                
                const [year, month] = selectedMonth.split('-').map(Number);
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0, 23, 59, 59, 999);
                
                const usersCache = {}; 

                try {
                    const querySnapshot = await db.collection('work_records')
                                                  .where('report.project', '==', selectedProject)
                                                  .where('date', '>=', startDate)
                                                  .where('date', '<=', endDate)
                                                  .orderBy('date', 'desc')
                                                  .get();

                    if (querySnapshot.empty) {
                        resultsContainer.innerHTML = '<p class="text-sm text-center text-gray-500 py-2">ไม่พบข้อมูลรายงานสำหรับเดือนและโครงการที่เลือก</p>';
                        return;
                    }

                    let resultsHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-gray-800">รายการทั้งหมด</h4>
                            <p class="text-sm font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                                พบ ${querySnapshot.size} รายการ
                            </p>
                        </div>
                        <div class="space-y-3">
                    `;
                    
                    for (const doc of querySnapshot.docs) {
                        const record = doc.data();
                        const report = record.report; 
                        const reportDate = record.date.toDate().toLocaleDateString('th-TH', {
                            day: '2-digit', month: 'long', year: 'numeric'
                        });
                        
                        let userName = usersCache[record.userId];
                        if (!userName) {
                            const userDoc = await db.collection('users').doc(record.userId).get();
                            userName = userDoc.exists ? userDoc.data().fullName : record.userId;
                            usersCache[record.userId] = userName;
                        }

                        resultsHTML += `
                            <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                                <div class="flex justify-between items-center">
                                    <p class="font-semibold text-gray-800">${userName}</p>
                                    <p class="text-xs text-gray-400">${reportDate}</p>
                                </div>
                                <div class="mt-3 flex flex-wrap gap-2 text-xs">
                                    <span class="inline-flex items-center font-medium bg-sky-100 text-sky-800 px-2.5 py-1 rounded-full">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                                        ${report.workType}
                                    </span>
                                    <span class="inline-flex items-center font-medium bg-gray-100 text-gray-800 px-2.5 py-1 rounded-full">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 10.586V6z" clip-rule="evenodd" /></svg>
                                        ${report.duration}
                                    </span>
                                </div>
                            </div>
                        `;
                    };
                    resultsHTML += '</div>';
                    resultsContainer.innerHTML = resultsHTML; 

                } catch (error) {
                    console.error("Error fetching project data:", error);
                    resultsContainer.innerHTML = '<p class="text-sm text-center text-red-500 py-2">เกิดข้อผิดพลาดในการดึงข้อมูล</p>';
                }
            };

            populateProjectOptions();
            projectSelect.addEventListener('change', fetchProjectData);
            monthInput.addEventListener('change', fetchProjectData);
            
            // --- [จุดที่แก้ไข] แก้ปุ่ม Export ของส่วนนี้ด้วย ---
            exportBtn.addEventListener('click', async () => {
                showNotification('กำลังโหลดโมดูล Excel...', 'warning');
                try {
                    await loadScript("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js");
                } catch (e) {
                    alert("โหลดไม่สำเร็จ กรุณาเช็คอินเทอร์เน็ต");
                    return;
                }
                exportProjectSummaryToExcel();
            });
            // -------------------------------------------------
        };

        initializeProjectSummary();
        setupAdminCalendarControls();
        controlsInitialized = true;
    };

    const adminGoToCalendarBtn = document.getElementById('admin-go-to-calendar-btn');
    if (adminGoToCalendarBtn) {
        adminGoToCalendarBtn.addEventListener('click', () => {
            // 1. สั่งให้เปิดหน้าปฏิทิน
            showPage('calendar-page');
            
            // 2. โหลดข้อมูลปฏิทิน
            loadCalendarData(currentDisplayDate);

            // 3. อัปเดตแถบเมนูด้านล่าง
            navItems.forEach(n => n.classList.remove('active'));
            // 3.1 หาปุ่มเมนูปฏิทิน (ปุ่มที่ 3)
            const dashboardNavButton = document.getElementById('calendar-or-admin-nav');
            if (dashboardNavButton) {
                dashboardNavButton.classList.add('active');
            }
        });
    }

    checkinBtn.addEventListener('click', async () => {
        // 1. [แก้ไข] ย้ายการตรวจสอบ !latestPosition ขึ้นมาเป็นอันดับแรก
        if (!latestPosition) {
            showNotification("กำลังรอสัญญาณ GPS กรุณารอสักครู่...", "warning");
            return; 
        }

        if (!currentUser) return showNotification("ไม่พบข้อมูลผู้ใช้", "error"); 

        // [ลบ] ลบ if (selectedWorkType === 'on_site') ... ออกทั้งหมด
        // เพราะเราจะไม่อนุญาต On-site อีกต่อไป

        const checkinSpan = checkinBtn.querySelector('span');
        checkinBtn.disabled = true;
        if (checkinSpan) checkinSpan.textContent = "ตรวจสอบตำแหน่ง...";

        // (ฟังก์ชัน proceedWithCheckin นี้ไม่ต้องแก้ไข)
        const proceedWithCheckin = async (finalWorkType) => {
            try {
                if (checkinSpan) checkinSpan.textContent = "กำลังบันทึก...";
                const now = new Date(); 
                const docId = `${currentUser.uid}_${toLocalDateKey(now)}`;

                let photoUrl = null;
                // [ลบ] ลบ if (finalWorkType === 'on_site' && photoFile) ... ออก

                const workRecord = {
                    userId: currentUser.uid,
                    date: firebase.firestore.Timestamp.fromDate(now),
                    checkIn: {
                        timestamp: firebase.firestore.Timestamp.fromDate(now),
                        location: new firebase.firestore.GeoPoint(latestPosition.coords.latitude, latestPosition.coords.longitude),
                        googleMapLink: `https://www.google.com/maps/search/?api=1&query=${latestPosition.coords.latitude},${latestPosition.coords.longitude}`,
                        accuracy: latestPosition.coords.accuracy,
                        workType: finalWorkType, // จะเป็น 'in_factory' เท่านั้น
                        onSiteDetails: null, // [แก้ไข] เป็น null เสมอ
                        photoUrl: photoUrl
                    },
                    status: "checked_in",
                    report: null,
                    checkOut: null,
                    overtime: null
                };

                await db.collection('work_records').doc(docId).set(workRecord);
                showNotification("บันทึกเวลาเข้างานสำเร็จ!"); 
                updateUIToCheckedIn();

                const savedRecord = await db.collection('work_records').doc(docId).get();
                if (savedRecord.exists) {
                    const serverCheckinTime = savedRecord.data().checkIn.timestamp.toDate();
                    summaryCheckinTime.textContent = serverCheckinTime.toLocaleTimeString('th-TH');
                    summaryCheckinTime.classList.remove('text-gray-400');
                    summaryCheckinTime.classList.add('text-green-600');
                    summaryCheckoutTime.textContent = '-';
                    summaryCheckoutTime.classList.add('text-gray-400');
                    summaryCheckoutTime.classList.remove('text-red-500');
                    summaryWorkHours.textContent = '-';
                    summaryWorkHours.classList.add('text-gray-400');
                }

            } catch (error) {
                console.error("Check-in error:", error);
                showNotification("เกิดข้อผิดพลาด: " + error.message, 'error');
            } finally {
                checkinBtn.disabled = false;
                if (checkinSpan) checkinSpan.textContent = "Check In";
            }
        };

        // [แก้ไข] แก้ไข logic การตรวจสอบ
        try {
            const distance = calculateDistance(latestPosition.coords.latitude, latestPosition.coords.longitude, FACTORY_LOCATION.latitude, FACTORY_LOCATION.longitude);
            
            // (★ นี่คือตรรกะที่รัดกุมที่สุด ★)
            if (distance <= ALLOWED_RADIUS_METERS) {
                // 1. ถ้าอยู่ในรัศมี -> อนุญาต
                proceedWithCheckin('in_factory');
            } else {
                // 2. ถ้าอยู่นอกรัศมี -> บล็อก
                showNotification(`อยู่นอกพื้นที่โรงงาน (${distance.toFixed(0)} ม.) ไม่สามารถเช็คอินได้`, 'error');
                checkinBtn.disabled = false; 
                if (checkinSpan) checkinSpan.textContent = "Check In"; 
                return; 
            }

        } catch (error) {
            console.error("Initial Check-in error:", error);
            showNotification("เกิดข้อผิดพลาดก่อนตรวจสอบพื้นที่: " + error.message, 'error');
            checkinBtn.disabled = false;
            if (checkinSpan) checkinSpan.textContent = "Check In";
        }
    });

    function updateProfilePage(userData) {
        const profilePic = document.getElementById('profile-page-pic');
        const profileName = document.getElementById('profile-page-name');
        const profileDepartment = document.getElementById('profile-page-department');

        if (profilePic) {
            const placeholderLg = 'https://placehold.co/150x150/E2E8F0/475569?text=User';
            profilePic.onerror = () => { profilePic.src = placeholderLg; };
            
            // [แก้ไข] เพิ่ม ?t=... เพื่อบังคับให้เบราว์เซอร์โหลดรูปใหม่ (Cache Busting)
            let imageUrl = userData.profileImageUrl || (currentUser && currentUser.photoURL);
            if (imageUrl) {
                // เพิ่ม timestamp ต่อท้าย URL
                profilePic.src = imageUrl + '?t=' + new Date().getTime();
            } else {
                profilePic.src = placeholderLg;
            }
        }
        if (profileName) {
            profileName.textContent = userData.fullName || 'ชื่อผู้ใช้';
        }
        if (profileDepartment) {
            profileDepartment.textContent = userData.department || 'ไม่มีข้อมูลแผนก';
        }
    }

    function startWatchingPosition() {
        if (navigator.geolocation && watchId === null) {
            const options = { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 };
            watchId = navigator.geolocation.watchPosition(updateRealtimeLocationStatus, handleLocationError, options);
        }
    }

    function stopWatchingPosition() {
        if (navigator.geolocation && watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
    }

    function updateRealtimeLocationStatus(position) {
        // 1. ตรวจสอบว่าเป็นมือถือหรือไม่
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // [Config] ถ้าอยากให้ PC กดเช็คอินได้แม้ไม่แม่นยำ ให้แก้ตรงนี้เป็น true
        const ALLOW_PC_ANYWAY = false; 

        // กรณีความแม่นยำไม่เพียงพอ (ค่าที่ได้มาเพี้ยนเกินค่าที่ตั้งไว้)
        if (position.coords.accuracy > MAX_ACCEPTABLE_ACCURACY) {
            
            if (!isMobile) {
                // --- กรณีเป็น PC/Desktop (UX ใหม่) ---
                if (ALLOW_PC_ANYWAY) {
                    // แบบ A: ยอมให้กดได้ แต่ขึ้นเตือนสีส้ม
                    locationStatusDiv.className = "flex items-center p-3 rounded-xl bg-orange-100 text-orange-800 border border-orange-200";
                    locationIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />`; // ไอคอนคอมพิวเตอร์
                    locationText.innerHTML = `<b>ใช้งานผ่าน PC</b> (ความแม่นยำต่ำ: ${position.coords.accuracy.toFixed(0)} ม.)`;
                    
                    latestPosition = position; // ยอมรับค่านี้
                    checkinBtn.disabled = false; // เปิดปุ่ม
                } else {
                    // แบบ B: ไม่ให้กด (UX แนะนำ) แต่เปลี่ยนข้อความให้ชัดเจน ไม่ค้าง
                    locationStatusDiv.className = "flex items-center p-3 rounded-xl bg-gray-100 text-gray-600 border border-gray-200";
                    locationIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>`;
                    locationText.innerHTML = `GPS บน PC ไม่แม่นยำ (${position.coords.accuracy.toFixed(0)} ม.)<br><span class="text-xs">กรุณาใช้มือถือเพื่อความถูกต้อง</span>`;
                    
                    checkinBtn.disabled = true; // ปิดปุ่ม
                }
            } else {
                // --- กรณีเป็นมือถือ (แสดงผลแบบเดิม: กำลังปรับ...) ---
                locationStatusDiv.className = "flex items-center p-3 rounded-xl bg-yellow-100 text-yellow-700";
                locationIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>`;
                locationText.textContent = `กำลังปรับความแม่นยำ... (${position.coords.accuracy.toFixed(0)} ม.)`;
                
                checkinBtn.disabled = true; 
            }
            return; 
        }

        // --- กรณีค่าแม่นยำ (GPS ปกติ) ---
        latestPosition = position; 
        checkinBtn.disabled = false; 
        
        const distance = calculateDistance(position.coords.latitude, position.coords.longitude, FACTORY_LOCATION.latitude, FACTORY_LOCATION.longitude);
        if (distance <= ALLOWED_RADIUS_METERS) {
            locationStatusDiv.className = "flex items-center p-3 rounded-xl bg-green-100 text-green-700";
            locationIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>`;
            locationText.textContent = `ในพื้นที่โรงงาน (รัศมี ${position.coords.accuracy.toFixed(0)} เมตร)`;
        } else {
            locationStatusDiv.className = "flex items-center p-3 rounded-xl bg-red-50 text-red-600 border border-red-100";
            locationIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>`;
            locationText.textContent = `อยู่นอกพื้นที่ (ห่าง ${distance.toFixed(0)} ม.)`;
        }
    }
    
    function handleLocationError(error) {
        let message = "ไม่สามารถเข้าถึงตำแหน่งได้";
        if (error.code === 1) message = "ผู้ใช้ปฏิเสธการเข้าถึงตำแหน่ง";
        if (error.code === 3) message = "หมดเวลาในการค้นหาตำแหน่ง";
        locationStatusDiv.className = "flex items-center p-3 rounded-xl bg-red-100 text-red-700";
        locationIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>`;
        locationText.textContent = message;
        console.error("Location Error:", error);
    }

    async function checkUserWorkStatus() {
        if (!currentUser) return;
        const today = toLocalDateKey(new Date());
        const docId = `${currentUser.uid}_${today}`;
        
        // ใช้ source: 'server' เพื่อให้ได้ข้อมูลล่าสุดเสมอ ไม่เอา cache
        let workRecordDoc;
        try {
             workRecordDoc = await db.collection('work_records').doc(docId).get();
        } catch(e) {
             // fallback ถ้าไม่มีเน็ต
             workRecordDoc = await db.collection('work_records').doc(docId).get({ source: 'cache' });
        }

        if (workRecordDoc.exists) {
            const data = workRecordDoc.data();
            const checkinTime = data.checkIn.timestamp.toDate();
            
            summaryCheckinTime.textContent = checkinTime.toLocaleTimeString('th-TH');
            summaryCheckinTime.classList.remove('text-gray-400');
            summaryCheckinTime.classList.add('text-green-600');

            if (data.status === 'checked_in') {
                updateUIToCheckedIn();
            } else if (data.status === 'completed') {
                updateUIToCompleted(); 
                
                const checkoutTime = data.checkOut.timestamp.toDate();
                
                // 1. คำนวณตามสูตรปกติก่อน
                let { regularWorkHours, overtimeHours } = calculateWorkHours(checkinTime, checkoutTime);

                // [แก้ไข] ตรวจสอบค่าจาก DB แต่ถ้า DB เป็น 0 และค่าคำนวณได้ > 0 ให้ใช้ค่าคำนวณ (เพื่อแก้ไขการแสดงผล)
                let dbOvertime = 0;
                if (data.overtime && typeof data.overtime.hours === 'number') {
                    dbOvertime = data.overtime.hours;
                }
                
                // ใช้ค่าจาก DB ถ้ามีค่ามากกว่า 0, ถ้าไม่ ให้ใช้ค่าที่คำนวณได้
                if (dbOvertime > 0) {
                    overtimeHours = dbOvertime;
                }
                // (ถ้า dbOvertime == 0 แต่ overtimeHours(คำนวณ) == 1.0 -> เราจะโชว์ 1.0 ตามสูตร)

                summaryCheckoutTime.textContent = checkoutTime.toLocaleTimeString('th-TH');
                summaryCheckoutTime.classList.remove('text-gray-400');
                summaryCheckoutTime.classList.add('text-red-500');

                summaryWorkHours.textContent = `${regularWorkHours.toFixed(2)} ชั่วโมง`;
                
                // แสดงผล OT
                if (overtimeHours > 0) {
                    summaryWorkHours.textContent += ` (OT ${overtimeHours} ชม.)`;
                }
            }
        } else {
            updateUIToCheckIn();
        }
    }

    async function loadEmployeeSummary(page = 1) { 
    const container = document.getElementById('employee-summary-container-admin');
    const paginationControls = document.getElementById('summary-pagination-controls'); 
    if (!container || !paginationControls) return;

    container.innerHTML = '<p class="text-sm text-center text-gray-500 py-2">กำลังโหลดข้อมูลพนักงาน...</p>';
    paginationControls.innerHTML = ''; 

    const startDateString = summaryStartDateInput.value;
    const endDateString = summaryEndDateInput.value;
    const userIdFilter = document.getElementById('summary-employee-select').value;
    const statusFilter = summaryStatusFilterSelect.value;

    if (!startDateString || !endDateString) {
            container.innerHTML = '<p class="text-sm text-center text-red-500 py-4">กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด</p>';
            return;
    }

    const startDate = new Date(startDateString);
    startDate.setHours(0, 0, 0, 0);
    const endDate = new Date(endDateString);
    endDate.setHours(23, 59, 59, 999);

    const ITEMS_PER_PAGE = 20; 
    let currentPage = page;
    let totalItems = 0;
    let totalPages = 1;

    try {
        const usersSnapshot = await db.collection('users').orderBy('fullName').get();
        if (usersSnapshot.empty) {
            container.innerHTML = '<p class="text-sm text-center text-gray-500 py-2">ไม่พบข้อมูลผู้ใช้ในระบบ</p>';
            return;
        }

        let allUsersData = {};
            usersSnapshot.forEach(doc => {
                const userData = doc.data();
                if (!userIdFilter || doc.id === userIdFilter) {
                    allUsersData[doc.id] = { ...userData, workRecords: [] };
                    }
            });

        let workRecordsQuery = db.collection('work_records')
                                    .where('date', '>=', startDate)
                                    .where('date', '<=', endDate);

        if (statusFilter && statusFilter !== 'not_checked_in') {
            workRecordsQuery = workRecordsQuery.where('status', '==', statusFilter);
        }

        workRecordsQuery = workRecordsQuery.orderBy('date', 'desc'); 

        const recordsSnapshot = await workRecordsQuery.get();

        recordsSnapshot.forEach(doc => {
            const record = doc.data();
            if (allUsersData[record.userId]) {
                allUsersData[record.userId].workRecords.push(record);
            }
        });

        let filteredUserIds = Object.keys(allUsersData);

        if (statusFilter === 'not_checked_in') {
                filteredUserIds = filteredUserIds.filter(userId => allUsersData[userId].workRecords.length === 0);
        } else if (statusFilter) {
                filteredUserIds = filteredUserIds.filter(userId => allUsersData[userId].workRecords.length > 0);
        }

        totalItems = filteredUserIds.length;
        totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const userIdsToShow = filteredUserIds.slice(startIndex, endIndex);

        let resultsHTML = '';
        if (userIdsToShow.length === 0) {
                resultsHTML = `<p class="text-sm text-center text-gray-500 py-4">ไม่พบข้อมูลพนักงานตามเงื่อนไขที่เลือก</p>`;
        } else {
                userIdsToShow.forEach(userId => {
                const user = allUsersData[userId];
                const latestRecord = user.workRecords.length > 0 ? user.workRecords[0] : null; 
                const report = latestRecord?.report;

                let statusText = 'ยังไม่เข้างาน';
                let statusColor = 'bg-gray-400';
                let checkInTime = '-';
                let checkOutTime = '-';
                let workHours = '-';
                let overtime = '-';
                let workTypeInfo = '-';
                let reportInfo = '<span class="text-gray-400">ยังไม่ส่งรายงาน</span>';
                let recordDate = '-'; 

                if (latestRecord) {
                        recordDate = latestRecord.date.toDate().toLocaleDateString('th-TH');
                    checkInTime = latestRecord.checkIn.timestamp.toDate().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                    workTypeInfo = latestRecord.checkIn.workType === 'in_factory' ? 'ในโรงงาน' : `On-site: ${latestRecord.checkIn.onSiteDetails || 'N/A'}`;

                    if(report) {
                        reportInfo = `${report.workType} (${report.project || 'N/A'})`;
                    }

                    if (latestRecord.status === 'checked_in') {
                        statusText = 'กำลังทำงาน';
                        statusColor = 'bg-green-500';
                    } else if (latestRecord.status === 'completed') {
                        statusText = 'สิ้นสุดการทำงาน';
                        statusColor = 'bg-red-500';
                        if (latestRecord.checkOut) {
                            checkOutTime = latestRecord.checkOut.timestamp.toDate().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                            
                            // --- [จุดสำคัญ] แก้ไขการแสดงผล OT ในหน้าเว็บ ---
                            // 1. คำนวณใหม่เสมอจากเวลาเข้า-ออกจริง
                            const { regularWorkHours, overtimeHours: calculatedOt } = calculateWorkHours(latestRecord.checkIn.timestamp.toDate(), latestRecord.checkOut.timestamp.toDate());
                            workHours = regularWorkHours.toFixed(2) + ' ชม.';
                            
                            // 2. ตรวจสอบค่าจาก Database
                            let finalOt = 0;
                            // ถ้า DB มีค่า > 0 ให้ใช้ค่าจาก DB (เชื่อ DB)
                            if (latestRecord.overtime && typeof latestRecord.overtime.hours === 'number' && latestRecord.overtime.hours > 0) {
                                finalOt = latestRecord.overtime.hours;
                            } else {
                                // ถ้า DB เป็น 0 หรือไม่มีค่า ให้ใช้ค่าที่คำนวณได้ (Fallback)
                                finalOt = calculatedOt;
                            }
                            overtime = finalOt.toFixed(1) + ' ชม.'; 
                            // -----------------------------------------
                        }
                    }
                } else {
                        recordDate = 'ไม่มีข้อมูลในช่วงนี้';
                }

                // ดึง Link แผนที่ (ถ้ามี)
                const mapLink = latestRecord?.checkIn?.googleMapLink || '#';
                const hasMap = !!latestRecord?.checkIn?.googleMapLink;

                    resultsHTML += `
                    <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                <img src="${user.profileImageUrl || 'https://placehold.co/100x100/E2E8F0/475569?text=User'}" class="w-12 h-12 rounded-full object-cover flex-shrink-0">
                                <div>
                                    <p class="font-semibold text-gray-800">${user.fullName || 'ไม่มีชื่อ'}</p>
                                    <div class="flex items-center gap-1.5 mt-1">
                                        <div class="w-2.5 h-2.5 rounded-full ${statusColor}"></div>
                                        <p class="text-xs font-medium text-gray-600">${statusText} (${recordDate})</p>
                                    </div>
                                    
                                    ${hasMap ? `
                                        <a href="${mapLink}" target="_blank" class="inline-flex items-center gap-1 mt-1 text-xs text-blue-600 hover:underline">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                            ดูแผนที่ (Google Maps)
                                        </a>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-100 grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                            <div><span class="text-gray-500">เข้า:</span> <span class="font-semibold text-green-600">${checkInTime}</span></div>
                            <div><span class="text-gray-500">ออก:</span> <span class="font-semibold text-red-500">${checkOutTime}</span></div>
                            <div><span class="text-gray-500">รวม:</span> <span class="font-medium text-gray-700">${workHours}</span></div>
                            <div><span class="text-gray-500">OT:</span> <span class="font-medium text-gray-700">${overtime}</span></div>
                            <div class="col-span-2 mt-1"><span class="text-gray-500">ประเภท:</span> <span class="font-medium text-gray-700">${workTypeInfo}</span></div>
                            <div class="col-span-2 mt-1"><span class="text-gray-500">รายงาน:</span> <span class="font-medium text-gray-700">${reportInfo}</span></div>
                        </div>
                    </div>
                `;
                });
            } 

        container.innerHTML = resultsHTML;

        if (totalPages > 1) {
            const prevButton = document.createElement('button');
            prevButton.textContent = '◀';
            prevButton.className = `px-3 py-1 text-sm rounded ${currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-sky-500 text-white hover:bg-sky-600'}`;
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => loadEmployeeSummary(currentPage - 1);
            paginationControls.appendChild(prevButton);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `หน้า ${currentPage} / ${totalPages}`;
            pageInfo.className = 'text-sm text-gray-600 mx-2';
            paginationControls.appendChild(pageInfo);

            const nextButton = document.createElement('button');
            nextButton.textContent = '▶';
            nextButton.className = `px-3 py-1 text-sm rounded ${currentPage === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-sky-500 text-white hover:bg-sky-600'}`;
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => loadEmployeeSummary(currentPage + 1);
            paginationControls.appendChild(nextButton);
        }

    } catch (error) {
        console.error("Error loading employee summary:", error);
        container.innerHTML = '<p class="text-sm text-center text-red-500 py-2">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>';
    }
}

    // --- [ฟังก์ชันใหม่] 1. ฟังก์ชันหลักสำหรับดึงและประมวลผลข้อมูล Payroll ---
    async function fetchPayrollData(startDate, endDate) {
        
        // 1. ดึงข้อมูลทั้งหมดที่จำเป็นพร้อมกัน
        const [usersSnapshot, recordsSnapshot, approvedLeaveSnapshot, calendarDoc] = await Promise.all([
            db.collection('users').orderBy('fullName').get(),
            db.collection('work_records').where('date', '>=', startDate).where('date', '<=', endDate).get(),
            db.collection('leave_requests').where('status', '==', 'approved').where('startDate', '<=', endDate).get(),
            db.collection('system_settings').doc('calendar_rules').get()
        ]);

        // 2. ประมวลผลกฎปฏิทิน (วันหยุด, วันทำงาน)
        const holidayMap = new Map();
        const workingSaturdayMap = new Map();
        if (calendarDoc.exists) {
            (calendarDoc.data().holidays || []).forEach(d => holidayMap.set(d, true));
            (calendarDoc.data().workingSaturdays || []).forEach(d => workingSaturdayMap.set(d, true));
        }

        // 3. ประมวลผลใบลาที่อนุมัติแล้ว
        const approvedLeaveMap = new Map();
        for (const doc of approvedLeaveSnapshot.docs) {
            const leave = doc.data();
            const start = leave.startDate.toDate();
            const end = leave.endDate.toDate();
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                if (d < startDate || d > endDate) continue;
                const dateKey = toLocalDateKey(new Date(d));
                const key = `${leave.userId}_${dateKey}`;
                approvedLeaveMap.set(key, leave);
            }
        }

        // 4. ประมวลผลเวลาทำงาน
        const recordsMap = new Map();
        recordsSnapshot.forEach(doc => {
            const record = doc.data();
            const dateKey = toLocalDateKey(record.date.toDate());
            if (!recordsMap.has(record.userId)) {
                recordsMap.set(record.userId, new Map());
            }
            recordsMap.get(record.userId).set(dateKey, record);
        });

        // 5. เริ่มการรวบรวมข้อมูลสรุป
        const payrollSummary = [];
        for (const userDoc of usersSnapshot.docs) {
            const userId = userDoc.id;
            const user = userDoc.data();
            
            let summary = {
                userId: userId,
                fullName: user.fullName || 'N/A',
                department: user.department || 'N/A',
                employeeType: user.employeeType || 'N/A',
                totalRegularHours: 0,
                total_OT_1_5x: 0,       
                total_Holiday_1x: 0,    
                total_Holiday_2x: 0,    
                total_OT_3x: 0,         
                totalLateDays: 0,
                totalLeaveDays: 0,
                totalAbsentDays: 0,
                totalWorkDays: 0 
            };

            const userRecords = recordsMap.get(userId) || new Map();

            for (let day = new Date(startDate); day <= endDate; day.setDate(day.getDate() + 1)) {
                const dateKey = toLocalDateKey(new Date(day));
                const dayOfWeek = day.getDay();
                
                const isHoliday = holidayMap.has(dateKey);
                const isWorkingSat = workingSaturdayMap.has(dateKey);
                const isWeekend = (dayOfWeek === 0 || (dayOfWeek === 6 && !isWorkingSat));
                const isWorkingDay = !isHoliday && !isWeekend; 

                const leave = approvedLeaveMap.get(`${userId}_${dateKey}`);
                const record = userRecords.get(dateKey);

                if (leave) {
                    if (leave.durationType !== 'hourly') {
                        summary.totalLeaveDays++;
                    }
                } else if (record) {
                    summary.totalWorkDays++;

                    if (record.status === 'completed' && record.checkOut) {
                        const checkinTime = record.checkIn.timestamp.toDate();
                        const checkoutTime = record.checkOut.timestamp.toDate();
                        
                        // --- [START FIX] คำนวณใหม่ถ้า DB เป็น 0 ---
                        const { regularWorkHours, overtimeHours: calculatedOt } = calculateWorkHours(checkinTime, checkoutTime);
                        
                        let otHoursToday = 0;
                        if (record.overtime && typeof record.overtime.hours === 'number' && record.overtime.hours > 0) {
                            otHoursToday = record.overtime.hours;
                        } else {
                            otHoursToday = calculatedOt; // ใช้ค่าคำนวณถ้า DB เป็น 0
                        }
                        // --- [END FIX] ---

                        if (isWorkingDay) {
                            summary.totalRegularHours += regularWorkHours;
                            summary.total_OT_1_5x += otHoursToday;
                        } else {
                            if (user.employeeType === 'monthly') {
                                summary.total_Holiday_1x += regularWorkHours; 
                            } else { 
                                summary.total_Holiday_2x += regularWorkHours; 
                            }
                            summary.total_OT_3x += otHoursToday;
                        }
                    }

                    const checkinTime = record.checkIn.timestamp.toDate();
                    const checkInMinutes = checkinTime.getHours() * 60 + checkinTime.getMinutes();
                    const LATE_THRESHOLD_MINUTES = 8 * 60 + 30; 
                    
                    if (isWorkingDay && checkInMinutes > LATE_THRESHOLD_MINUTES) {
                        summary.totalLateDays++;
                    }

                } else if (isWorkingDay) {
                    summary.totalAbsentDays++;
                }
            } 

            payrollSummary.push(summary);
        } 

        return payrollSummary;
    }

    // --- [ฟังก์ชันใหม่] 2. ฟังก์ชันสำหรับแสดงผลบนหน้าเว็บ ---
    async function loadPayrollSummary() {
        const container = document.getElementById('payroll-summary-results-container');
        const startInput = document.getElementById('payroll-start-date');
        const endInput = document.getElementById('payroll-end-date');
        
        if (!startInput.value || !endInput.value) {
            return showNotification('กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด', 'warning');
        }
        
        container.innerHTML = '<p class="text-sm text-center text-gray-500 py-2">กำลังประมวลผลข้อมูลสรุป...</p>';
        
        try {
            const startDate = new Date(startInput.value); startDate.setHours(0,0,0,0);
            const endDate = new Date(endInput.value); endDate.setHours(23,59,59,999);
            
            if (endDate < startDate) {
                return showNotification('วันที่สิ้นสุดต้องไม่น้อยกว่าวันที่เริ่มต้น', 'warning');
            }
            
            const summaryData = await fetchPayrollData(startDate, endDate);
            
            if (summaryData.length === 0) {
                container.innerHTML = '<p class="text-sm text-center text-gray-500 py-2">ไม่พบข้อมูลพนักงาน</p>';
                return;
            }

            // [แก้ไข] 1/2: อัปเดต "หัวตาราง" (Header)
            let tableHTML = `
                <table class="w-full text-left text-sm">
                    <thead class="text-xs text-gray-500 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3">พนักงาน</th>
                            <th scope="col" class="px-2 py-3 text-center">ทำงาน (วัน)</th>
                            <th scope="col" class="px-2 py-3 text-center">ชั่วโมงปกติ</th>
                            <th scope="col" class="px-2 py-3 text-center">OT (1.5x)</th>
                            <th scope="col" class="px-2 py-3 text-center">ชม.หยุด (1x)</th>
                            <th scope="col" class="px-2 py-3 text-center">ชม.หยุด (2x)</th>
                            <th scope="col" class="px-2 py-3 text-center">OT (3x)</th>
                            <th scope="col" class="px-2 py-3 text-center">มาสาย</th>
                            <th scope="col" class="px-2 py-3 text-center">ลา</th>
                            <th scope="col" class="px-2 py-3 text-center">ขาด</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            summaryData.forEach(user => {
                tableHTML += `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium text-gray-900">${user.fullName}</td>
                        <td class="px-2 py-3 text-center">${user.totalWorkDays}</td>
                        
                        <td class="px-2 py-3 text-center">${user.totalRegularHours.toFixed(2)}</td>
                        <td class="px-2 py-3 text-center">${user.total_OT_1_5x.toFixed(1)}</td>
                        <td class="px-2 py-3 text-center">${user.total_Holiday_1x.toFixed(2)}</td>
                        <td class="px-2 py-3 text-center">${user.total_Holiday_2x.toFixed(2)}</td>
                        <td class="px-2 py-3 text-center">${user.total_OT_3x.toFixed(1)}</td>
                        
                        <td class="px-2 py-3 text-center ${user.totalLateDays > 0 ? 'text-yellow-600 font-bold' : ''}">${user.totalLateDays}</td>
                        <td class="px-2 py-3 text-center ${user.totalLeaveDays > 0 ? 'text-blue-600 font-bold' : ''}">${user.totalLeaveDays}</td>
                        <td class="px-2 py-3 text-center ${user.totalAbsentDays > 0 ? 'text-red-600 font-bold' : ''}">${user.totalAbsentDays}</td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
            
        } catch (error) {
            console.error("Error loading payroll summary:", error);
            container.innerHTML = '<p class="text-sm text-center text-red-500 py-2">เกิดข้อผิดพลาด: ' + error.message + '</p>';
        }
    }

    // --- [ฟังก์ชันใหม่] 3. ฟังก์ชันสำหรับ Export Excel ---
    // --- [ฟังก์ชันใหม่] 3. ฟังก์ชันสำหรับ Export Excel ---
    async function exportPayrollSummaryToExcel() {
        const startInput = document.getElementById('payroll-start-date');
        const endInput = document.getElementById('payroll-end-date');
        
        if (!startInput.value || !endInput.value) {
            return showNotification('กรุณาเลือกช่วงวันที่ก่อน Export', 'warning');
        }
        
        showNotification('กำลังเตรียมข้อมูล Excel...', 'success');

        try {
            const startDate = new Date(startInput.value); startDate.setHours(0,0,0,0);
            const endDate = new Date(endInput.value); endDate.setHours(23,59,59,999);
            
            if (endDate < startDate) {
                return showNotification('วันที่สิ้นสุดต้องไม่น้อยกว่าวันที่เริ่มต้น', 'warning');
            }
            
            const summaryData = await fetchPayrollData(startDate, endDate);
            
            // [แก้ไข] 1/3: แก้ไข "หัวตาราง" (Headers)
            const dataForExcel = [
                ["ชื่อ-สกุล", "แผนก", "ประเภท", "จำนวนวันทำงาน", "ชั่วโมงทำงานปกติ", "OT (1.5x)", "ชม.หยุด (1x)", "ชม.หยุด (2x)", "OT (3x)", "จำนวนวันมาสาย", "จำนวนวันลา", "จำนวนวันขาด"]
            ];
            
            // [แก้ไข] 2/3: แก้ไข "ข้อมูล" (Data loop)
            summaryData.forEach(user => {
                // [เพิ่มบรรทัดนี้] แปลง 'monthly'/'daily' เป็นข้อความที่ HR เข้าใจง่าย
                const employeeTypeText = (user.employeeType === 'monthly') ? 'พนักงาน (รายเดือน)' : (user.employeeType === 'daily' ? 'เด็กฝึกงาน (รายวัน)' : 'N/A');

                dataForExcel.push([
                    // user.userId, // (ลบออกแล้ว)
                    user.fullName,
                    user.department,
                    employeeTypeText, // (เพิ่มเข้ามา)
                    user.totalWorkDays,
                    user.totalRegularHours.toFixed(2),
                    user.total_OT_1_5x.toFixed(1),
                    user.total_Holiday_1x.toFixed(2),
                    user.total_Holiday_2x.toFixed(2),
                    user.total_OT_3x.toFixed(1),
                    user.totalLateDays,
                    user.totalLeaveDays,
                    user.totalAbsentDays
                ]);
            });

            // [แก้ไข] 3/3: แก้ไข "ความกว้างคอลัมน์"
            const ws = XLSX.utils.aoa_to_sheet(dataForExcel);
            ws['!cols'] = [
                // { wch: 30 }, // (ลบออก - ID พนักงาน)
                { wch: 25 }, // ชื่อ-สกุล
                { wch: 15 }, // แผนก
                { wch: 20 }, // (เพิ่ม - ประเภท)
                { wch: 15 }, // วันทำงาน
                { wch: 15 }, // ชั่วโมงปกติ
                { wch: 10 }, // OT (1.5x)
                { wch: 12 }, // ชม.หยุด (1x)
                { wch: 12 }, // ชม.หยุด (2x)
                { wch: 10 }, // OT (3x)
                { wch: 10 }, // มาสาย
                { wch: 10 }, // ลา
                { wch: 10 }  // ขาด
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Payroll Summary');
            const fileName = `PayrollSummary_${startInput.value}_to_${endInput.value}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
        } catch (error) {
            console.error("Error exporting payroll summary:", error);
            showNotification('Export Excel ล้มเหลว: ' + error.message, 'error');
        }
    }  

    // (นำ 2 บรรทัดนี้ไปวางไว้ในฟังก์ชัน initializeControls() หรือ DOMContentLoaded)
    document.getElementById('generate-payroll-summary-btn')?.addEventListener('click', loadPayrollSummary);
    // [แก้ไข] ปุ่ม Export Payroll Summary
const exportPayrollBtn = document.getElementById('export-payroll-summary-btn');
if (exportPayrollBtn) {
    exportPayrollBtn.addEventListener('click', async () => {
        
        // 1. แจ้งเตือน
        showNotification('กำลังโหลดโมดูล Excel...', 'warning');

        // 2. โหลด Library (เช็คว่ามี XLSX หรือยัง)
        if (typeof XLSX === 'undefined') {
            try {
                await loadScript("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js");
            } catch (e) {
                alert("โหลดไม่สำเร็จ กรุณาเช็คอินเทอร์เน็ต");
                return;
            }
        }

        // 3. เรียกฟังก์ชันเดิม
        exportPayrollSummaryToExcel();
    });
}

    async function exportEmployeeSummaryToExcel() {
        const startDateString = summaryStartDateInput.value;
        const endDateString = summaryEndDateInput.value;
        const userIdFilter = document.getElementById('summary-employee-select').value;
        const statusFilter = summaryStatusFilterSelect.value;

        if (!startDateString || !endDateString) {
            return alert('กรุณาเลือกช่วงวันที่ก่อน Export');
        }

        showNotification('กำลังเตรียมข้อมูลสำหรับ Export...');

        try {
            const startDate = new Date(startDateString);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateString);
            endDate.setHours(23, 59, 59, 999);

            // --- Step 1: ดึงข้อมูลปฏิทินและใบลา ---
            const holidayMap = new Map();
            const workingSaturdayMap = new Map();
            const approvedLeaveMap = new Map(); 

            try {
                const calendarDoc = await db.collection('system_settings').doc('calendar_rules').get();
                if (calendarDoc.exists) {
                    const data = calendarDoc.data();
                    (data.holidays || []).forEach(dateStr => holidayMap.set(dateStr, true));
                    (data.workingSaturdays || []).forEach(dateStr => workingSaturdayMap.set(dateStr, true));
                }
                
                const approvedLeaveSnapshot = await db.collection('leave_requests')
                    .where('status', '==', 'approved')
                    .where('startDate', '<=', endDate) 
                    .where('endDate', '>=', startDate) 
                    .get();

                approvedLeaveSnapshot.forEach(doc => {
                    const leave = doc.data();
                    const leaveTypeDisplay = LEAVE_TYPE_MAP[leave.leaveType] || leave.leaveType;
                    
                    if (leave.durationType === 'hourly') {
                        const dateKey = leave.startDate.toDate().toISOString().split('T')[0];
                        const key = `${leave.userId}_${dateKey}`;
                        approvedLeaveMap.set(key, { 
                            type: leaveTypeDisplay, 
                            durationType: 'hourly',
                            startTime: leave.startTime,
                            endTime: leave.endTime
                        });
                    } else {
                        const start = leave.startDate.toDate();
                        const end = leave.endDate.toDate();
                        const current = new Date(Date.UTC(start.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate()));
                        const final = new Date(Date.UTC(end.getUTCFullYear(), end.getUTCMonth(), end.getUTCDate()));
                        
                        while (current.getTime() <= final.getTime()) {
                            const y = current.getUTCFullYear();
                            const m = (current.getUTCMonth() + 1).toString().padStart(2, '0');
                            const d = current.getUTCDate().toString().padStart(2, '0');
                            const dateKey = `${y}-${m}-${d}`;
                            const key = `${leave.userId}_${dateKey}`;
                            approvedLeaveMap.set(key, { type: leaveTypeDisplay, durationType: 'full_day' });
                            current.setUTCDate(current.getUTCDate() + 1);
                        }
                    }
                });
            } catch (e) {
                console.warn("Could not load calendar rules or approved leaves:", e);
            }

            // --- Step 2: ดึง User ---
            const usersSnapshot = await db.collection('users').orderBy('fullName').get();
            let filteredUsers = [];
            usersSnapshot.forEach(doc => {
                if (!userIdFilter || doc.id === userIdFilter) {
                    filteredUsers.push({ 
                        id: doc.id, 
                        fullName: doc.data().fullName || doc.id,
                        department: doc.data().department || '-' 
                    });
                }
            });

            if (filteredUsers.length === 0) {
                 alert('ไม่พบข้อมูลพนักงานที่เลือก');
                 return;
            }

            // --- Step 3 & 4: ดึง work_records ---
            const recordsSnapshot = await db.collection('work_records')
                                         .where('date', '>=', startDate)
                                         .where('date', '<=', endDate)
                                         .get();

            const recordsMap = new Map();
            recordsSnapshot.forEach(doc => {
                const record = doc.data();
                const docId = doc.id;
                const dateString = docId.substring(docId.indexOf('_') + 1);
                const userId = record.userId;

                if (!recordsMap.has(userId)) {
                    recordsMap.set(userId, new Map());
                }
                recordsMap.get(userId).set(dateString, record);
            });

            // --- Step 5: สร้าง Headers (เพิ่ม Google Map Link) ---
            const dataForExcel = [
                [
                    "ชื่อพนักงาน", 
                    "แผนก", 
                    "วันที่", 
                    "ประเภทวัน", 
                    "สถานะ", 
                    "เวลาเข้า", 
                    "เวลาออก", 
                    "ชั่วโมงปกติ", 
                    "ชั่วโมง OT", 
                    "ประเภทงาน", 
                    "รายละเอียด On-site", 
                    "Google Map Link",  // <--- เพิ่มคอลัมน์นี้ครับ
                    "รายงาน: ประเภท", 
                    "รายงาน: โครงการ", 
                    "รายงาน: ระยะเวลา"
                ]
            ];
            
            const localDateFormatter = new Intl.DateTimeFormat('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const localTimeFormatter = new Intl.DateTimeFormat('th-TH', { hour: '2-digit', minute: '2-digit' });

            // --- Step 6: Loop ---
            for (let day = new Date(startDate); day <= endDate; day.setDate(day.getDate() + 1)) {
                const y = day.getFullYear();
                const m = (day.getMonth() + 1).toString().padStart(2, '0');
                const d = day.getDate().toString().padStart(2, '0');
                const dateKey = `${y}-${m}-${d}`;
                const dayOfWeek = day.getDay();
                
                let dayType = "วันทำงาน";
                if (holidayMap.has(dateKey)) dayType = "วันหยุดนักขัตฤกษ์";
                else if (dayOfWeek === 0) dayType = "วันอาทิตย์";
                else if (dayOfWeek === 6 && !workingSaturdayMap.has(dateKey)) dayType = "วันเสาร์ (หยุด)";
                else if (dayOfWeek === 6 && workingSaturdayMap.has(dateKey)) dayType = "วันเสาร์ (ทำงาน)";

                for (const user of filteredUsers) {
                    const record = recordsMap.get(user.id)?.get(dateKey) || null;
                    const approvedLeave = approvedLeaveMap.get(`${user.id}_${dateKey}`);

                    let statusText = "", checkInTime = "-", checkOutTime = "-";
                    let regularWorkHours = 0, overtimeHours = 0;
                    let workTypeInfo = "-", onSiteDetails = "-", googleMapLink = "-";
                    let reportType = "-", reportProject = "-", reportDuration = "-";

                    if (record) {
                        const report = record.report || {};
                        const checkinDate = record.checkIn.timestamp.toDate();
                        checkInTime = localTimeFormatter.format(checkinDate);
                        workTypeInfo = record.checkIn.workType === 'in_factory' ? 'ในโรงงาน' : 'On-site';
                        onSiteDetails = record.checkIn.onSiteDetails || '-';
                        
                        // ดึงลิงก์ Google Map (ถ้ามี)
                        googleMapLink = record.checkIn.googleMapLink || "-";

                        reportType = report.workType || '-';
                        reportProject = report.project || '-';
                        reportDuration = report.duration || '-';

                        if (record.status === 'checked_in') {
                            statusText = 'กำลังทำงาน';
                        } else if (record.status === 'completed') {
                            statusText = 'สิ้นสุดการทำงาน';
                            if (record.checkOut) {
                                const checkoutDate = record.checkOut.timestamp.toDate();
                                checkOutTime = localTimeFormatter.format(checkoutDate);
                                
                                // คำนวณ OT (Fallback logic)
                                const hours = calculateWorkHours(checkinDate, checkoutDate);
                                regularWorkHours = hours.regularWorkHours;
                                
                                if (record.overtime && typeof record.overtime.hours === 'number' && record.overtime.hours > 0) {
                                    overtimeHours = record.overtime.hours;
                                } else {
                                    overtimeHours = hours.overtimeHours;
                                }
                            }
                        }
                        
                        const checkInMinutes = checkinDate.getHours() * 60 + checkinDate.getMinutes();
                        const LATE_THRESHOLD_MINUTES = 8 * 60 + 30;
                        
                        if (dayType === "วันทำงาน" && checkInMinutes > LATE_THRESHOLD_MINUTES) {
                            statusText = 'มาสาย';
                            if (approvedLeave && approvedLeave.durationType === 'hourly') {
                                const [eh, em] = approvedLeave.endTime.split(':').map(Number);
                                if (checkInMinutes >= eh * 60 + em) statusText = `ลา: ${approvedLeave.type} (ชม.)`;
                            }
                        }
                    } else {
                        if (approvedLeave) {
                             let leaveText = approvedLeave.type.replace(/\s*\(.*\)\s*/g, '');
                            if (approvedLeave.durationType === 'hourly') leaveText += ` (${approvedLeave.startTime} - ${approvedLeave.endTime})`;
                            statusText = `ลา: ${leaveText}`;
                        } else if (dayType === "วันทำงาน" || dayType === "วันเสาร์ (ทำงาน)") {
                            statusText = "ไม่ได้ลงเวลา"; 
                        } else {
                            statusText = "วันหยุด"; 
                        }
                    }

                    // Push ข้อมูลให้ตรงกับลำดับ Header
                    dataForExcel.push([
                        user.fullName, 
                        user.department, 
                        localDateFormatter.format(day), 
                        dayType, 
                        statusText,
                        checkInTime, 
                        checkOutTime, 
                        regularWorkHours.toFixed(2), 
                        overtimeHours.toFixed(1),
                        workTypeInfo, 
                        onSiteDetails, 
                        googleMapLink, // <--- ใส่ค่า Link ตรงนี้ (ลำดับต้องตรงกับ Header)
                        reportType, 
                        reportProject, 
                        reportDuration
                    ]);
                }
            }

            if (dataForExcel.length <= 1) {
                 alert('ไม่พบข้อมูลที่จะ Export ตามเงื่อนไขที่เลือก');
                 return;
            }

            const ws = XLSX.utils.aoa_to_sheet(dataForExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'สรุปเวลาทำงาน');
            const fileName = `สรุปเวลาทำงาน_${startDateString}_ถึง_${endDateString}.xlsx`;
            XLSX.writeFile(wb, fileName);

        } catch (error) {
            console.error("Error exporting excel:", error);
            alert("เกิดข้อผิดพลาด: " + error.message);
        }
    }

    async function loadWorkHistory() {
    if (!currentUser) return;

    const container = document.getElementById('work-history-container');
    const rangeSelect = document.getElementById('history-range-select');
    const selectedRange = rangeSelect.value;

    const summaryHoursEl = document.getElementById('profile-summary-hours');
    const summaryOtEl = document.getElementById('profile-summary-ot');
    const summaryDaysEl = document.getElementById('profile-summary-days');

    // รีเซ็ตค่าหน้าจอ
    summaryHoursEl.textContent = '-';
    summaryOtEl.textContent = '-';
    summaryDaysEl.textContent = '-';
    container.innerHTML = `<p class="text-center text-gray-500 text-sm py-4">กำลังโหลดประวัติการทำงาน...</p>`;

    try {
        let startDate, endDate;
        const now = new Date();
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);

        // กำหนดช่วงเวลาตามที่เลือก
        if (selectedRange === "7") {
            startDate = new Date(todayStart);
            startDate.setDate(todayStart.getDate() - 6);
            endDate = new Date(now);
        } else if (selectedRange === "this_month") {
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now);
        } else if (selectedRange === "last_month") {
            startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
        }

        // ดึงข้อมูล Work Records
        const recordsSnapshot = await db.collection('work_records')
            .where('userId', '==', currentUser.uid)
            .where('date', '>=', startDate)
            .where('date', '<=', endDate)
            .orderBy('date', 'desc')
            .get();

        if (recordsSnapshot.empty) {
            let emptyMessage = "ไม่พบประวัติการทำงาน";
            if (selectedRange === "7") emptyMessage = "ไม่พบประวัติในช่วง 7 วันที่ผ่านมา";
            else if (selectedRange === "this_month") emptyMessage = "ไม่พบประวัติในเดือนนี้";
            else if (selectedRange === "last_month") emptyMessage = "ไม่พบประวัติในเดือนที่แล้ว";

            container.innerHTML = `<p class="text-center text-gray-500 text-sm py-4">${emptyMessage}</p>`;
            summaryDaysEl.textContent = '0 วัน';
            return;
        }

        let historyHtml = '';
        let totalRegularHours = 0;
        let totalOtHours = 0;
        let totalDays = recordsSnapshot.size;
        let accumulatorRegularWorkHours = 0;

        recordsSnapshot.forEach(doc => {
            const record = doc.data();
            const checkinTime = record.checkIn.timestamp.toDate();
            const report = record.report;

            // const dateKey = toLocalDateKey(checkinTime); // (ไม่ได้ใช้ บรรทัดนี้ comment ไว้ได้)
            let checkoutTime;
            let regularWorkHours = 0;
            let overtimeHours = 0;
            let checkoutTimeStr = '-';

            // ---------------------------------------------------------
            // [ส่วนที่แก้ไข Logic] : คำนวณใหม่ถ้า DB เป็น 0
            // ---------------------------------------------------------
            if (record.status === 'completed' && record.checkOut) {
                checkoutTime = record.checkOut.timestamp.toDate();
                checkoutTimeStr = checkoutTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) + ' น.';

                // 1. คำนวณค่าจริงทางคณิตศาสตร์ก่อนเสมอ
                const timeCalc = calculateWorkHours(checkinTime, checkoutTime);
                regularWorkHours = timeCalc.regularWorkHours;

                // 2. ตรวจสอบค่าใน Database
                // ถ้ามีค่า > 0 ให้ใช้ค่าจาก DB
                if (record.overtime && typeof record.overtime.hours === 'number' && record.overtime.hours > 0) {
                    overtimeHours = record.overtime.hours;
                } else {
                    // ถ้า DB เป็น 0 หรือไม่มี ให้ใช้ค่าที่คำนวณได้ (Fallback)
                    overtimeHours = timeCalc.overtimeHours;
                }
            }
            // ---------------------------------------------------------

            // สะสมยอดรวม
            totalRegularHours += regularWorkHours;
            totalOtHours += overtimeHours;
            accumulatorRegularWorkHours += regularWorkHours;

            // ส่วนของการ์ดแสดงผล (โครงสร้างเดิมที่คุณต้องการ)
            historyHtml += `
            <div class="flex space-x-4">
                <div class="flex flex-col items-center">
                    <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-sky-50 flex flex-col items-center justify-center leading-none">
                        <span class="text-xs text-sky-600 font-medium">${checkinTime.toLocaleDateString('th-TH', { month: 'short' })}</span>
                        <span class="text-xl font-bold text-sky-700">${checkinTime.getDate()}</span>
                    </div>
                    <div class="flex-1 w-px bg-gray-200 my-2"></div> 
                </div>
                
                <div class="flex-1 card !p-4 !shadow-sm mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-gray-800">${checkinTime.toLocaleDateString('th-TH', { weekday: 'long' })}</p>
                            <p class="text-sm text-gray-500 font-medium">
                                <span class="text-green-600">${checkinTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })} น.</span>
                                <span> → </span>
                                <span class="text-red-500">${checkoutTimeStr}</span>
                            </p>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4 mt-3 pt-3 border-t border-gray-100 text-sm">
                        <div class="flex items-center gap-1.5" title="ชั่วโมงทำงานปกติ (ไม่รวม OT)">
                            <svg class="w-5 h-5 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span class="font-medium text-gray-700">${regularWorkHours.toFixed(2)} ชม.</span>
                        </div>

                        <div class="flex items-center gap-1.5" title="Overtime รวม">
                            <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            <span class="font-medium text-gray-700">OT: ${overtimeHours.toFixed(1)} ชม.</span>
                        </div>
                    </div>

                    <div class="mt-3 pt-3 border-t border-gray-100 text-sm space-y-2">
                        <div>
                            ${record.checkIn.workType === 'in_factory' ? `
                                <span class="inline-flex items-center rounded-full bg-sky-100 px-3 py-1 text-xs font-semibold text-sky-800">
                                    <svg class="w-4 h-4 mr-1.5 -ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5v-13A1.5 1.5 0 0015.5 2h-11zM10 4a.75.75 0 01.75.75v.5a.75.75 0 01-1.5 0v-.5A.75.75 0 0110 4zM8.5 7.5A.75.75 0 007.75 8v.5a.75.75 0 001.5 0V8A.75.75 0 008.5 7.5zM11.5 7.5a.75.75 0 01.75.75v.5a.75.75 0 01-1.5 0V8a.75.75 0 01.75-.75zM8.5 10.5a.75.75 0 00-.75.75v.5a.75.75 0 001.5 0v-.5a.75.75 0 00-.75-.75zm3 0a.75.75 0 00-.75.75v.5a.75.75 0 001.5 0v-.5a.75.75 0 00-.75-.75z" clip-rule="evenodd" /></svg>
                                    ในโรงงาน
                                </span>
                            ` : `
                                <span class="inline-flex items-center rounded-full bg-teal-100 px-3 py-1 text-xs font-semibold text-teal-800">
                                    <svg class="w-4 h-4 mr-1.5 -ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.096.446-.24.757-.433.62-.384 1.445-.966 2.274-1.765C15.302 14.988 17 12.493 17 10a7 7 0 10-14 0c0 2.493 1.698 4.988 3.355 6.59C7.22 17.384 8.046 17.966 8.666 18.35c.31.193.57.337.757.433.09.046.185.09.28.14l.018.008.006.003zM10 11.25a1.25 1.25 0 100-2.5 1.25 1.25 0 000 2.5z" clip-rule="evenodd" /></svg>
                                    On-site: ${record.checkIn.onSiteDetails || 'N/A'}
                                </span>
                            `}
                        </div>

                        <div class="flex flex-wrap items-center gap-2">
                            ${report ? `
                                <span class="inline-flex items-center rounded-full bg-gray-100 px-3 py-1 text-xs font-semibold text-gray-800">
                                    <svg class="w-4 h-4 mr-1.5 -ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.234 3.125a.75.75 0 011.06 0l2.625 2.625a.75.75 0 010 1.06l-2.625 2.625a.75.75 0 01-1.06-1.06L12.44 7.17 9.83 9.83l-1.25-1.25a.75.75 0 010-1.06l2.625-2.625a.75.75 0 011.03-.07zM9.83 12.83l-1.25 1.25a.75.75 0 01-1.06 0L4.895 11.455a.75.75 0 010-1.06l2.625-2.625a.75.75 0 011.06 1.06L7.33 10.08l2.5 2.5.001.001z" clip-rule="evenodd" /><path d="M10 2.25a.75.75 0 01.75.75v.251a3.001 3.001 0 012.38 1.34l.32.4a.75.75 0 01-.98.98l-.32-.4a1.5 1.5 0 00-1.19-.67V6a.75.75 0 01-1.5 0V4.86a1.5 1.5 0 00-1.19.67l-.32.4a.75.75 0 11-.98-.98l.32-.4A3.001 3.001 0 019.25 3.251V3a.75.75 0 01.75-.75z" /><path d="M11 12.75a.75.75 0 01.75.75v.251a3.001 3.001 0 012.38 1.34l.32.4a.75.75 0 01-.98.98l-.32-.4a1.5 1.5 0 00-1.19-.67V16a.75.75 0 01-1.5 0v-.76a1.5 1.5 0 00-1.19.67l-.32.4a.75.75 0 11-.98-.98l.32-.4A3.001 3.001 0 0110.25 13.751V13.5a.75.75 0 01.75-.75z" /></svg>
                                    ${report.workType}
                                </span>
                                
                                ${report.project === 'FAC' ? `
                                    <span class="inline-flex items-center rounded-full bg-purple-100 px-3 py-1 text-xs font-semibold text-purple-800">
                                        <svg class="w-4 h-4 mr-1.5 -ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.183 2.25c.348-.7 1.286-.7 1.634 0l.963 1.947a.75.75 0 00.563.41l2.15.312c.732.106 1.025.99.494 1.506l-1.556 1.516a.75.75 0 00-.216.66l.367 2.14c.124.729-.64.128-1.283.3l-1.928.898a.75.75 0 00-.58 0l-1.928-.898c-.643-.172-1.407.428-1.283-.3l.367-2.14a.75.75 0 00-.216-.66L2.3 6.43c-.53-.516-.238-1.4.494-1.506l2.15-.312a.75.75 0 00.563-.41l.963-1.947z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M10 12.25a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5a.75.75 0 01.75-.75z" clip-rule="evenodd" /></svg>
                                        ${report.project} (Factory)
                                    </span>
                                ` : `
                                    <span class="inline-flex items-center rounded-full bg-blue-100 px-3 py-1 text-xs font-semibold text-blue-800">
                                        <svg class="w-4 h-4 mr-1.5 -ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.5 3A2.5 2.5 0 003 5.5v2.879a2.5 2.5 0 00.732 1.767l6.5 6.5a2.5 2.5 0 003.536 0l2.878-2.878a2.5 2.5 0 000-3.536l-6.5-6.5A2.5 2.5 0 008.379 3H5.5zM6 7a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        ${report.project}
                                    </span>
                                `}
                            ` : `
                                <span class="inline-flex items-center rounded-full bg-yellow-100 px-3 py-1 text-xs font-semibold text-yellow-800">
                                    <svg class="w-4 h-4 mr-1.5 -ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.25 9.75h-.5a.75.75 0 000 1.5h.5v.25a.75.75 0 001.5 0v-.25h.5a.75.75 0 000-1.5h-.5v-.25a.75.75 0 00-1.5 0v.25zM10 6a.75.75 0 01.75.75v.5a.75.75 0 01-1.5 0v-.5A.75.75 0 0110 6z" clip-rule="evenodd" /></svg>
                                    ยังไม่ส่งรายงาน
                                </span>
                            `}
                        </div>
                    </div>

                </div>
            </div>`;
        });

        container.innerHTML = historyHtml;

        // อัปเดต Summary ด้านบน
        summaryHoursEl.textContent = `${accumulatorRegularWorkHours.toFixed(2)}`;
        summaryOtEl.textContent = `${totalOtHours.toFixed(1)}`;
        summaryDaysEl.textContent = `${totalDays} วัน`;

    } catch (error) {
        console.error("Error loading work history:", error);
        container.innerHTML = '<p class="text-center text-red-500 text-sm py-4">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>';
    }
}
        
    function updateUIToCheckIn() {
        checkinBtn.classList.remove('hidden');
        checkoutBtn.classList.add('hidden');
        document.getElementById('request-ot-btn').classList.add('hidden');
        // Reset checkout button if previously completed
        checkoutBtn.disabled = false;
        checkoutBtn.classList.add('checkout-btn-anim', 'bg-red-500', 'hover:bg-red-600');
        checkoutBtn.classList.remove('bg-green-500', 'completed-btn-anim');
        checkoutBtn.innerHTML = `
            <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            <span class="text-2xl font-semibold mt-2">Check Out</span>
        `;
    }

    function updateUIToCheckedIn() {
        checkinBtn.classList.add('hidden');
        checkoutBtn.classList.remove('hidden');
        // Ensure checkout button is in the default state
        checkoutBtn.disabled = false;
        checkoutBtn.classList.add('checkout-btn-anim', 'bg-red-500', 'hover:bg-red-600');
        checkoutBtn.classList.remove('bg-green-500', 'completed-btn-anim');
        checkoutBtn.innerHTML = `
            <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            <span class="text-2xl font-semibold mt-2">Check Out</span>
        `;
    }

    function updateUIToCompleted() {
        checkinBtn.classList.add('hidden');
        checkoutBtn.classList.remove('hidden');
        checkoutBtn.disabled = true;
        checkoutBtn.classList.remove('checkout-btn-anim', 'bg-red-500', 'hover:bg-red-600');
        checkoutBtn.classList.add('bg-green-500', 'completed-btn-anim');
        checkoutBtn.innerHTML = `
            <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            <span class="text-2xl font-semibold mt-2">Completed</span>
        `;
        document.getElementById('request-ot-btn').classList.remove('hidden'); // [เพิ่มบรรทัดนี้]
    }

    checkoutBtn.addEventListener('click', async () => {
        if (!currentUser) return showNotification("ไม่พบข้อมูลผู้ใช้", "error");
        if (!latestPosition) return showNotification("กำลังรอสัญญาณ GPS...", "warning");
        
        const checkoutSpan = checkoutBtn.querySelector('span'); 

        // ฟังก์ชัน A: บันทึกแบบ "มี OT"
        const proceedWithCheckout = async () => {
            checkoutBtn.disabled = true; 
            if (checkoutSpan) checkoutSpan.textContent = "บันทึก (มี OT)..."; 

            try {
                const now = new Date();
                // now.setHours(19, 30, 0, 0);
                // ปลดบรรทัดนี้ถ้าจะ Test เวลา 18:04

                const docId = `${currentUser.uid}_${toLocalDateKey(now)}`;
                const workRecordRef = db.collection('work_records').doc(docId);
                const workRecordDoc = await workRecordRef.get();
                
                if (!workRecordDoc.exists) throw new Error("ไม่พบข้อมูลเข้างาน");
                const checkinTime = workRecordDoc.data().checkIn.timestamp.toDate();

                // คำนวณเวลา
                const { regularWorkHours, overtimeHours } = calculateWorkHours(checkinTime, now);

                await workRecordRef.update({
                    checkOut: {
                        timestamp: firebase.firestore.Timestamp.fromDate(now),
                        location: new firebase.firestore.GeoPoint(latestPosition.coords.latitude, latestPosition.coords.longitude)
                    },
                    status: "completed", 
                    overtime: { hours: overtimeHours } // บันทึกค่า OT ที่คำนวณได้ (เช่น 0.5)
                });

                showNotification(`บันทึกสำเร็จ! (งาน ${regularWorkHours.toFixed(2)} ชม. + OT ${overtimeHours} ชม.)`);
                updateUIToCompleted(); 
                
                // อัปเดตหน้าจอ
                summaryCheckoutTime.textContent = now.toLocaleTimeString('th-TH');
                summaryCheckoutTime.classList.add('text-red-500');
                summaryWorkHours.textContent = `${regularWorkHours.toFixed(2)} ชั่วโมง`;
                if (overtimeHours > 0) summaryWorkHours.textContent += ` (OT ${overtimeHours} ชม.)`;

            } catch (error) {
                console.error(error);
                showNotification("Error: " + error.message, 'error');
                checkoutBtn.disabled = false;
                if (checkoutSpan) checkoutSpan.textContent = "Check Out";
            }
        };

        // ฟังก์ชัน B: บันทึกแบบ "ไม่เอา OT" (ตัดเวลาที่ 17:30)
        const proceedWithCheckoutWithoutOT = async () => {
            checkoutBtn.disabled = true; 
            if (checkoutSpan) checkoutSpan.textContent = "บันทึก (ไม่มี OT)..."; 

            try {
                const now = new Date();
                
                // [แก้ไขสำคัญ] สร้างเวลาสมมติว่าเป็น 17:30 เพื่อให้คำนวณชั่วโมงงานปกติได้ถูกต้อง
                // (ป้องกันปัญหา Regular = 8.12 แต่ OT = 0)
                const cappedTime = new Date(now);
                if (now.getHours() >= 18) {
                    cappedTime.setHours(17, 30, 0, 0);
                }

                const docId = `${currentUser.uid}_${toLocalDateKey(now)}`;
                const workRecordRef = db.collection('work_records').doc(docId);
                const workRecordDoc = await workRecordRef.get();
                
                if (!workRecordDoc.exists) throw new Error("ไม่พบข้อมูลเข้างาน");
                const checkinTime = workRecordDoc.data().checkIn.timestamp.toDate();

                // คำนวณโดยใช้เวลาที่ถูกตัด (Capped Time) หรือเวลาจริงถ้ายังไม่ถึง OT
                const { regularWorkHours } = calculateWorkHours(checkinTime, cappedTime); 
                
                await workRecordRef.update({
                    checkOut: {
                        timestamp: firebase.firestore.Timestamp.fromDate(now), // เวลาออกจริง
                        location: new firebase.firestore.GeoPoint(latestPosition.coords.latitude, latestPosition.coords.longitude)
                    },
                    status: "completed",
                    overtime: { hours: 0 } // บังคับ OT เป็น 0
                });

                showNotification("บันทึกสำเร็จ (ไม่นับ OT)"); 
                updateUIToCompleted();

                summaryCheckoutTime.textContent = now.toLocaleTimeString('th-TH');
                summaryCheckoutTime.classList.add('text-red-500');
                // แสดงเวลาทำงานปกติที่ถูกต้อง (เช่น 8.05 ชม.)
                summaryWorkHours.textContent = `${regularWorkHours.toFixed(2)} ชั่วโมง`;

            } catch (error) {
                console.error(error);
                showNotification("Error: " + error.message, 'error');
                checkoutBtn.disabled = false;
                if (checkoutSpan) checkoutSpan.textContent = "Check Out";
            }
        };

        const currentTime = new Date();
        // currentTime.setHours(18, 4, 0, 0); // ปลดบรรทัดนี้ถ้าจะ Test Popup

        if (currentTime.getHours() >= 18) { 
             showConfirmDialog(
                "ขณะนี้เลยเวลาเลิกงานแล้ว ต้องการบันทึกเวลานี้เป็น OT หรือไม่?", 
                proceedWithCheckout,          // ปุ่มขวา (สีฟ้า) -> ไปฟังก์ชัน A
                proceedWithCheckoutWithoutOT, // ปุ่มซ้าย (สีเทา) -> ไปฟังก์ชัน B
                "บันทึกเวลา OT",              
                "ไม่ลงเวลา OT"        
            );
        } else {
            proceedWithCheckout();
        }
    });

    const provider = new firebase.auth.GoogleAuthProvider();
    // บังคับให้ Google แสดงหน้าต่างเลือกบัญชีทุกครั้ง
    provider.setCustomParameters({
      prompt: 'select_account'
    });
    
    // (เราไม่ต้องการ .setCustomParameters สำหรับ Google)
    
    // [คงไว้] 2. ฟังก์ชันตรวจสอบมือถือ (ยังจำเป็น)
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // [แก้ไข] 3. ผูก Event กับปุ่ม Google ใหม่
    const googleLoginBtn = document.getElementById('google-login-btn');
    
    if (googleLoginBtn) { // (เพิ่ม if-check เพื่อความปลอดภัย)
      googleLoginBtn.addEventListener('click', () => {
        
        if (isMobileDevice()) {
          // --- สำหรับมือถือ (iOS/Android) ---
          // ใช้วิธี Redirect (Google รับมือกับ iOS ได้ดี)
          auth.signInWithRedirect(provider).catch(e => {
            console.error("Redirect Login Error (Mobile):", e);
            alert("เกิดข้อผิดพลาดในการเริ่ม Login (Mobile): " + e.message);
          });

        } else {
          // --- สำหรับ Desktop (PC) ---
          // ใช้วิธี Popup (ทำงานได้ดีบน PC)
          auth.signInWithPopup(provider).catch(e => {
            
            if (e.code === 'auth/popup-blocked') {
              alert('Pop-up ถูกบล็อก! กรุณาอนุญาต Pop-up สำหรับเว็บนี้');
            } else if (e.code === 'auth/cancelled-popup-request') {
              console.log('ผู้ใช้ปิดหน้าต่าง Login');
            } else {
              console.error("Popup Login Error (Desktop):", e);
            }

          });
        }
      });
    }
    
    // (เราได้ลบโค้ดส่วนนั้นออกไปแล้วในขั้นตอนการ "ลบโค้ดเดิม")

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const φ1 = lat1 * Math.PI / 180, φ2 = lat2 * Math.PI / 180;
        const Δφ = (lat2 - lat1) * Math.PI / 180;
        const Δλ = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function showPage(pageId) {
        pages.forEach(p => p.classList.remove('active'));
        const activePage = document.getElementById(pageId);
        if (activePage) activePage.classList.add('active');
    }

    // [แก้ไข] --- โค้ด Event Listener สำหรับ Navigation ---
    navItems.forEach(item => {
        item.addEventListener('click', e => {
            e.preventDefault();
            const pageId = item.dataset.page;

            // หยุด GPS ทันที ถ้าไปหน้าอื่นที่ไม่ใช่หน้าลงเวลา
            if (pageId !== 'check-in-out-page') {
                stopWatchingPosition();
            }

            // [แก้ไข] --- ป้องกันการเข้าหน้า (Admin/User) ---
            if (pageId === 'admin-dashboard-page' && (!currentUserData || currentUserData.role !== 'admin')) {
                alert("คุณไม่มีสิทธิ์เข้าถึงหน้านี้");
                return; // ไม่ต้องทำอะไรต่อ
            }

            navItems.forEach(n => n.classList.remove('active'));
            
            // (แก้ไข) หาปุ่มทั้งหมดที่ตรงกับ pageId นี้
            const newActiveItems = document.querySelectorAll(`.nav-item[data-page="${pageId}"]`);
            // (แก้ไข) เพิ่มคลาส active ให้กับทุกปุ่มที่เจอ (ทั้งใน sidebar และ bottom-nav)
            newActiveItems.forEach(nav => nav.classList.add('active'));
            
            showPage(pageId);
            
            // เริ่ม GPS อีกครั้ง เมื่อกลับมาหน้าลงเวลา
            if (pageId === 'check-in-out-page') {
                latestPosition = null; // [เพิ่ม] ล้างค่าเก่าทิ้ง
                checkinBtn.disabled = true; // [เพิ่ม] ปิดปุ่มไว้ก่อน
                
                // [เพิ่ม] รีเซ็ตข้อความสถานะ
                locationStatusDiv.className = "flex items-center p-3 rounded-xl bg-gray-100 text-gray-700";
                locationIcon.innerHTML = ``; // ล้างไอคอน
                locationText.textContent = 'กำลังตรวจสอบตำแหน่ง...';

                startWatchingPosition();
            }
            
            if (pageId === 'report-page') {
                loadAllUsersForDropdown();
                loadPendingLeaveRequests();
                if (!editDateSelect.value) {
                    reportDateInput.value = new Date().toISOString().split('T')[0];
                    loadReportForSelectedDate();
                }
                document.getElementById('employee-summary-container-admin').innerHTML = '<p class="text-sm text-center text-gray-400 py-4">กรุณาเลือกช่วงวันที่และกด "แสดงข้อมูล"</p>';
                document.getElementById('summary-pagination-controls').innerHTML = '';
            }

            // [ ★★★ นี่คือบล็อกที่เพิ่มเข้ามา ★★★ ]
            if (pageId === 'admin-dashboard-page') {
                // โหลดรายชื่อ User ลงใน dropdowns
                loadAllUsersForDropdown();
                
                // โหลดใบลาที่รออนุมัติ
                loadPendingLeaveRequests(); 
                
                // โหลด OT ที่รออนุมัติ (นี่คือฟังก์ชันที่ขาดไป)
                loadPendingOtRequests(); 

                // ตั้งค่าวันที่เริ่มต้นในช่อง "แก้ไขข้อมูล"
                if (!editDateSelect.value) {
                    editDateSelect.value = new Date().toISOString().split('T')[0];
                }
                
                // ล้างข้อมูลเก่าในตารางสรุป
                document.getElementById('employee-summary-container-admin').innerHTML = '<p class="text-sm text-center text-gray-400 py-4">กรุณาเลือกช่วงวันที่และกด "แสดงข้อมูล"</p>';
                document.getElementById('summary-pagination-controls').innerHTML = '';
            }
            
            // [แก้ไข] เรียกฟังก์ชันโหลดปฏิทิน และตรวจสอบสิทธิ์ Admin
            if (pageId === 'calendar-page') {
                loadCalendarData(currentDisplayDate);
                
                // [ใหม่] ตรวจสอบสิทธิ์เพื่อแสดงกล่อง Admin
                const adminControls = document.getElementById('admin-calendar-controls-card');
                if (adminControls) {
                    if (currentUserData && currentUserData.role === 'admin') {
                        adminControls.classList.remove('hidden');
                        loadCalendarRules(); // โหลดรายการวันหยุด
                    } else {
                        adminControls.classList.add('hidden');
                    }
                }
            }
            
            if (pageId === 'profile-page') {
                loadWorkHistory(); 
                db.collection('users').doc(currentUser.uid).get().then(doc => {
                    if (doc.exists) {
                        updateProfilePage(doc.data());
                    }
                });
            }
        });
    });

    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
            showConfirmDialog(
                'คุณต้องการออกจากระบบใช่หรือไม่?',
                () => { // onConfirm callback
                    auth.signOut().catch(error => {
                        console.error("Sign out error:", error);
                        showNotification("เกิดข้อผิดพลาดในการออกจากระบบ", "error"); 
                    });
                }
            );
        });
    }

    const historyRangeSelect = document.getElementById('history-range-select');
    if(historyRangeSelect) {
        historyRangeSelect.addEventListener('change', loadWorkHistory);
    }
    

    function resetReportForm() {
        workTypeSelectedText.textContent = 'เลือกประเภทงาน...';
        workTypeSelectedText.classList.add('text-gray-500');
        projectSelectedText.textContent = 'เลือกโครงการ...';
        projectSelectedText.classList.add('text-gray-500');
        durationSelectedText.textContent = 'เลือกระยะเวลา...';
        durationSelectedText.classList.add('text-gray-500');
        customTimeInputs.classList.add('hidden');
        customTimeStartInput.value = '';
        customTimeEndInput.value = '';
    }

    function updateProfilePage(userData) {
        const profilePic = document.getElementById('profile-page-pic');
        const profileName = document.getElementById('profile-page-name');
        const profileDepartment = document.getElementById('profile-page-department');

       if (profilePic) {
            const placeholderLg = 'https://placehold.co/150x150/E2E8F0/475569?text=User';
            profilePic.onerror = () => { profilePic.src = placeholderLg; };
            
            // [ ★★★ แก้ไข ★★★ ]
            // เพิ่ม ?t=... เพื่อบังคับให้เบราว์เซอร์โหลดรูปใหม่ (Cache Busting)
            // ดึง URL จาก userData หรือ currentUser
            let imageUrl = userData.profileImageUrl || (currentUser && currentUser.photoURL);
            
            if (imageUrl) {
                // เพิ่ม timestamp ต่อท้าย URL
                profilePic.src = imageUrl + '?t=' + new Date().getTime();
            } else {
                profilePic.src = placeholderLg;
            }
        }
        if (profileName) {
            profileName.textContent = userData.fullName || 'ชื่อผู้ใช้';
        }
        if (profileDepartment) {
            profileDepartment.textContent = userData.department || 'ไม่มีข้อมูลแผนก';
        }
    }

    function calculateWorkHours(checkinTime, checkoutTime) {
        let workDurationMillis = checkoutTime - checkinTime;
        if (workDurationMillis < 0) workDurationMillis = 0;

        // หักเวลาพักเที่ยง 1 ชั่วโมง
        const lunchStart = new Date(checkinTime);
        lunchStart.setHours(12, 0, 0, 0);
        const lunchEnd = new Date(checkinTime);
        lunchEnd.setHours(13, 0, 0, 0);
        
        if (checkinTime < lunchEnd && checkoutTime > lunchStart) {
            workDurationMillis -= 3600000; 
        }

        let overtimeHours = 0;
        // เกณฑ์เริ่มนับ OT คือ 18:00
        const otStartThreshold = new Date(checkoutTime);
        otStartThreshold.setHours(18, 0, 0, 0);

        // เกณฑ์จบเวลางานปกติคือ 17:30
        const normalEndThreshold = new Date(checkoutTime);
        normalEndThreshold.setHours(17, 30, 0, 0);

        if (checkoutTime >= otStartThreshold) {
            // คำนวณ OT จาก 17:30 (เช่นเลิก 18:04 -> คิดจาก 17:30 = 34 นาที)
            const otMillis = checkoutTime - normalEndThreshold;
            if (otMillis > 0) {
                // หาร 30 นาที แล้วปัดเศษทิ้ง (34/30 = 1.13 -> 1 block)
                const otBlocks = Math.floor(otMillis / (1000 * 60 * 30));
                overtimeHours = otBlocks * 0.5; // 1 * 0.5 = 0.5 ชม.
            }
        }

        const totalWorkHours = workDurationMillis / (1000 * 60 * 60);
        const regularWorkHours = totalWorkHours - overtimeHours;

        return {
            regularWorkHours: Math.max(0, regularWorkHours), 
            overtimeHours: overtimeHours
        };
    }

    
    // --- [ปรับปรุง] Logic โหลดรายงานที่ส่งแล้ว (อ่านจาก work_records.report) ---
    async function loadSentReports() {
        if (!currentUser) return;

        const container = document.getElementById('sent-reports-container');
        if (!container) {
            console.error("Report container not found.");
            return;
        }

        const today = toLocalDateKey(new Date());
        const reportDocId = `${currentUser.uid}_${today}`;
        
        try {
            // [เปลี่ยน] อ่านจาก work_records
            const reportDoc = await db.collection('work_records').doc(reportDocId).get();

            // [เปลี่ยน] ตรวจสอบว่ามี .report field หรือไม่
            if (reportDoc.exists && reportDoc.data().report) {
                const data = reportDoc.data().report; // ดึงข้อมูลจาก field 'report'
                const reportCardHTML = `
                    <div class="card !p-4">
                        <div>
                            <p class="text-sm text-gray-600">รายงานที่ส่งแล้ว:</p>
                            <p class="text-lg font-bold text-sky-600 my-1">${data.workType}</p>
                            <div class="pt-2 mt-2 border-t border-gray-100 text-sm space-y-1">
                                <p class="text-gray-500">โครงการ: <span class="font-medium text-gray-700">${data.project}</span></p>
                                <p class="text-gray-500">ระยะเวลา: <span class="font-medium text-gray-700">${data.duration}</span></p>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML = reportCardHTML;
            } else {
                container.innerHTML = `<p id="no-reports-message" class="text-center text-gray-500 text-sm py-4">ยังไม่ได้ส่งรายงานวันนี้</p>`;
            }
        } catch (error) {
            console.error("Error loading sent reports:", error);
            container.innerHTML = '<p class="text-center text-red-500 text-sm py-4">เกิดข้อผิดพลาดในการโหลดรายงาน</p>';
        }
    }

    function updateClock() {
        if (timeElement) {
            const now = new Date();
            timeElement.textContent = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
    }
    setInterval(updateClock, 1000);
    updateClock();

    function showNotification(message, type = 'success') {
    const notificationElement = document.getElementById('notification');
    // [แก้ไข] เลือก p และ span ด้วย ID ใหม่
    const msgElement = document.getElementById('notification-message');
    const iconElement = document.getElementById('notification-icon');

    if (!notificationElement || !msgElement || !iconElement) return;

    msgElement.textContent = message;

    // [ใหม่] สร้างชุดไอคอนสำหรับสถานะต่างๆ
    const icons = {
        success: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`,
        error: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`,
        warning: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.1 2.15-1.1 2.786 0l5.625 9.742c.636 1.1-.178 2.46-1.393 2.46H3.725c-1.215 0-2.029-1.36-1.393-2.46l5.625-9.742zM9 11a1 1 0 112 0v1a1 1 0 11-2 0v-1zm1-4a1 1 0 011 1v2a1 1 0 11-2 0V8a1 1 0 011-1z" clip-rule="evenodd" /></svg>`
    };

    // Reset classes
    notificationElement.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'bg-gray-500');
    // [แก้ไข] เปลี่ยนจาก -translate-y-10 เป็น translate-y-10 (เลื่อนจากล่าง)
    notificationElement.classList.remove('opacity-0', 'translate-y-10');
    
    // Add showing classes (เลื่อนขึ้นมาที่ 0)
    notificationElement.classList.add('opacity-100', 'translate-y-0');

    // Set color and icon based on type
    if (type === 'success') {
        notificationElement.classList.add('bg-green-500');
        iconElement.innerHTML = icons.success;
    } else if (type === 'error') {
        notificationElement.classList.add('bg-red-500');
        iconElement.innerHTML = icons.error;
    } else if (type === 'warning') {
        notificationElement.classList.add('bg-yellow-500'); // [แก้ไข] ใช้สีเหลืองสำหรับ warning
        iconElement.innerHTML = icons.warning;
    } else {
        notificationElement.classList.add('bg-gray-500');
        iconElement.innerHTML = ''; // ไม่มีไอคอน
    }


    // Hide after a delay
    setTimeout(() => {
        notificationElement.classList.remove('opacity-100', 'translate-y-0');
        // [แก้ไข] ให้เลื่อนกลับลงไปด้านล่าง
        notificationElement.classList.add('opacity-0', 'translate-y-10'); 
    }, 3000); // Hide after 3 seconds
}


// [แทนที่ฟังก์ชันเดิมทั้งหมด]
async function loadAndDisplayHolidays() {
    // 1. [NEW] ดึง ID ของ 2 คอลัมน์ใหม่
    const holidayContainer = document.getElementById('holiday-list-display');
    const worksatContainer = document.getElementById('worksat-list-display');
    
    if (!holidayContainer || !worksatContainer) {
        console.error("Holiday list containers not found!");
        return;
    }
    
    // 2. [NEW] ตั้งค่า "กำลังโหลด" ให้ทั้งสองฝั่ง
    holidayContainer.innerHTML = '<p class="text-xs text-center text-gray-400">กำลังโหลด...</p>';
    worksatContainer.innerHTML = '<p class="text-xs text-center text-gray-400">กำลังโหลด...</p>';
    
    try {
        const doc = await db.collection('system_settings').doc('calendar_rules').get();
        
        let holidays = [];
        let workingSaturdays = [];

        if (doc.exists) {
            const data = doc.data();
            holidays = data.holidays || [];
            workingSaturdays = data.workingSaturdays || [];
        }

        // 3. [NEW] สร้างฟังก์ชัน Helper เพื่อสร้าง HTML ของแต่ละรายการ
        const createItemHTML = (dateStr, type) => {
            const isHoliday = type === 'holidays';
            const bgColor = isHoliday ? 'bg-red-50' : 'bg-green-50';
            const textColor = isHoliday ? 'text-red-700' : 'text-green-700';
            const hoverColor = isHoliday ? 'hover:bg-red-100' : 'hover:bg-green-100';
            
            // เพิ่ม class 'calendar-delete-item-btn' สำหรับการคลิกลบ
            return `
                <div class="flex justify-between items-center p-2 rounded-lg ${bgColor} ${textColor} text-sm font-medium">
                    <span>${dateStr}</span>
                    <button class="calendar-delete-item-btn ${hoverColor} rounded p-0.5" data-date="${dateStr}" data-type="${type}">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            `;
        };

        // 4. [NEW] เติมข้อมูล "วันหยุด" (ฝั่งซ้าย)
        if (holidays.length === 0) {
            holidayContainer.innerHTML = '<p class="text-xs text-center text-gray-400">ยังไม่มีข้อมูล</p>';
        } else {
            holidays.sort();
            holidayContainer.innerHTML = holidays.map(date => createItemHTML(date, 'holidays')).join('');
        }

        // 5. [NEW] เติมข้อมูล "เสาร์ทำงาน" (ฝั่งขวา)
        if (workingSaturdays.length === 0) {
            worksatContainer.innerHTML = '<p class="text-xs text-center text-gray-400">ยังไม่มีข้อมูล</p>';
        } else {
            workingSaturdays.sort();
            worksatContainer.innerHTML = workingSaturdays.map(date => createItemHTML(date, 'workingSaturdays')).join('');
        }
        
        // 6. [REMOVED] ลบโค้ดจัดการการลบออกจากฟังก์ชันนี้ (เราจะย้ายไปไว้ข้างนอก)

    } catch (error) {
        console.error("Error loading holiday list:", error);
        holidayContainer.innerHTML = '<p class="text-xs text-center text-red-500">โหลดข้อมูลล้มเหลว</p>';
        worksatContainer.innerHTML = '<p class="text-xs text-center text-red-500">โหลดข้อมูลล้มเหลว</p>';
    }
}

// [โค้ดใหม่] ฟังก์ชันสำหรับผูกปุ่ม "เพิ่ม" วันหยุด/วันเสาร์ทำงาน
// [แทนที่ฟังก์ชันเดิมทั้งหมด]
function setupAdminCalendarControls() {
    // 1. ดึง Element สำหรับ "การเพิ่ม" ข้อมูล
    const dateInput = document.getElementById('admin-calendar-date-input');
    const addHolidayBtn = document.getElementById('add-holiday-btn');
    const addWorkingSatBtn = document.getElementById('add-working-saturday-btn');

    if (!dateInput || !addHolidayBtn || !addWorkingSatBtn) {
        console.error("Admin calendar 'add' controls not found.");
        return; // หยุด ถ้าไม่เจอ Element หลัก
    }

    // 2. ฟังก์ชันสำหรับ "เพิ่ม" ข้อมูล (ใช้ 'holidays' หรือ 'workingSaturdays')
    const handleAddDate = async (type) => { 
        const dateStr = dateInput.value; // "YYYY-MM-DD"
        if (!dateStr) {
            showNotification('กรุณาเลือกวันที่ก่อน', 'warning');
            return;
        }

        const button = (type === 'holidays') ? addHolidayBtn : addWorkingSatBtn;
        button.disabled = true;
        button.classList.add('opacity-50');

        try {
            const docRef = db.collection('system_settings').doc('calendar_rules');
            // ใช้ FieldValue.arrayUnion() เพื่อเพิ่มข้อมูลเข้า Array (ป้องกันการซ้ำ)
            const updateAction = firebase.firestore.FieldValue.arrayUnion(dateStr);
            
            // ใช้ { merge: true } เพื่อสร้างเอกสาร/field ถ้ายังไม่มี
            await docRef.set({ [type]: updateAction }, { merge: true });

            showNotification(`เพิ่ม "${dateStr}" สำเร็จ!`, 'success');
            dateInput.value = ''; // ล้างช่องวันที่

            // [ปรับปรุง] เช็คว่ารายการกำลังแสดงอยู่หรือไม่ ถ้าแสดงอยู่ ก็ให้โหลดใหม่
            const listWrapper = document.getElementById('holiday-list-wrapper');
            if (listWrapper && !listWrapper.classList.contains('hidden')) {
                await loadAndDisplayHolidays(); // โหลดรายการในกล่องนี้ใหม่
            }
            
            loadCalendarData(currentDisplayDate); // รีเฟรชปฏิทินหลัก (ทำเสมอ)

        } catch (error) {
            console.error(`Error adding ${type}:`, error);
            showNotification('เกิดข้อผิดพลาดในการเพิ่ม', 'error');
        } finally {
            button.disabled = false;
            button.classList.remove('opacity-50');
        }
    };

    // 3. ผูก Event ให้ปุ่ม "เพิ่ม"
    addHolidayBtn.addEventListener('click', () => handleAddDate('holidays'));
    addWorkingSatBtn.addEventListener('click', () => handleAddDate('workingSaturdays'));

    // 4. ดึง Element สำหรับ "การแสดง/ซ่อน" และ "การลบ"
    const toggleBtn = document.getElementById('toggle-holiday-list-btn');
    const listWrapper = document.getElementById('holiday-list-wrapper');

    if (toggleBtn && listWrapper) {
        
        // 5. ผูก Event ให้ปุ่ม "แสดง/ซ่อน"
        toggleBtn.addEventListener('click', () => {
            const isHidden = listWrapper.classList.contains('hidden');
            if (isHidden) {
                // ถ้าซ่อนอยู่: ให้โหลดข้อมูล, ลบคลาส hidden, และเปลี่ยนข้อความปุ่ม
                loadAndDisplayHolidays(); // เรียกโหลดข้อมูลเมื่อกด
                listWrapper.classList.remove('hidden');
                toggleBtn.textContent = 'ซ่อนรายการที่บันทึกไว้';
            } else {
                // ถ้าแสดงอยู่: ให้ซ่อน และเปลี่ยนข้อความปุ่ม
                listWrapper.classList.add('hidden');
                toggleBtn.textContent = 'แสดงรายการที่บันทึกไว้';
            }
        });

        // 6. [NEW] ผูก Event "การลบ" ที่ตัว Wrapper (Event Delegation)
        // เพื่อให้ปุ่มลบที่สร้างขึ้นมาทีหลังยังทำงานได้
        listWrapper.addEventListener('click', (e) => {
            // ค้นหาปุ่มลบที่ใกล้ที่สุดที่ถูกคลิก
            const deleteBtn = e.target.closest('.calendar-delete-item-btn');
            
            if (deleteBtn) {
                // ถ้าเจอปุ่มลบ
                const date = deleteBtn.dataset.date;
                const type = deleteBtn.dataset.type; // 'holidays' หรือ 'workingSaturdays'
                const typeText = type === 'holidays' ? 'วันหยุด' : 'เสาร์ทำงาน';
                
                showConfirmDialog(
                    `คุณแน่ใจหรือไม่ว่าต้องการลบ "${typeText}: ${date}"?`,
                    async () => { // ฟังก์ชัน onConfirm (เมื่อกดยืนยัน)
                        try {
                            const docRef = db.collection('system_settings').doc('calendar_rules');
                            const updateAction = firebase.firestore.FieldValue.arrayRemove(date);
                            
                            await docRef.update({ [type]: updateAction });

                            showNotification(`ลบ "${date}" สำเร็จ!`, 'success');
                            await loadAndDisplayHolidays(); // โหลดรายการในกล่องนี้ใหม่
                            loadCalendarData(currentDisplayDate); // รีเฟรชปฏิทินหลัก
                        } catch (error) {
                            console.error("Error deleting holiday/workday:", error);
                            showNotification('เกิดข้อผิดพลาดในการลบ', 'error');
                        }
                    }
                );
            }
        });
    }
}

    // [อัปเกรด] --- ฟังก์ชัน Render ปฏิทิน (เวอร์ชัน "ปฏิทินบริษัท") ---
    async function loadCalendarData(date) {
        if (!currentUser) return;
        const calGrid = document.getElementById('cal-grid');
        const calHeader = document.getElementById('cal-month-year');
        const calDetailsContainer = document.getElementById('cal-details-container');

        if (!calGrid || !calHeader || !calDetailsContainer) return;

        calHeader.textContent = date.toLocaleString('th-TH', { month: 'long', year: 'numeric' });
        calGrid.innerHTML = '<div class="col-span-7 text-center p-4 text-gray-400">กำลังโหลด...</div>';
        calDetailsContainer.innerHTML = '<p class="text-center text-gray-400 text-sm">คลิกวันที่เพื่อดูรายละเอียด</p>'; // รีเซ็ต

        const year = date.getFullYear();
        const month = date.getMonth();

        const today = new Date();
        const todayDate = today.getDate();
        const todayMonth = today.getMonth();
        const todayYear = today.getFullYear();

        // รีเซ็ต Cache (ต้องล้างทุกครั้งที่โหลดเดือนใหม่)
        calendarDataCache.plans.clear();
        calendarDataCache.records.clear();
        calendarDataCache.users.clear();

        const startDate = new Date(year, month, 1);
        const endDate = new Date(year, month + 1, 0);
        const firstDayOfWeek = startDate.getDay();
        const daysInMonth = endDate.getDate();

        // 1. ดึงข้อมูล 4 ส่วนพร้อมกัน
        try {
            // Query 1: ดึง work_records (เฉพาะของ User ปัจจุบัน)
            const recordsQuery = db.collection('work_records')
                .where('userId', '==', currentUser.uid)
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .get();

            // Query 2: ดึงปฏิทินบริษัท (วันหยุด)
            const calendarQuery = db.collection('system_settings').doc('calendar_rules').get();

            // Query 3: [เปลี่ยน] ดึง user_plans (ของ "ทุกคน" ในเดือนนี้)
            const plansQuery = db.collection('user_plans')
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .get();

            // Query 4: [เพิ่ม] ดึงข้อมูล Users ทั้งหมด (เพื่อเอาชื่อมาแสดง)
            const usersQuery = db.collection('users').get();

            // รอทั้ง 4 query พร้อมกัน
            const [recordsSnapshot, calendarDoc, plansSnapshot, usersSnapshot] = 
                await Promise.all([recordsQuery, calendarQuery, plansQuery, usersQuery]);

            // ประมวลผล Users (เก็บใน Cache)
            usersSnapshot.forEach(doc => {
                calendarDataCache.users.set(doc.id, doc.data());
            });

            // ประมวลผล work_records (เก็บใน Cache)
            recordsSnapshot.forEach(doc => {
                const data = doc.data();
                const day = data.date.toDate().getDate();
                calendarDataCache.records.set(day, data);
            });

            // ประมวลผลปฏิทินบริษัท (เก็บใน Map ชั่วคราว)
            const holidayMap = new Map();
            const workingSaturdayMap = new Map();
            if (calendarDoc.exists) {
                const data = calendarDoc.data();
                (data.holidays || []).forEach(dateStr => holidayMap.set(dateStr, true));
                (data.workingSaturdays || []).forEach(dateStr => workingSaturdayMap.set(dateStr, true));
            }

            // ประมวลผล user_plans (เก็บใน Cache)
            plansSnapshot.forEach(doc => {
                const data = doc.data();
                const day = data.date.toDate().getDate();

                if (!calendarDataCache.plans.has(day)) {
                    calendarDataCache.plans.set(day, []); // สร้าง Array ถ้ายังไม่มี
                }
                // เพิ่ม plan นี้เข้าไปใน Array ของวันนั้นๆ
                calendarDataCache.plans.get(day).push({
                    id: doc.id, // เก็บ ID ของเอกสาร plan ไว้ (เผื่อลบ)
                    ...data 
                });
            });

            // 2. สร้างตารางปฏิทิน
            calGrid.innerHTML = '';
            for (let i = 0; i < firstDayOfWeek; i++) {
                calGrid.innerHTML += `<div class="p-2"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = (day === todayDate && month === todayMonth && year === todayYear);
                const record = calendarDataCache.records.get(day);
                const plans = calendarDataCache.plans.get(day) || []; // [เปลี่ยน]

                const monthStr = (month + 1).toString().padStart(2, '0');
                const dayStr = day.toString().padStart(2, '0');
                const dateKey = `${year}-${monthStr}-${dayStr}`;

                const isHoliday = holidayMap.has(dateKey);
                const isWorkingSaturday = workingSaturdayMap.has(dateKey);
                const currentDayOfWeek = new Date(year, month, day).getDay();
                const isSunday = (currentDayOfWeek === 0);
                const isRegularSaturday = (currentDayOfWeek === 6);

                // [เปลี่ยน] สร้างจุด ถ้ามี Plan (plans.length > 0)
                let planDotHtml = '';
                if (plans.length > 0) {
                    planDotHtml = `<div class="w-2 h-2 bg-indigo-500 rounded-full mx-auto mt-0.5"></div>`;
                }

                // สร้าง HTML ของตัวเลข (เหมือนเดิม)
                let dayNumberHtml = '';
                if (isToday) {
                    dayNumberHtml = `<div class="w-7 h-7 flex items-center justify-center rounded-full bg-sky-100 text-sky-700 font-bold mx-auto">${day}</div>`;
                } else if (isHoliday) {
                    dayNumberHtml = `<div class="w-7 h-7 flex items-center justify-center rounded-full mx-auto text-red-500 font-bold">${day}</div>`;
                } else if (isWorkingSaturday) {
                    dayNumberHtml = `<div class="w-7 h-7 flex items-center justify-center rounded-full mx-auto text-green-700 font-bold">${day}</div>`;
                } else if (isSunday || isRegularSaturday) {
                    dayNumberHtml = `<div class="w-7 h-7 flex items-center justify-center rounded-full mx-auto text-red-400">${day}</div>`;
                } else {
                    dayNumberHtml = `<div class="w-7 h-7 flex items-center justify-center rounded-full mx-auto text-gray-400">${day}</div>`;
                }

                // [เปลี่ยน] เพิ่ม data-day-number และลบ data-plan-text
                let cellBaseClass = 'p-2 text-center rounded-lg cursor-pointer hover:bg-gray-100';
                const dataAttributes = `data-day-number="${day}" data-date-key="${dateKey}"`;

                let dayCellHtml = '';
                if (isHoliday) {
                    dayCellHtml = `<div class="${cellBaseClass}" ${dataAttributes}>${dayNumberHtml}${planDotHtml}<div class="text-xs mt-1 text-red-500 truncate" style="line-height: 1.25;">หยุด</div></div>`;
                } else if (isWorkingSaturday) {
                    // [แก้ไข] เพิ่ม div ข้อความ "ทำงาน" กลับเข้าไป
                    dayCellHtml = `<div class="${cellBaseClass}" ${dataAttributes}>${dayNumberHtml}${planDotHtml}<div class="text-xs mt-1 text-green-700 truncate" style="line-height: 1.25;">ทำงาน</div></div>`;
                } else {
                    dayCellHtml = `<div class="${cellBaseClass}" ${dataAttributes}>${dayNumberHtml}${planDotHtml}</div>`;
                }

                calGrid.innerHTML += dayCellHtml;
            }
        } catch (error) {
            console.error("Error fetching calendar data: ", error);
            calGrid.innerHTML = `<div class="col-span-7 text-center p-4 text-red-500">โหลดข้อมูลล้มเหลว</div>`;
        }
    }

// 3. เพิ่ม Event Listener ให้ปุ่ม
document.getElementById('cal-prev-month').addEventListener('click', () => {
    currentDisplayDate.setMonth(currentDisplayDate.getMonth() - 1);
    loadCalendarData(currentDisplayDate);
});

document.getElementById('cal-next-month').addEventListener('click', () => {
    currentDisplayDate.setMonth(currentDisplayDate.getMonth() + 1);
    loadCalendarData(currentDisplayDate);
});

const openLeaveModal = () => {
        if (leaveRequestModal) {
            leaveRequestModal.classList.remove('hidden');
        }
    };
    
    // ฟังก์ชันปิด Modal และล้างฟอร์ม (แก้ไข)
    // ฟังก์ชันปิด Modal และล้างฟอร์ม (แก้ไข)
    const closeLeaveModal = () => {
        if (leaveRequestModal) {
            leaveRequestModal.classList.add('hidden');
            // ล้างค่าในฟอร์ม
            leaveTypeSelect.value = "";
            leaveStartDate.value = "";
            leaveEndDate.value = "";
            leaveReason.value = "";
            
            // [ใหม่] รีเซ็ตค่าใหม่
            leaveDurationType.value = "full_day"; // กลับไปเป็นค่าเริ่มต้น
            leaveDurationType.disabled = false; // [เพิ่ม] ปลดล็อค dropdown เสมอเมื่อปิด
            leaveStartTime.value = "";
            leaveEndTime.value = "";
            
            // [ใหม่] รีเซ็ตการแสดงผล
            leaveEndDateWrapper.classList.remove('hidden');
            leaveHourlyInputsWrapper.classList.add('hidden');

            // [ลบส่วนที่เป็นบั๊กออกแล้ว]
        }
    };
                
    // --- [แก้ไข] ย้าย Event Listeners ของฟอร์มลาออกมาไว้ข้างนอก ---

    // [Fix 1] ฟังก์ชันสำหรับสลับการแสดงผล (Full Day/Hourly)
    const handleDurationToggle = () => {
        const durationType = leaveDurationType.value;
        if (durationType === 'hourly') {
            leaveEndDateWrapper.classList.add('hidden');
            leaveHourlyInputsWrapper.classList.remove('hidden');
            // ตั้งวันที่สิ้นสุดให้เป็นวันเดียวกับวันที่เริ่ม
            leaveEndDate.value = leaveStartDate.value;
        } else { // 'full_day'
            leaveEndDateWrapper.classList.remove('hidden');
            leaveHourlyInputsWrapper.classList.add('hidden');
            // ล้างค่าเวลา (เผื่อไว้)
            leaveStartTime.value = '';
            leaveEndTime.value = '';
        }
    };

    // [Fix 1] ผูก Event Listener ของ leaveDurationType (สลับวัน/ชั่วโมง) *เพียงครั้งเดียว*
    if (leaveDurationType) {
        leaveDurationType.addEventListener('change', handleDurationToggle);
    }

    // [Fix 1] ผูก Event Listener ของ leaveStartDate (สำหรับโหมด Hourly) *เพียงครั้งเดียว*
    if (leaveStartDate) {
        leaveStartDate.addEventListener('change', () => {
            if (leaveDurationType.value === 'hourly') {
                leaveEndDate.value = leaveStartDate.value;
            }
        });
    }
    
// [Fix 2] ฟังก์ชันสำหรับจำกัดการลา "รายชั่วโมง" (Feature Request)
    const handleLeaveTypeChange = () => {
        const selectedType = leaveTypeSelect.value;
        
        // [แก้ไข] เพิ่ม 'sick' (ลาป่วย) เข้าไปในเงื่อนไข
        if (selectedType === 'personal' || selectedType === 'sick') {
            // ถ้าเป็น "ลากิจ" หรือ "ลาป่วย" -> ปลดล็อค dropdown
            leaveDurationType.disabled = false;
        } else {
            // ถ้าเป็นประเภทอื่น (พักร้อน, คลอด)
            // 1. บังคับให้เป็น "เต็มวัน"
            leaveDurationType.value = 'full_day';
            // 2. ล็อค dropdown
            leaveDurationType.disabled = true;
            
            // 3. (สำคัญ) เรียกใช้ handleDurationToggle() เพื่อซ่อนช่องรายชั่วโมง
            //    (เผื่อว่าก่อนหน้านี้มันถูกเปิดค้างไว้)
            handleDurationToggle();
        }
    };

    // [Fix 2] ผูก Event Listener ของ leaveTypeSelect (เลือกประเภทการลา) *เพียงครั้งเดียว*
    if (leaveTypeSelect) {
        leaveTypeSelect.addEventListener('change', handleLeaveTypeChange);
    }

    // นี่คือวิธีที่ปลอดภัยกว่า หากปุ่มถูกสร้างทีหลัง หรืออยู่ในหน้าที่ยังไม่ active
    document.body.addEventListener('click', function(event) {
        if (event.target.id === 'show-leave-form-btn') {
            openLeaveModal();
        }
    });

    if (cancelLeaveBtn) {
        cancelLeaveBtn.addEventListener('click', closeLeaveModal);
    }
    if (leaveOverlay) {
        leaveOverlay.addEventListener('click', closeLeaveModal);
    }

    // --- 5. [ฟังก์ชันหลัก] Event Listener สำหรับปุ่ม "ส่งใบลา" ---
    // --- 5. [ฟังก์ชันหลัก] Event Listener สำหรับปุ่ม "ส่งใบลา" (แก้ไข) ---
    if (submitLeaveBtn) {
        submitLeaveBtn.addEventListener('click', async () => {
            
            // (ส่วนตรวจสอบ currentUser ... เหมือนเดิม)
            if (!currentUser || !currentUserData) {
                showNotification('กรุณาเข้าสู่ระบบก่อนยื่นใบลา', 'error');
                return;
            }

            // --- 5.1 ดึงข้อมูลและ Validate ---
            const leaveType = leaveTypeSelect.value;
            const startDateStr = leaveStartDate.value;
            const reason = leaveReason.value.trim();
            
            // [ใหม่] ดึงข้อมูลใหม่
            const durationType = leaveDurationType.value;
            const endDateStr = leaveEndDate.value;
            const startTimeStr = leaveStartTime.value;
            const endTimeStr = leaveEndTime.value;

            if (!leaveType || !startDateStr || !reason) {
                showNotification('กรุณากรอกประเภทการลา, วันที่ลา, และเหตุผล', 'warning');
                return;
            }

            let startDate = new Date(startDateStr);
            let endDate;
            
            // [ใหม่] Validation ตาม durationType
            if (durationType === 'hourly') {
                if (!startTimeStr || !endTimeStr) {
                    showNotification('กรุณากรอกเวลาเริ่มต้นและสิ้นสุด', 'warning');
                    return;
                }
                // สำหรับรายชั่วโมง วันที่สิ้นสุดคือวันเดียวกับวันที่เริ่ม
                endDate = new Date(startDateStr); 
                
                // (Optional) ทำให้วันที่เริ่มต้นและสิ้นสุดมีเวลาเป็น 00:00:00
                startDate.setHours(0, 0, 0, 0);
                endDate.setHours(0, 0, 0, 0);

            } else { // 'full_day'
                if (!endDateStr) {
                    showNotification('กรุณากรอกวันที่สิ้นสุด', 'warning');
                    return;
                }
                endDate = new Date(endDateStr);
                if (endDate < startDate) {
                    showNotification('วันที่สิ้นสุด ต้องไม่น้อยกว่าวันที่เริ่มต้น', 'warning');
                    return;
                }
            }
            
            // (ส่วนปิดปุ่ม ... เหมือนเดิม)
            submitLeaveBtn.disabled = true;
            submitLeaveBtn.textContent = 'กำลังส่งเรื่อง...';

            // --- 5.2 เตรียมข้อมูลสำหรับ Firestore ---
            const leaveData = {
                userId: currentUser.uid,
                userName: currentUserData.fullName,
                userPhoto: currentUserData.profileImageUrl || currentUser.photoURL,
                leaveType: leaveType,
                reason: reason,
                status: "pending", 
                submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                
                // [ใหม่] เพิ่มข้อมูลใหม่
                durationType: durationType, // 'full_day' or 'hourly'
                startDate: firebase.firestore.Timestamp.fromDate(startDate),
                endDate: firebase.firestore.Timestamp.fromDate(endDate)
            };
            
            // [ใหม่] เพิ่มข้อมูลเวลา ถ้าเป็นรายชั่วโมง
            if (durationType === 'hourly') {
                leaveData.startTime = startTimeStr;
                leaveData.endTime = endTimeStr;
            }

            // --- 5.3 บันทึกลง Firestore ---
            try {
                // (ส่วน try/catch ... เหมือนเดิม)
                await db.collection('leave_requests').add(leaveData);
                
                showNotification('ยื่นใบลาสำเร็จ รอการอนุมัติ', 'success');
                closeLeaveModal(); // ปิด Modal เมื่อสำเร็จ

            } catch (error) {
                console.error("Error submitting leave request:", error);
                showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
            } finally {
                // (ส่วนคืนค่าปุ่ม ... เหมือนเดิม)
                submitLeaveBtn.disabled = false;
                submitLeaveBtn.textContent = 'ส่งใบลา';
            }
        });
    }

// [แก้ไข] 1. ฟังก์ชันสำหรับ "แสดง" รายละเอียด (ซ่อนฟอร์มไว้ก่อน)
        function showCalendarDetails(e) {
            const cell = e.target.closest('[data-day-number]');
            if (!cell) return;

            const day = parseInt(cell.dataset.dayNumber);
            const dateKey = cell.dataset.dateKey; // YYYY-MM-DD
            const [y, m, d] = dateKey.split('-');
            const thaiDate = new Date(y, m - 1, d).toLocaleDateString('th-TH', {
                day: 'numeric', month: 'long'
            });

            const plans = calendarDataCache.plans.get(day) || [];
            const users = calendarDataCache.users;
            const container = document.getElementById('cal-details-container');
            
            let detailHtml = `
                <h4 class="font-semibold text-lg">แผนงาน วันที่ ${thaiDate}</h4>
            `;
            
            // --- 1. สร้าง HTML สำหรับ "Plan ที่มีอยู่" (ของทุกคน) ---
            if (plans.length > 0) {
                detailHtml += '<div class="space-y-3 pt-3">';
                plans.forEach(plan => {
                    const userName = users.get(plan.userId)?.fullName || 'ไม่พบชื่อ';
                    const userPhoto = users.get(plan.userId)?.profileImageUrl || 'https://placehold.co/100x100/E2E8F0/475569?text=User';
                    
                    detailHtml += `
                        <div class="flex items-start space-x-3">
                            <img src="${userPhoto}" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                            <div class="flex-1">
                                <div class="flex justify-between items-center">
                                    <p class="font-semibold text-sm">${userName}</p>
                                    ${plan.userId === currentUser.uid ? // [เช็ก] ถ้าเป็น plan ของเรา, ให้แสดงปุ่มลบ
                                        `<button class="plan-delete-btn text-red-400 hover:text-red-600" data-doc-id="${plan.id}">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                                        </button>` 
                                        : ''
                                    }
                                </div>
                                <p class="text-sm text-gray-700 whitespace-pre-wrap">${plan.planText}</p>
                            </div>
                        </div>
                    `;
                });
                detailHtml += '</div>';
            } else {
                detailHtml += '<p class="text-center text-gray-400 text-sm py-2">ยังไม่มีแผนงานสำหรับวันนี้</p>';
            }

            // --- 2. สร้าง HTML สำหรับ "ปุ่มเพิ่ม" และ "ฟอร์มที่ซ่อนอยู่" ---
            detailHtml += `
                <div class="pt-3 mt-3 border-t border-gray-100">
                    <button id="plan-show-form-btn" class="w-full text-sm font-medium text-sky-600 p-2 rounded-lg hover:bg-sky-50">
                        + เพิ่มแผนของฉันในวันนี้
                    </button>
                    
                    <div id="plan-new-form" class="hidden space-y-2 mt-2">
                        <textarea id="plan-new-textarea" class="w-full p-2 border border-gray-300 rounded-lg" rows="2" placeholder="กรอกแผนงานของคุณ..."></textarea>
                        <button id="plan-save-new-btn" data-date-key="${dateKey}" class="btn-primary w-full py-2 text-sm">บันทึกแผนของฉัน</button>
                    </div>
                </div>
            `;

            container.innerHTML = detailHtml;
        }

    // [แก้ไข] 2. ฟังก์ชันสำหรับ "จัดการ" การคลิก (เพิ่มปุ่ม "เปิดฟอร์ม")
        async function handleCalendarDetailClick(e) {

            // --- [เพิ่ม] กรณีคลิก "เปิดฟอร์ม" ---
            if (e.target.id === 'plan-show-form-btn') {
                document.getElementById('plan-new-form').classList.remove('hidden'); // แสดงฟอร์ม
                e.target.classList.add('hidden'); // ซ่อนปุ่ม "+ เพิ่มแผน"
                return;
            }

            // --- (เหมือนเดิม) กรณีคลิก "บันทึกแผนใหม่" ---
            if (e.target.id === 'plan-save-new-btn') {
                const saveBtn = e.target;
                const dateKey = saveBtn.dataset.dateKey;
                const textarea = document.getElementById('plan-new-textarea');
                const planText = textarea.value.trim();
                const docId = `${currentUser.uid}_${dateKey}`; // ID เอกสาร

                if (!planText) {
                    alert("กรุณากรอกแผนงาน");
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.textContent = 'กำลังบันทึก...';
                
                try {
                    const planData = {
                        userId: currentUser.uid,
                        date: firebase.firestore.Timestamp.fromDate(new Date(dateKey)),
                        planText: planText,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await db.collection('user_plans').doc(docId).set(planData);
                    
                    showNotification('บันทึกแผนสำเร็จ!');
                    loadCalendarData(currentDisplayDate); // รีเฟรชปฏิทินทั้งหมด
                    
                } catch (error) {
                    console.error("Error saving plan:", error);
                    showNotification('เกิดข้อผิดพลาด', 'error');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'บันทึกแผนของฉัน';
                }
            }

            // --- (เหมือนเดิม) กรณีคลิก "ลบ" ---
            if (e.target.closest('.plan-delete-btn')) {
                const deleteBtn = e.target.closest('.plan-delete-btn');
                const docId = deleteBtn.dataset.docId; // ID ของ plan ที่จะลบ
                
                showConfirmDialog(
                    'คุณต้องการลบแผนงานนี้ใช่หรือไม่?',
                    async () => { // onConfirm
                        try {
                            await db.collection('user_plans').doc(docId).delete();
                            showNotification('ลบแผนงานแล้ว', 'success');
                            loadCalendarData(currentDisplayDate); // รีเฟรชปฏิทินทั้งหมด
                        } catch (error) {
                             console.error("Error deleting plan:", error);
                             showNotification('เกิดข้อผิดพลาดในการลบ', 'error');
                        }
                    }
                );
            }
        }

    // 3. เพิ่ม Event Listener หลัก (ใช้ Event Delegation)
    document.getElementById('cal-grid').addEventListener('click', showCalendarDetails);
    document.getElementById('cal-details-container').addEventListener('click', handleCalendarDetailClick);

    // --- จบส่วนโค้ด Details ---
    
    saveEditBtn.addEventListener('click', async () => {
        const docId = editDocIdInput.value;
        const checkinStr = editCheckinTimeInput.value;
        const checkoutStr = editCheckoutTimeInput.value;

        if (!docId || !checkinStr) {
            alert('ข้อมูล ID หรือ เวลา Check-in ไม่ถูกต้อง');
            return;
        }

        saveEditBtn.disabled = true;
        saveEditBtn.textContent = 'กำลังบันทึก...';

        try {
            // ดึง userId และ dateKey จาก docId
            const [userId, dateKey] = docId.split('_'); 
            const baseDate = new Date(dateKey + 'T00:00:00'); // ใช้วันที่จาก docId เป็นหลัก

            // --- 1. รวบรวมข้อมูล Report ---
            const workType = editModalWorkTypeSelectedText.textContent;
            const project = editModalProjectSelectedText.textContent;
            let duration = editModalDurationSelectedText.textContent;

            if (duration === 'กำหนดเวลา') {
                const startTime = editModalCustomTimeStartInput.value;
                const endTime = editModalCustomTimeEndInput.value;
                if (startTime && endTime) {
                    duration = `${startTime} - ${endTime}`;
                } else {
                    duration = 'กำหนดเวลา (ไม่สมบูรณ์)';
                }
            }

            const reportData = {
                workType: (workType.includes('...') ? null : workType),
                project: (project.includes('...') ? null : project),
                duration: (duration.includes('...') ? null : duration),
                submittedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // --- 2. ตรวจสอบว่าเป็นการ "เพิ่มใหม่" หรือ "แก้ไข" ---
            const workRecordRef = db.collection('work_records').doc(docId);
            const doc = await workRecordRef.get();
            let isCreatingNew = !doc.exists;

            let dataToSave = {};
            const checkinTimestamp = firebase.firestore.Timestamp.fromDate(new Date(checkinStr));
            const checkoutTimestamp = checkoutStr ? firebase.firestore.Timestamp.fromDate(new Date(checkoutStr)) : null;

            if (isCreatingNew) {
                // --- 3A. Logic สำหรับ "การสร้างใหม่" (Add) ---
                dataToSave = {
                    userId: userId,
                    date: firebase.firestore.Timestamp.fromDate(baseDate), // ใช้วันที่ที่เลือก
                    checkIn: {
                        timestamp: checkinTimestamp,
                        location: null, // Admin add, no location
                        accuracy: null,
                        workType: "in_factory", // Default for admin
                        onSiteDetails: editOnsiteDetailsInput.value || null,
                        photoUrl: null
                    },
                    checkOut: checkoutTimestamp ? {
                        timestamp: checkoutTimestamp,
                        location: null
                    } : null,
                    status: checkoutTimestamp ? "completed" : "checked_in",
                    report: (reportData.workType ? reportData : null), // เพิ่ม report ถ้ามีการกรอก
                    overtime: null // ต้องคำนวณ
                };

                // คำนวณ OT ถ้าสถานะเป็น completed
                if (dataToSave.status === "completed") {
                    const { regularWorkHours, overtimeHours } = calculateWorkHours(new Date(checkinStr), new Date(checkoutStr));
                    dataToSave.overtime = { hours: overtimeHours };
                }
                
                // ใช้ .set() สำหรับการสร้างเอกสารใหม่
                await workRecordRef.set(dataToSave);

            } else {
                // --- 3B. Logic สำหรับ "การแก้ไข" (Edit) ---
                const existingRecord = doc.data();
                
                // ใช้ .update() เพื่อ merge ข้อมูล, ป้องกันข้อมูลเดิม (เช่น location) หาย
                dataToSave = {
                    'checkIn.timestamp': checkinTimestamp,
                    'checkIn.onSiteDetails': editOnsiteDetailsInput.value || null, // อัปเดต onSiteDetails
                    'checkOut': checkoutTimestamp ? {
                        timestamp: checkoutTimestamp,
                        location: existingRecord.checkOut?.location || null // ใช้ location เดิมถ้ามี
                    } : null,
                    'status': checkoutTimestamp ? "completed" : "checked_in",
                    'report': (reportData.workType ? reportData : existingRecord.report) // อัปเดต report
                };

                // คำนวณ OT ถ้าสถานะเป็น completed
                if (dataToSave.status === "completed") {
                    const { regularWorkHours, overtimeHours } = calculateWorkHours(new Date(checkinStr), new Date(checkoutStr));
                    dataToSave['overtime'] = { hours: overtimeHours }; // อัปเดต field overtime
                } else {
                    dataToSave['overtime'] = null; // ล้างค่า OT ถ้า check-out ถูกลบ
                }

                // ใช้ .update() สำหรับการแก้ไขเอกสารเดิม
                await workRecordRef.update(dataToSave);
            }

            // --- 4. Success ---
            showNotification('บันทึกข้อมูลสำเร็จ!', 'success');
            editModal.classList.add('hidden');
            searchRecordBtn.click(); // กดค้นหาอีกครั้งเพื่อรีเฟรชข้อมูลที่แสดง

        } catch (error) {
            console.error("Error saving record:", error);
            showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
        } finally {
            saveEditBtn.disabled = false;
            saveEditBtn.textContent = 'บันทึกการแก้ไข';
        }
    });

    // เพิ่ม Event Listener ให้ปุ่ม Cancel (โค้ดนี้น่าจะมีอยู่แล้ว)
    cancelEditBtn.addEventListener('click', () => {
        editModal.classList.add('hidden');
    });

    // --- Function to show confirmation dialog ---
// Added optional onCancel parameter
// [แก้ไข] เพิ่ม parameter: okText, cancelText
function showConfirmDialog(message, onConfirm, onCancel = null, okText = "ตกลง", cancelText = "ยกเลิก") {
    const confirmModal = document.getElementById('confirm-modal');
    const overlay = document.getElementById('confirm-overlay');
    const msgElement = document.getElementById('confirm-message');
    const okBtn = document.getElementById('confirm-ok-btn');
    const cancelBtn = document.getElementById('confirm-cancel-btn');

    if (!confirmModal || !msgElement || !okBtn || !cancelBtn || !overlay) return;

    msgElement.textContent = message;
    
    // [เพิ่มใหม่] เปลี่ยนข้อความปุ่ม
    okBtn.textContent = okText;
    cancelBtn.textContent = cancelText;

    // ... (ส่วน Event Listener เหมือนเดิม ไม่ต้องแก้) ...
    const handleConfirm = () => {
        closeDialog();
        if (typeof onConfirm === 'function') onConfirm();
    };

    const handleCancel = () => {
        closeDialog();
        if (typeof onCancel === 'function') onCancel();
    };

    const closeDialog = () => {
        confirmModal.classList.add('hidden');
        okBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
        overlay.removeEventListener('click', handleCancel);
        
        // [เพิ่มใหม่] คืนค่าข้อความปุ่มเป็นค่าเริ่มต้น (เผื่อใช้ที่อื่น)
        setTimeout(() => {
            okBtn.textContent = "ตกลง";
            cancelBtn.textContent = "ยกเลิก";
        }, 300);
    };

    okBtn.addEventListener('click', handleConfirm);
    cancelBtn.addEventListener('click', handleCancel);
    overlay.addEventListener('click', handleCancel);

    confirmModal.classList.remove('hidden');
}

    // 3. [เพิ่ม] ฟังก์ชันสำหรับค้นหาข้อมูลเมื่อคลิกปุ่ม
    searchRecordBtn.addEventListener('click', async () => {
        const userId = editUserSelect.value;
        const dateStr = editDateSelect.value; // YYYY-MM-DD

        if (!userId || !dateStr) {
            searchResultsContainer.innerHTML = '<p class="text-sm text-center text-red-500 py-2">กรุณาเลือกพนักงานและวันที่</p>';
            return;
        }

        searchResultsContainer.innerHTML = '<p class="text-sm text-center text-gray-500 py-2">กำลังค้นหาข้อมูล...</p>';

        try {
            const docId = `${userId}_${dateStr}`;
            const workRecordRef = db.collection('work_records').doc(docId);
            const doc = await workRecordRef.get();

            if (doc.exists) {
                // --- กรณีพบข้อมูล (เหมือนเดิม) ---
                const record = doc.data();
                const report = record.report || {};
                
                const checkinTime = record.checkIn.timestamp.toDate().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                const checkoutTime = record.checkOut ? record.checkOut.timestamp.toDate().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '-';
                const reportInfo = report.workType ? `${report.workType} (${report.project || 'N/A'})` : 'ยังไม่ส่งรายงาน';

                searchResultsContainer.innerHTML = `
                    <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-start">
                            <p class="font-semibold text-gray-800">ข้อมูลที่พบ</p>
                            <button data-doc-id="${doc.id}" class="edit-record-btn text-sm bg-sky-100 text-sky-700 font-semibold px-3 py-1 rounded-lg hover:bg-sky-200">
                                แก้ไข
                            </button>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-100 grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                            <div><span class="text-gray-500">เข้า:</span> <span class="font-semibold text-green-600">${checkinTime}</span></div>
                            <div><span class="text-gray-500">ออก:</span> <span class="font-semibold text-red-500">${checkoutTime}</span></div>
                            <div class="col-span-2 mt-1"><span class="text-gray-500">รายงาน:</span> <span class="font-medium text-gray-700">${reportInfo}</span></div>
                        </div>
                    </div>
                `;
            } else {
                // --- [แก้ไข] กรณีไม่พบข้อมูล -> แสดงปุ่ม "เพิ่ม" ---
                searchResultsContainer.innerHTML = `
                    <p class="text-sm text-center text-yellow-600 py-2">ไม่พบข้อมูลการลงเวลาสำหรับผู้ใช้และวันที่ที่เลือก</p>
                    <button 
                        data-user-id="${userId}" 
                        data-date-str="${dateStr}" 
                        class="add-record-btn mt-2 w-full btn-primary py-2 text-sm">
                        + เพิ่มข้อมูลสำหรับวันนี้
                    </button>
                `;
            }

        } catch (error) {
            console.error("Error searching record:", error);
            searchResultsContainer.innerHTML = '<p class="text-sm text-center text-red-500 py-2">เกิดข้อผิดพลาดในการค้นหา</p>';
        }
    });

    async function loadCalendarRules() {
    const holidayList = document.getElementById('holiday-list');
    const workSatList = document.getElementById('working-saturday-list');
    if (!holidayList || !workSatList) return;

    holidayList.innerHTML = '<p class="text-sm text-gray-400">กำลังโหลด...</p>';
    workSatList.innerHTML = '<p class="text-sm text-gray-400">กำลังโหลด...</p>';

    try {
        const doc = await db.collection('system_settings').doc('calendar_rules').get();
        if (!doc.exists) {
            holidayList.innerHTML = '<p class="text-sm text-gray-400">ไม่พบข้อมูล</p>';
            workSatList.innerHTML = '<p class="text-sm text-gray-400">ไม่พบข้อมูล</p>';
            return;
        }

        const data = doc.data();
        const holidays = data.holidays || [];
        const workingSaturdays = data.workingSaturdays || [];

        // ฟังก์ชัน Helper สร้าง HTML
        const createListHTML = (dateArray, type) => {
            if (dateArray.length === 0) return '<p class="text-sm text-gray-400">ไม่มีรายการ</p>';
            // เรียงวันที่จากน้อยไปมาก
            dateArray.sort((a, b) => new Date(a) - new Date(b));
            
            return dateArray.map(dateStr => `
                <div class="flex justify-between items-center bg-white p-2 rounded-md shadow-sm">
                    <span class="text-sm font-medium">${dateStr}</span>
                    <button data-date="${dateStr}" data-type="${type}" class="calendar-delete-btn text-red-400 hover:text-red-600 p-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            `).join('');
        };

        holidayList.innerHTML = createListHTML(holidays, 'holidays');
        workSatList.innerHTML = createListHTML(workingSaturdays, 'workingSaturdays');

    } catch (error) {
        console.error("Error loading calendar rules:", error);
        holidayList.innerHTML = '<p class="text-sm text-red-500">โหลดล้มเหลว</p>';
        workSatList.innerHTML = '<p class="text-sm text-red-500">โหลดล้มเหลว</p>';
    }
}

// 2. ฟังก์ชันเพิ่มกฎ (Holiday หรือ Working Saturday)
async function handleAddCalendarRule(type) {
    const dateInput = document.getElementById('calendar-admin-date-input');
    const dateString = dateInput.value; // YYYY-MM-DD
    
    if (!dateString) {
        showNotification('กรุณาเลือกวันที่ก่อน', 'warning');
        return;
    }

    const buttonId = (type === 'holidays') ? 'calendar-admin-add-holiday' : 'calendar-admin-add-worksat';
    const button = document.getElementById(buttonId);
    button.disabled = true;
    button.textContent = 'กำลังเพิ่ม...';

    try {
        const docRef = db.collection('system_settings').doc('calendar_rules');
        
        // ใช้ arrayUnion เพื่อเพิ่มค่าลงใน array (ถ้ายังไม่มี)
        await docRef.set({
            [type]: firebase.firestore.FieldValue.arrayUnion(dateString)
        }, { merge: true }); // merge: true เพื่อไม่ให้ลบ field อื่น

        showNotification(`เพิ่มวันที่ ${dateString} สำเร็จ`, 'success');
        dateInput.value = ''; // ล้างค่า
        loadCalendarRules(); // โหลดรายการใหม่

    } catch (error) {
        console.error("Error adding calendar rule:", error);
        showNotification('เกิดข้อผิดพลาด', 'error');
    } finally {
        button.disabled = false;
        button.textContent = (type === 'holidays') ? '+ เพิ่มเป็นวันหยุด' : '+ เพิ่มเป็นวันเสาร์ทำงาน';
    }
}

// 3. ฟังก์ชันลบกฎ
async function handleDeleteCalendarRule(type, dateString, buttonElement) {
    if (!type || !dateString) return;

    buttonElement.disabled = true;
    buttonElement.style.opacity = '0.5';

    try {
        const docRef = db.collection('system_settings').doc('calendar_rules');
        
        // ใช้ arrayRemove เพื่อลบค่าออกจาก array
        await docRef.update({
            [type]: firebase.firestore.FieldValue.arrayRemove(dateString)
        });

        showNotification(`ลบวันที่ ${dateString} สำเร็จ`, 'success');
        loadCalendarRules(); // โหลดรายการใหม่ (วิธีนี้ง่ายที่สุด)

    } catch (error) {
        console.error("Error deleting calendar rule:", error);
        showNotification('เกิดข้อผิดพลาด', 'error');
        buttonElement.disabled = false;
        buttonElement.style.opacity = '1';
    }
}

async function loadPendingLeaveRequests() {
        const listContainer = document.getElementById('leave-approval-list');
        const loadingMsg = document.getElementById('leave-loading-msg');
        
        if (!listContainer || !loadingMsg) return;

        listContainer.innerHTML = ''; 
        loadingMsg.textContent = 'กำลังโหลดรายการ...';
        listContainer.appendChild(loadingMsg); 

        try {
            // [ ★ 1. ดึงข้อมูล User ทั้งหมดมาเก็บใน Map ก่อน ★ ]
            const userMap = new Map();
            const usersSnapshot = await db.collection('users').get();
            usersSnapshot.forEach(doc => {
                userMap.set(doc.id, doc.data());
            });


            // [ ★ 2. ดึงใบลา (เหมือนเดิม) ★ ]
            const querySnapshot = await db.collection('leave_requests')
                                          .where('status', '==', 'pending')
                                          // .orderBy('submittedAt', 'asc')
                                          .get();

            if (querySnapshot.empty) {
                loadingMsg.textContent = 'ไม่มีรายการรออนุมัติ';
                return;
            }

            listContainer.innerHTML = ''; // ล้าง "กำลังโหลด" ออก

            querySnapshot.forEach(doc => {
                const leave = doc.data();
                const docId = doc.id;

                // [ ★ 3. ค้นหาชื่อและรูปปัจจุบันจาก Map ★ ]
                const user = userMap.get(leave.userId);
                // (ถ้าหา user ไม่เจอจริงๆ ให้ใช้ชื่อเก่าที่บันทึกมาแทน)
                const displayName = user ? user.fullName : leave.userName;
                const displayPhoto = user ? user.profileImageUrl : leave.userPhoto;

                
                // ... (โค้ดแปลงวันที่ เหมือนเดิม) ...
                const startDate = leave.startDate.toDate().toLocaleDateString('th-TH');
                const endDate = leave.endDate.toDate().toLocaleDateString('th-TH');
                let dateInfoText = '';
                if (leave.durationType === 'hourly' && leave.startTime && leave.endTime) {
                    dateInfoText = `${startDate} (${leave.startTime} - ${leave.endTime})`;
                } else {
                    dateInfoText = `${startDate} ถึง ${endDate}`;
                }


                const cardHTML = `
<div class="bg-white shadow-md rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-all duration-200 mb-4 relative leave-request-card">

    <!-- แถบด้านบนให้รู้ว่าเป็นใบลาที่รออนุมัติ -->
    <div class="flex items-start gap-3 mt-2">
        <img src="${displayPhoto || 'https://placehold.co/100x100/E2E8F0/475569?text=User'}" 
            class="w-12 h-12 rounded-full object-cover border border-gray-300">
        
        <div>
            <p class="font-semibold text-gray-800 text-lg">${displayName}</p>
            <p class="text-sm font-medium text-sky-700">
                ${LEAVE_TYPE_MAP[leave.leaveType] || leave.leaveType}
            </p>
            <p class="text-sm text-gray-600 font-medium">${dateInfoText}</p>
        </div>
    </div>

    <p class="text-sm text-gray-700 mt-3 p-3 bg-gray-50 rounded-lg border border-gray-100">
        ${leave.reason}
    </p>

    <div class="flex justify-end gap-3 mt-4">
        <button data-id="${docId}" 
            class="reject-leave-btn text-sm font-medium text-red-600 px-4 py-2 rounded-lg border border-red-200 hover:bg-red-50 transition">
            ไม่อนุมัติ
        </button>

        <button data-id="${docId}" 
            class="approve-leave-btn text-sm font-medium text-green-600 px-4 py-2 rounded-lg border border-green-200 hover:bg-green-50 transition">
            อนุมัติ
        </button>
    </div>

</div>
`;
                listContainer.innerHTML += cardHTML;
            });

        } catch (error) {
            console.error("Error loading leave requests:", error);
            loadingMsg.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล';
        }
    }
    // 2. ฟังก์ชันสำหรับโหลดรายชื่อพนักงาน
    // [ปรับปรุง] --- 2. ฟังก์ชันสำหรับโหลดรายชื่อพนักงาน ---
// (แทนที่ฟังก์ชันเดิมใน index.html)
async function loadAllUsersForDropdown() {
    const summaryEmployeeSelect = document.getElementById('summary-employee-select');
    // [ใหม่] ดึง Select Box ของฟิลเตอร์ประวัติใบลา
    const leaveHistoryUserSelect = document.getElementById('leave-history-user-filter');

    // [ปรับปรุง] ตรวจสอบ Select Box ทั้ง 3 ตัว
    if (editUserSelect.options.length > 1 && 
        summaryEmployeeSelect.options.length > 1 && 
        (leaveHistoryUserSelect && leaveHistoryUserSelect.options.length > 1)) return;

    try {
        const usersSnapshot = await db.collection('users').orderBy('fullName').get();
        editUserSelect.innerHTML = '<option value="">--- เลือกพนักงาน ---</option>';
        summaryEmployeeSelect.innerHTML = '<option value="">พนักงานทั้งหมด</option>';
        // [ใหม่] เคลียร์ค่า Select Box ใหม่
        if (leaveHistoryUserSelect) {
            leaveHistoryUserSelect.innerHTML = '<option value="">พนักงานทั้งหมด</option>';
        }

        usersSnapshot.forEach(doc => {
            const user = doc.data();
            const optionText = user.fullName || doc.id;
            const optionValue = doc.id;

            // (ส่วนของ editUserSelect เหมือนเดิม)
            const optionEdit = document.createElement('option');
            optionEdit.value = optionValue;
            optionEdit.textContent = optionText;
            editUserSelect.appendChild(optionEdit);

            // (ส่วนของ summaryEmployeeSelect เหมือนเดิม)
            const optionSummary = document.createElement('option');
            optionSummary.value = optionValue;
            optionSummary.textContent = optionText;
            summaryEmployeeSelect.appendChild(optionSummary);

            // [ใหม่] เพิ่ม Option ให้กับ Select Box ของประวัติใบลา
            if (leaveHistoryUserSelect) {
                const optionLeaveHistory = document.createElement('option');
                optionLeaveHistory.value = optionValue;
                optionLeaveHistory.textContent = optionText;
                leaveHistoryUserSelect.appendChild(optionLeaveHistory);
            }
        });
    } catch (error) {
        console.error("Error loading users:", error);
        editUserSelect.innerHTML = '<option value="">โหลดข้อมูลล้มเหลว</option>';
        summaryEmployeeSelect.innerHTML = '<option value="">โหลดข้อมูลล้มเหลว</option>';
        // [ใหม่] แสดง Error ใน Select Box ใหม่ด้วย
        if (leaveHistoryUserSelect) {
            leaveHistoryUserSelect.innerHTML = '<option value="">โหลดข้อมูลล้มเหลว</option>';
        }
    }
}

    async function loadLeaveHistory() {
        const listContainer = document.getElementById('leave-history-list');
        // FIX: ต้องตรวจสอบและสร้าง element ใหม่ถ้าถูกลบไป
        let loadingMsg = document.getElementById('leave-history-loading-msg'); 
        
        if (!listContainer) {
            console.error("Leave history elements not found!");
            return;
        }

        // หาก loadingMsg ไม่มีอยู่ (ถูกล้างไปในการค้นหาก่อนหน้า) ให้สร้างใหม่
        if (!loadingMsg) {
            loadingMsg = document.createElement('p');
            loadingMsg.id = 'leave-history-loading-msg';
            loadingMsg.className = 'text-center text-gray-400 text-sm py-4';
        }

        listContainer.innerHTML = ''; // ล้างของเก่า
        loadingMsg.textContent = 'กำลังโหลดประวัติ...';
        listContainer.appendChild(loadingMsg);

        // 1. ดึงค่าจากฟิลเตอร์
        const statusFilter = document.getElementById('leave-history-status-filter').value;
        const userFilter = document.getElementById('leave-history-user-filter').value;

        try {
            let query = db.collection('leave_requests');

            // 2. สร้าง Query ตามฟิลเตอร์
            if (statusFilter) {
                query = query.where('status', '==', statusFilter);
            }
            if (userFilter) {
                query = query.where('userId', '==', userFilter);
            }
            
            // 3. เรียงลำดับ (ต้องสร้าง Index ใน Firestore ถ้า Query ซับซ้อน)
            // ถ้าใช้แค่ filter เดียว ให้เรียงตาม submittedAt
            if (!statusFilter || !userFilter) {
                // query = query.orderBy('submittedAt', 'desc');
            }
            // (หมายเหตุ: ถ้าใช้ filter 2 ช่องพร้อมกัน อาจต้องสร้าง Composite Index ใน Firebase)

            const querySnapshot = await query.get();

            if (querySnapshot.empty) {
                loadingMsg.textContent = 'ไม่พบประวัติใบลาตามเงื่อนไขที่เลือก';
                return;
            }

            listContainer.innerHTML = ''; // ล้าง "กำลังโหลด"

            querySnapshot.forEach(doc => {
                const leave = doc.data();
                const docId = doc.id;

                const startDate = leave.startDate.toDate().toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });
                const endDate = leave.endDate.toDate().toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });

                // 4. กำหนดสีและข้อความของสถานะ
                let statusText, statusColorClass;
                switch (leave.status) {
                    case 'approved':
                        statusText = 'อนุมัติแล้ว';
                        statusColorClass = 'bg-green-100 text-green-800';
                        break;
                    case 'rejected':
                        statusText = 'ไม่อนุมัติ';
                        statusColorClass = 'bg-red-100 text-red-800';
                        break;
                    default:
                        statusText = 'รออนุมัติ';
                        statusColorClass = 'bg-yellow-100 text-yellow-800';
                }

                // [ใหม่] สร้างข้อความแสดงผลวันที่/เวลา
                let dateInfoText = '';
                if (leave.durationType === 'hourly' && leave.startTime && leave.endTime) {
                    // สำหรับลารายชั่วโมง (ใช้ startDate ที่ format แล้ว)
                    dateInfoText = `${startDate} (${leave.startTime} - ${leave.endTime})`;
                } else {
                    // สำหรับลาเต็มวัน (แบบเดิม)
                    dateInfoText = `${startDate} ถึง ${endDate}`;
                }


                const cardHTML = `
                <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex items-start gap-3">
                        <img src="${leave.userPhoto || 'https://placehold.co/100x100/E2E8F0/475569?text=User'}" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                        <div>
                            <div class="flex flex-wrap items-center gap-2 mb-1">
                                <p class="font-semibold">${leave.userName}</p>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusColorClass}">${statusText}</span>
                            </div>
                            <p class="text-sm font-medium text-sky-700">${LEAVE_TYPE_MAP[leave.leaveType] || leave.leaveType}</p>
                            
                            <p class="text-sm text-gray-500 font-medium">${dateInfoText}</p>

                        </div>
                    </div>
                    <p class="text-sm text-gray-700 mt-3 p-3 bg-gray-50 rounded-lg whitespace-pre-wrap">${leave.reason}</p>
                    ${leave.status !== 'pending' ? `<p class="text-xs text-gray-400 mt-2 text-right">จัดการโดย: ${leave.approvedBy || 'N/A'}</p>` : ''}
                </div>
                `;
                listContainer.innerHTML += cardHTML;
            });

        } catch (error) {
            console.error("Error loading leave history:", error);
            loadingMsg.textContent = 'เกิดข้อผิดพลาด: ' + error.message;
            // (ถ้า error เกี่ยวกับ Index, Firebase จะบอกใน Console)
            if (error.code === 'failed-precondition') {
                loadingMsg.textContent = 'Error: ต้องสร้าง Index ใน Firestore สำหรับการค้นหานี้';
            }
        }
    }

    const leaveListContainer = document.getElementById('leave-approval-list');
    if (leaveListContainer) {
        leaveListContainer.addEventListener('click', (event) => {
            
            // [แก้ไข] ใช้ .closest() เพื่อหาปุ่มที่ถูกคลิก
            // วิธีนี้จะแม่นยำกว่า แม้ว่าผู้ใช้จะคลิกโดนข้อความบนปุ่ม
            const approveBtn = event.target.closest('.approve-leave-btn');
            const rejectBtn = event.target.closest('.reject-leave-btn');

            if (approveBtn) {
                // กดปุ่มอนุมัติ
                const docId = approveBtn.dataset.id;
                if (!docId) return; // ตรวจสอบอีกครั้ง
                
                approveBtn.disabled = true; 
                approveBtn.textContent = 'กำลังบันทึก...';
                handleLeaveApproval(docId, 'approved', approveBtn); 
            }
            else if (rejectBtn) {
                // กดปุ่มไม่อนุมัติ
                const docId = rejectBtn.dataset.id;
                if (!docId) return; // ตรวจสอบอีกครั้ง
                
                rejectBtn.disabled = true;
                rejectBtn.textContent = 'กำลังบันทึก...';
                handleLeaveApproval(docId, 'rejected', rejectBtn);
            }
        });
    }

// (แทนที่ฟังก์ชันเดิม)
async function handleLeaveApproval(docId, newStatus, buttonElement) { 
    if (!docId) return;

    // [แก้ไข] ค้นหาการ์ดหลักด้วย class ใหม่
    const cardElement = buttonElement.closest('.leave-request-card');

    // 1. ปิดการใช้งานปุ่มและทำให้การ์ดจางลงทันที
    if (cardElement) {
        cardElement.querySelectorAll('button').forEach(btn => btn.disabled = true);
        cardElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        cardElement.style.opacity = '0.5';
    } else {
        // Fallback (กรณี selector ผิด)
        buttonElement.disabled = true;
    }

    try {
        // 2. อัปเดต Firestore (เหมือนเดิม)
        await db.collection('leave_requests').doc(docId).update({
            status: newStatus,
            approvedBy: currentUserData.fullName
        });
        
        const statusText = newStatus === 'approved' ? 'อนุมัติ' : 'ไม่อนุมัติ';
        showNotification(`${statusText}ใบลาสำเร็จ`, 'success');

        // 3. ถ้าหาการ์ดเจอ ให้ซ่อนและลบออก
        if (cardElement) {
            cardElement.style.opacity = '0';
            cardElement.style.transform = 'scale(0.95)';
            
            setTimeout(() => {
                cardElement.remove(); // ลบการ์ดออกจาก DOM
                
                // 4. [FIX] ตรวจสอบว่ามีรายการเหลือหรือไม่
                const listContainer = document.getElementById('leave-approval-list');
                if (listContainer && listContainer.children.length === 0) {
                    
                    // ค้นหา p id="leave-loading-msg"
                    let loadingMsg = document.getElementById('leave-loading-msg');
                    
                    if (!loadingMsg) {
                        // ถ้าไม่มี (เพราะถูกลบไปตอนโหลด) ให้สร้างขึ้นมาใหม่
                        loadingMsg = document.createElement('p');
                        loadingMsg.id = 'leave-loading-msg';
                        loadingMsg.className = 'text-center text-gray-400 text-sm py-4';
                        listContainer.appendChild(loadingMsg);
                    }
                    // อัปเดตข้อความ
                    loadingMsg.textContent = 'ไม่มีรายการรออนุมัติ';
                }
            }, 300); // รอ animation 0.3s
        } else {
            // 3b. Fallback (ถ้าหาการ์ดไม่เจอ) ให้โหลดซ้ำทั้งรายการ
            await loadPendingLeaveRequests(); 
        }

    } catch (error) {
        // 5. ถ้าเกิดข้อผิดพลาด
        console.error("Error updating leave status:", error);
        showNotification('เกิดข้อผิดพลาดในการอัปเดต', 'error');

        // คืนค่าปุ่มให้กดได้อีกครั้ง
        if (cardElement) {
            cardElement.querySelectorAll('button').forEach(btn => btn.disabled = false);
            cardElement.style.opacity = '1';
            cardElement.style.transform = 'scale(1)';
        } else {
            buttonElement.disabled = false;
        }
    }
}

    // [ ★★★ เพิ่มส่วนนี้ ★★★ ]
// ผูก Event Listener สำหรับการอนุมัติ OT
const otListContainer = document.getElementById('ot-approval-list');
if (otListContainer) {
    otListContainer.addEventListener('click', (event) => {

        const approveBtn = event.target.closest('.approve-ot-btn');
        const rejectBtn = event.target.closest('.reject-ot-btn');

        if (approveBtn) {
            // กดปุ่มอนุมัติ
            const docId = approveBtn.dataset.id;
            if (!docId) return; 

            approveBtn.disabled = true; 
            approveBtn.textContent = 'กำลังบันทึก...';
            handleOtApproval(docId, 'approved', approveBtn); 
        }
        else if (rejectBtn) {
            // กดปุ่มไม่อนุมัติ
            const docId = rejectBtn.dataset.id;
            if (!docId) return; 

            rejectBtn.disabled = true;
            rejectBtn.textContent = 'กำลังบันทึก...';
            handleOtApproval(docId, 'rejected', rejectBtn);
        }
    });
}

    // ฟังก์ชันเปิด Modal ขอ OT (ฝั่ง User) (เวอร์ชันแก้ไข: ใช้วิธี format วันที่/เวลา ที่ปลอดภัยกว่า)
    const openOtModal = async () => {
        if (!currentUser) return;
        const today = toLocalDateKey(new Date());
        const docId = `${currentUser.uid}_${today}`;
        
        try {
            const workRecordDoc = await db.collection('work_records').doc(docId).get();
            if (!workRecordDoc.exists || !workRecordDoc.data().checkOut) {
                showNotification('ไม่พบข้อมูลการ Check-out ของวันนี้', 'error');
                return;
            }
            
            const checkoutTime = workRecordDoc.data().checkOut.timestamp.toDate();
            
            // [ ★ แก้ไข ★ ] ใช้วิธีดึงค่าและ .padStart(2, '0') เพื่อให้ได้ YYYY-MM-DD
            const year = checkoutTime.getFullYear();
            const month = (checkoutTime.getMonth() + 1).toString().padStart(2, '0');
            const day = checkoutTime.getDate().toString().padStart(2, '0');
            
            // [ ★ แก้ไข ★ ] ใช้วิธีดึงค่าและ .padStart(2, '0') เพื่อให้ได้ HH:mm
            const hours = checkoutTime.getHours().toString().padStart(2, '0');
            const minutes = checkoutTime.getMinutes().toString().padStart(2, '0');
            
            // เติมข้อมูลลง Modal
            otRequestDate.value = `${year}-${month}-${day}`;
            otStartTime.value = `${hours}:${minutes}`;
            otEndTime.value = '';
            otReason.value = '';
            
            otRequestModal.classList.remove('hidden');

        } catch (error) {
            showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
        }
    };

    // ฟังก์ชันปิด Modal ขอ OT
    const closeOtModal = () => {
        otRequestModal.classList.add('hidden');
    };

    // --- Event Listeners สำหรับ Modal ขอ OT (ฝั่ง User) ---
    requestOtBtn.addEventListener('click', openOtModal);
    cancelOtBtn.addEventListener('click', closeOtModal);
    otOverlay.addEventListener('click', closeOtModal);

    // Event Listener สำหรับปุ่ม "ส่งคำขอ OT" (เวอร์ชันแก้ไข: ตรวจสอบทุกช่อง)
    submitOtBtn.addEventListener('click', async () => {
        if (!currentUser || !currentUserData) return;

        const startTimeStr = otStartTime.value;
        const endTimeStr = otEndTime.value;
        const reason = otReason.value.trim();
        const dateStr = otRequestDate.value;

        // [ ★ แก้ไข ★ ] ตรวจสอบทุกช่อง (date, start, end, reason)
        if (!dateStr || !startTimeStr || !endTimeStr || !reason) {
            showNotification('กรุณากรอกข้อมูล วันที่, เวลาเริ่มต้น, เวลาสิ้นสุด และเหตุผล', 'warning');
            return;
        }
        
        if (endTimeStr <= startTimeStr) {
             showNotification('เวลาสิ้นสุดต้องอยู่หลังเวลาเริ่มต้น', 'warning');
            return;
        }

        submitOtBtn.disabled = true;
        submitOtBtn.textContent = 'กำลังส่ง...';

        try {
            // สร้าง Collection ใหม่สำหรับเก็บคำขอ OT
            const otRequestData = {
                userId: currentUser.uid,
                userName: currentUserData.fullName,
                userPhoto: currentUserData.profileImageUrl || currentUser.photoURL,
                date: firebase.firestore.Timestamp.fromDate(new Date(dateStr)),
                startTime: startTimeStr,
                endTime: endTimeStr,
                reason: reason,
                status: "pending", 
                submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                workRecordDocId: `${currentUser.uid}_${dateStr}` // อ้างอิงถึงเอกสาร Check-in
            };

            await db.collection('ot_requests').add(otRequestData);

            showNotification('ส่งคำขอ OT สำเร็จ!', 'success');
            closeOtModal();
            requestOtBtn.classList.add('hidden'); // ซ่อนปุ่มหลังจากส่งสำเร็จ

        } catch (error) {
            console.error("Error submitting OT request:", error);
            showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
        } finally {
            submitOtBtn.disabled = false;
            submitOtBtn.textContent = 'ส่งคำขอ';
        }
    });

    // 1. การสลับแท็บ (Pending/History)
    const otTabNav = document.getElementById('ot-tab-nav');
    if (otTabNav) {
        const tabs = otTabNav.querySelectorAll('a.ot-tab-btn');
        const contents = otTabNav.closest('.p-4').querySelectorAll('.ot-tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = tab.dataset.target;

                tabs.forEach(t => {
                    t.classList.remove('border-orange-500', 'text-orange-600', 'font-semibold');
                    t.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                });
                contents.forEach(c => c.classList.add('hidden'));

                tab.classList.add('border-orange-500', 'text-orange-600', 'font-semibold');
                tab.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                
                const targetContent = document.getElementById(targetId);
                if (targetContent) {
                    targetContent.classList.remove('hidden');
                }
            });
        });
    }

    // 2. โหลดรายการ OT ที่ "รออนุมัติ" (เวอร์ชันแก้ไข: ป้องกัน NaN และ บั๊ก loading)
    async function loadPendingOtRequests() {
        const listContainer = document.getElementById('ot-approval-list');
        
        // 1. ค้นหา loadingMsg ที่อยู่ใน HTML
        let loadingMsg = document.getElementById('ot-loading-msg');
        
        if (!listContainer) return; // ออกถ้าไม่เจอ Container

        // 2. เคลียร์เฉพาะ "การ์ด" เก่า, แต่ "เก็บ" loadingMsg ไว้
        listContainer.innerHTML = ''; 

        // 3. ตรวจสอบ: ถ้า loadingMsg ไม่มี (เช่น ถูกลบไป) ให้สร้างขึ้นมาใหม่
        if (!loadingMsg) {
            loadingMsg = document.createElement('p');
            loadingMsg.id = 'ot-loading-msg';
            loadingMsg.className = 'text-center text-gray-400 text-sm py-4';
        }

        // 4. แสดงข้อความ "กำลังโหลด..." และเพิ่มกลับเข้าไปใน Container
        loadingMsg.textContent = 'กำลังโหลดรายการ...';
        listContainer.appendChild(loadingMsg); 

        try {
            const userMap = new Map();
            const usersSnapshot = await db.collection('users').get();
            usersSnapshot.forEach(doc => userMap.set(doc.id, doc.data()));

            const querySnapshot = await db.collection('ot_requests')
                                          .where('status', '==', 'pending')
                                          // .orderBy('submittedAt', 'asc') // (ปิดไว้ก่อน กัน Error เรื่อง Index)
                                          .get();

            if (querySnapshot.empty) {
                // 5. ถ้าไม่เจอ: เปลี่ยนข้อความใน loadingMsg (จะไม่ถูกลบ)
                loadingMsg.textContent = 'ไม่มีรายการรออนุมัติ';
                return;
            }

            // 6. ถ้าเจอ: เคลียร์ Container (ลบ loadingMsg) แล้วเริ่มสร้างการ์ด
            listContainer.innerHTML = ''; 

            querySnapshot.forEach(doc => {
                const ot = doc.data();
                const docId = doc.id;
                const user = userMap.get(ot.userId);
                const displayName = user ? user.fullName : ot.userName;
                const displayPhoto = user ? user.profileImageUrl : ot.userPhoto;
                const otDate = ot.date.toDate().toLocaleDateString('th-TH');

                // [ ★ แก้ไข ★ ] ตรวจสอบข้อมูลก่อนคำนวณและแสดงผล
                let timeInfoText = '';
                let otDurationText = '(ข้อมูลไม่สมบูรณ์)';

                if (ot.startTime && ot.endTime) {
                    timeInfoText = `${otDate} (${ot.startTime} - ${ot.endTime})`;
                    
                    // แยกชั่วโมงและนาที
                    const [startH, startM] = ot.startTime.split(':').map(Number);
                    const [endH, endM] = ot.endTime.split(':').map(Number);
                    
                    // 1. แปลงเวลาทั้งหมดเป็นหน่วย "นาที" เพื่อให้คำนวณง่าย
                    const totalMinutes = (endH * 60 + endM) - (startH * 60 + startM);

                    // 2. คำนวณ OT ตามกฎ "นับทุก 30 นาที" (เศษปัดทิ้ง)
                    // สูตร: (นาทีรวม หาร 30) ปัดเศษทิ้ง แล้วคูณ 0.5
                    const otDurationHours = Math.floor(totalMinutes / 30) * 0.5;

                    // แสดงผล (จะลงท้ายด้วย .0 หรือ .5 เสมอ)
                    otDurationText = `(${otDurationHours.toFixed(1)} ชม.)`;

                } else {
                    timeInfoText = `${otDate} (เวลาไม่ถูกต้อง)`;
                }


                const cardHTML = `
                <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm ot-request-card">
                    <div class="flex items-start gap-3">
                        <img src="${displayPhoto || 'https://placehold.co/100x100/E2E8F0/475569?text=User'}" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                        <div>
                            <p class="font-semibold">${displayName}</p> 
                            <p class="text-sm font-medium text-orange-700">ขออนุมัติ OT ${otDurationText}</p>
                            <p class="text-sm text-gray-500 font-medium">${timeInfoText}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700 mt-3 p-3 bg-gray-50 rounded-lg whitespace-pre-wrap">${ot.reason || '(ไม่มีเหตุผล)'}</p>
                    
                    <div class="flex justify-end gap-3 mt-4">
                        <button data-id="${docId}" class="reject-ot-btn text-sm font-medium text-red-600 px-4 py-2 rounded-lg hover:bg-red-50">
                            ไม่อนุมัติ
                        </button>
                        <button data-id="${docId}" class="approve-ot-btn text-sm font-medium text-green-600 px-4 py-2 rounded-lg hover:bg-green-50">
                            อนุมัติ
                        </button>
                    </div>
                </div>
                `;
                listContainer.innerHTML += cardHTML;
            });

        } catch (error) {
            console.error("Error loading OT requests:", error);
            // 7. ถ้า Error: เปลี่ยนข้อความใน loadingMsg
            loadingMsg.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล';
            
            // (ถ้ามี Error เรื่อง Index ให้เปิด Console ดู)
            if (error.code === 'failed-precondition') {
                loadingMsg.textContent = 'ต้องสร้าง Index! (ดู Console F12)';
            }
        }
    }

    // 3. โหลด "ประวัติ" OT ทั้งหมด (เวอร์ชันแก้ไข: ป้องกัน NaN และ บั๊ก loading)
    async function loadOtHistory() {
        const listContainer = document.getElementById('ot-history-list');
        
        // 1. ค้นหา loadingMsg ที่อยู่ใน HTML
        let loadingMsg = document.getElementById('ot-history-loading-msg'); 
        
        if (!listContainer) return;

        // 2. เคลียร์การ์ดเก่า
        listContainer.innerHTML = ''; 

        // 3. สร้าง loadingMsg ถ้าไม่มี
        if (!loadingMsg) {
            loadingMsg = document.createElement('p');
            loadingMsg.id = 'ot-history-loading-msg';
            loadingMsg.className = 'text-center text-gray-400 text-sm py-4';
        }

        // 4. แสดง "กำลังโหลด..."
        loadingMsg.textContent = 'กำลังโหลดประวัติ...';
        listContainer.appendChild(loadingMsg);

        const statusFilter = document.getElementById('ot-history-status-filter').value;
        const userFilter = document.getElementById('ot-history-user-filter').value;

        try {
            let query = db.collection('ot_requests');

            if (statusFilter) query = query.where('status', '==', statusFilter);
            if (userFilter) query = query.where('userId', '==', userFilter);
            
            // [ ★ แก้ไข ★ ] (ปิดไว้ก่อน กัน Error เรื่อง Index)
            // if (!statusFilter || !userFilter) {
            //     query = query.orderBy('submittedAt', 'desc');
            // }

            const querySnapshot = await query.get();

            if (querySnapshot.empty) {
                // 5. ถ้าไม่เจอ:
                loadingMsg.textContent = 'ไม่พบประวัติ OT ตามเงื่อนไข';
                return;
            }
            
            // 6. ถ้าเจอ:
            listContainer.innerHTML = ''; 

            querySnapshot.forEach(doc => {
                const ot = doc.data();
                const otDate = ot.date.toDate().toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });

                let statusText, statusColorClass;
                switch (ot.status) {
                    case 'approved':
                        statusText = 'อนุมัติแล้ว';
                        statusColorClass = 'bg-green-100 text-green-800';
                        break;
                    case 'rejected':
                        statusText = 'ไม่อนุมัติ';
                        statusColorClass = 'bg-red-100 text-red-800';
                        break;
                    default:
                        statusText = 'รออนุมัติ';
                        statusColorClass = 'bg-yellow-100 text-yellow-800';
                }
                
                // [ ★ แก้ไข ★ ] ตรวจสอบข้อมูลก่อนแสดงผล
                let timeInfoText = '';
                if (ot.startTime && ot.endTime) {
                    timeInfoText = `${otDate} (${ot.startTime} - ${ot.endTime})`;
                } else {
                    timeInfoText = `${otDate} (เวลาไม่ถูกต้อง)`;
                }

                const cardHTML = `
                <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex items-start gap-3">
                        <img src="${ot.userPhoto || 'https://placehold.co/100x100/E2E8F0/475569?text=User'}" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                        <div>
                            <div class="flex flex-wrap items-center gap-2 mb-1">
                                <p class="font-semibold">${ot.userName}</p>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusColorClass}">${statusText}</span>
                            </div>
                            <p class="text-sm font-medium text-orange-700">คำขอ OT</p>
                            <p class="text-sm text-gray-500 font-medium">${timeInfoText}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700 mt-3 p-3 bg-gray-50 rounded-lg whitespace-pre-wrap">${ot.reason || '(ไม่มีเหตุผล)'}</p>
                    ${ot.status !== 'pending' ? `<p class="text-xs text-gray-400 mt-2 text-right">จัดการโดย: ${ot.approvedBy || 'N/A'}</p>` : ''}
                </div>
                `;
                listContainer.innerHTML += cardHTML;
            });

        } catch (error) {
            console.error("Error loading OT history:", error);
            loadingMsg.textContent = 'เกิดข้อผิดพลาด: ' + error.message;

            if (error.code === 'failed-precondition') {
                loadingMsg.textContent = 'ต้องสร้าง Index! (ดู Console F12)';
            }
        }
    }

    // 4. ฟังก์ชัน "อนุมัติ/ไม่อนุมัติ" OT (เวอร์ชันแก้ไข: ป้องกัน NaN)
    async function handleOtApproval(docId, newStatus, buttonElement) {
        if (!docId) return;

        const cardElement = buttonElement.closest('.ot-request-card');

        if (cardElement) {
            cardElement.querySelectorAll('button').forEach(btn => btn.disabled = true);
            cardElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            cardElement.style.opacity = '0.5';
        } else {
            buttonElement.disabled = true;
        }

        try {
            const otRequestRef = db.collection('ot_requests').doc(docId);
            const otDoc = await otRequestRef.get();
            if (!otDoc.exists) throw new Error("ไม่พบคำขอ OT");
            
            const otData = otDoc.data();

            // 1. อัปเดตเอกสาร ot_requests (เหมือนเดิม)
            await otRequestRef.update({
                status: newStatus,
                approvedBy: currentUserData.fullName
            });

            // 2. ถ้าสถานะเป็น "approved" ให้อัปเดต work_records ด้วย
            if (newStatus === 'approved') {
                
                // [ ★ แก้ไข ★ ] ตรวจสอบว่ามีข้อมูลครบหรือไม่
                if (otData.workRecordDocId && otData.startTime && otData.endTime)
                {
                    const workRecordRef = db.collection('work_records').doc(otData.workRecordDocId);

                    const [startH, startM] = otData.startTime.split(':').map(Number);
                    const [endH, endM] = otData.endTime.split(':').map(Number);
                    
                    // [ ★ แก้ไข ★ ] ตรวจสอบ NaN อีกชั้นก่อนคำนวณ
                    if (!isNaN(startH) && !isNaN(startM) && !isNaN(endH) && !isNaN(endM)) {
                        
                        const totalMinutes = (endH * 60 + endM) - (startH * 60 + startM);
                        const otDurationHours = Math.floor(totalMinutes / 30) * 0.5;

                        if (otDurationHours > 0) {
                            await workRecordRef.update({
                                'overtime.hours': firebase.firestore.FieldValue.increment(otDurationHours)
                            });
                        }
                    } else {
                        // ถ้าข้อมูลเป็น NaN (เช่น "abc".split(':') )
                         console.warn(`ไม่สามารถคำนวณ OT สำหรับ ${docId} ได้ เพราะเวลา (Time) ผิดพลาด`);
                         showNotification(`อนุมัติสำเร็จ (แต่คำนวณ OT ไม่ได้เพราะข้อมูลเวลาเสีย)`, 'warning');
                    }
                } else {
                    // ถ้าข้อมูลไม่ครบ (เช่น startTime เป็น null)
                    console.warn(`ไม่สามารถคำนวณ OT สำหรับ ${docId} ได้ เพราะข้อมูลไม่ครบ`);
                    showNotification(`อนุมัติสำเร็จ (แต่คำนวณ OT ไม่ได้เพราะข้อมูลเก่า)`, 'warning');
                }
            }
            
            if (newStatus === 'rejected') {
                 showNotification(`ปฏิเสธคำขอ OT สำเร็จ`, 'success');
            } else {
                 showNotification(`อนุมัติ OT สำเร็จ`, 'success');
            }

            // --- โค้ดส่วน UI (เหมือนเดิม) ---
            if (cardElement) {
                cardElement.style.opacity = '0';
                cardElement.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    cardElement.remove();
                    const listContainer = document.getElementById('ot-approval-list');
                    if (listContainer && listContainer.children.length === 0) {
                        let loadingMsg = document.getElementById('ot-loading-msg');
                        if (!loadingMsg) {
                            loadingMsg = document.createElement('p');
                            loadingMsg.id = 'ot-loading-msg';
                            loadingMsg.className = 'text-center text-gray-400 text-sm py-4';
                            listContainer.appendChild(loadingMsg);
                        }
                        loadingMsg.textContent = 'ไม่มีรายการรออนุมัติ';
                    }
                }, 300);
            } else {
                await loadPendingOtRequests(); 
            }

        } catch (error) {
            console.error("Error updating OT status:", error);
            showNotification('เกิดข้อผิดพลาดในการอัปเดต', 'error');

            if (cardElement) {
                cardElement.querySelectorAll('button').forEach(btn => btn.disabled = false);
                cardElement.style.opacity = '1';
                cardElement.style.transform = 'scale(1)';
            } else {
                buttonElement.disabled = false;
            }
        }
    }

    // 5. [ปรับปรุง] ฟังก์ชันเปิด Modal และดึงข้อมูล (รวม Report)
    async function openEditModal(docId, newUserId, newDateStr) {
        try {
            let record = {};
            let report = {};
            let checkinDate = null;
            let checkoutDate = null;
            let finalDocId = docId;

            if (docId) {
                // --- Case 1: แก้ไข (Logic เดิม) ---
                const workRecordDoc = await db.collection('work_records').doc(docId).get();
                if (!workRecordDoc.exists) {
                    alert("ไม่พบข้อมูลที่จะแก้ไข");
                    return;
                }
                record = workRecordDoc.data();
                report = record.report || {};
                checkinDate = record.checkIn.timestamp.toDate();
                checkoutDate = record.checkOut ? record.checkOut.timestamp.toDate() : null;
            
            } else {
                // --- Case 2: เพิ่มใหม่ (Logic ใหม่) ---
                finalDocId = `${newUserId}_${newDateStr}`; // ตั้ง ID ที่จะสร้าง
                
                // ตั้งเวลาเริ่มต้น 08:30 และ 17:30 ของวันที่เลือก
                const defaultCheckin = new Date(`${newDateStr}T08:30:00`);
                const defaultCheckout = new Date(`${newDateStr}T17:30:00`);

                checkinDate = defaultCheckin;
                checkoutDate = defaultCheckout;
                
                // report กับ record.checkIn.onSiteDetails จะเป็น object ว่าง
            }
            // --- เติมข้อมูลลง Modal (ใช้ร่วมกันทั้ง 2 กรณี) ---
            editDocIdInput.value = finalDocId;
            editCheckinTimeInput.value = toLocalISOString(checkinDate);
            editCheckoutTimeInput.value = toLocalISOString(checkoutDate);
            editOnsiteDetailsInput.value = record.checkIn?.onSiteDetails || '';

            // เติมข้อมูล Report
            if (report.workType) {
                editModalWorkTypeSelectedText.textContent = report.workType;
                editModalWorkTypeSelectedText.classList.remove('text-gray-500');
            } else {
                editModalWorkTypeSelectedText.textContent = '--- เลือกประเภทงาน ---';
                editModalWorkTypeSelectedText.classList.add('text-gray-500');
            }

            if (report.project) {
                editModalProjectSelectedText.textContent = report.project;
                editModalProjectSelectedText.classList.remove('text-gray-500');
            } else {
                editModalProjectSelectedText.textContent = '--- เลือกโครงการ ---';
                editModalProjectSelectedText.classList.add('text-gray-500');
            }

            // Logic การตั้งค่า Duration
            editModalCustomTimeInputs.classList.add('hidden');
            const standardDurations = ['ทั้งวัน (08:30 - 17:30)', 'ครึ่งวันเช้า (08:30 - 12:00)', 'ครึ่งวันบ่าย (13:00 - 17:30)'];
            if (report.duration) {
                if (standardDurations.includes(report.duration)) {
                    editModalDurationSelectedText.textContent = report.duration;
                    editModalDurationSelectedText.classList.remove('text-gray-500');
                } else {
                    editModalDurationSelectedText.textContent = 'กำหนดเวลา';
                    editModalDurationSelectedText.classList.remove('text-gray-500');
                    editModalCustomTimeInputs.classList.remove('hidden');
                    const times = report.duration.split(' - ');
                    if (times.length === 2) {
                        editModalCustomTimeStartInput.value = times[0];
                        editModalCustomTimeEndInput.value = times[1];
                    } else {
                        editModalCustomTimeStartInput.value = '';
                        editModalCustomTimeEndInput.value = '';
                    }
                }
            } else {
                // [แก้ไข] ถ้าเป็นการเพิ่มใหม่ ให้ตั้งค่าเริ่มต้นเป็น "ทั้งวัน"
                if (!docId) { 
                    editModalDurationSelectedText.textContent = 'ทั้งวัน (08:30 - 17:30)';
                    editModalDurationSelectedText.classList.remove('text-gray-500');
                } else {
                    editModalDurationSelectedText.textContent = '--- เลือกระยะเวลา ---';
                    editModalDurationSelectedText.classList.add('text-gray-500');
                }
                editModalCustomTimeStartInput.value = '';
                editModalCustomTimeEndInput.value = '';
            }

            editModal.classList.remove('hidden');

        } catch (error) {
            console.error("Error opening modal:", error);
            alert("เกิดข้อผิดพลาดในการเปิดหน้าแก้ไข");
        }
    }

    // [NEW FUNCTION] Load and display daily leave notifications
    async function loadDailyLeaveNotifications() {
        if (!currentUser) return;

        const today = new Date();
        // ตั้งเวลาเริ่มต้นของวันนี้
        const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0);
        // ตั้งเวลาสิ้นสุดของวันนี้
        const todayEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59, 999);

        try {
            // Query: Status เป็น 'approved' และช่วงวันลาครอบคลุมวันนี้
            const querySnapshot = await db.collection('leave_requests')
                .where('status', '==', 'approved')
                .where('startDate', '<=', todayEnd) // วันลาต้องเริ่มก่อนหรือตรงกับสิ้นวัน
                .where('endDate', '>=', todayStart)   // วันลาต้องสิ้นสุดหลังหรือตรงกับต้นวัน
                .get();

            let notifications = [];
            
            querySnapshot.forEach(doc => {
                const leave = doc.data();
                const startDate = leave.startDate.toDate();
                const endDate = leave.endDate.toDate();
                
                if (startDate <= todayEnd && endDate >= todayStart) {
                    notifications.push(leave);
                }
            });

            // --- Render UI ---
            let listHTML = '';
            
            if (notifications.length > 0) {
                notificationBadge.textContent = notifications.length;
                notificationBadge.classList.remove('hidden');

                    // --- เริ่มส่วนที่แก้ไข (เวอร์ชันคงดีไซน์เดิม + รูปโปรไฟล์) ---
                notifications.forEach(leave => {
                    const leaveTypeText = LEAVE_TYPE_MAP[leave.leaveType] || leave.leaveType;
                    
                    // กำหนดสีพื้นหลังและขอบตามประเภทการลา (คง Theme เดิมไว้)
                    let colorClass = 'bg-red-50 border-red-200'; // Default: Annual (พักร้อน)
                    let badgeClass = 'bg-red-100 text-red-700';

                    if (leave.leaveType === 'sick') { 
                         colorClass = 'bg-yellow-50 border-yellow-200';
                         badgeClass = 'bg-yellow-100 text-yellow-800';
                    } else if (leave.leaveType === 'personal') { 
                        colorClass = 'bg-blue-50 border-blue-200';
                        badgeClass = 'bg-blue-100 text-blue-800';
                    } else if (leave.leaveType === 'maternity') {
                        colorClass = 'bg-pink-50 border-pink-200';
                        badgeClass = 'bg-pink-100 text-pink-800';
                    }

                    // จัดการวันที่ให้แสดงผลสวยงาม
                    const isSameDay = leave.startDate.toDate().toLocaleDateString('th-TH') === leave.endDate.toDate().toLocaleDateString('th-TH');
                    const dateInfo = isSameDay
                        ? leave.startDate.toDate().toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' })
                        : `${leave.startDate.toDate().toLocaleDateString('th-TH', { day: 'numeric', month: 'short' })} - ${leave.endDate.toDate().toLocaleDateString('th-TH', { day: 'numeric', month: 'short' })}`;

                    // รูปโปรไฟล์ (ถ้าไม่มีใช้ Placeholder)
                    const userAvatar = leave.userPhoto || 'https://placehold.co/100x100/E2E8F0/475569?text=User';

                    // HTML Template
                    listHTML += `
                        <div class="p-3 mb-3 rounded-xl border shadow-sm ${colorClass} transition-all hover:shadow-md">
                            <div class="flex items-start gap-3">
                                <img src="${userAvatar}" 
                                     alt="${leave.userName}"
                                     class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm flex-shrink-0">
                                
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="text-sm font-bold text-gray-800 truncate">${leave.userName}</p>
                                            <p class="text-xs font-medium text-gray-600 mt-0.5">
                                                ${leaveTypeText}
                                            </p>
                                        </div>
                                        <span class="text-[10px] bg-white/60 px-2 py-1 rounded-lg text-gray-500 font-medium border border-gray-100">
                                            ${dateInfo}
                                        </span>
                                    </div>
                                    
                                    <div class="mt-2 pt-2 border-t border-black/5">
                                        <p class="text-xs text-gray-600 italic truncate">"${leave.reason}"</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                notificationBadge.classList.add('hidden');
                listHTML = `<p id="no-notifications-msg" class="text-center text-gray-500 text-sm">วันนี้ไม่มีพนักงานลา</p>`;
            }

            notificationList.innerHTML = listHTML;

        } catch (error) {
            console.error("Error loading daily leave notifications:", error);
            notificationList.innerHTML = `<p class="text-center text-red-500 text-sm">เกิดข้อผิดพลาดในการโหลด</p>`;
            notificationBadge.classList.add('hidden');
        }
    }

    // [NEW] Notification Bell Event Listener
    if (notificationBellBtn) {
        notificationBellBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            // สลับการแสดง Modal
            notificationModal.classList.toggle('hidden');
            
            // ลบ Badge เมื่อกดเปิด Modal
            notificationBadge.classList.add('hidden');
            notificationBadge.textContent = '0';

        });

        // ปิด Modal เมื่อคลิกนอกพื้นที่
        document.addEventListener('click', (e) => {
            if (notificationModal && !notificationModal.classList.contains('hidden') && 
                !notificationModal.contains(e.target) && !notificationBellBtn.contains(e.target)) {
                
                notificationModal.classList.add('hidden');
            }
        });
    }

    // --- ส่วนจัดการประวัติคำขอของพนักงาน (My Requests) ---

    // 1. ตัวแปร Elements
    const btnMyLeaveHistory = document.getElementById('btn-my-leave-history');
    const btnMyOtHistory = document.getElementById('btn-my-ot-history');
    
    const myLeaveModal = document.getElementById('my-leave-history-modal');
    const myOtModal = document.getElementById('my-ot-history-modal');
    
    const myLeaveContainer = document.getElementById('my-leave-list-container');
    const myOtContainer = document.getElementById('my-ot-list-container');

    // 2. ฟังก์ชัน Helper สำหรับปิด Modal ทั้งหมดที่กดปุ่มปิด หรือกดพื้นหลัง
    document.querySelectorAll('.close-modal-btn, .modal-overlay').forEach(el => {
        el.addEventListener('click', () => {
            myLeaveModal.classList.add('hidden');
            myOtModal.classList.add('hidden');
        });
    });

    // 3. โหลดประวัติการลาของฉัน
    if(btnMyLeaveHistory) {
        btnMyLeaveHistory.addEventListener('click', async () => {
            if (!currentUser) return;
            myLeaveModal.classList.remove('hidden');
            myLeaveContainer.innerHTML = '<p class="text-center text-gray-400 mt-4">กำลังโหลด...</p>';

            try {
                const snapshot = await db.collection('leave_requests')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('submittedAt', 'desc') // เรียงจากใหม่ไปเก่า
                    .limit(20)
                    .get();

                if (snapshot.empty) {
                    myLeaveContainer.innerHTML = '<p class="text-center text-gray-400 mt-10">ไม่พบประวัติการยื่นใบลา</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const leaveType = LEAVE_TYPE_MAP[data.leaveType] || data.leaveType;
                    
                    // จัดการวันที่
                    const start = data.startDate.toDate().toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: '2-digit' });
                    const end = data.endDate.toDate().toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: '2-digit' });
                    let dateText = `${start} - ${end}`;
                    if (data.durationType === 'hourly') {
                        dateText = `${start} (${data.startTime} - ${data.endTime})`;
                    }

                    // สถานะและการแสดงผล
                    // สถานะและการแสดงผล
                    let statusBadge = '';
                    let statusBorder = '';
                    
                    // [แก้ไข] เพิ่ม class: inline-block, w-24 (กว้างคงที่), text-center (จัดกลาง)
                    const badgeBaseClass = "inline-block w-24 text-center text-xs font-semibold px-2 py-1 rounded-full";

                    if (data.status === 'pending') {
                        statusBadge = `<span class="${badgeBaseClass} bg-yellow-100 text-yellow-800">รออนุมัติ</span>`;
                        statusBorder = 'border-l-4 border-yellow-400';
                    } else if (data.status === 'approved') {
                        statusBadge = `<span class="${badgeBaseClass} bg-green-100 text-green-800">อนุมัติแล้ว</span>`;
                        statusBorder = 'border-l-4 border-green-500';
                    } else if (data.status === 'rejected') {
                        statusBadge = `<span class="${badgeBaseClass} bg-red-100 text-red-800">ไม่อนุมัติ</span>`;
                        statusBorder = 'border-l-4 border-red-500';
                    }

                    html += `
                        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 ${statusBorder}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-gray-800 text-sm">${leaveType}</p>
                                    <p class="text-xs text-gray-500 mt-1">${dateText}</p>
                                </div>
                                ${statusBadge}
                            </div>
                            <p class="text-xs text-gray-600 mt-2 bg-gray-50 p-2 rounded">เหตุผล: ${data.reason}</p>
                            ${data.approvedBy ? `<p class="text-[10px] text-gray-400 text-right mt-1">ตรวจสอบโดย: ${data.approvedBy}</p>` : ''}
                        </div>
                    `;
                });
                myLeaveContainer.innerHTML = html;

            } catch (error) {
                console.error("Error loading my leaves:", error);
                let errorMsg = 'เกิดข้อผิดพลาด';
                if(error.code === 'failed-precondition') errorMsg = 'ระบบกำลังสร้างดัชนีข้อมูล (Index) กรุณารอสักครู่แล้วลองใหม่';
                myLeaveContainer.innerHTML = `<p class="text-center text-red-400 mt-10 text-sm">${errorMsg}</p>`;
            }
        });
    }
    // 4. โหลดประวัติ OT ของฉัน
    if(btnMyOtHistory) {
        btnMyOtHistory.addEventListener('click', async () => {
            if (!currentUser) return;
            myOtModal.classList.remove('hidden');
            myOtContainer.innerHTML = '<p class="text-center text-gray-400 mt-4">กำลังโหลด...</p>';

            try {
                const snapshot = await db.collection('ot_requests')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('submittedAt', 'desc')
                    .limit(20)
                    .get();

                if (snapshot.empty) {
                    myOtContainer.innerHTML = '<p class="text-center text-gray-400 mt-10">ไม่พบประวัติการขอ OT</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.date.toDate().toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: '2-digit' });
                    const timeText = `${data.startTime} - ${data.endTime}`;

                    let statusBadge = '';
                    let statusBorder = '';
                    if (data.status === 'pending') {
                        statusBadge = '<span class="bg-yellow-100 text-yellow-800 text-xs font-semibold px-2 py-1 rounded-full">รออนุมัติ</span>';
                        statusBorder = 'border-l-4 border-yellow-400';
                    } else if (data.status === 'approved') {
                        statusBadge = '<span class="bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded-full">อนุมัติแล้ว</span>';
                        statusBorder = 'border-l-4 border-green-500';
                    } else if (data.status === 'rejected') {
                        statusBadge = '<span class="bg-red-100 text-red-800 text-xs font-semibold px-2 py-1 rounded-full">ไม่อนุมัติ</span>';
                        statusBorder = 'border-l-4 border-red-500';
                    }

                    html += `
                        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 ${statusBorder}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-gray-800 text-sm">ขอ OT: ${date}</p>
                                    <p class="text-xs text-gray-500 mt-1">เวลา: ${timeText}</p>
                                </div>
                                ${statusBadge}
                            </div>
                            <p class="text-xs text-gray-600 mt-2 bg-gray-50 p-2 rounded">รายละเอียด: ${data.reason}</p>
                            ${data.approvedBy ? `<p class="text-[10px] text-gray-400 text-right mt-1">ตรวจสอบโดย: ${data.approvedBy}</p>` : ''}
                        </div>
                    `;
                });
                myOtContainer.innerHTML = html;

            } catch (error) {
                console.error("Error loading my OT:", error);
                let errorMsg = 'เกิดข้อผิดพลาด';
                if(error.code === 'failed-precondition') errorMsg = 'ระบบกำลังสร้างดัชนีข้อมูล (Index) กรุณารอสักครู่แล้วลองใหม่';
                myOtContainer.innerHTML = `<p class="text-center text-red-400 mt-10 text-sm">${errorMsg}</p>`;
            }
        });
    }

    // ฟังก์ชันโหลดข้อมูลรายงานตามวันที่เลือก (ฉบับสมบูรณ์)
    // ฟังก์ชันโหลดข้อมูลรายงาน (ฉบับใช้ปุ่มสีฟ้าเดิม)
    async function loadReportForSelectedDate() {
        if (!currentUser) return;
        
        const selectedDate = reportDateInput.value;
        if (!selectedDate) return;

        const docId = `${currentUser.uid}_${selectedDate}`;
        
        // สถานะกำลังโหลด
        saveReportBtn.textContent = 'กำลังตรวจสอบข้อมูล...';
        saveReportBtn.disabled = true;

        try {
            const doc = await db.collection('work_records').doc(docId).get();
            
            resetReportForm();

            // ★★★ บังคับใช้ Class เดิม (ปุ่มสีฟ้า) เสมอ ไม่ว่าจะสถานะไหน ★★★
            saveReportBtn.className = 'btn-primary w-full py-3 text-base';

            if (doc.exists && doc.data().report) {
                // --- กรณีมีรายงานแล้ว (โหมดแก้ไข) ---
                const report = doc.data().report;
                
                // คืนค่าข้อมูลลงในฟอร์ม
                workTypeSelectedText.textContent = report.workType || 'เลือกประเภทงาน...';
                if (report.workType) workTypeSelectedText.classList.remove('text-gray-500');
                
                projectSelectedText.textContent = report.project || 'เลือกโครงการ...';
                if (report.project) projectSelectedText.classList.remove('text-gray-500');
                
                // คืนค่าระยะเวลา
                const standardDurations = ['ทั้งวัน (08:30 - 17:30)', 'ครึ่งวันเช้า (08:30 - 12:00)', 'ครึ่งวันบ่าย (13:00 - 17:30)'];
                if (report.duration && !standardDurations.includes(report.duration)) {
                    durationSelectedText.textContent = 'กำหนดเวลา';
                    durationSelectedText.classList.remove('text-gray-500');
                    customTimeInputs.classList.remove('hidden');
                    
                    const times = report.duration.split(' - ');
                    if (times.length === 2) {
                        customTimeStartInput.value = times[0];
                        customTimeEndInput.value = times[1];
                    }
                } else {
                    durationSelectedText.textContent = report.duration || 'เลือกระยะเวลา...';
                    if (report.duration) durationSelectedText.classList.remove('text-gray-500');
                }

                // ★ เปลี่ยนแค่ข้อความ (Style ปุ่มยังคงเป็นสีฟ้าเหมือนเดิม) ★
                saveReportBtn.textContent = 'บันทึกการแก้ไข'; 

            } else {
                // --- กรณีสร้างใหม่ ---
                saveReportBtn.textContent = 'บันทึกข้อมูล';
            }

        } catch (error) {
            console.error("Error loading report:", error);
            alert("เกิดข้อผิดพลาดในการโหลดข้อมูล: " + error.message);
        } finally {
            saveReportBtn.disabled = false;
        }
    }
    
    // เพิ่ม Event Listener เมื่อเปลี่ยนวันที่ 
    if (reportDateInput) {
        reportDateInput.addEventListener('change', loadReportForSelectedDate);
    }

    function switchRole(role) {
    if (role === 'member') {
        memberSection.classList.remove('hidden');
        leaderSection.classList.add('hidden');
        
        roleMemberBtn.classList.add(...activeClass);
        roleMemberBtn.classList.remove(...inactiveClass);
        roleLeaderBtn.classList.remove(...activeClass);
        roleLeaderBtn.classList.add(...inactiveClass);
        
        // ปิดปุ่ม Check In หลัก เพราะสมาชิกจะ Check in ผ่าน QR
        document.getElementById('checkin-btn').classList.add('hidden'); 
    } else {
        memberSection.classList.add('hidden');
        leaderSection.classList.remove('hidden');
        
        roleLeaderBtn.classList.add(...activeClass);
        roleLeaderBtn.classList.remove(...inactiveClass);
        roleMemberBtn.classList.remove(...activeClass);
        roleMemberBtn.classList.add(...inactiveClass);

        // Leader สร้างห้องแล้วถือว่า Check-in เลย หรือกดปุ่มสร้างห้อง
        document.getElementById('checkin-btn').classList.add('hidden');
    }
}

if(roleMemberBtn) roleMemberBtn.addEventListener('click', () => switchRole('member'));
if(roleLeaderBtn) roleLeaderBtn.addEventListener('click', () => switchRole('leader'));


// --- 2. Logic ฝั่ง Leader (สร้างห้อง) ---
const createRoomBtn = document.getElementById('create-room-btn');
const roomQrContainer = document.getElementById('room-qr-container');
const roomMembersList = document.getElementById('room-members-list');

if (createRoomBtn) {
    createRoomBtn.addEventListener('click', async () => { // <--- 1. ต้องมี async ตรงนี้
        const project = document.getElementById('room-project-input').value;
        const locationName = document.getElementById('room-location-input').value;

        if (!project || !locationName) {
            alert("กรุณากรอกชื่อโครงการและสถานที่");
            return;
        }
        
        if (!currentUser) {
            alert("คุณยังไม่ได้เข้าสู่ระบบ หรือ Session หมดอายุ");
            return;
        }

        if (!latestPosition) {
             alert("กรุณารอสัญญาณ GPS สักครู่...");
             return;
        }

        createRoomBtn.disabled = true;
        createRoomBtn.textContent = "กำลังสร้างห้อง...";

        // ------------------------------------------------------------------
        // [จุดที่แก้] โหลด Library QR Code ก่อนเริ่มทำงาน (ต้องมี await)
        // ------------------------------------------------------------------
        if (typeof QRCode === 'undefined') { // เช็คว่ามี QRCode หรือยัง ถ้าไม่มีค่อยโหลด
            try {
                // รอให้โหลดเสร็จก่อนค่อยไปต่อ
                await loadScript("https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js");
            } catch (e) {
                console.error(e);
                alert("ไม่สามารถโหลดระบบ QR Code ได้ กรุณาตรวจสอบอินเทอร์เน็ต");
                createRoomBtn.disabled = false;
                createRoomBtn.textContent = "สร้างห้อง Check-in";
                return; // จบการทำงานทันทีถ้าโหลดไม่ได้
            }
        }
        // ------------------------------------------------------------------

        try {
            // 1. สร้าง Room ID
            const roomId = `ROOM_${currentUser.uid}_${Date.now()}`;
            
            // ... (โค้ดส่วนสร้าง roomData และ Firestore เหมือนเดิม) ...
            const roomData = {
                roomId: roomId,
                leaderId: currentUser.uid,
                leaderName: currentUserData.fullName,
                project: project,
                locationName: locationName,
                gpsLocation: new firebase.firestore.GeoPoint(latestPosition.coords.latitude, latestPosition.coords.longitude),
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                isActive: true,
                members: [] 
            };

            await db.collection('onsite_rooms').doc(roomId).set(roomData);
            await performCheckIn(roomId, project, locationName, 'leader', currentUser.uid);

            // 4. สร้าง QR Code (ตอนนี้ QRCode จะไม่ error แล้วเพราะเรา await โหลดมาแล้ว)
            document.getElementById('qrcode').innerHTML = ""; 
            new QRCode(document.getElementById("qrcode"), {
                text: roomId,
                width: 180,
                height: 180
            });

            // 5. แสดง UI
            createRoomBtn.classList.add('hidden');
            roomQrContainer.classList.remove('hidden');
            listenToRoomMembers(roomId);

        } catch (error) {
            console.error("Error creating room:", error);
            alert("เกิดข้อผิดพลาด: " + error.message);
            createRoomBtn.disabled = false;
            createRoomBtn.textContent = "สร้างห้อง Check-in";
        }
    });
}

function listenToRoomMembers(roomId) {
    roomUnsubscribe = db.collection('onsite_rooms').doc(roomId)
        .onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                const members = data.members || [];
                
                // อัปเดตรายชื่อสมาชิกที่หน้าจอ Leader
                if (members.length === 0) {
                    roomMembersList.innerHTML = '<li class="text-gray-400 italic">รอสมาชิกสแกน...</li>';
                } else {
                    // ดึงชื่อจาก users collection (แบบง่ายอาจจะเก็บชื่อใน array members เลยก็ได้ แต่ที่นี่สมมติเก็บแค่ uid)
                    // เพื่อความง่าย แนะนำให้เก็บ {uid, name} ใน members array ตอนจอย
                    roomMembersList.innerHTML = members.map(m => 
                        `<li class="text-green-600 font-medium">✓ ${m.name}</li>`
                    ).join('');
                }
            }
        });
}


// --- 3. Logic ฝั่ง Member (Scan QR) ---
const startScanBtn = document.getElementById('start-scan-btn');

if(startScanBtn) {
    startScanBtn.addEventListener('click', async () => { // เติม async
        
        // 1. สั่งโหลด Library กล้อง
        try {
            // ใส่ URL ของ html5-qrcode
            await loadScript("https://unpkg.com/html5-qrcode");
        } catch (e) {
            alert("โหลดกล้องไม่สำเร็จ");
            return;
        }
        
        const html5QrCode = new Html5Qrcode("reader");
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            // หยุดสแกนเมื่อเจอ QR
            html5QrCode.stop().then(() => {
                document.getElementById('reader').classList.add('hidden');
                document.getElementById('scan-status').textContent = "สแกนสำเร็จ! กำลังตรวจสอบ...";
                joinRoom(decodedText); // decodedText คือ roomId
            }).catch(err => {
                console.log("Stop failed ", err);
            });
        };
        
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        // เปิดกล้อง
        document.getElementById('reader').classList.remove('hidden');
        html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
        .catch(err => {
            alert("ไม่สามารถเปิดกล้องได้: " + err);
        });
    });
}

async function joinRoom(roomId) {
    if(!currentUser) return;

    try {
        // 1. ตรวจสอบว่าห้องมีอยู่จริงและยัง Active อยู่
        const roomRef = db.collection('onsite_rooms').doc(roomId);
        const roomDoc = await roomRef.get();

        if (!roomDoc.exists || !roomDoc.data().isActive) {
            alert("ห้องนี้ปิดไปแล้ว หรือรหัสไม่ถูกต้อง");
            document.getElementById('scan-status').textContent = "กดปุ่มเพื่อเริ่มสแกนใหม่";
            return;
        }

        const roomData = roomDoc.data();

        // 2. ตรวจสอบระยะห่างกับ Leader (Optional: ป้องกันการส่งรูป QR ให้กัน)
        // หากต้องการเข้มงวด ให้เช็ค distance ระหว่าง latestPosition กับ roomData.gpsLocation
        
        // 3. ทำการ Check-in
        await performCheckIn(roomId, roomData.project, roomData.locationName, 'member', roomData.leaderId);

        // 4. อัปเดตชื่อลงในรายชื่อสมาชิกของห้อง
        await roomRef.update({
            members: firebase.firestore.FieldValue.arrayUnion({
                uid: currentUser.uid,
                name: currentUserData.fullName
            })
        });

        alert(`เข้าร่วมกลุ่ม "${roomData.project}" สำเร็จ!`);
        // รีเฟรชหน้าหรือเปลี่ยนสถานะ UI
        location.reload(); // หรือ updateUIToCheckedIn()

    } catch (error) {
        console.error("Join room error:", error);
        alert("เกิดข้อผิดพลาดในการเข้าร่วม: " + error.message);
    }
}

// --- 4. ฟังก์ชัน Check-in รวม (ใช้ทั้ง Leader และ Member) ---
// --- 4. ฟังก์ชัน Check-in รวม (ใช้ทั้ง Leader และ Member) ---
// [แก้ไข] เพิ่ม parameter 'leaderId' ต่อท้าย
async function performCheckIn(roomId, project, locationName, role, leaderId) {
    const now = new Date();
    const docId = `${currentUser.uid}_${toLocalDateKey(now)}`;

    const workRecord = {
        userId: currentUser.uid,
        date: firebase.firestore.Timestamp.fromDate(now),
        checkIn: {
            timestamp: firebase.firestore.Timestamp.fromDate(now),
            location: new firebase.firestore.GeoPoint(latestPosition.coords.latitude, latestPosition.coords.longitude),
            // เพิ่ม google map
            googleMapLink: `https://www.google.com/maps/search/?api=1&query=${latestPosition.coords.latitude},${latestPosition.coords.longitude}`,
            accuracy: latestPosition.coords.accuracy,
            
            // ระบุประเภทงานเป็น Group Onsite
            workType: 'onsite_group', 
            
            // เก็บข้อมูลห้องไว้ด้วย
            roomId: roomId,
            leaderId: leaderId, // [แก้ไข] ใช้ค่าจาก parameter แทน roomData.leaderId
            onSiteDetails: `${locationName} (Group: ${project})`,
            photoUrl: null // ไม่ต้องใช้รูปเพราะมี Leader ยืนยันแล้ว
        },
        status: "checked_in",
        report: null, // ยังไม่มีรายงาน
        checkOut: null,
        overtime: null
    };

    await db.collection('work_records').doc(docId).set(workRecord);
    
    // อัปเดต UI หลักให้เป็น Checked In
    updateUIToCheckedIn();
    showNotification("บันทึกเวลาเข้างานเรียบร้อย");
}

// เพิ่ม Logic การกดปุ่ม On-site ใน Event Listener เดิม
workTypeButtons.forEach(button => {
        button.addEventListener('click', () => {
            // 1. เปลี่ยนสีปุ่ม (เหมือนเดิม)
            workTypeButtons.forEach(btn => {
                btn.classList.remove('bg-sky-500', 'text-white', 'shadow');
                btn.classList.add('text-gray-600');
            });
            button.classList.add('bg-sky-500', 'text-white', 'shadow');
            
            // 2. อัปเดตตัวแปร selectedWorkType
            selectedWorkType = button.dataset.workType;

            // 3. Logic การแสดงผล (แก้ไขใหม่)
            if (selectedWorkType === 'on_site') {
                // แสดงฟอร์ม QR
                document.getElementById('onsite-details-form').classList.remove('hidden');
                
                // *** [แก้ไข] สั่งซ่อนทั้งปุ่ม Check In และ Check Out เสมอเมื่อเข้าโหมด On-site ***
                document.getElementById('checkin-btn').classList.add('hidden');
                document.getElementById('checkout-btn').classList.add('hidden');
                document.getElementById('request-ot-btn').classList.add('hidden'); // ซ่อนปุ่ม OT ด้วยถ้ามี

                // เริ่มต้นที่โหมด Member
                switchRole('member');
            } else {
                // ซ่อนฟอร์ม QR
                document.getElementById('onsite-details-form').classList.add('hidden');
                
                // *** [แก้ไข] ให้เช็คสถานะล่าสุดเพื่อโชว์ปุ่มที่ถูกต้อง (เข้า หรือ ออก) ***
                checkUserWorkStatus(); 
            }
        });
    });

    // ตัวอย่างฟังก์ชันเมื่อ Leader กดปุ่ม "ส่งรายงานกลุ่ม"
async function submitGroupReport(roomId, reportData) {
    // 1. ดึงข้อมูลห้องเพื่อเอารายชื่อสมาชิก
    const roomDoc = await db.collection('onsite_rooms').doc(roomId).get();
    const members = roomDoc.data().members || [];

    // 2. เตรียมข้อมูล Report
    const reportPayload = {
        workType: reportData.workType, // เช่น "ติดตั้งระบบไฟ"
        project: reportData.project,   // เช่น "Project A"
        duration: "ทั้งวัน (08:30 - 17:30)",
        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
        submittedBy: "Leader" // ระบุว่าหัวหน้าทำให้
    };

    // 3. วนลูปอัปเดตให้ทุกคนในลิสต์ (รวมถึงตัว Leader เองด้วย)
    const batch = db.batch(); // ใช้ Batch เพื่อความเร็วและชัวร์
    const dateKey = toLocalDateKey(new Date()); // ฟังก์ชันแปลงวันที่เป็น YYYY-MM-DD

    members.forEach(member => {
        const docId = `${member.uid}_${dateKey}`;
        const ref = db.collection('work_records').doc(docId);
        
        // สั่งอัปเดตเฉพาะส่วน report
        batch.update(ref, { report: reportPayload });
    });

    // 4. ยิงขึ้น Database ทีเดียว
    await batch.commit();
    alert("บันทึกรายงานให้สมาชิก " + members.length + " คน เรียบร้อยแล้ว!");
}

});

</script>
</body>
</html> 