<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Prompt:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-functions-compat.js"></script>

    <link rel="manifest" href="manifest.json">

    <meta name="theme-color" content="#38BDF8">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TimeTracker">
    <link rel="apple-touch-icon" href="icons/icon-180.png">

    <style>
        /* CSS ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) */
        :root {
            --bg-color: #F9FAFB;
            --card-bg: #FFFFFF;
            --primary-color: #38BDF8; /* Light Blue */
            --primary-hover: #0EA5E9;
            --secondary-color: #34D399; /* Mint Green */
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
        }
        body {
            font-family: 'Prompt', 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
        }
        .card {
            background-color: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bottom-nav { box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.08); }
        .nav-item.active svg { color: var(--primary-color); }
        .nav-item.active span { color: var(--primary-color); font-weight: 600; }
        .checkin-btn-anim { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(56, 189, 248, 0); }
        }

        .checkout-btn-anim {
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        .completed-btn-anim {
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
        }
        
        /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
        #edit-modal.hidden {
            display: none;
        }
        /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô */
        #confirm-modal.hidden {
             display: none;
        }
        /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° Plan ‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ */
        #plan-new-form.hidden {
             display: none;
        }
        
    </style>
</head>
<body class="antialiased">

    <div id="loading-spinner" class="min-h-screen flex items-center justify-center bg-gray-50">
        <svg class="animate-spin h-10 w-10 text-sky-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <div id="login-page" class="hidden page min-h-screen flex flex-col items-center justify-center p-4 bg-gray-50">
        <div class="w-full max-w-sm text-center">
            <svg class="w-20 h-20 mx-auto text-sky-500 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
            <h1 class="text-2xl font-bold text-gray-800">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h1>
            <p class="text-gray-500 mb-8">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</p>
            
            <button id="line-login-btn" class="bg-green-500 hover:bg-green-600 text-white w-full py-4 text-lg font-semibold rounded-xl transition-all">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE
            </button>
            <p class="text-gray-400 text-sm my-4">‡∏´‡∏£‡∏∑‡∏≠</p>
            <div class="space-y-4">
                <input type="text" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" class="w-full p-4 text-center border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:outline-none">
                <input type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-4 text-center border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:outline-none">
            </div>
            <button id="login-btn" class="btn-primary w-full mt-8 py-4 text-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="app-container" class="hidden pb-24">
        
        <main id="main-content" class="p-4 md:p-6">

            <div id="check-in-out-page" class="page space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</p>
                        <h2 id="user-display-name" class="text-2xl font-bold"></h2>
                    </div>
                    <div class="w-12 h-12 bg-gray-200 rounded-full overflow-hidden">
                        <img id="user-profile-pic" src="https://placehold.co/100x100/E2E8F0/475569?text=User" alt="‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå" class="w-full h-full object-cover">
                    </div>
                </div>

                <div class="card text-center">
                    <p class="text-gray-400 text-sm">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                    <p id="current-time" class="text-5xl font-bold my-4"></p>
                    
                    <button id="checkin-btn" class="w-48 h-48 bg-sky-400 text-white rounded-full flex flex-col items-center justify-center mx-auto shadow-lg hover:bg-sky-500 transition-all duration-300 checkin-btn-anim">
                        <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="text-2xl font-semibold mt-2">Check In</span>
                    </button>

                    <button id="checkout-btn" class="hidden w-48 h-48 bg-red-500 text-white checkout-btn-anim rounded-full flex flex-col items-center justify-center mx-auto shadow-lg hover:bg-red-600 transition-all duration-300">
                        <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        <span class="text-2xl font-semibold mt-2">Check Out</span>
                    </button>
                </div>

                <div class="card space-y-4">
                    <div>
                        <h3 class="font-semibold mb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
                        <div id="work-type-selector" class="flex bg-gray-100 rounded-xl p-1">
                            <button data-work-type="in_factory" class="work-type-btn flex-1 p-2 rounded-lg bg-sky-500 text-white shadow">‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</button>
                            <button data-work-type="on_site" class="work-type-btn flex-1 p-2 rounded-lg text-gray-600">On-site</button>
                        </div>
                    </div>
                    
                    <div id="onsite-details-form" class="hidden pt-4 border-t border-gray-100 space-y-4">
                        <input id="onsite-location-input" type="text" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:outline-none">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏∑‡∏ô</label>
                            <div class="flex items-center space-x-4">
                                <input type="file" id="photo-upload-input" class="hidden" accept="image/*" capture="user">
                                <button id="take-photo-btn" class="w-full flex items-center justify-center p-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:bg-gray-50">
                                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                    <span>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</span>
                                </button>
                            </div>
                            <img id="photo-preview" src="" class="hidden mt-4 rounded-xl max-h-40 mx-auto"/>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-gray-100">
                         <h3 class="font-semibold mb-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                         <div id="location-status" class="flex items-center p-3 rounded-xl bg-gray-100 text-gray-700">
                            <svg id="location-icon" class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
                            <span id="location-text" class="font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="font-semibold mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                    <div id="summary-card-content" class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Check-in:</span>
                            <span id="summary-checkin-time" class="font-medium text-gray-400">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Check-out:</span>
                            <span id="summary-checkout-time" class="font-medium text-gray-400">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</span>
                            <span id="summary-work-hours" class="font-medium text-gray-400">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="report-page" class="page space-y-6">
                <h2 class="text-2xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>
                <div class="card space-y-4">
                    <h3 class="font-semibold">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
                    <div>
                        <label class="text-sm font-medium text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
                        <div id="work-type-dropdown" class="relative mt-1">
                            
                            <button id="work-type-btn" type="button" class="w-full p-3 bg-white border border-gray-300 rounded-xl text-left flex justify-between items-center focus:ring-2 focus:ring-sky-400 focus:outline-none">
                                <span id="work-type-selected-text" class="text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô...</span>
                                <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>

                            <div id="work-type-panel" class="hidden absolute z-10 w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg">
                                <div class="p-2 border-b border-gray-100">
                                    <input id="work-type-search" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-sky-400 focus:outline-none">
                                </div>
                                
                                <div id="work-type-options" class="max-h-60 overflow-y-auto p-1">
                        </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-600">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                        
                        <div class="mt-2 p-3 bg-violet-50 border border-violet-200 rounded-lg text-sm text-violet-800 flex items-start space-x-3">
                            <svg class="w-5 h-5 flex-shrink-0 mt-0.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                            <div>
                                <b>Project No. :</b> ‡∏´‡∏≤‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏á‡∏≤‡∏ô Project ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà <b>FAC</b><br>
                                <i>(‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ: H1-0554 ‚Üí 1554, SI2303 ‚Üí 2303)</i>
                            </div>
                        </div>

                        <div id="project-dropdown" class="relative mt-2">
                            <button id="project-btn" type="button" class="w-full p-3 bg-white border border-gray-300 rounded-xl text-left flex justify-between items-center focus:ring-2 focus:ring-sky-400 focus:outline-none">
                                <span id="project-selected-text" class="text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£...</span>
                                <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                            <div id="project-panel" class="hidden absolute z-10 w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg">
                                <div class="p-2 border-b border-gray-100">
                                    <input id="project-search" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-sky-400 focus:outline-none">
                                </div>
                                <div id="project-options" class="max-h-60 overflow-y-auto p-1">
                        </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-600">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                        
                        <div id="duration-dropdown" class="relative mt-1">
                            <button id="duration-btn" type="button" class="w-full p-3 bg-white border border-gray-300 rounded-xl text-left flex justify-between items-center focus:ring-2 focus:ring-sky-400 focus:outline-none">
                                <span id="duration-selected-text" class="text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤...</span>
                                <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                            <div id="duration-panel" class="hidden absolute z-10 w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg">
                                <div id="duration-options" class="p-1">
                                    <div class="duration-option p-2 rounded-lg hover:bg-sky-50 cursor-pointer">‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô (08:30 - 17:30)</div>
                                    <div class="duration-option p-2 rounded-lg hover:bg-sky-50 cursor-pointer">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ (08:30 - 12:00)</div>
                                    <div class="duration-option p-2 rounded-lg hover:bg-sky-50 cursor-pointer">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ö‡πà‡∏≤‡∏¢ (13:00 - 17:30)</div>
                                    <div class="duration-option p-2 rounded-lg hover:bg-sky-50 cursor-pointer">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤</div>
                                </div>
                            </div>
                        </div>

                        <div id="custom-time-inputs" class="hidden mt-3 grid grid-cols-2 gap-3 p-3 bg-gray-50 rounded-lg">
    <div>
        <label class="text-xs font-medium text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
        <input type="time" id="custom-time-start-input" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400 focus:outline-none">
    </div>
    <div>
        <label class="text-xs font-medium text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
        <input type="time" id="custom-time-end-input" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400 focus:outline-none">
    </div>
</div>
                    </div>
                    <button id="save-report-btn" class="btn-primary w-full py-3 text-base">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
                
                <div class="space-y-4">
                    <h3 class="font-semibold text-lg">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                    <div id="sent-reports-container" class="space-y-3">
                        <p id="no-reports-message" class="text-center text-gray-500 text-sm py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                    </div>
                </div>
            </div>
            
            <div id="admin-dashboard-page" class="page space-y-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-sky-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 11a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                        <span>Admin Dashboard</span>
                    </h2>
                    <p class="text-gray-500 mt-1">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
                </div>


                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                    <div class="space-y-8">
                        <div class="card">
                            <h3 class="font-semibold text-lg text-gray-800 mb-4">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
                            <button id="admin-go-to-calendar-btn" class="w-full flex items-center justify-center text-sm font-medium text-violet-600 p-3 mb-4 rounded-lg bg-violet-50 hover:bg-violet-100 border border-violet-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <span>‡∏î‡∏π‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô (‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô/‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)</span>
                            </button>
                             <div class="space-y-6">
                                <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                                    <h4 class="font-semibold text-gray-700 mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</h4>
                                    <div class="space-y-3">
                                        <div class="flex items-center space-x-2">
                                            <input type="text" id="add-work-type-input" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà..." class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400 focus:outline-none text-sm">
                                            <button id="add-work-type-btn" class="bg-sky-500 text-white font-semibold p-3 rounded-lg hover:bg-sky-600 transition-colors flex-shrink-0">
                                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <div class="relative w-full">
                                                <button id="delete-work-type-select-btn" type="button" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-left flex justify-between items-center focus:ring-2 focus:ring-red-400 focus:outline-none text-sm">
                                                    <span id="delete-work-type-selected-text" class="text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö...</span>
                                                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                                </button>
                                                <div id="delete-work-type-panel" class="hidden absolute z-10 w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg">
                                                    <div id="delete-work-type-options" class="max-h-40 overflow-y-auto p-1"></div>
                                                </div>
                                            </div>
                                            <button id="delete-work-type-btn" class="bg-red-500 text-white font-semibold p-3 rounded-lg hover:bg-red-600 transition-colors flex-shrink-0">
                                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                                    <h4 class="font-semibold text-gray-700 mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h4>
                                    <div class="space-y-3">
                                         <div class="flex items-center space-x-2">
                                            <input type="text" id="add-project-input" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà..." class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400 focus:outline-none text-sm">
                                            <button id="add-project-btn" class="bg-sky-500 text-white font-semibold p-3 rounded-lg hover:bg-sky-600 transition-colors flex-shrink-0">
                                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <div class="relative w-full">
                                                <button id="delete-project-select-btn" type="button" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-left flex justify-between items-center focus:ring-2 focus:ring-red-400 focus:outline-none text-sm">
                                                    <span id="delete-project-selected-text" class="text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö...</span>
                                                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                                </button>
                                                <div id="delete-project-panel" class="hidden absolute z-10 w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg">
                                                    <div id="delete-project-options" class="max-h-40 overflow-y-auto p-1"></div>
                                                </div>
                                            </div>
                                            <button id="delete-project-btn" class="bg-red-500 text-white font-semibold p-3 rounded-lg hover:bg-red-600 transition-colors flex-shrink-0">
                                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                                    <h4 class="font-semibold text-gray-700 mb-3">üóìÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h4>
                                    <div class="space-y-3">
                                        
                                        <div>
                                            <label class="text-sm font-medium text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                            <input type="date" id="admin-calendar-date-input" class="w-full mt-1 p-3 bg-white border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:outline-none text-sm">
                                        </div>

                                        <div class="grid grid-cols-2 gap-2">
                                            <button id="add-holiday-btn" class="flex items-center justify-center gap-2 w-full p-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition-colors text-sm">
                                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                                                <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span>
                                            </button>
                                            <button id="add-working-saturday-btn" class="flex items-center justify-center gap-2 w-full p-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors text-sm">
                                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                                <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>
                                            </button>
                                        </div>

                                        <div class="pt-3 border-t border-gray-200">
                                            <h5 class="text-sm font-semibold text-gray-600 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö)</h5>
                                            <div id="holiday-list-container" class="space-y-2 max-h-60 overflow-y-auto">
                                                <p class="text-xs text-center text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card">
                                    <h3 class="font-semibold text-lg text-gray-800 mb-4">üóìÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h3>

                                    <div class="border-b border-gray-200">
                                        <nav id="leave-tab-nav" class="-mb-px flex space-x-6" aria-label="Tabs">
                                            <a href="#" data-target="leave-pending-content" class="leave-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-semibold border-sky-500 text-sky-600" aria-current="page">
                                                ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                                </a>
                                            <a href="#" data-target="leave-history-content" class="leave-tab-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700">
                                                ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                            </a>
                                        </nav>
                                    </div>

                                    <div class="mt-4">
                                        <div id="leave-pending-content" class="leave-tab-content space-y-4 max-h-96 overflow-y-auto">
                                            <div id="leave-approval-list" class="space-y-4">
                                                <p id="leave-loading-msg" class="text-center text-gray-400 text-sm py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</p>
                                            </div>
                                        </div>

                                        <div id="leave-history-content" class="leave-tab-content hidden">
                                            <div class="space-y-3 mb-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
                                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                                    <div>
                                                        <label for="leave-history-status-filter" class="text-xs font-medium text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                                        <select id="leave-history-status-filter" class="w-full mt-1 p-2 bg-white border border-gray-300 rounded-lg focus:ring-1 focus:ring-sky-400 focus:outline-none text-sm">
                                                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                                            <option value="pending">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                                                            <option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option>
                                                            <option value="rejected">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label for="leave-history-user-filter" class="text-xs font-medium text-gray-600">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                                                        <select id="leave-history-user-filter" class="w-full mt-1 p-2 bg-white border border-gray-300 rounded-lg focus:ring-1 focus:ring-sky-400 focus:outline-none text-sm">
                                                            <option value="">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                                            </select>
                                                    </div>
                                                </div>
                                                <button id="leave-history-search-btn" class="w-full sm:w-auto px-5 py-2 bg-sky-500 text-white text-sm font-semibold rounded-lg hover:bg-sky-600">
                                                    ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                                                </button>
                                            </div>
                                            
                                            <div id="leave-history-list" class="space-y-4 max-h-96 overflow-y-auto">
                                                <p id="leave-history-loading-msg" class="text-center text-gray-400 text-sm py-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥"</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card !p-0">
                                    <h3 class="font-semibold text-lg text-gray-800 p-4 pb-0">üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h3>
                                    <div class="p-4 bg-gray-50 rounded-xl border border-gray-200 space-y-4">
                                        <div>
                                            <label class="text-sm font-medium text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                                            <select id="edit-user-select" class="w-full mt-1 p-3 bg-white border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:outline-none">
                                                <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                            <input type="date" id="edit-date-select" class="w-full mt-1 p-3 bg-white border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:outline-none">
                                        </div>
                                        <button id="search-record-btn" class="btn-primary w-full py-3 text-base">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                            ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                        </button>
                                        <div id="search-results-container" class="mt-4 pt-4 border-t border-gray-200">
                                            <p class="text-sm text-center text-gray-400 py-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-8">
                        <div class="card">
                            <h3 class="font-semibold text-lg text-gray-800 mb-4">üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
                            <div class="space-y-6">
                                <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                                     <div class="flex justify-between items-start mb-3">
                                        <h4 class="font-semibold text-gray-700">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h4>
                                        <button id="export-project-summary-btn" class="text-sm bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd"></path></svg>
                                            <span>Export</span>
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label class="text-sm font-medium text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                                            <input type="month" id="project-summary-month" class="w-full mt-1 p-3 bg-white border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:outline-none">
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                                            <select id="project-summary-select" class="w-full mt-1 p-3 bg-white border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:outline-none">
                                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£...</option>
                                                </select>
                                        </div>
                                    </div>
                                    <div id="project-summary-results" class="mt-4 pt-4 border-t border-gray-200 max-h-96 overflow-y-auto">
                                         <p class="text-sm text-center text-gray-400 py-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</p>
                                    </div>
                                </div>

                                <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                                    <div class="flex justify-between items-center mb-4">
                                        <h4 class="font-semibold text-gray-700">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h4>
                                        <button id="export-employee-summary-btn" class="text-sm bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd"></path></svg>
                                            <span>Export Excel</span>
                                        </button>
                                    </div>

                                    <div class="space-y-4 mb-6 p-4 bg-white rounded-lg border border-gray-200">
                                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                            <div>
                                                <label for="summary-start-date" class="text-xs font-medium text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                                                <input type="date" id="summary-start-date" class="w-full mt-1 p-2 bg-white border border-gray-300 rounded-lg focus:ring-1 focus:ring-sky-400 focus:outline-none text-sm">
                                            </div>
                                            <div>
                                                <label for="summary-end-date" class="text-xs font-medium text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                                                <input type="date" id="summary-end-date" class="w-full mt-1 p-2 bg-white border border-gray-300 rounded-lg focus:ring-1 focus:ring-sky-400 focus:outline-none text-sm">
                                            </div>
                                            <div>
                                                <label for="summary-employee-select" class="text-xs font-medium text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                                                <select id="summary-employee-select" class="w-full mt-1 p-2 bg-white border border-gray-300 rounded-lg focus:ring-1 focus:ring-sky-400 focus:outline-none text-sm">
                                                    <option value="">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                                    </select>
                                            </div>
                                            <div>
                                                <label for="summary-status-filter" class="text-xs font-medium text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                                <select id="summary-status-filter" class="w-full mt-1 p-2 bg-white border border-gray-300 rounded-lg focus:ring-1 focus:ring-sky-400 focus:outline-none text-sm">
                                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                                    <option value="checked_in">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</option>
                                                    <option value="completed">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</option>
                                                    <option value="not_checked_in">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</option>
                                                </select>
                                            </div>
                                        </div>
                                         <button id="apply-summary-filters-btn" class="w-full sm:w-auto mt-3 px-5 py-2 bg-sky-500 text-white text-sm font-semibold rounded-lg hover:bg-sky-600">
                                            ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                        </button>
                                    </div>
                                    <div id="employee-summary-container-admin" class="space-y-3 max-h-[60vh] overflow-y-auto">
                                        <p class="text-sm text-center text-gray-400 py-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</p>
                                    </div>
                                     <div id="summary-pagination-controls" class="mt-4 flex justify-center items-center space-x-2">
                                        </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            

            <div id="calendar-page" class="page space-y-6">
                <h2 class="text-2xl font-bold">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</h2>
                <div class="card !p-4 flex justify-between items-center">
    <p class="font-semibold text-gray-700">‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: 10 ‡∏ß‡∏±‡∏ô</p>
    <button id="show-leave-form-btn" class="btn-primary !py-2 !px-4 text-sm">
        + ‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤
    </button>
</div>

                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <button id="cal-prev-month" class="p-2 rounded-full hover:bg-gray-100">
                            <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h3 id="cal-month-year" class="text-xl font-semibold"></h3>
                        <button id="cal-next-month" class="p-2 rounded-full hover:bg-gray-100">
                            <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-1 text-center text-xs font-semibold text-gray-500 mb-2">
                        <span>‡∏≠‡∏≤</span>
                        <span>‡∏à</span>
                        <span>‡∏≠</span>
                        <span>‡∏û</span>
                        <span>‡∏û‡∏§</span>
                        <span>‡∏®</span>
                        <span>‡∏™</span>
                    </div>
                    
                    <div id="cal-grid" class="grid grid-cols-7 gap-1">
                        </div>

                    <div id="cal-details-container" class="mt-4 pt-4 border-t border-gray-100 space-y-4">
                        <p class="text-center text-gray-400 text-sm">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                    </div>
                    
                </div> </div>
            <div id="profile-page" class="page space-y-6">
                <div class="card !p-0 overflow-hidden"> <div class="p-5 flex items-center space-x-4">
                        <img id="profile-page-pic" src="https://placehold.co/150x150/E2E8F0/475569?text=User" alt="‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå" class="w-20 h-20 rounded-full object-cover border-4 border-white shadow-lg flex-shrink-0">
                        <div class="overflow-hidden">
                             <h2 id="profile-page-name" class="text-xl font-bold text-gray-800 truncate"></h2>
                             <p id="profile-page-department" class="text-gray-500 font-medium"></p>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 border-t border-gray-100">
                        <h3 class="text-sm font-semibold text-gray-600 mb-3 ml-1">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h3>
                        
                        <div class="grid grid-cols-3 gap-3 text-center">
                            
                            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                                <p class="text-xs text-sky-600 font-semibold">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏õ‡∏Å‡∏ï‡∏¥</p>
                                <p id="profile-summary-hours" class="text-xl font-bold text-sky-600 mt-1">-</p> </div>
                            
                            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                                <p class="text-xs text-orange-600 font-semibold">OT ‡∏£‡∏ß‡∏°</p>
                                <p id="profile-summary-ot" class="text-xl font-bold text-orange-600 mt-1">-</p> </div>
                            
                            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                                <p class="text-xs text-green-600 font-semibold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</p>
                                <p id="profile-summary-days" class="text-xl font-bold text-green-600 mt-1">-</p> </div>
                            
                        </div>
                    </div>

                </div> 
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                         <h3 class="font-bold text-xl text-gray-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
                         
                         <div class="relative inline-block shadow-sm rounded-lg">
                            <select id="history-range-select" class="appearance-none text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg pl-3 pr-8 py-2 focus:ring-sky-500 focus:border-sky-500 focus:outline-none">
                                <option value="7">7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                                <option value="this_month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                                <option value="last_month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        
                    </div>
                   
                    <div id="work-history-container" class="space-y-4">
                        </div>
                </div>

                 <button id="logout-btn" class="w-full flex items-center justify-center text-center py-3 bg-red-100 text-red-600 rounded-xl font-semibold hover:bg-red-200 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
                </button>
            </div>

        </main>
        
        <nav class="fixed bottom-0 left-0 right-0 bg-white h-20 flex justify-around items-center border-t border-gray-200 bottom-nav">
            <a href="#" class="nav-item text-center text-gray-500 active" data-page="check-in-out-page">
                <svg class="w-7 h-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="text-xs">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>
            </a>
            
            <a href="#" id="report-or-admin-nav" class="nav-item text-center text-gray-500" data-page="report-page">
                <svg class="w-7 h-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span class="text-xs">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
            </a>

            <a href="#" id="calendar-or-admin-nav" class="nav-item text-center text-gray-500" data-page="calendar-page">
                 <svg class="w-7 h-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span class="text-xs">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</span>
            </a>

            <a href="#" class="nav-item text-center text-gray-500" data-page="profile-page">
                <svg class="w-7 h-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span class="text-xs">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
            </a>
        </nav>
    </div>

    <div id="notification" class="fixed bottom-5 left-1/2 -translate-x-1/2 flex items-center gap-3 bg-green-500 text-white py-3 px-5 rounded-lg shadow-lg text-sm transition-all duration-500 opacity-0 translate-y-10">
    <span id="notification-icon">
        </span>
    <p id="notification-message">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</p>
</div>
    
    <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div id="modal-overlay" class="absolute inset-0 bg-black opacity-50"></div>
        <div class="card relative z-10 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h3>
            
            <input type="hidden" id="edit-doc-id">
            
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-medium text-gray-600">‡πÄ‡∏ß‡∏•‡∏≤ Check-in</label>
                    <input type="datetime-local" id="edit-checkin-time" class="w-full mt-1 p-3 border border-gray-300 rounded-xl">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600">‡πÄ‡∏ß‡∏•‡∏≤ Check-out</label>
                    <input type="datetime-local" id="edit-checkout-time" class="w-full mt-1 p-3 border border-gray-300 rounded-xl">
                </div>
                
                <hr class="my-4">
                <h4 class="font-semibold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h4>
                
                <div>
                    <label class="text-sm font-medium text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà On-site (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                    <input type="text" id="edit-onsite-details" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö. A, ‡πÑ‡∏ã‡∏ï‡πå‡∏á‡∏≤‡∏ô B" class="w-full mt-1 p-3 border border-gray-300 rounded-xl">
                </div>

                <div>
                    <label class="text-sm font-medium text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
                    <div class="relative mt-1">
                        <button id="edit-modal-work-type-btn" type="button" class="w-full p-3 bg-white border border-gray-300 rounded-xl text-left flex justify-between items-center focus:ring-2 focus:ring-sky-400 focus:outline-none">
                            <span id="edit-modal-work-type-selected-text" class="text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô...</span>
                            <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="edit-modal-work-type-panel" class="hidden absolute z-20 w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg">
                            <div class="p-2 border-b border-gray-100">
                                <input id="edit-modal-work-type-search" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-sky-400 focus:outline-none">
                            </div>
                            <div id="edit-modal-work-type-options" class="max-h-40 overflow-y-auto p-1"></div>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="text-sm font-medium text-gray-600">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                    <div class="relative mt-1">
                        <button id="edit-modal-project-btn" type="button" class="w-full p-3 bg-white border border-gray-300 rounded-xl text-left flex justify-between items-center focus:ring-2 focus:ring-sky-400 focus:outline-none">
                            <span id="edit-modal-project-selected-text" class="text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£...</span>
                            <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="edit-modal-project-panel" class="hidden absolute z-20 w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg">
                            <div class="p-2 border-b border-gray-100">
                                <input id="edit-modal-project-search" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-sky-400 focus:outline-none">
                            </div>
                            <div id="edit-modal-project-options" class="max-h-40 overflow-y-auto p-1"></div>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="text-sm font-medium text-gray-600">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                    <div class="relative mt-1">
                        <button id="edit-modal-duration-btn" type="button" class="w-full p-3 bg-white border border-gray-300 rounded-xl text-left flex justify-between items-center focus:ring-2 focus:ring-sky-400 focus:outline-none">
                            <span id="edit-modal-duration-selected-text" class="text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤...</span>
                            <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="edit-modal-duration-panel" class="hidden absolute z-20 w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg">
                            <div id="edit-modal-duration-options" class="p-1">
                                <div class="duration-option p-2 rounded-lg hover:bg-sky-50 cursor-pointer">‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô (08:30 - 17:30)</div>
                                <div class="duration-option p-2 rounded-lg hover:bg-sky-50 cursor-pointer">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ (08:30 - 12:00)</div>
                                <div class="duration-option p-2 rounded-lg hover:bg-sky-50 cursor-pointer">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ö‡πà‡∏≤‡∏¢ (13:00 - 17:30)</div>
                                <div class="duration-option p-2 rounded-lg hover:bg-sky-50 cursor-pointer">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤</div>
                            </div>
                        </div>
                    </div>
                    <div id="edit-modal-custom-time-inputs" class="hidden mt-3 grid grid-cols-2 gap-3 p-3 bg-gray-50 rounded-lg">
                        <div>
                            <label class="text-xs font-medium text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                            <input type="time" id="edit-modal-custom-time-start-input" class="w-full mt-1 p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                            <input type="time" id="edit-modal-custom-time-end-input" class="w-full mt-1 p-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancel-edit-btn" class="py-2 px-5 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button id="save-edit-btn" class="py-2 px-5 bg-sky-500 text-white rounded-lg font-semibold hover:bg-sky-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div id="confirm-overlay" class="absolute inset-0 bg-black opacity-50"></div>
        <div class="card relative z-10 w-full max-w-sm">
            <h3 id="confirm-title" class="text-lg font-semibold mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
            <p id="confirm-message" class="text-sm text-gray-600 mb-6">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="py-2 px-5 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</button>
                <button id="confirm-ok-btn" class="py-2 px-5 bg-sky-500 text-white rounded-lg font-semibold hover:bg-sky-600">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>

    <div id="leave-request-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center p-4">
    <div id="leave-overlay" class="absolute inset-0 bg-black opacity-50"></div>
    <div class="card relative z-10 w-full max-w-md">
        <h3 class="text-xl font-bold mb-6">‡∏¢‡∏∑‡πà‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏•‡∏≤</h3>
        
        <div class="space-y-4">
            <div>
                <label class="text-sm font-medium text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
                <select id="leave-type-select" class="w-full mt-1 p-3 bg-white border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-400 focus:outline-none">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤ --</option>
                    <option value="annual">‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô (Annual Leave)</option>
                    <option value="sick">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (Sick Leave)</option>
                    <option value="personal">‡∏•‡∏≤‡∏Å‡∏¥‡∏à (Personal Leave)</option>
                </select>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                    <input type="date" id="leave-start-date" class="w-full mt-1 p-3 border border-gray-300 rounded-xl">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                    <input type="date" id="leave-end-date" class="w-full mt-1 p-3 border border-gray-300 rounded-xl">
                </div>
            </div>

            <div>
                <label class="text-sm font-medium text-gray-600">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
                <textarea id="leave-reason" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡πà‡∏ß‡∏¢, ‡πÑ‡∏õ‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î..." class="w-full mt-1 p-3 border border-gray-300 rounded-xl"></textarea>
            </div>

            <div class="flex justify-end space-x-3 pt-4">
                <button id="cancel-leave-btn" class="py-2 px-5 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="submit-leave-btn" class="py-2 px-5 bg-sky-500 text-white rounded-lg font-semibold hover:bg-sky-600">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</button>
            </div>
        </div>
    </div>
</div>

    <script src="firebase-config.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful!');
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        });
    }
    
    // --- Initialize Firebase & Config ---
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const LEAVE_TYPE_MAP = { 'annual': '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô (Annual Leave)', 'sick': '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (Sick Leave)', 'personal': '‡∏•‡∏≤‡∏Å‡∏¥‡∏à (Personal Leave)' };
    const storage = firebase.storage(); 
    const FACTORY_LOCATION = { latitude: 13.625, longitude: 101.025 };
    const ALLOWED_RADIUS_METERS = 200;

    // --- UI Elements ---
    const loadingSpinner = document.getElementById('loading-spinner');
    const loginPage = document.getElementById('login-page');
    const appContainer = document.getElementById('app-container');
    const lineLoginBtn = document.getElementById('line-login-btn');
    const checkinBtn = document.getElementById('checkin-btn');
    const checkoutBtn = document.getElementById('checkout-btn');
    const mainContent = document.getElementById('main-content');
    const locationStatusDiv = document.getElementById('location-status');
    const locationIcon = document.getElementById('location-icon');
    const locationText = document.getElementById('location-text');
    const workTypeButtons = document.querySelectorAll('.work-type-btn');
    const onsiteDetailsForm = document.getElementById('onsite-details-form');
    const onsiteLocationInput = document.getElementById('onsite-location-input');
    const takePhotoBtn = document.getElementById('take-photo-btn');
    const photoUploadInput = document.getElementById('photo-upload-input');
    const photoPreview = document.getElementById('photo-preview');
    const summaryCheckinTime = document.getElementById('summary-checkin-time');
    const summaryCheckoutTime = document.getElementById('summary-checkout-time');
    const summaryWorkHours = document.getElementById('summary-work-hours');
    const pages = mainContent.querySelectorAll('.page');
    const navItems = document.querySelectorAll('.nav-item');
    const timeElement = document.getElementById('current-time');

    // --- UI Elements for Report Page ---
    const saveReportBtn = document.getElementById('save-report-btn');
    const workTypeSelectedText = document.getElementById('work-type-selected-text');
    const projectSelectedText = document.getElementById('project-selected-text');
    const durationSelectedText = document.getElementById('duration-selected-text');
    const customTimeInputs = document.getElementById('custom-time-inputs');
    const customTimeStartInput = document.getElementById('custom-time-start-input');
    const customTimeEndInput = document.getElementById('custom-time-end-input');
    const summaryStartDateInput = document.getElementById('summary-start-date');
    const summaryEndDateInput = document.getElementById('summary-end-date');
    const summaryEmployeeFilterInput = document.getElementById('summary-employee-filter');
    const summaryStatusFilterSelect = document.getElementById('summary-status-filter');
    const applySummaryFiltersBtn = document.getElementById('apply-summary-filters-btn');
    const exportEmployeeSummaryBtn = document.getElementById('export-employee-summary-btn');    
    // 1. ‡∏î‡∏∂‡∏á Elements
    const editUserSelect = document.getElementById('edit-user-select');
    const editDateSelect = document.getElementById('edit-date-select');
    const searchRecordBtn = document.getElementById('search-record-btn');
    const searchResultsContainer = document.getElementById('search-results-container');

    const editModal = document.getElementById('edit-modal');
    const modalOverlay = document.getElementById('modal-overlay');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const saveEditBtn = document.getElementById('save-edit-btn');

    // Input ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Modal
    const editDocIdInput = document.getElementById('edit-doc-id');
    const editCheckinTimeInput = document.getElementById('edit-checkin-time');
    const editCheckoutTimeInput = document.getElementById('edit-checkout-time');
    const editOnsiteDetailsInput = document.getElementById('edit-onsite-details');
    // Elements ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dropdown ‡πÉ‡∏ô Modal
    const editModalWorkTypeSelectedText = document.getElementById('edit-modal-work-type-selected-text');
    const editModalProjectSelectedText = document.getElementById('edit-modal-project-selected-text');
    const editModalDurationSelectedText = document.getElementById('edit-modal-duration-selected-text');
    const editModalCustomTimeInputs = document.getElementById('edit-modal-custom-time-inputs');
    const editModalCustomTimeStartInput = document.getElementById('edit-modal-custom-time-start-input');
    const editModalCustomTimeEndInput = document.getElementById('edit-modal-custom-time-end-input');
    // --- 1. ‡∏î‡∏∂‡∏á Element ‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ö‡∏•‡∏≤ ---
    const leaveRequestModal = document.getElementById('leave-request-modal');
    const leaveOverlay = document.getElementById('leave-overlay');
    const cancelLeaveBtn = document.getElementById('cancel-leave-btn');
    const submitLeaveBtn = document.getElementById('submit-leave-btn');
    // --- 2. ‡∏î‡∏∂‡∏á Element ‡∏Ç‡∏≠‡∏á Input ---
    const leaveTypeSelect = document.getElementById('leave-type-select');
    const leaveStartDate = document.getElementById('leave-start-date');
    const leaveEndDate = document.getElementById('leave-end-date');
    const leaveReason = document.getElementById('leave-reason');
    // --- App State ---
    let currentUser = null;
    let watchId = null;
    let latestPosition = null;
    let selectedWorkType = 'in_factory';
    let photoFile = null;
    let controlsInitialized = false;
    let currentUserData = null; 
    // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà
    let currentDisplayDate = new Date();
    
    // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏™‡∏£‡πâ‡∏≤‡∏á Cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤
    let calendarDataCache = {
        plans: new Map(),
        records: new Map(),
        users: new Map() // Map(userId -> userData)
    };

    // --- Firebase Auth State Changed ---
    auth.onAuthStateChanged(async (user) => {
        loginPage.style.display = 'none';
        appContainer.style.display = 'none';

        if (user) {
            currentUser = user;
            const userDocRef = db.collection('users').doc(user.uid);
            const userDoc = await userDocRef.get();

            if (userDoc.exists) {
                try {
                    const functions = firebase.functions();
                    const saveLineProfileImage = functions.https.callable('saveLineProfileImage');
                    await saveLineProfileImage({ photoURL: user.photoURL });
                    console.log("Profile image update function called successfully.");
                } catch (error) {
                    console.error("Error calling update profile image function:", error);
                }

                const updatedUserDoc = await userDocRef.get();
                const userData = updatedUserDoc.data();
                
                currentUserData = userData; 

                const topProfilePic = document.getElementById('user-profile-pic');
                const placeholderSm = 'https://placehold.co/100x100/E2E8F0/475569?text=User';
                
                topProfilePic.onerror = () => { topProfilePic.src = placeholderSm; };
                topProfilePic.src = userData.profileImageUrl || user.photoURL || placeholderSm;
                
                document.getElementById('user-display-name').textContent = userData.fullName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                
                // 1. ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 2 (‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô) - ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" ‡πÄ‡∏™‡∏°‡∏≠
                const reportNavButton = document.getElementById('report-or-admin-nav');
                if (reportNavButton) {
                    const navIcon = reportNavButton.querySelector('svg');
                    const navText = reportNavButton.querySelector('span');
                    const reportIconSvg = `
                        <svg class="w-7 h-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    `;
                    reportNavButton.dataset.page = 'report-page';
                    navText.textContent = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';
                    navIcon.innerHTML = reportIconSvg;
                }

                // 2. ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 3 (‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô/Dashboard) - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏° Role
                const thirdNavButton = document.getElementById('calendar-or-admin-nav');
                if (thirdNavButton) {
                    const navIcon = thirdNavButton.querySelector('svg');
                    const navText = thirdNavButton.querySelector('span');

                    // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô Dashboard
                    const dashboardIconSvg = `
                        <svg class="w-7 h-7 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    `;
                    // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô Calendar (Default)
                    const calendarIconSvg = `
                        <svg class="w-7 h-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    `;

                    if (currentUserData && currentUserData.role === 'admin') {
                        // --- ‡πÄ‡∏õ‡πá‡∏ô Admin ---
                        thirdNavButton.dataset.page = 'admin-dashboard-page';
                        navText.textContent = 'Dashboard';
                        navIcon.innerHTML = dashboardIconSvg;
                    } else {
                        // --- ‡πÄ‡∏õ‡πá‡∏ô User ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ---
                        thirdNavButton.dataset.page = 'calendar-page';
                        navText.textContent = '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô';
                        navIcon.innerHTML = calendarIconSvg;
                    }
                }
                // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Role ---
                // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Role ---

                updateProfilePage(userData);
                startWatchingPosition();
                await checkUserWorkStatus();
                
                initializeControls();
                await populateDropdownOptions();

                appContainer.style.display = 'block';
                showPage('check-in-out-page');
                document.querySelector('.nav-item[data-page="check-in-out-page"]').classList.add('active');

            } else {
                alert("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
                auth.signOut();
                loginPage.style.display = 'flex';
            }
        } else {
            stopWatchingPosition();
            currentUser = null;
            loginPage.style.display = 'flex';
        }
        loadingSpinner.style.display = 'none';
    });

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ (Check-in, Check-out, Report, Admin, Profile, etc.) ---
    // (‡πÇ‡∏Ñ‡πâ‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
    
    // ... (‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà saveReportBtn.addEventListener ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á showNotification) ...
     // --- [‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á] Logic ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ---
    saveReportBtn.addEventListener('click', async () => {
        if (!currentUser) {
            return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô");
        }

        const workType = workTypeSelectedText.textContent;
        const project = projectSelectedText.textContent;
        const duration = durationSelectedText.textContent;
        let timeRange = duration;

        if (workType.includes('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô...')) {
            return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô");
        }
        if (project.includes('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£...')) {
            return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£");
        }
        if (duration.includes('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤...')) {
            return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô");
        }

        if (duration === '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤') {
            const startTime = customTimeStartInput.value;
            const endTime = customTimeEndInput.value;
            if (!startTime || !endTime) {
                return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î");
            }
            timeRange = `${startTime} - ${endTime}`;
        }
        
        saveReportBtn.disabled = true;
        saveReportBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        
        try {
            const today = new Date().toISOString().split('T')[0];
            // [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô] ‡πÉ‡∏ä‡πâ ID ‡∏Ç‡∏≠‡∏á work_records
            const workRecordDocId = `${currentUser.uid}_${today}`;
            const workRecordRef = db.collection('work_records').doc(workRecordDocId);
            
            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤ Check-in ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            const doc = await workRecordRef.get();
            if (!doc.exists) {
                saveReportBtn.disabled = false;
                saveReportBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                return alert("‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Check-in ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Check-in ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô");
            }

            // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ userId, userName)
            const reportData = {
                submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                workType: workType,
                project: project,
                duration: timeRange
            };

            // 3. [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô work_records ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ field 'report'
            await workRecordRef.update({
                report: reportData
            });

            showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            resetReportForm();
            loadSentReports(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πá‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
            
        } catch (error) {
            console.error("Error saving report: ", error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + error.message);
        } finally {
            saveReportBtn.disabled = false;
            saveReportBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        }
    });

    workTypeButtons.forEach(button => {
        button.addEventListener('click', () => {
            workTypeButtons.forEach(btn => {
                btn.classList.remove('bg-sky-500', 'text-white', 'shadow');
                btn.classList.add('text-gray-600');
            });
            button.classList.add('bg-sky-500', 'text-white', 'shadow');
            selectedWorkType = button.dataset.workType;
            onsiteDetailsForm.classList.toggle('hidden', selectedWorkType !== 'on_site');
        });
    });

    takePhotoBtn.addEventListener('click', () => {
        photoUploadInput.click();
    });

    photoUploadInput.addEventListener('change', (event) => {
        photoFile = event.target.files[0];
        if (photoFile) {
            const reader = new FileReader();
            reader.onload = e => {
                photoPreview.src = e.target.result;
                photoPreview.classList.remove('hidden');
            };
            reader.readAsDataURL(photoFile);
        }
    });

    const populateDropdownOptions = async () => {
        const db = firebase.firestore();
        const configs = [
            { docId: 'workTypes', optionsId: 'work-type-options' },
            { docId: 'projects', optionsId: 'project-options' },
            { docId: 'workTypes', optionsId: 'delete-work-type-options' },
            { docId: 'projects', optionsId: 'delete-project-options' },
            { docId: 'workTypes', optionsId: 'edit-modal-work-type-options' },
            { docId: 'projects', optionsId: 'edit-modal-project-options' }
        ];

        for (const config of configs) {
            try {
                const doc = await db.collection('system_settings').doc(config.docId).get();
                if (!doc.exists) continue;

                const items = doc.data().names || [];
                const optionsContainer = document.getElementById(config.optionsId);
                const panel = optionsContainer.closest('.absolute');
                const selectedText = panel.previousElementSibling.querySelector('span');
                
                optionsContainer.innerHTML = '';

                items.forEach(name => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'p-2 rounded-lg hover:bg-sky-50 cursor-pointer text-sm';
                    optionDiv.textContent = name;
                    
                    optionDiv.addEventListener('click', () => {
                        selectedText.textContent = name;
                        selectedText.classList.remove('text-gray-500');
                        panel.classList.add('hidden');
                    });
                    optionsContainer.appendChild(optionDiv);
                });
            } catch (error) {
                console.error(`Error populating ${config.docId}:`, error);
            }
        }
    };

    const initializeControls = () => {
        if (controlsInitialized) return;
        
        const db = firebase.firestore();
        
        const dropdownConfigs = [
            { panelId: 'work-type-panel', selectBtnId: 'work-type-btn', searchId: 'work-type-search' },
            { panelId: 'project-panel', selectBtnId: 'project-btn', searchId: 'project-search' },
            { panelId: 'delete-work-type-panel', selectBtnId: 'delete-work-type-select-btn' },
            { panelId: 'delete-project-panel', selectBtnId: 'delete-project-select-btn' },
            { panelId: 'duration-panel', selectBtnId: 'duration-btn' },
            { panelId: 'edit-modal-work-type-panel', selectBtnId: 'edit-modal-work-type-btn', searchId: 'edit-modal-work-type-search' },
            { panelId: 'edit-modal-project-panel', selectBtnId: 'edit-modal-project-btn', searchId: 'edit-modal-project-search' },
            { panelId: 'edit-modal-duration-panel', selectBtnId: 'edit-modal-duration-btn' }
        ];

        dropdownConfigs.forEach(config => {
            const selectBtn = document.getElementById(config.selectBtnId);
            const panel = document.getElementById(config.panelId);

            if (!selectBtn || !panel) return;

            selectBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                
                const isCurrentlyHidden = panel.classList.contains('hidden');
                dropdownConfigs.forEach(otherConf => {
                    if (otherConf.panelId !== config.panelId) {
                        document.getElementById(otherConf.panelId)?.classList.add('hidden');
                    }
                });

                if (isCurrentlyHidden) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });
            
            panel.addEventListener('click', (e) => e.stopPropagation());

            if (config.searchId) {
                const searchInput = document.getElementById(config.searchId);
                const optionsContainer = panel.querySelector('.overflow-y-auto');
                if (searchInput && optionsContainer) {
                    searchInput.addEventListener('input', () => {
                        const filter = searchInput.value.toLowerCase();
                        for (const option of optionsContainer.children) {
                            option.style.display = option.textContent.toLowerCase().includes(filter) ? '' : 'none';
                        }
                    });
                }
            }
        });

        document.addEventListener('click', () => {
            dropdownConfigs.forEach(config => {
                document.getElementById(config.panelId)?.classList.add('hidden');
            });
        });
        
        const setupAdminAction = (btnId, valueSourceId, docId, action) => {
            const actionButton = document.getElementById(btnId);
            if (!actionButton) {
                console.error(`Button with ID ${btnId} not found.`);
                return;
            }

            actionButton.addEventListener('click', async () => {
                const isDelete = action === 'delete';
                const valueElement = document.getElementById(valueSourceId);
                if (!valueElement) {
                    console.error(`Value source with ID ${valueSourceId} not found.`);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö Element ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤');
                    return;
                }

                const value = isDelete ? valueElement.textContent.trim() : valueElement.value.trim();

                if ((isDelete && value.includes('...')) || (!isDelete && !value)) {
                    showNotification(isDelete ? '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö' : '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'warning');
                    return;
                }

                if (isDelete) {
                    showConfirmDialog(
                        `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö "${value}"?`,
                        async () => { 
                            try {
                                actionButton.disabled = true;
                                actionButton.classList.add('opacity-50');

                                const docRef = db.collection('system_settings').doc(docId);
                                const updateAction = firebase.firestore.FieldValue.arrayRemove(value);
                                await docRef.update({ names: updateAction });

                                showNotification(`‡∏•‡∏ö "${value}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                                await populateDropdownOptions(); 

                                valueElement.textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å${docId === 'workTypes' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô' : '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£'}‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö...`;
                                valueElement.classList.add('text-gray-500');

                            } catch (error) {
                                console.error(`Error deleting ${docId}:`, error);
                                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                            } finally {
                                actionButton.disabled = false;
                                actionButton.classList.remove('opacity-50');
                            }
                        }
                    );
                } else { 
                    try {
                        actionButton.disabled = true;
                        actionButton.classList.add('opacity-50');

                        const docRef = db.collection('system_settings').doc(docId);
                        const updateAction = firebase.firestore.FieldValue.arrayUnion(value);
                        await docRef.update({ names: updateAction });

                        showNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏° "${value}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                        await populateDropdownOptions();
                        valueElement.value = ''; 

                    } catch (error) {
                        console.error(`Error adding ${docId}:`, error);
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°', 'error');
                    } finally {
                        actionButton.disabled = false;
                        actionButton.classList.remove('opacity-50');
                    }
                }
            });
        };
        setupAdminAction('add-work-type-btn', 'add-work-type-input', 'workTypes', 'add');
        setupAdminAction('delete-work-type-btn', 'delete-work-type-selected-text', 'workTypes', 'delete');
        setupAdminAction('add-project-btn', 'add-project-input', 'projects', 'add');
        setupAdminAction('delete-project-btn', 'delete-project-selected-text', 'projects', 'delete');

        document.getElementById('duration-options').addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('duration-option')) {
                const selectedValue = e.target.textContent;
                durationSelectedText.textContent = selectedValue;
                durationSelectedText.classList.remove('text-gray-500');
                document.getElementById('duration-panel').classList.add('hidden');
                customTimeInputs.classList.toggle('hidden', selectedValue !== '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤');
            }
        });

        document.getElementById('edit-modal-duration-options').addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('duration-option')) {
                const selectedValue = e.target.textContent;
                editModalDurationSelectedText.textContent = selectedValue;
                editModalDurationSelectedText.classList.remove('text-gray-500');
                document.getElementById('edit-modal-duration-panel').classList.add('hidden');
                editModalCustomTimeInputs.classList.toggle('hidden', selectedValue !== '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤');
            }
        });

        document.getElementById('calendar-admin-add-holiday')?.addEventListener('click', () => {
            handleAddCalendarRule('holidays');
        });
        document.getElementById('calendar-admin-add-worksat')?.addEventListener('click', () => {
            handleAddCalendarRule('workingSaturdays');
        });
        // Event Delegation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
        document.getElementById('admin-calendar-controls-card')?.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.calendar-delete-btn');
            if (deleteBtn) {
                const date = deleteBtn.dataset.date;
                const type = deleteBtn.dataset.type;
                handleDeleteCalendarRule(type, date, deleteBtn);
            }
        });

        const leaveHistorySearchBtn = document.getElementById('leave-history-search-btn');
        if (leaveHistorySearchBtn) {
            leaveHistorySearchBtn.addEventListener('click', loadLeaveHistory);
        }

        const leaveTabNav = document.getElementById('leave-tab-nav');
        if (leaveTabNav) {
            // ‡∏î‡∏∂‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏õ‡∏∏‡πà‡∏° <a>)
            const tabs = leaveTabNav.querySelectorAll('a.leave-tab-btn');
            // ‡∏î‡∏∂‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (div .leave-tab-content)
            const contents = leaveTabNav.closest('.card').querySelectorAll('.leave-tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = tab.dataset.target; // ‡πÄ‡∏ä‡πà‡∏ô "leave-pending-content"

                    // 1. (‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï) ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞ ‡∏•‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™ active ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    tabs.forEach(t => {
                        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ó‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ (‡πÑ‡∏°‡πà active)
                        t.classList.remove('border-sky-500', 'text-sky-600', 'font-semibold');
                        t.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                    });
                    contents.forEach(c => {
                        // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        c.classList.add('hidden');
                    });

                    // 2. (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤) ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    
                    // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤ (active)
                    tab.classList.add('border-sky-500', 'text-sky-600', 'font-semibold');
                    tab.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
                    const targetContent = document.getElementById(targetId);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        }


        const initializeProjectSummary = () => {
            const db = firebase.firestore();
            const projectSelect = document.getElementById('project-summary-select');
            const monthInput = document.getElementById('project-summary-month');
            const resultsContainer = document.getElementById('project-summary-results');
            const exportBtn = document.getElementById('export-project-summary-btn');

            const exportProjectSummaryToExcel = async () => {
                const selectedProject = projectSelect.value;
                const selectedMonth = monthInput.value;

                if (!selectedProject || !selectedMonth) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô Export');
                    return;
                }
                
                const [year, month] = selectedMonth.split('-').map(Number);
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0, 23, 59, 59, 999);

                try {
                    const querySnapshot = await db.collection('work_records')
                                                  .where('report.project', '==', selectedProject)
                                                  .where('date', '>=', startDate) 
                                                  .where('date', '<=', endDate)
                                                  .orderBy('date', 'asc')
                                                  .get();
                    
                    if (querySnapshot.empty) {
                        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export');
                        return;
                    }

                    const dataForExcel = [
                        ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô", "‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤"]
                    ];
                    
                    const usersCache = {}; 

                    for (const doc of querySnapshot.docs) {
                        const record = doc.data();
                        const report = record.report; 
                        
                        let userName = usersCache[record.userId];
                        if (!userName) {
                            const userDoc = await db.collection('users').doc(record.userId).get();
                            userName = userDoc.exists ? userDoc.data().fullName : record.userId;
                            usersCache[record.userId] = userName;
                        }

                        const reportDate = record.date.toDate().toLocaleDateString('th-TH', {
                            year: 'numeric', month: 'long', day: 'numeric'
                        });
                        
                        dataForExcel.push([
                            reportDate,
                            userName,
                            report.workType,
                            report.duration
                        ]);
                    };

                    const ws = XLSX.utils.aoa_to_sheet(dataForExcel);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, '‡∏™‡∏£‡∏∏‡∏õ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£');
                    XLSX.writeFile(wb, `‡∏™‡∏£‡∏∏‡∏õ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£_${selectedProject}_${selectedMonth}.xlsx`);

                } catch (error) {
                    console.error("Error exporting to Excel:", error);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£ Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + error.message);
                }
            };
            
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            monthInput.value = `${year}-${month}`;

            const todayISO = new Date().toISOString().split('T')[0];
            summaryStartDateInput.value = todayISO;
            summaryEndDateInput.value = todayISO;

            applySummaryFiltersBtn.addEventListener('click', () => {
                loadEmployeeSummary(); 
            });

            exportEmployeeSummaryBtn.addEventListener('click', exportEmployeeSummaryToExcel);

            const populateProjectOptions = async () => {
                try {
                    const doc = await db.collection('system_settings').doc('projects').get();
                    projectSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£...</option>';

                    if (doc.exists) {
                        const projects = doc.data().names || [];
                        projects.forEach(name => {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name;
                            projectSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error("Error populating project summary dropdown:", error);
                }
            };

            const fetchProjectData = async () => {
                const selectedProject = projectSelect.value;
                const selectedMonth = monthInput.value;

                if (!selectedProject || !selectedMonth) {
                    resultsContainer.innerHTML = '<p class="text-sm text-center text-gray-400 py-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</p>';
                    return;
                }
                
                resultsContainer.innerHTML = '<p class="text-sm text-center text-gray-500 py-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';
                
                const [year, month] = selectedMonth.split('-').map(Number);
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0, 23, 59, 59, 999);
                
                const usersCache = {}; 

                try {
                    const querySnapshot = await db.collection('work_records')
                                                  .where('report.project', '==', selectedProject)
                                                  .where('date', '>=', startDate)
                                                  .where('date', '<=', endDate)
                                                  .orderBy('date', 'desc')
                                                  .get();

                    if (querySnapshot.empty) {
                        resultsContainer.innerHTML = '<p class="text-sm text-center text-gray-500 py-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
                        return;
                    }

                    let resultsHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
                            <p class="text-sm font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                                ‡∏û‡∏ö ${querySnapshot.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                            </p>
                        </div>
                        <div class="space-y-3">
                    `;
                    
                    for (const doc of querySnapshot.docs) {
                        const record = doc.data();
                        const report = record.report; 
                        const reportDate = record.date.toDate().toLocaleDateString('th-TH', {
                            day: '2-digit', month: 'long', year: 'numeric'
                        });
                        
                        let userName = usersCache[record.userId];
                        if (!userName) {
                            const userDoc = await db.collection('users').doc(record.userId).get();
                            userName = userDoc.exists ? userDoc.data().fullName : record.userId;
                            usersCache[record.userId] = userName;
                        }

                        resultsHTML += `
                            <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                                <div class="flex justify-between items-center">
                                    <p class="font-semibold text-gray-800">${userName}</p>
                                    <p class="text-xs text-gray-400">${reportDate}</p>
                                </div>
                                <div class="mt-3 flex flex-wrap gap-2 text-xs">
                                    <span class="inline-flex items-center font-medium bg-sky-100 text-sky-800 px-2.5 py-1 rounded-full">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                                        ${report.workType}
                                    </span>
                                    <span class="inline-flex items-center font-medium bg-gray-100 text-gray-800 px-2.5 py-1 rounded-full">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 10.586V6z" clip-rule="evenodd" /></svg>
                                        ${report.duration}
                                    </span>
                                </div>
                            </div>
                        `;
                    };
                    resultsHTML += '</div>';
                    resultsContainer.innerHTML = resultsHTML; 

                } catch (error) {
                    console.error("Error fetching project data:", error);
                    resultsContainer.innerHTML = '<p class="text-sm text-center text-red-500 py-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                }
            };

            populateProjectOptions();
            projectSelect.addEventListener('change', fetchProjectData);
            monthInput.addEventListener('change', fetchProjectData);
            exportBtn.addEventListener('click', exportProjectSummaryToExcel);
        };

        initializeProjectSummary();
        setupAdminCalendarControls();
        controlsInitialized = true;
    };

    const adminGoToCalendarBtn = document.getElementById('admin-go-to-calendar-btn');
    if (adminGoToCalendarBtn) {
        adminGoToCalendarBtn.addEventListener('click', () => {
            // 1. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
            showPage('calendar-page');
            
            // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
            loadCalendarData(currentDisplayDate);

            // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
            navItems.forEach(n => n.classList.remove('active'));
            // 3.1 ‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô (‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 3)
            const dashboardNavButton = document.getElementById('calendar-or-admin-nav');
            if (dashboardNavButton) {
                dashboardNavButton.classList.add('active');
            }
        });
    }

    checkinBtn.addEventListener('click', async () => {
        if (!currentUser) return showNotification("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", "error"); 
        if (!latestPosition) return showNotification("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...", "warning"); 

        if (selectedWorkType === 'on_site') {
            if (!onsiteLocationInput.value.trim()) return showNotification("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà On-site", "warning"); 
            if (!photoFile) return showNotification("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô", "warning"); 
        }

        const checkinSpan = checkinBtn.querySelector('span');
        checkinBtn.disabled = true;
        if (checkinSpan) checkinSpan.textContent = "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...";

        const proceedWithCheckin = async (finalWorkType) => {
            try {
                if (checkinSpan) checkinSpan.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                const now = new Date(); 
                const docId = `${currentUser.uid}_${now.toISOString().split('T')[0]}`;

                let photoUrl = null;
                if (finalWorkType === 'on_site' && photoFile) {
                    if (checkinSpan) checkinSpan.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...";
                    const filePath = `checkin-photos/${currentUser.uid}/${docId}.jpg`;
                    const fileSnapshot = await storage.ref(filePath).put(photoFile);
                    photoUrl = await fileSnapshot.ref.getDownloadURL();
                }

                const workRecord = {
                    userId: currentUser.uid,
                    date: firebase.firestore.Timestamp.fromDate(now),
                    checkIn: {
                        timestamp: firebase.firestore.Timestamp.fromDate(now),
                        location: new firebase.firestore.GeoPoint(latestPosition.coords.latitude, latestPosition.coords.longitude),
                        accuracy: latestPosition.coords.accuracy,
                        workType: finalWorkType, 
                        onSiteDetails: finalWorkType === 'on_site' ? onsiteLocationInput.value.trim() : null,
                        photoUrl: photoUrl
                    },
                    status: "checked_in",
                    report: null,
                    checkOut: null,
                    overtime: null
                };

                await db.collection('work_records').doc(docId).set(workRecord);
                showNotification("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); 
                updateUIToCheckedIn();

                const savedRecord = await db.collection('work_records').doc(docId).get();
                if (savedRecord.exists) {
                    const serverCheckinTime = savedRecord.data().checkIn.timestamp.toDate();
                    summaryCheckinTime.textContent = serverCheckinTime.toLocaleTimeString('th-TH');
                    summaryCheckinTime.classList.remove('text-gray-400');
                    summaryCheckinTime.classList.add('text-green-600');
                    summaryCheckoutTime.textContent = '-';
                    summaryCheckoutTime.classList.add('text-gray-400');
                    summaryCheckoutTime.classList.remove('text-red-500');
                    summaryWorkHours.textContent = '-';
                    summaryWorkHours.classList.add('text-gray-400');
                }

            } catch (error) {
                console.error("Check-in error:", error);
                showNotification("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message, 'error'); 
            } finally {
                checkinBtn.disabled = false;
                if (checkinSpan) checkinSpan.textContent = "Check In";
            }
        };

        try {
            const distance = calculateDistance(latestPosition.coords.latitude, latestPosition.coords.longitude, FACTORY_LOCATION.latitude, FACTORY_LOCATION.longitude);
            let workType = selectedWorkType; 

            if (workType === 'in_factory' && distance > ALLOWED_RADIUS_METERS) {
                showNotification(`‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô (${distance.toFixed(0)} ‡∏°.) ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô '‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô' ‡πÑ‡∏î‡πâ`, 'error');
                checkinBtn.disabled = false; 
                if (checkinSpan) checkinSpan.textContent = "Check In"; 
                return; 
            } else {
                proceedWithCheckin(workType);
            }

        } catch (error) {
            console.error("Initial Check-in error:", error);
            showNotification("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: " + error.message, 'error');
            checkinBtn.disabled = false;
            if (checkinSpan) checkinSpan.textContent = "Check In";
        }
    });

    function updateProfilePage(userData) {
        const profilePic = document.getElementById('profile-page-pic');
        const profileName = document.getElementById('profile-page-name');
        const profileDepartment = document.getElementById('profile-page-department');

        if (profilePic) {
            const placeholderLg = 'https://placehold.co/150x150/E2E8F0/475569?text=User';
            profilePic.onerror = () => { profilePic.src = placeholderLg; };
            profilePic.src = userData.profileImageUrl || (currentUser && currentUser.photoURL) || placeholderLg;
        }
        if (profileName) {
            profileName.textContent = userData.fullName || '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
        }
        if (profileDepartment) {
            profileDepartment.textContent = userData.department || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å';
        }
    }

    function startWatchingPosition() {
        if (navigator.geolocation && watchId === null) {
            const options = { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 };
            watchId = navigator.geolocation.watchPosition(updateRealtimeLocationStatus, handleLocationError, options);
        }
    }

    function stopWatchingPosition() {
        if (navigator.geolocation && watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
    }

    function updateRealtimeLocationStatus(position) {
        latestPosition = position;
        const distance = calculateDistance(position.coords.latitude, position.coords.longitude, FACTORY_LOCATION.latitude, FACTORY_LOCATION.longitude);
        if (distance <= ALLOWED_RADIUS_METERS) {
            locationStatusDiv.className = "flex items-center p-3 rounded-xl bg-green-100 text-green-700";
            locationIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>`;
            locationText.textContent = `‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô (‡∏£‡∏±‡∏®‡∏°‡∏µ ${position.coords.accuracy.toFixed(0)} ‡πÄ‡∏°‡∏ï‡∏£)`;
        } else {
            locationStatusDiv.className = "flex items-center p-3 rounded-xl bg-yellow-100 text-yellow-700";
            locationIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>`;
            locationText.textContent = `‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á ${distance.toFixed(0)} ‡∏°.)`;
        }
    }
    
    function handleLocationError(error) {
        let message = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ";
        if (error.code === 1) message = "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
        if (error.code === 3) message = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
        locationStatusDiv.className = "flex items-center p-3 rounded-xl bg-red-100 text-red-700";
        locationIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>`;
        locationText.textContent = message;
        console.error("Location Error:", error);
    }

    async function checkUserWorkStatus() {
        if (!currentUser) return;
        const today = new Date().toISOString().split('T')[0];
        const docId = `${currentUser.uid}_${today}`;
        const workRecordDoc = await db.collection('work_records').doc(docId).get();

        if (workRecordDoc.exists) {
            const data = workRecordDoc.data();
            const checkinTime = data.checkIn.timestamp.toDate();
            
            summaryCheckinTime.textContent = checkinTime.toLocaleTimeString('th-TH');
            summaryCheckinTime.classList.remove('text-gray-400');
            summaryCheckinTime.classList.add('text-green-600');

            if (data.status === 'checked_in') {
                updateUIToCheckedIn();
            } else if (data.status === 'completed') {
                updateUIToCompleted(); 
                
                const checkoutTime = data.checkOut.timestamp.toDate();
                const { regularWorkHours, overtimeHours } = calculateWorkHours(checkinTime, checkoutTime);

                summaryCheckoutTime.textContent = checkoutTime.toLocaleTimeString('th-TH');
                summaryCheckoutTime.classList.remove('text-gray-400');
                summaryCheckoutTime.classList.add('text-red-500');

                summaryWorkHours.textContent = `${regularWorkHours.toFixed(2)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`;
                if (overtimeHours > 0) {
                    summaryWorkHours.textContent += ` (OT ${overtimeHours} ‡∏ä‡∏°.)`;
                }
            }
        } else {
            updateUIToCheckIn();
        }
    }

    async function loadEmployeeSummary(page = 1) { 
        const container = document.getElementById('employee-summary-container-admin');
        const paginationControls = document.getElementById('summary-pagination-controls'); 
        if (!container || !paginationControls) return;

        container.innerHTML = '<p class="text-sm text-center text-gray-500 py-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...</p>';
        paginationControls.innerHTML = ''; 

        const startDateString = summaryStartDateInput.value;
        const endDateString = summaryEndDateInput.value;
        const userIdFilter = document.getElementById('summary-employee-select').value;
        const statusFilter = summaryStatusFilterSelect.value;

        if (!startDateString || !endDateString) {
             container.innerHTML = '<p class="text-sm text-center text-red-500 py-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</p>';
             return;
        }

        const startDate = new Date(startDateString);
        startDate.setHours(0, 0, 0, 0);
        const endDate = new Date(endDateString);
        endDate.setHours(23, 59, 59, 999);

        const ITEMS_PER_PAGE = 20; 
        let currentPage = page;
        let totalItems = 0;
        let totalPages = 1;

        try {
            const usersSnapshot = await db.collection('users').orderBy('fullName').get();
            if (usersSnapshot.empty) {
                container.innerHTML = '<p class="text-sm text-center text-gray-500 py-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>';
                return;
            }

            let allUsersData = {};
             usersSnapshot.forEach(doc => {
                 const userData = doc.data();
                 const fullName = (userData.fullName || '').toLowerCase();
                 if (!userIdFilter || doc.id === userIdFilter) {
                        allUsersData[doc.id] = { ...userData, workRecords: [] };
                     }
            });

            let workRecordsQuery = db.collection('work_records')
                                     .where('date', '>=', startDate)
                                     .where('date', '<=', endDate);

            if (statusFilter && statusFilter !== 'not_checked_in') {
                workRecordsQuery = workRecordsQuery.where('status', '==', statusFilter);
            }

            workRecordsQuery = workRecordsQuery.orderBy('date', 'desc'); 

            const recordsSnapshot = await workRecordsQuery.get();

            recordsSnapshot.forEach(doc => {
            const record = doc.data();
            if (allUsersData[record.userId]) {
                allUsersData[record.userId].workRecords.push(record);
            }
        });

            let filteredUserIds = Object.keys(allUsersData);

            if (statusFilter === 'not_checked_in') {
                 filteredUserIds = filteredUserIds.filter(userId => allUsersData[userId].workRecords.length === 0);
            } else if (statusFilter) {
                 filteredUserIds = filteredUserIds.filter(userId => allUsersData[userId].workRecords.length > 0);
            }

            totalItems = filteredUserIds.length;
            totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const userIdsToShow = filteredUserIds.slice(startIndex, endIndex);

            let resultsHTML = '';
            if (userIdsToShow.length === 0) {
                 resultsHTML = `<p class="text-sm text-center text-gray-500 py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>`;
            } else {
                 userIdsToShow.forEach(userId => {
                    const user = allUsersData[userId];
                    const latestRecord = user.workRecords.length > 0 ? user.workRecords[0] : null; 
                    const report = latestRecord?.report;

                    let statusText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô';
                    let statusColor = 'bg-gray-400';
                    let checkInTime = '-';
                    let checkOutTime = '-';
                    let workHours = '-';
                    let overtime = '-';
                    let workTypeInfo = '-';
                    let reportInfo = '<span class="text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>';
                    let recordDate = '-'; 

                    if (latestRecord) {
                         recordDate = latestRecord.date.toDate().toLocaleDateString('th-TH');
                        checkInTime = latestRecord.checkIn.timestamp.toDate().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                        workTypeInfo = latestRecord.checkIn.workType === 'in_factory' ? '‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô' : `On-site: ${latestRecord.checkIn.onSiteDetails || 'N/A'}`;

                        if(report) {
                            reportInfo = `${report.workType} (${report.project || 'N/A'})`;
                        }

                        if (latestRecord.status === 'checked_in') {
                            statusText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
                            statusColor = 'bg-green-500';
                        } else if (latestRecord.status === 'completed') {
                            statusText = '‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
                            statusColor = 'bg-red-500';
                            if (latestRecord.checkOut) {
                                checkOutTime = latestRecord.checkOut.timestamp.toDate().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                                const { regularWorkHours, overtimeHours } = calculateWorkHours(latestRecord.checkIn.timestamp.toDate(), latestRecord.checkOut.timestamp.toDate());
                                workHours = regularWorkHours.toFixed(2) + ' ‡∏ä‡∏°.';
                                overtime = (latestRecord.overtime?.hours || 0).toFixed(1) + ' ‡∏ä‡∏°.'; 
                            }
                        }
                    } else {
                         recordDate = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ';
                    }

                     resultsHTML += `
                        <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-3">
                                    <img src="${user.profileImageUrl || 'https://placehold.co/100x100/E2E8F0/475569?text=User'}" class="w-12 h-12 rounded-full object-cover flex-shrink-0">
                                    <div>
                                        <p class="font-semibold text-gray-800">${user.fullName || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'}</p>
                                        <div class="flex items-center gap-1.5 mt-1">
                                            <div class="w-2.5 h-2.5 rounded-full ${statusColor}"></div>
                                            <p class="text-xs font-medium text-gray-600">${statusText} (${recordDate})</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-gray-100 grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                                <div><span class="text-gray-500">‡πÄ‡∏Ç‡πâ‡∏≤:</span> <span class="font-semibold text-green-600">${checkInTime}</span></div>
                                <div><span class="text-gray-500">‡∏≠‡∏≠‡∏Å:</span> <span class="font-semibold text-red-500">${checkOutTime}</span></div>
                                <div><span class="text-gray-500">‡∏£‡∏ß‡∏°:</span> <span class="font-medium text-gray-700">${workHours}</span></div>
                                <div><span class="text-gray-500">OT:</span> <span class="font-medium text-gray-700">${overtime}</span></div>
                                <div class="col-span-2 mt-1"><span class="text-gray-500">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</span> <span class="font-medium text-gray-700">${workTypeInfo}</span></div>
                                <div class="col-span-2 mt-1"><span class="text-gray-500">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</span> <span class="font-medium text-gray-700">${reportInfo}</span></div>
                            </div>
                        </div>
                    `;
                 });
             } 

            container.innerHTML = resultsHTML;

            if (totalPages > 1) {
                const prevButton = document.createElement('button');
                prevButton.textContent = '‚óÄ';
                prevButton.className = `px-3 py-1 text-sm rounded ${currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-sky-500 text-white hover:bg-sky-600'}`;
                prevButton.disabled = currentPage === 1;
                prevButton.onclick = () => loadEmployeeSummary(currentPage - 1);
                paginationControls.appendChild(prevButton);

                const pageInfo = document.createElement('span');
                pageInfo.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} / ${totalPages}`;
                pageInfo.className = 'text-sm text-gray-600 mx-2';
                paginationControls.appendChild(pageInfo);

                const nextButton = document.createElement('button');
                nextButton.textContent = '‚ñ∂';
                nextButton.className = `px-3 py-1 text-sm rounded ${currentPage === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-sky-500 text-white hover:bg-sky-600'}`;
                nextButton.disabled = currentPage === totalPages;
                nextButton.onclick = () => loadEmployeeSummary(currentPage + 1);
                paginationControls.appendChild(nextButton);
            }

        } catch (error) {
            console.error("Error loading employee summary:", error);
            container.innerHTML = '<p class="text-sm text-center text-red-500 py-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
        }
    }

    async function exportEmployeeSummaryToExcel() {
        const startDateString = summaryStartDateInput.value;
        const endDateString = summaryEndDateInput.value;
        const userIdFilter = document.getElementById('summary-employee-select').value;
        const statusFilter = summaryStatusFilterSelect.value;

        if (!startDateString || !endDateString) {
            return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô Export');
        }

        showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export...');

        try {
            const startDate = new Date(startDateString);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateString);
            endDate.setHours(23, 59, 59, 999);

            // --- [‡πÉ‡∏´‡∏°‡πà] Step 1: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô (‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î) ---
            const holidayMap = new Map();
            const workingSaturdayMap = new Map();
            try {
                const calendarDoc = await db.collection('system_settings').doc('calendar_rules').get();
                if (calendarDoc.exists) {
                    const data = calendarDoc.data();
                    (data.holidays || []).forEach(dateStr => holidayMap.set(dateStr, true));
                    (data.workingSaturdays || []).forEach(dateStr => workingSaturdayMap.set(dateStr, true));
                }
            } catch (e) {
                console.warn("Could not load calendar rules for export:", e);
            }

            // --- [‡πÉ‡∏´‡∏°‡πà] Step 2: ‡∏î‡∏∂‡∏á User ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô) ---
            const usersSnapshot = await db.collection('users').orderBy('fullName').get();
            let filteredUsers = [];
            usersSnapshot.forEach(doc => {
                if (!userIdFilter || doc.id === userIdFilter) {
                    // [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                    filteredUsers.push({ 
                        id: doc.id, 
                        fullName: doc.data().fullName || doc.id,
                        department: doc.data().department || '-' // (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏ú‡∏ô‡∏Å)
                    });
                }
            });

            if (filteredUsers.length === 0) {
                 alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
                 return;
            }

            // --- [‡πÉ‡∏´‡∏°‡πà] Step 3: ‡∏î‡∏∂‡∏á work_records ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ---
            const recordsSnapshot = await db.collection('work_records')
                                         .where('date', '>=', startDate)
                                         .where('date', '<=', endDate)
                                         .get();

            // --- [‡πÉ‡∏´‡∏°‡πà] Step 4: ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á work_records ‡∏•‡∏á Map ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏á‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ---
            // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á: Map<userId, Map<dateString, recordData>>
            const recordsMap = new Map();
            recordsSnapshot.forEach(doc => {
                const record = doc.data();
                const userId = record.userId;
                // ‡πÉ‡∏ä‡πâ YYYY-MM-DD ‡πÄ‡∏õ‡πá‡∏ô Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Timezone
                const dateString = record.date.toDate().toISOString().split('T')[0]; 
                
                if (!recordsMap.has(userId)) {
                    recordsMap.set(userId, new Map());
                }
                recordsMap.get(userId).set(dateString, record);
            });

            // --- [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] Step 5: ‡∏™‡∏£‡πâ‡∏≤‡∏á Headers (‡πÄ‡∏û‡∏¥‡πà‡∏° "‡πÅ‡∏ú‡∏ô‡∏Å" ‡πÅ‡∏•‡∏∞ "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô") ---
            const dataForExcel = [
                ["‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", "‡πÅ‡∏ú‡∏ô‡∏Å", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤", "‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å", "‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏õ‡∏Å‡∏ï‡∏¥", "‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á OT", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î On-site", "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£", "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤"]
            ];
            
            // Format ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢
            const localDateFormatter = new Intl.DateTimeFormat('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const localTimeFormatter = new Intl.DateTimeFormat('th-TH', { hour: '2-digit', minute: '2-digit' });

            // --- [‡πÉ‡∏´‡∏°‡πà] Step 6: Loop ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏ö) ---
            for (let day = new Date(startDate); day <= endDate; day.setDate(day.getDate() + 1)) {
                
                const dateKey = day.toISOString().split('T')[0]; // YYYY-MM-DD
                const dayOfWeek = day.getDay(); // 0=Sunday, 6=Saturday
                
                // [‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô
                let dayType = "‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô";
                if (holidayMap.has(dateKey)) {
                    dayType = "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå";
                } else if (dayOfWeek === 0) {
                    dayType = "‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå";
                } else if (dayOfWeek === 6 && !workingSaturdayMap.has(dateKey)) {
                    dayType = "‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå (‡∏´‡∏¢‡∏∏‡∏î)";
                } else if (dayOfWeek === 6 && workingSaturdayMap.has(dateKey)) {
                    dayType = "‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô)";
                }

                // --- [‡πÉ‡∏´‡∏°‡πà] Step 7: Loop ‡∏ï‡∏≤‡∏° User ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÑ‡∏ß‡πâ ---
                for (const user of filteredUsers) {
                    
                    const userRecords = recordsMap.get(user.id);
                    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á user ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    const record = userRecords ? userRecords.get(dateKey) : null;

                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Default
                    let statusText = "";
                    let checkInTime = "-";
                    let checkOutTime = "-";
                    let regularWorkHours = 0;
                    let overtimeHours = 0;
                    let workTypeInfo = "-";
                    let onSiteDetails = "-";
                    let reportType = "-";
                    let reportProject = "-";
                    let reportDuration = "-";

                    if (record) {
                        // --- Case 1: ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô) ---
                        const report = record.report || {};
                        checkInTime = localTimeFormatter.format(record.checkIn.timestamp.toDate());
                        workTypeInfo = record.checkIn.workType === 'in_factory' ? '‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô' : 'On-site';
                        onSiteDetails = record.checkIn.onSiteDetails || '-';
                        reportType = report.workType || '-';
                        reportProject = report.project || '-';
                        reportDuration = report.duration || '-';

                        if (record.status === 'checked_in') {
                            statusText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
                        } else if (record.status === 'completed') {
                            statusText = '‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
                            if (record.checkOut) {
                                checkOutTime = localTimeFormatter.format(record.checkOut.timestamp.toDate());
                                const hours = calculateWorkHours(record.checkIn.timestamp.toDate(), record.checkOut.timestamp.toDate());
                                regularWorkHours = hours.regularWorkHours;
                                overtimeHours = record.overtime?.hours || 0;
                            }
                        }
                    } else {
                        // --- Case 2: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô) ---
                        if (dayType === "‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô" || dayType === "‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô)") {
                            statusText = "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤"; // ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏°‡∏≤‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏≤
                        } else {
                            statusText = "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"; // ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                        }
                    }
                    
                    // --- [‡πÉ‡∏´‡∏°‡πà] Step 8: Filter ‡∏ï‡∏≤‡∏° Status ‡∏ó‡∏µ‡πà user ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ---
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤" ‡πÅ‡∏ï‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤" -> ‡∏Ç‡πâ‡∏≤‡∏°
                    if (statusFilter === "not_checked_in" && statusText !== "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤") continue;
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô" ‡πÅ‡∏ï‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô" -> ‡∏Ç‡πâ‡∏≤‡∏°
                    if (statusFilter === "checked_in" && statusText !== "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô") continue;
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô" ‡πÅ‡∏ï‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô" -> ‡∏Ç‡πâ‡∏≤‡∏°
                    if (statusFilter === "completed" && statusText !== "‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô") continue;
                    // (‡∏ñ‡πâ‡∏≤ statusFilter = "" (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏¢)

                    // --- Step 9: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Excel ---
                    dataForExcel.push([
                        user.fullName,
                        user.department,                 // [‡πÉ‡∏´‡∏°‡πà]
                        localDateFormatter.format(day),  // ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Loop
                        dayType,                         // [‡πÉ‡∏´‡∏°‡πà]
                        statusText,                      // [‡πÉ‡∏´‡∏°‡πà]
                        checkInTime,
                        checkOutTime,
                        regularWorkHours.toFixed(2),
                        overtimeHours.toFixed(1),
                        workTypeInfo,
                        onSiteDetails,
                        reportType,
                        reportProject,
                        reportDuration
                    ]);
                } // ‡∏à‡∏ö Loop User
            } // ‡∏à‡∏ö Loop ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà

            if (dataForExcel.length <= 1) {
                 alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞ Export ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
                 return;
            }

            const ws = XLSX.utils.aoa_to_sheet(dataForExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô');
            const fileName = `‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô_${startDateString}_‡∏ñ‡∏∂‡∏á_${endDateString}.xlsx`;
            XLSX.writeFile(wb, fileName);

        } catch (error) {
            console.error("Error exporting employee summary to Excel:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£ Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + error.message);
        }
    }

    async function loadWorkHistory() {
        if (!currentUser) return;

        const container = document.getElementById('work-history-container');
        const rangeSelect = document.getElementById('history-range-select');
        const selectedRange = rangeSelect.value; 

        const summaryHoursEl = document.getElementById('profile-summary-hours');
        const summaryOtEl = document.getElementById('profile-summary-ot');
        const summaryDaysEl = document.getElementById('profile-summary-days');

        summaryHoursEl.textContent = '-';
        summaryOtEl.textContent = '-';
        summaryDaysEl.textContent = '-';
        container.innerHTML = `<p class="text-center text-gray-500 text-sm py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</p>`;

        try {
            let startDate, endDate;
            const now = new Date();
            
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);

            if (selectedRange === "7") {
                startDate = new Date(todayStart);
                startDate.setDate(todayStart.getDate() - 6); 
                endDate = new Date(now); 
            } else if (selectedRange === "this_month") {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1); 
                endDate = new Date(now); 
            } else if (selectedRange === "last_month") {
                startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
            }

            const recordsSnapshot = await db.collection('work_records')
                .where('userId', '==', currentUser.uid)
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .orderBy('date', 'desc')
                .get();

            if (recordsSnapshot.empty) {
                let emptyMessage = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô";
                if (selectedRange === "7") emptyMessage = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 7 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤";
                else if (selectedRange === "this_month") emptyMessage = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ";
                else if (selectedRange === "last_month") emptyMessage = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
                
                container.innerHTML = `<p class="text-center text-gray-500 text-sm py-4">${emptyMessage}</p>`;
                summaryDaysEl.textContent = '0 ‡∏ß‡∏±‡∏ô'; 
                return;
            }

            let historyHtml = '';
            let totalRegularHours = 0;
            let totalOtHours = 0;
            let totalDays = recordsSnapshot.size;

            recordsSnapshot.forEach(doc => {
                const record = doc.data();
                const checkinTime = record.checkIn.timestamp.toDate();
                const report = record.report;

                let checkoutTime, regularWorkHours = 0, overtimeHours = 0;
                
                let workTypeInfo = '';
                let workTypeIcon = '';
                
                if (record.checkIn.workType === 'in_factory') {
                    workTypeInfo = '‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô';
                    workTypeIcon = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-gray-500 flex-shrink-0">
                          <path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5v-13A1.5 1.5 0 0015.5 2h-11zM10 4a.75.75 0 01.75.75v.5a.75.75 0 01-1.5 0v-.5A.75.75 0 0110 4zM8.5 7.5A.75.75 0 007.75 8v.5a.75.75 0 001.5 0V8A.75.75 0 008.5 7.5zM11.5 7.5a.75.75 0 01.75.75v.5a.75.75 0 01-1.5 0V8a.75.75 0 01.75-.75zM8.5 10.5a.75.75 0 00-.75.75v.5a.75.75 0 001.5 0v-.5a.75.75 0 00-.75-.75zm3 0a.75.75 0 00-.75.75v.5a.75.75 0 001.5 0v-.5a.75.75 0 00-.75-.75zM8.5 13.5a.75.75 0 00-.75.75v.5a.75.75 0 001.5 0v-.5a.75.75 0 00-.75-.75zm3 0a.75.75 0 00-.75.75v.5a.75.75 0 001.5 0v-.5a.75.75 0 00-.75-.75z" clip-rule="evenodd" />
                        </svg>
                    `;
                } else {
                    workTypeInfo = `On-site: ${record.checkIn.onSiteDetails || 'N/A'}`;
                    workTypeIcon = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-gray-500 flex-shrink-0">
                            <path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.096.446-.24.757-.433.62-.384 1.445-.966 2.274-1.765C15.302 14.988 17 12.493 17 10a7 7 0 10-14 0c0 2.493 1.698 4.988 3.355 6.59C7.22 17.384 8.046 17.966 8.666 18.35c.31.193.57.337.757.433.09.046.185.09.28.14l.018.008.006.003zM10 11.25a1.25 1.25 0 100-2.5 1.25 1.25 0 000 2.5z" clip-rule="evenodd" />
                        </svg>
                    `;
                }

                if (record.status === 'completed') {
                    checkoutTime = record.checkOut.timestamp.toDate();
                    
                    overtimeHours = record.overtime?.hours || 0; 
                    
                    let workDurationMillis = checkoutTime - checkinTime;
                    if (workDurationMillis < 0) workDurationMillis = 0;
                    const lunchStart = new Date(checkinTime); lunchStart.setHours(12, 0, 0, 0);
                    const lunchEnd = new Date(checkinTime); lunchEnd.setHours(13, 0, 0, 0);
                    if (checkinTime < lunchEnd && checkoutTime > lunchStart) {
                        workDurationMillis -= 3600000; 
                    }
                    const totalWorkHours = Math.max(0, workDurationMillis / (1000 * 60 * 60));
                    
                    regularWorkHours = totalWorkHours - overtimeHours;
                    if (regularWorkHours < 0) regularWorkHours = 0;
                }

                totalRegularHours += regularWorkHours;
                totalOtHours += overtimeHours;

                historyHtml += `
                <div class="card !p-4 shadow-sm">
                    <p class="font-semibold text-gray-800 mb-3">${checkinTime.toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-green-500">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.25 5.75a.75.75 0 011.5 0v5.69l1.97-1.97a.75.75 0 111.06 1.06l-3.5 3.5a.75.75 0 01-1.06 0l-3.5-3.5a.75.75 0 111.06-1.06l1.97 1.97V5.75z" clip-rule="evenodd" />
                            </svg>
                            <span class="font-medium">${checkinTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })} ‡∏ô.</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-red-500">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-.75-4.75a.75.75 0 001.5 0V8.66l1.97 1.97a.75.75 0 101.06-1.06l-3.5-3.5a.75.75 0 00-1.06 0l-3.5 3.5a.75.75 0 101.06 1.06l1.97-1.97v4.59z" clip-rule="evenodd" />
                            </svg>
                            <span class="font-medium">${checkoutTime ? checkoutTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) + ' ‡∏ô.' : '-'}</span>
                        </div>

                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-sky-500">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" />
                            </svg>
                            <span class="font-medium">${regularWorkHours.toFixed(2)} ‡∏ä‡∏°.</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-orange-500">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.75 9.75h-1.5a.75.75 0 000 1.5h1.5v1.5a.75.75 0 001.5 0v-1.5h1.5a.75.75 0 000-1.5h-1.5V8.25a.75.75 0 00-1.5 0v1.5z" clip-rule="evenodd" />
                            </svg>
                            <span class="font-medium">OT: ${overtimeHours.toFixed(1)} ‡∏ä‡∏°.</span>
                        </div>
                    </div>

                    <div class="mt-4 pt-3 border-t border-gray-100 text-sm space-y-2">
                        <div class="flex items-start gap-2">
                            ${workTypeIcon}
                            <span class="font-medium text-gray-700">${workTypeInfo}</span>
                        </div>
                        
                        ${report ? `
                        <div class="flex items-start gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-gray-500 flex-shrink-0">
                              <path fill-rule="evenodd" d="M11.234 3.125a.75.75 0 011.06 0l2.625 2.625a.75.75 0 010 1.06l-2.625 2.625a.75.75 0 01-1.06-1.06L12.44 7.17 9.83 9.83l-1.25-1.25a.75.75 0 010-1.06l2.625-2.625a.75.75 0 011.03-.07zM9.83 12.83l-1.25 1.25a.75.75 0 01-1.06 0L4.895 11.455a.75.75 0 010-1.06l2.625-2.625a.75.75 0 011.06 1.06L7.33 10.08l2.5 2.5.001.001z" clip-rule="evenodd" />
                              <path d="M10 2.25a.75.75 0 01.75.75v.251a3.001 3.001 0 012.38 1.34l.32.4a.75.75 0 01-.98.98l-.32-.4a1.5 1.5 0 00-1.19-.67V6a.75.75 0 01-1.5 0V4.86a1.5 1.5 0 00-1.19.67l-.32.4a.75.75 0 11-.98-.98l.32-.4A3.001 3.001 0 019.25 3.251V3a.75.75 0 01.75-.75z" />
                              <path d="M11 12.75a.75.75 0 01.75.75v.251a3.001 3.001 0 012.38 1.34l.32.4a.75.75 0 01-.98.98l-.32-.4a1.5 1.5 0 00-1.19-.67V16a.75.75 0 01-1.5 0v-.76a1.5 1.5 0 00-1.19.67l-.32.4a.75.75 0 11-.98-.98l.32-.4A3.001 3.001 0 0110.25 13.751V13.5a.75.75 0 01.75-.75z" />
                            </svg>
                            <span class="font-medium text-gray-700">${report.workType} (${report.project})</span>
                        </div>
                        ` : `
                        <div class="flex items-start gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-yellow-500 flex-shrink-0">
                                <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                            </svg>
                            <span class="font-medium text-yellow-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
                        </div>
                        `}
                    </div>
                </div>`;
            });
            
            container.innerHTML = historyHtml;

            summaryHoursEl.textContent = `${totalRegularHours.toFixed(2)}`;
            summaryOtEl.textContent = `${totalOtHours.toFixed(1)}`;
            summaryDaysEl.textContent = `${totalDays} ‡∏ß‡∏±‡∏ô`;

        } catch (error) {
            console.error("Error loading work history:", error);
            container.innerHTML = '<p class="text-center text-red-500 text-sm py-4">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
        }
    }
        
    function updateUIToCheckIn() {
        checkinBtn.classList.remove('hidden');
        checkoutBtn.classList.add('hidden');
        // Reset checkout button if previously completed
        checkoutBtn.disabled = false;
        checkoutBtn.classList.add('checkout-btn-anim', 'bg-red-500', 'hover:bg-red-600');
        checkoutBtn.classList.remove('bg-green-500', 'completed-btn-anim');
        checkoutBtn.innerHTML = `
            <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            <span class="text-2xl font-semibold mt-2">Check Out</span>
        `;
    }

    function updateUIToCheckedIn() {
        checkinBtn.classList.add('hidden');
        checkoutBtn.classList.remove('hidden');
        // Ensure checkout button is in the default state
        checkoutBtn.disabled = false;
        checkoutBtn.classList.add('checkout-btn-anim', 'bg-red-500', 'hover:bg-red-600');
        checkoutBtn.classList.remove('bg-green-500', 'completed-btn-anim');
        checkoutBtn.innerHTML = `
            <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            <span class="text-2xl font-semibold mt-2">Check Out</span>
        `;
    }

    function updateUIToCompleted() {
        checkinBtn.classList.add('hidden');
        checkoutBtn.classList.remove('hidden');
        checkoutBtn.disabled = true;
        checkoutBtn.classList.remove('checkout-btn-anim', 'bg-red-500', 'hover:bg-red-600');
        checkoutBtn.classList.add('bg-green-500', 'completed-btn-anim');
        checkoutBtn.innerHTML = `
            <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            <span class="text-2xl font-semibold mt-2">Completed</span>
        `;
    }

    checkoutBtn.addEventListener('click', async () => {
        if (!currentUser) {
            return showNotification("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", "error");
        }
        if (!latestPosition) {
            return showNotification("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...", "warning");
        }
        const checkoutSpan = checkoutBtn.querySelector('span'); 

        const proceedWithCheckout = async () => {
            checkoutBtn.disabled = true; 
            if (checkoutSpan) checkoutSpan.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; 

            try {
                const now = new Date();
                const docId = `${currentUser.uid}_${now.toISOString().split('T')[0]}`;
                const workRecordRef = db.collection('work_records').doc(docId);

                const workRecordDoc = await workRecordRef.get();
                if (!workRecordDoc.exists) {
                    throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ");
                }
                const checkinTime = workRecordDoc.data().checkIn.timestamp.toDate();

                const { regularWorkHours, overtimeHours } = calculateWorkHours(checkinTime, now);

                const checkOutData = {
                    timestamp: firebase.firestore.Timestamp.fromDate(now),
                    location: new firebase.firestore.GeoPoint(latestPosition.coords.latitude, latestPosition.coords.longitude)
                };

                await workRecordRef.update({
                    checkOut: checkOutData,
                    status: "completed", 
                    overtime: { hours: overtimeHours } 
                });

                showNotification("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                updateUIToCompleted(); 

                summaryCheckoutTime.textContent = now.toLocaleTimeString('th-TH');
                summaryCheckoutTime.classList.remove('text-gray-400');
                summaryCheckoutTime.classList.add('text-red-500');
                summaryWorkHours.textContent = `${regularWorkHours.toFixed(2)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`;
                if (overtimeHours > 0) {
                    summaryWorkHours.textContent += ` (OT ${overtimeHours} ‡∏ä‡∏°.)`;
                }

            } catch (error) {
                console.error("Check-out error:", error);
                showNotification("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å: " + error.message, 'error');
                checkoutBtn.disabled = false;
                if (checkoutSpan) checkoutSpan.textContent = "Check Out";
            }
        };

        const proceedWithCheckoutWithoutOT = async () => {
            checkoutBtn.disabled = true; 
            if (checkoutSpan) checkoutSpan.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; 

            try {
                const now = new Date();
                const docId = `${currentUser.uid}_${now.toISOString().split('T')[0]}`;
                const workRecordRef = db.collection('work_records').doc(docId);

                const workRecordDoc = await workRecordRef.get();
                if (!workRecordDoc.exists) {
                    throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ");
                }
                const checkinTime = workRecordDoc.data().checkIn.timestamp.toDate();

                const { regularWorkHours } = calculateWorkHours(checkinTime, now); 
                const overtimeHours = 0; 

                const checkOutData = {
                    timestamp: firebase.firestore.Timestamp.fromDate(now),
                    location: new firebase.firestore.GeoPoint(latestPosition.coords.latitude, latestPosition.coords.longitude)
                };

                await workRecordRef.update({
                    checkOut: checkOutData,
                    status: "completed",
                    overtime: { hours: overtimeHours } 
                });

                showNotification("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î OT)"); 
                updateUIToCompleted();

                summaryCheckoutTime.textContent = now.toLocaleTimeString('th-TH');
                summaryCheckoutTime.classList.remove('text-gray-400');
                summaryCheckoutTime.classList.add('text-red-500');
                summaryWorkHours.textContent = `${regularWorkHours.toFixed(2)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`;

            } catch (error) {
                console.error("Check-out without OT error:", error);
                showNotification("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å: " + error.message, 'error');
                checkoutBtn.disabled = false;
                if (checkoutSpan) checkoutSpan.textContent = "Check Out";
            }
        };

        const currentTime = new Date();
        if (currentTime.getHours() >= 18) { // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á (>= 18 ‡∏Ñ‡∏∑‡∏≠ 18:00 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ)
             showConfirmDialog(
                "‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ OT ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å OT ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
                proceedWithCheckout,         
                proceedWithCheckoutWithoutOT 
            );
        } else {
            proceedWithCheckout();
        }
    }); 

    const provider = new firebase.auth.OAuthProvider('oidc.line');
    lineLoginBtn.addEventListener('click', () => { auth.signInWithPopup(provider).catch(e => console.error("Login Error:", e)); });
    
    const emailLoginBtn = document.getElementById('login-btn');
    const emailInput = document.querySelector('input[placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"]');
    const passwordInput = document.querySelector('input[placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"]');

    emailLoginBtn.addEventListener('click', () => {
      const email = emailInput.value; 
      const password = passwordInput.value;

      if (!email || !password) {
        return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô) ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
      }

      emailLoginBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
      emailLoginBtn.disabled = true;

      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        })
        .catch((error) => {
          console.error("Email login error:", error);
          alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
          emailLoginBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
          emailLoginBtn.disabled = false;
        });
    });

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const œÜ1 = lat1 * Math.PI / 180, œÜ2 = lat2 * Math.PI / 180;
        const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
        const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function showPage(pageId) {
        pages.forEach(p => p.classList.remove('active'));
        const activePage = document.getElementById(pageId);
        if (activePage) activePage.classList.add('active');
    }

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] --- ‡πÇ‡∏Ñ‡πâ‡∏î Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Navigation ---
    navItems.forEach(item => {
        item.addEventListener('click', e => {
            e.preventDefault();
            const pageId = item.dataset.page;

            // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] --- ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ (Admin/User) ---
            if (pageId === 'admin-dashboard-page' && (!currentUserData || currentUserData.role !== 'admin')) {
                alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ");
                return; // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠
            }
            // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô ---

            navItems.forEach(n => n.classList.remove('active'));
            item.classList.add('active');
            showPage(pageId);
            
            if (pageId === 'report-page') {
                loadSentReports(); 
            }
            if (pageId === 'admin-dashboard-page') {
                loadAllUsersForDropdown();
                loadPendingLeaveRequests();
                loadAndDisplayHolidays();
                if (!editDateSelect.value) {
                    editDateSelect.value = new Date().toISOString().split('T')[0];
                }
                document.getElementById('employee-summary-container-admin').innerHTML = '<p class="text-sm text-center text-gray-400 py-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</p>';
                document.getElementById('summary-pagination-controls').innerHTML = '';
            }
            
            // [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
            // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin
            if (pageId === 'calendar-page') {
                loadCalendarData(currentDisplayDate);
                
                // [‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á Admin
                const adminControls = document.getElementById('admin-calendar-controls-card');
                if (adminControls) {
                    if (currentUserData && currentUserData.role === 'admin') {
                        adminControls.classList.remove('hidden');
                        loadCalendarRules(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
                    } else {
                        adminControls.classList.add('hidden');
                    }
                }
            }
            
            if (pageId === 'profile-page') {
                loadWorkHistory(); 
                db.collection('users').doc(currentUser.uid).get().then(doc => {
                    if (doc.exists) {
                        updateProfilePage(doc.data());
                    }
                });
            }
        });
    });

    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
            showConfirmDialog(
                '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                () => { // onConfirm callback
                    auth.signOut().catch(error => {
                        console.error("Sign out error:", error);
                        showNotification("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö", "error"); 
                    });
                }
            );
        });
    }

    const historyRangeSelect = document.getElementById('history-range-select');
    if(historyRangeSelect) {
        historyRangeSelect.addEventListener('change', loadWorkHistory);
    }
    
    function resetReportForm() {
        workTypeSelectedText.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô...';
        workTypeSelectedText.classList.add('text-gray-500');
        projectSelectedText.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£...';
        projectSelectedText.classList.add('text-gray-500');
        durationSelectedText.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤...';
        durationSelectedText.classList.add('text-gray-500');
        customTimeInputs.classList.add('hidden');
        customTimeStartInput.value = '';
        customTimeEndInput.value = '';
    }

    function updateProfilePage(userData) {
        const profilePic = document.getElementById('profile-page-pic');
        const profileName = document.getElementById('profile-page-name');
        const profileDepartment = document.getElementById('profile-page-department');

        if (profilePic) {
            profilePic.src = currentUser.photoURL || userData.profileImageUrl || 'https://placehold.co/150x150/E2E8F0/475569?text=User';
        }
        if (profileName) {
            profileName.textContent = userData.fullName || '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
        }
        if (profileDepartment) {
            profileDepartment.textContent = userData.department || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å';
        }
    }

function calculateWorkHours(checkinTime, checkoutTime) {
    let workDurationMillis = checkoutTime - checkinTime;
    if (workDurationMillis < 0) workDurationMillis = 0;

    const lunchStart = new Date(checkinTime);
    lunchStart.setHours(12, 0, 0, 0);
    const lunchEnd = new Date(checkinTime);
    lunchEnd.setHours(13, 0, 0, 0);
    
    if (checkinTime < lunchEnd && checkoutTime > lunchStart) {
        workDurationMillis -= 3600000; 
    }

    let overtimeHours = 0;
    const otStartThreshold = new Date(checkoutTime);
    otStartThreshold.setHours(18, 0, 0, 0);

    const normalEndThreshold = new Date(checkoutTime);
    normalEndThreshold.setHours(17, 30, 0, 0);

    if (checkoutTime >= otStartThreshold) {
        const otMillis = checkoutTime - normalEndThreshold;
        if (otMillis > 0) {
            const otBlocks = Math.floor(otMillis / (1000 * 60 * 30));
            overtimeHours = otBlocks * 0.5;
        }
    }

    const totalWorkHours = workDurationMillis / (1000 * 60 * 60);
    const regularWorkHours = totalWorkHours - overtimeHours;

    return {
        regularWorkHours: Math.max(0, regularWorkHours), 
        overtimeHours
    };
}

    // --- [‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á] Logic ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å work_records.report) ---
    async function loadSentReports() {
        if (!currentUser) return;

        const container = document.getElementById('sent-reports-container');
        if (!container) {
            console.error("Report container not found.");
            return;
        }

        const today = new Date().toISOString().split('T')[0];
        const reportDocId = `${currentUser.uid}_${today}`;
        
        try {
            // [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô] ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å work_records
            const reportDoc = await db.collection('work_records').doc(reportDocId).get();

            // [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ .report field ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (reportDoc.exists && reportDoc.data().report) {
                const data = reportDoc.data().report; // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å field 'report'
                const reportCardHTML = `
                    <div class="card !p-4">
                        <div>
                            <p class="text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß:</p>
                            <p class="text-lg font-bold text-sky-600 my-1">${data.workType}</p>
                            <div class="pt-2 mt-2 border-t border-gray-100 text-sm space-y-1">
                                <p class="text-gray-500">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: <span class="font-medium text-gray-700">${data.project}</span></p>
                                <p class="text-gray-500">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: <span class="font-medium text-gray-700">${data.duration}</span></p>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML = reportCardHTML;
            } else {
                container.innerHTML = `<p id="no-reports-message" class="text-center text-gray-500 text-sm py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>`;
            }
        } catch (error) {
            console.error("Error loading sent reports:", error);
            container.innerHTML = '<p class="text-center text-red-500 text-sm py-4">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>';
        }
    }

    function updateClock() {
        if (timeElement) {
            const now = new Date();
            timeElement.textContent = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
    }
    setInterval(updateClock, 1000);
    updateClock();

    function showNotification(message, type = 'success') {
    const notificationElement = document.getElementById('notification');
    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å p ‡πÅ‡∏•‡∏∞ span ‡∏î‡πâ‡∏ß‡∏¢ ID ‡πÉ‡∏´‡∏°‡πà
    const msgElement = document.getElementById('notification-message');
    const iconElement = document.getElementById('notification-icon');

    if (!notificationElement || !msgElement || !iconElement) return;

    msgElement.textContent = message;

    // [‡πÉ‡∏´‡∏°‡πà] ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡πà‡∏≤‡∏á‡πÜ
    const icons = {
        success: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`,
        error: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`,
        warning: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.1 2.15-1.1 2.786 0l5.625 9.742c.636 1.1-.178 2.46-1.393 2.46H3.725c-1.215 0-2.029-1.36-1.393-2.46l5.625-9.742zM9 11a1 1 0 112 0v1a1 1 0 11-2 0v-1zm1-4a1 1 0 011 1v2a1 1 0 11-2 0V8a1 1 0 011-1z" clip-rule="evenodd" /></svg>`
    };

    // Reset classes
    notificationElement.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'bg-gray-500');
    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å -translate-y-10 ‡πÄ‡∏õ‡πá‡∏ô translate-y-10 (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏á)
    notificationElement.classList.remove('opacity-0', 'translate-y-10');
    
    // Add showing classes (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ó‡∏µ‡πà 0)
    notificationElement.classList.add('opacity-100', 'translate-y-0');

    // Set color and icon based on type
    if (type === 'success') {
        notificationElement.classList.add('bg-green-500');
        iconElement.innerHTML = icons.success;
    } else if (type === 'error') {
        notificationElement.classList.add('bg-red-500');
        iconElement.innerHTML = icons.error;
    } else if (type === 'warning') {
        notificationElement.classList.add('bg-yellow-500'); // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö warning
        iconElement.innerHTML = icons.warning;
    } else {
        notificationElement.classList.add('bg-gray-500');
        iconElement.innerHTML = ''; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
    }


    // Hide after a delay
    setTimeout(() => {
        notificationElement.classList.remove('opacity-100', 'translate-y-0');
        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
        notificationElement.classList.add('opacity-0', 'translate-y-10'); 
    }, 3000); // Hide after 3 seconds
}

// [‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin
// [‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin
async function loadAndDisplayHolidays() {
    const container = document.getElementById('holiday-list-container');
    if (!container) return;
    
    container.innerHTML = '<p class="text-xs text-center text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
    
    try {
        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ db ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
        const doc = await db.collection('system_settings').doc('calendar_rules').get();
        if (!doc.exists) {
            container.innerHTML = '<p class="text-xs text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            return;
        }

        const data = doc.data();
        const holidays = data.holidays || [];
        const workingSaturdays = data.workingSaturdays || [];
        
        container.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î"

        if (holidays.length === 0 && workingSaturdays.length === 0) {
            container.innerHTML = '<p class="text-xs text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            return;
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        holidays.sort();
        workingSaturdays.sort();

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
        holidays.forEach(dateStr => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-2 bg-red-50 rounded-lg text-red-700 text-sm font-medium cursor-pointer hover:bg-red-100';
            div.textContent = `‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î: ${dateStr}`;
            div.dataset.date = dateStr;
            div.dataset.type = 'holidays'; // ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            container.appendChild(div);
        });

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        workingSaturdays.forEach(dateStr => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-2 bg-green-50 rounded-lg text-green-700 text-sm font-medium cursor-pointer hover:bg-green-100';
            div.textContent = `‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ${dateStr}`;
            div.dataset.date = dateStr;
            div.dataset.type = 'workingSaturdays'; // ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            container.appendChild(div);
        });

        // [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
        container.querySelectorAll('div[data-date]').forEach(el => {
            el.addEventListener('click', () => {
                const date = el.dataset.date;
                const type = el.dataset.type; // 'holidays' ‡∏´‡∏£‡∏∑‡∏≠ 'workingSaturdays'
                const typeText = type === 'holidays' ? '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î' : '‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
                
                showConfirmDialog(
                    `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${typeText}: ${date}"?`,
                    async () => { // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô onConfirm (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)
                        try {
                            const docRef = db.collection('system_settings').doc('calendar_rules');
                            // ‡πÉ‡∏ä‡πâ FieldValue.arrayRemove() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Array
                            const updateAction = firebase.firestore.FieldValue.arrayRemove(date);
                            
                            await docRef.update({ [type]: updateAction });

                            showNotification(`‡∏•‡∏ö "${date}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                            await loadAndDisplayHolidays(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà
                            loadCalendarData(currentDisplayDate); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏Å
                        } catch (error) {
                            console.error("Error deleting holiday/workday:", error);
                            showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                        }
                    }
                );
            });
        });

    } catch (error) {
        console.error("Error loading holiday list:", error);
        container.innerHTML = '<p class="text-xs text-center text-red-500">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>';
    }
}

// [‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°" ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
function setupAdminCalendarControls() {
    const dateInput = document.getElementById('admin-calendar-date-input');
    const addHolidayBtn = document.getElementById('add-holiday-btn');
    const addWorkingSatBtn = document.getElementById('add-working-saturday-btn');

    if (!dateInput || !addHolidayBtn || !addWorkingSatBtn) return;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÄ‡∏û‡∏¥‡πà‡∏°" ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÉ‡∏ä‡πâ 'holidays' ‡∏´‡∏£‡∏∑‡∏≠ 'workingSaturdays')
    const handleAddDate = async (type) => { 
        const dateStr = dateInput.value; // "YYYY-MM-DD"
        if (!dateStr) {
            showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô', 'warning');
            return;
        }

        const button = (type === 'holidays') ? addHolidayBtn : addWorkingSatBtn;
        button.disabled = true;
        button.classList.add('opacity-50');

        try {
            const docRef = db.collection('system_settings').doc('calendar_rules');
            // ‡πÉ‡∏ä‡πâ FieldValue.arrayUnion() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Array (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥)
            const updateAction = firebase.firestore.FieldValue.arrayUnion(dateStr);
            
            // ‡πÉ‡∏ä‡πâ { merge: true } ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£/field ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
            await docRef.set({ [type]: updateAction }, { merge: true });

            showNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏° "${dateStr}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
            dateInput.value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            await loadAndDisplayHolidays(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà
            loadCalendarData(currentDisplayDate); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏Å

        } catch (error) {
            console.error(`Error adding ${type}:`, error);
            showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°', 'error');
        } finally {
            button.disabled = false;
            button.classList.remove('opacity-50');
        }
    };

    // ‡∏ú‡∏π‡∏Å Event ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°
    addHolidayBtn.addEventListener('click', () => handleAddDate('holidays'));
    addWorkingSatBtn.addEventListener('click', () => handleAddDate('workingSaturdays'));
}

    // [‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î] --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Render ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô "‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó") ---
    async function loadCalendarData(date) {
        if (!currentUser) return;
        const calGrid = document.getElementById('cal-grid');
        const calHeader = document.getElementById('cal-month-year');
        const calDetailsContainer = document.getElementById('cal-details-container');

        if (!calGrid || !calHeader || !calDetailsContainer) return;

        calHeader.textContent = date.toLocaleString('th-TH', { month: 'long', year: 'numeric' });
        calGrid.innerHTML = '<div class="col-span-7 text-center p-4 text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
        calDetailsContainer.innerHTML = '<p class="text-center text-gray-400 text-sm">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>'; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï

        const year = date.getFullYear();
        const month = date.getMonth();

        const today = new Date();
        const todayDate = today.getDate();
        const todayMonth = today.getMonth();
        const todayYear = today.getFullYear();

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Cache (‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà)
        calendarDataCache.plans.clear();
        calendarDataCache.records.clear();
        calendarDataCache.users.clear();

        const startDate = new Date(year, month, 1);
        const endDate = new Date(year, month + 1, 0);
        const firstDayOfWeek = startDate.getDay();
        const daysInMonth = endDate.getDate();

        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 4 ‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
        try {
            // Query 1: ‡∏î‡∏∂‡∏á work_records (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á User ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
            const recordsQuery = db.collection('work_records')
                .where('userId', '==', currentUser.uid)
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .get();

            // Query 2: ‡∏î‡∏∂‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)
            const calendarQuery = db.collection('system_settings').doc('calendar_rules').get();

            // Query 3: [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô] ‡∏î‡∏∂‡∏á user_plans (‡∏Ç‡∏≠‡∏á "‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô" ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
            const plansQuery = db.collection('user_plans')
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .get();

            // Query 4: [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Users ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á)
            const usersQuery = db.collection('users').get();

            // ‡∏£‡∏≠‡∏ó‡∏±‡πâ‡∏á 4 query ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
            const [recordsSnapshot, calendarDoc, plansSnapshot, usersSnapshot] = 
                await Promise.all([recordsQuery, calendarQuery, plansQuery, usersQuery]);

            // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Users (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Cache)
            usersSnapshot.forEach(doc => {
                calendarDataCache.users.set(doc.id, doc.data());
            });

            // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• work_records (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Cache)
            recordsSnapshot.forEach(doc => {
                const data = doc.data();
                const day = data.date.toDate().getDate();
                calendarDataCache.records.set(day, data);
            });

            // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Map ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)
            const holidayMap = new Map();
            const workingSaturdayMap = new Map();
            if (calendarDoc.exists) {
                const data = calendarDoc.data();
                (data.holidays || []).forEach(dateStr => holidayMap.set(dateStr, true));
                (data.workingSaturdays || []).forEach(dateStr => workingSaturdayMap.set(dateStr, true));
            }

            // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• user_plans (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Cache)
            plansSnapshot.forEach(doc => {
                const data = doc.data();
                const day = data.date.toDate().getDate();

                if (!calendarDataCache.plans.has(day)) {
                    calendarDataCache.plans.set(day, []); // ‡∏™‡∏£‡πâ‡∏≤‡∏á Array ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
                }
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° plan ‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô Array ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                calendarDataCache.plans.get(day).push({
                    id: doc.id, // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ plan ‡πÑ‡∏ß‡πâ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏•‡∏ö)
                    ...data 
                });
            });

            // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
            calGrid.innerHTML = '';
            for (let i = 0; i < firstDayOfWeek; i++) {
                calGrid.innerHTML += `<div class="p-2"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = (day === todayDate && month === todayMonth && year === todayYear);
                const record = calendarDataCache.records.get(day);
                const plans = calendarDataCache.plans.get(day) || []; // [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]

                const monthStr = (month + 1).toString().padStart(2, '0');
                const dayStr = day.toString().padStart(2, '0');
                const dateKey = `${year}-${monthStr}-${dayStr}`;

                const isHoliday = holidayMap.has(dateKey);
                const isWorkingSaturday = workingSaturdayMap.has(dateKey);
                const currentDayOfWeek = new Date(year, month, day).getDay();
                const isSunday = (currentDayOfWeek === 0);
                const isRegularSaturday = (currentDayOfWeek === 6);

                // [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô] ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Plan (plans.length > 0)
                let planDotHtml = '';
                if (plans.length > 0) {
                    planDotHtml = `<div class="w-2 h-2 bg-indigo-500 rounded-full mx-auto mt-0.5"></div>`;
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                let dayNumberHtml = '';
                if (isToday) {
                    dayNumberHtml = `<div class="w-7 h-7 flex items-center justify-center rounded-full bg-sky-100 text-sky-700 font-bold mx-auto">${day}</div>`;
                } else if (isHoliday) {
                    dayNumberHtml = `<div class="w-7 h-7 flex items-center justify-center rounded-full mx-auto text-red-500 font-bold">${day}</div>`;
                } else if (isWorkingSaturday) {
                    dayNumberHtml = `<div class="w-7 h-7 flex items-center justify-center rounded-full mx-auto text-green-700 font-bold">${day}</div>`;
                } else if (isSunday || isRegularSaturday) {
                    dayNumberHtml = `<div class="w-7 h-7 flex items-center justify-center rounded-full mx-auto text-red-400">${day}</div>`;
                } else {
                    dayNumberHtml = `<div class="w-7 h-7 flex items-center justify-center rounded-full mx-auto text-gray-400">${day}</div>`;
                }

                // [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô] ‡πÄ‡∏û‡∏¥‡πà‡∏° data-day-number ‡πÅ‡∏•‡∏∞‡∏•‡∏ö data-plan-text
                let cellBaseClass = 'p-2 text-center rounded-lg cursor-pointer hover:bg-gray-100';
                const dataAttributes = `data-day-number="${day}" data-date-key="${dateKey}"`;

                let dayCellHtml = '';
                if (isHoliday) {
                    dayCellHtml = `<div class="${cellBaseClass}" ${dataAttributes}>${dayNumberHtml}${planDotHtml}<div class="text-xs mt-1 text-red-500 truncate" style="line-height: 1.25;">‡∏´‡∏¢‡∏∏‡∏î</div></div>`;
                } else if (isWorkingSaturday) {
                    dayCellHtml = `<div class="${cellBaseClass}" ${dataAttributes}>${dayNumberHtml}${planDotHtml}</div>`;
                } else {
                    dayCellHtml = `<div class="${cellBaseClass}" ${dataAttributes}>${dayNumberHtml}${planDotHtml}</div>`;
                }

                calGrid.innerHTML += dayCellHtml;
            }
        } catch (error) {
            console.error("Error fetching calendar data: ", error);
            calGrid.innerHTML = `<div class="col-span-7 text-center p-4 text-red-500">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</div>`;
        }
    }

// 3. ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°
document.getElementById('cal-prev-month').addEventListener('click', () => {
    currentDisplayDate.setMonth(currentDisplayDate.getMonth() - 1);
    loadCalendarData(currentDisplayDate);
});

document.getElementById('cal-next-month').addEventListener('click', () => {
    currentDisplayDate.setMonth(currentDisplayDate.getMonth() + 1);
    loadCalendarData(currentDisplayDate);
});

const openLeaveModal = () => {
        if (leaveRequestModal) {
            leaveRequestModal.classList.remove('hidden');
        }
    };
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    const closeLeaveModal = () => {
        if (leaveRequestModal) {
            leaveRequestModal.classList.add('hidden');
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
            leaveTypeSelect.value = "";
            leaveStartDate.value = "";
            leaveEndDate.value = "";
            leaveReason.value = "";
        }
    };
    
    // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤ ‡∏´‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà active
    document.body.addEventListener('click', function(event) {
        if (event.target.id === 'show-leave-form-btn') {
            openLeaveModal();
        }
    });

    if (cancelLeaveBtn) {
        cancelLeaveBtn.addEventListener('click', closeLeaveModal);
    }
    if (leaveOverlay) {
        leaveOverlay.addEventListener('click', closeLeaveModal);
    }

    // --- 5. [‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å] Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤" ---
    if (submitLeaveBtn) {
        submitLeaveBtn.addEventListener('click', async () => {
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Login ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
            if (!currentUser || !currentUserData) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤', 'error');
                return;
            }

            // --- 5.1 ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞ Validate ---
            const leaveType = leaveTypeSelect.value;
            const startDateStr = leaveStartDate.value;
            const endDateStr = leaveEndDate.value;
            const reason = leaveReason.value.trim();

            if (!leaveType || !startDateStr || !endDateStr || !reason) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á', 'warning');
                return;
            }
            
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);

            if (endDate < startDate) {
                showNotification('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'warning');
                return;
            }
            
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥
            submitLeaveBtn.disabled = true;
            submitLeaveBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á...';

            // --- 5.2 ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firestore ---
            const leaveData = {
                userId: currentUser.uid,
                userName: currentUserData.fullName,
                userPhoto: currentUserData.profileImageUrl || currentUser.photoURL,
                leaveType: leaveType,
                startDate: firebase.firestore.Timestamp.fromDate(startDate),
                endDate: firebase.firestore.Timestamp.fromDate(endDate),
                reason: reason,
                status: "pending", // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                submittedAt: firebase.firestore.FieldValue.serverTimestamp() //
            };

            // --- 5.3 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firestore ---
            try {
                // (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ db ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
                await db.collection('leave_requests').add(leaveData);
                
                showNotification('‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'success');
                closeLeaveModal(); // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à

            } catch (error) {
                console.error("Error submitting leave request:", error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
                submitLeaveBtn.disabled = false;
                submitLeaveBtn.textContent = '‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤';
            }
        });
    }


// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÅ‡∏™‡∏î‡∏á" ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô)
        function showCalendarDetails(e) {
            const cell = e.target.closest('[data-day-number]');
            if (!cell) return;

            const day = parseInt(cell.dataset.dayNumber);
            const dateKey = cell.dataset.dateKey; // YYYY-MM-DD
            const [y, m, d] = dateKey.split('-');
            const thaiDate = new Date(y, m - 1, d).toLocaleDateString('th-TH', {
                day: 'numeric', month: 'long'
            });

            const plans = calendarDataCache.plans.get(day) || [];
            const users = calendarDataCache.users;
            const container = document.getElementById('cal-details-container');
            
            let detailHtml = `
                <h4 class="font-semibold text-lg">‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${thaiDate}</h4>
            `;
            
            // --- 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "Plan ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà" (‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô) ---
            if (plans.length > 0) {
                detailHtml += '<div class="space-y-3 pt-3">';
                plans.forEach(plan => {
                    const userName = users.get(plan.userId)?.fullName || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
                    const userPhoto = users.get(plan.userId)?.profileImageUrl || 'https://placehold.co/100x100/E2E8F0/475569?text=User';
                    
                    detailHtml += `
                        <div class="flex items-start space-x-3">
                            <img src="${userPhoto}" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                            <div class="flex-1">
                                <div class="flex justify-between items-center">
                                    <p class="font-semibold text-sm">${userName}</p>
                                    ${plan.userId === currentUser.uid ? // [‡πÄ‡∏ä‡πá‡∏Å] ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô plan ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤, ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
                                        `<button class="plan-delete-btn text-red-400 hover:text-red-600" data-doc-id="${plan.id}">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                                        </button>` 
                                        : ''
                                    }
                                </div>
                                <p class="text-sm text-gray-700 whitespace-pre-wrap">${plan.planText}</p>
                            </div>
                        </div>
                    `;
                });
                detailHtml += '</div>';
            } else {
                detailHtml += '<p class="text-center text-gray-400 text-sm py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>';
            }

            // --- 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°" ‡πÅ‡∏•‡∏∞ "‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà" ---
            detailHtml += `
                <div class="pt-3 mt-3 border-t border-gray-100">
                    <button id="plan-show-form-btn" class="w-full text-sm font-medium text-sky-600 p-2 rounded-lg hover:bg-sky-50">
                        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                    </button>
                    
                    <div id="plan-new-form" class="hidden space-y-2 mt-2">
                        <textarea id="plan-new-textarea" class="w-full p-2 border border-gray-300 rounded-lg" rows="2" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..."></textarea>
                        <button id="plan-save-new-btn" data-date-key="${dateKey}" class="btn-primary w-full py-2 text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
                    </div>
                </div>
            `;

            container.innerHTML = detailHtml;
        }

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£" ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°")
        async function handleCalendarDetailClick(e) {

            // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°" ---
            if (e.target.id === 'plan-show-form-btn') {
                document.getElementById('plan-new-form').classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                e.target.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° "+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô"
                return;
            }

            // --- (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡πÉ‡∏´‡∏°‡πà" ---
            if (e.target.id === 'plan-save-new-btn') {
                const saveBtn = e.target;
                const dateKey = saveBtn.dataset.dateKey;
                const textarea = document.getElementById('plan-new-textarea');
                const planText = textarea.value.trim();
                const docId = `${currentUser.uid}_${dateKey}`; // ID ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£

                if (!planText) {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô");
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                
                try {
                    const planData = {
                        userId: currentUser.uid,
                        date: firebase.firestore.Timestamp.fromDate(new Date(dateKey)),
                        planText: planText,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await db.collection('user_plans').doc(docId).set(planData);
                    
                    showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    loadCalendarData(currentDisplayDate); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    
                } catch (error) {
                    console.error("Error saving plan:", error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                    saveBtn.disabled = false;
                    saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô';
                }
            }

            // --- (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏•‡∏ö" ---
            if (e.target.closest('.plan-delete-btn')) {
                const deleteBtn = e.target.closest('.plan-delete-btn');
                const docId = deleteBtn.dataset.docId; // ID ‡∏Ç‡∏≠‡∏á plan ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö
                
                showConfirmDialog(
                    '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                    async () => { // onConfirm
                        try {
                            await db.collection('user_plans').doc(docId).delete();
                            showNotification('‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
                            loadCalendarData(currentDisplayDate); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        } catch (error) {
                             console.error("Error deleting plan:", error);
                             showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                        }
                    }
                );
            }
        }

    // 3. ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏´‡∏•‡∏±‡∏Å (‡πÉ‡∏ä‡πâ Event Delegation)
    document.getElementById('cal-grid').addEventListener('click', showCalendarDetails);
    document.getElementById('cal-details-container').addEventListener('click', handleCalendarDetailClick);

    // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î Details ---
    
    saveEditBtn.addEventListener('click', async () => {
        const docId = editDocIdInput.value;
        const checkinStr = editCheckinTimeInput.value;
        const checkoutStr = editCheckoutTimeInput.value;

        if (!docId || !checkinStr) {
            alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ID ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ß‡∏•‡∏≤ Check-in ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            return;
        }

        saveEditBtn.disabled = true;
        saveEditBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

        try {
            // ‡∏î‡∏∂‡∏á userId ‡πÅ‡∏•‡∏∞ dateKey ‡∏à‡∏≤‡∏Å docId
            const [userId, dateKey] = docId.split('_'); 
            const baseDate = new Date(dateKey + 'T00:00:00'); // ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å docId ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å

            // --- 1. ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Report ---
            const workType = editModalWorkTypeSelectedText.textContent;
            const project = editModalProjectSelectedText.textContent;
            let duration = editModalDurationSelectedText.textContent;

            if (duration === '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤') {
                const startTime = editModalCustomTimeStartInput.value;
                const endTime = editModalCustomTimeEndInput.value;
                if (startTime && endTime) {
                    duration = `${startTime} - ${endTime}`;
                } else {
                    duration = '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)';
                }
            }

            const reportData = {
                workType: (workType.includes('...') ? null : workType),
                project: (project.includes('...') ? null : project),
                duration: (duration.includes('...') ? null : duration),
                submittedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // --- 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£ "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" ---
            const workRecordRef = db.collection('work_records').doc(docId);
            const doc = await workRecordRef.get();
            let isCreatingNew = !doc.exists;

            let dataToSave = {};
            const checkinTimestamp = firebase.firestore.Timestamp.fromDate(new Date(checkinStr));
            const checkoutTimestamp = checkoutStr ? firebase.firestore.Timestamp.fromDate(new Date(checkoutStr)) : null;

            if (isCreatingNew) {
                // --- 3A. Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà" (Add) ---
                dataToSave = {
                    userId: userId,
                    date: firebase.firestore.Timestamp.fromDate(baseDate), // ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    checkIn: {
                        timestamp: checkinTimestamp,
                        location: null, // Admin add, no location
                        accuracy: null,
                        workType: "in_factory", // Default for admin
                        onSiteDetails: editOnsiteDetailsInput.value || null,
                        photoUrl: null
                    },
                    checkOut: checkoutTimestamp ? {
                        timestamp: checkoutTimestamp,
                        location: null
                    } : null,
                    status: checkoutTimestamp ? "completed" : "checked_in",
                    report: (reportData.workType ? reportData : null), // ‡πÄ‡∏û‡∏¥‡πà‡∏° report ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å
                    overtime: null // ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                };

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì OT ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô completed
                if (dataToSave.status === "completed") {
                    const { regularWorkHours, overtimeHours } = calculateWorkHours(new Date(checkinStr), new Date(checkoutStr));
                    dataToSave.overtime = { hours: overtimeHours };
                }
                
                // ‡πÉ‡∏ä‡πâ .set() ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
                await workRecordRef.set(dataToSave);

            } else {
                // --- 3B. Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" (Edit) ---
                const existingRecord = doc.data();
                
                // ‡πÉ‡∏ä‡πâ .update() ‡πÄ‡∏û‡∏∑‡πà‡∏≠ merge ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•, ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô location) ‡∏´‡∏≤‡∏¢
                dataToSave = {
                    'checkIn.timestamp': checkinTimestamp,
                    'checkIn.onSiteDetails': editOnsiteDetailsInput.value || null, // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï onSiteDetails
                    'checkOut': checkoutTimestamp ? {
                        timestamp: checkoutTimestamp,
                        location: existingRecord.checkOut?.location || null // ‡πÉ‡∏ä‡πâ location ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                    } : null,
                    'status': checkoutTimestamp ? "completed" : "checked_in",
                    'report': (reportData.workType ? reportData : existingRecord.report) // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï report
                };

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì OT ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô completed
                if (dataToSave.status === "completed") {
                    const { regularWorkHours, overtimeHours } = calculateWorkHours(new Date(checkinStr), new Date(checkoutStr));
                    dataToSave['overtime'] = { hours: overtimeHours }; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï field overtime
                } else {
                    dataToSave['overtime'] = null; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ OT ‡∏ñ‡πâ‡∏≤ check-out ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö
                }

                // ‡πÉ‡∏ä‡πâ .update() ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°
                await workRecordRef.update(dataToSave);
            }

            // --- 4. Success ---
            showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            editModal.classList.add('hidden');
            searchRecordBtn.click(); // ‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á

        } catch (error) {
            console.error("Error saving record:", error);
            showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
        } finally {
            saveEditBtn.disabled = false;
            saveEditBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
        }
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° Cancel (‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
    cancelEditBtn.addEventListener('click', () => {
        editModal.classList.add('hidden');
    });

    // --- Function to show confirmation dialog ---
// Added optional onCancel parameter
function showConfirmDialog(message, onConfirm, onCancel = null) {
    const confirmModal = document.getElementById('confirm-modal');
    const overlay = document.getElementById('confirm-overlay');
    const msgElement = document.getElementById('confirm-message');
    const okBtn = document.getElementById('confirm-ok-btn');
    const cancelBtn = document.getElementById('confirm-cancel-btn');

    if (!confirmModal || !msgElement || !okBtn || !cancelBtn || !overlay) {
         console.error("Confirmation modal elements not found!");
         return; // Exit if elements are missing
    }

    msgElement.textContent = message;

    // --- Event Listeners (ensure removal on close) ---
    const handleConfirm = () => {
        closeDialog();
        if (typeof onConfirm === 'function') {
            onConfirm(); // Call OK callback
        }
    };

    const handleCancel = () => {
        closeDialog();
        if (typeof onCancel === 'function') {
            onCancel(); // Call Cancel callback if provided
        }
    };

    const closeDialog = () => {
        confirmModal.classList.add('hidden');
        // Remove specific listeners to prevent duplicates
        okBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
        overlay.removeEventListener('click', handleCancel); // Also close on overlay click
    };
    // --- End Event Listeners ---

    // Add listeners
    okBtn.addEventListener('click', handleConfirm);
    cancelBtn.addEventListener('click', handleCancel);
    overlay.addEventListener('click', handleCancel);

    confirmModal.classList.remove('hidden'); // Show Modal
}

    // 3. [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°
    searchRecordBtn.addEventListener('click', async () => {
        const userId = editUserSelect.value;
        const dateStr = editDateSelect.value; // YYYY-MM-DD

        if (!userId || !dateStr) {
            searchResultsContainer.innerHTML = '<p class="text-sm text-center text-red-500 py-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</p>';
            return;
        }

        searchResultsContainer.innerHTML = '<p class="text-sm text-center text-gray-500 py-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';

        try {
            const docId = `${userId}_${dateStr}`;
            const workRecordRef = db.collection('work_records').doc(docId);
            const doc = await workRecordRef.get();

            if (doc.exists) {
                // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
                const record = doc.data();
                const report = record.report || {};
                
                const checkinTime = record.checkIn.timestamp.toDate().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                const checkoutTime = record.checkOut ? record.checkOut.timestamp.toDate().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '-';
                const reportInfo = report.workType ? `${report.workType} (${report.project || 'N/A'})` : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';

                searchResultsContainer.innerHTML = `
                    <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-start">
                            <p class="font-semibold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏ö</p>
                            <button data-doc-id="${doc.id}" class="edit-record-btn text-sm bg-sky-100 text-sky-700 font-semibold px-3 py-1 rounded-lg hover:bg-sky-200">
                                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-100 grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                            <div><span class="text-gray-500">‡πÄ‡∏Ç‡πâ‡∏≤:</span> <span class="font-semibold text-green-600">${checkinTime}</span></div>
                            <div><span class="text-gray-500">‡∏≠‡∏≠‡∏Å:</span> <span class="font-semibold text-red-500">${checkoutTime}</span></div>
                            <div class="col-span-2 mt-1"><span class="text-gray-500">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</span> <span class="font-medium text-gray-700">${reportInfo}</span></div>
                        </div>
                    </div>
                `;
            } else {
                // --- [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -> ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°" ---
                searchResultsContainer.innerHTML = `
                    <p class="text-sm text-center text-yellow-600 py-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
                    <button 
                        data-user-id="${userId}" 
                        data-date-str="${dateStr}" 
                        class="add-record-btn mt-2 w-full btn-primary py-2 text-sm">
                        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                    </button>
                `;
            }

        } catch (error) {
            console.error("Error searching record:", error);
            searchResultsContainer.innerHTML = '<p class="text-sm text-center text-red-500 py-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>';
        }
    });

    async function loadCalendarRules() {
    const holidayList = document.getElementById('holiday-list');
    const workSatList = document.getElementById('working-saturday-list');
    if (!holidayList || !workSatList) return;

    holidayList.innerHTML = '<p class="text-sm text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
    workSatList.innerHTML = '<p class="text-sm text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';

    try {
        const doc = await db.collection('system_settings').doc('calendar_rules').get();
        if (!doc.exists) {
            holidayList.innerHTML = '<p class="text-sm text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            workSatList.innerHTML = '<p class="text-sm text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            return;
        }

        const data = doc.data();
        const holidays = data.holidays || [];
        const workingSaturdays = data.workingSaturdays || [];

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Helper ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML
        const createListHTML = (dateArray, type) => {
            if (dateArray.length === 0) return '<p class="text-sm text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å
            dateArray.sort((a, b) => new Date(a) - new Date(b));
            
            return dateArray.map(dateStr => `
                <div class="flex justify-between items-center bg-white p-2 rounded-md shadow-sm">
                    <span class="text-sm font-medium">${dateStr}</span>
                    <button data-date="${dateStr}" data-type="${type}" class="calendar-delete-btn text-red-400 hover:text-red-600 p-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            `).join('');
        };

        holidayList.innerHTML = createListHTML(holidays, 'holidays');
        workSatList.innerHTML = createListHTML(workingSaturdays, 'workingSaturdays');

    } catch (error) {
        console.error("Error loading calendar rules:", error);
        holidayList.innerHTML = '<p class="text-sm text-red-500">‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>';
        workSatList.innerHTML = '<p class="text-sm text-red-500">‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>';
    }
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏é (Holiday ‡∏´‡∏£‡∏∑‡∏≠ Working Saturday)
async function handleAddCalendarRule(type) {
    const dateInput = document.getElementById('calendar-admin-date-input');
    const dateString = dateInput.value; // YYYY-MM-DD
    
    if (!dateString) {
        showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
    }

    const buttonId = (type === 'holidays') ? 'calendar-admin-add-holiday' : 'calendar-admin-add-worksat';
    const button = document.getElementById(buttonId);
    button.disabled = true;
    button.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°...';

    try {
        const docRef = db.collection('system_settings').doc('calendar_rules');
        
        // ‡πÉ‡∏ä‡πâ arrayUnion ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡πÉ‡∏ô array (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
        await docRef.set({
            [type]: firebase.firestore.FieldValue.arrayUnion(dateString)
        }, { merge: true }); // merge: true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡∏ö field ‡∏≠‡∏∑‡πà‡∏ô

        showNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateString} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        dateInput.value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
        loadCalendarRules(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà

    } catch (error) {
        console.error("Error adding calendar rule:", error);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
    } finally {
        button.disabled = false;
        button.textContent = (type === 'holidays') ? '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î' : '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
    }
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Å‡∏é
async function handleDeleteCalendarRule(type, dateString, buttonElement) {
    if (!type || !dateString) return;

    buttonElement.disabled = true;
    buttonElement.style.opacity = '0.5';

    try {
        const docRef = db.collection('system_settings').doc('calendar_rules');
        
        // ‡πÉ‡∏ä‡πâ arrayRemove ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Ñ‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å array
        await docRef.update({
            [type]: firebase.firestore.FieldValue.arrayRemove(dateString)
        });

        showNotification(`‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateString} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        loadCalendarRules(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)

    } catch (error) {
        console.error("Error deleting calendar rule:", error);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        buttonElement.disabled = false;
        buttonElement.style.opacity = '1';
    }
}

    // --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏ó‡∏µ‡πà 'pending' ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á ---
// [‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á] --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏ó‡∏µ‡πà 'pending' ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á ---
// (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
async function loadPendingLeaveRequests() {
    const listContainer = document.getElementById('leave-approval-list');
    const loadingMsg = document.getElementById('leave-loading-msg');
    
    if (!listContainer || !loadingMsg) return;

    listContainer.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤
    loadingMsg.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...';
    listContainer.appendChild(loadingMsg); // ‡πÉ‡∏™‡πà "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î" ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ

    try {
        // (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ db ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
        const querySnapshot = await db.collection('leave_requests')
                                      .where('status', '==', 'pending')
                                      .orderBy('submittedAt', 'asc')
                                      .get();

        if (querySnapshot.empty) {
            loadingMsg.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
            return;
        }

        listContainer.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î" ‡∏≠‡∏≠‡∏Å

        querySnapshot.forEach(doc => {
            const leave = doc.data();
            const docId = doc.id;

            // ‡πÅ‡∏õ‡∏•‡∏á Timestamp ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
            const startDate = leave.startDate.toDate().toLocaleDateString('th-TH');
            const endDate = leave.endDate.toDate().toLocaleDateString('th-TH');

            // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏° class="leave-request-card" ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
            const cardHTML = `
            <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm leave-request-card">
                <div class="flex items-start gap-3">
                    <img src="${leave.userPhoto || 'https://placehold.co/100x100/E2E8F0/475569?text=User'}" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                    <div>
                        <p class="font-semibold">${leave.userName}</p>
                        <p class="text-sm font-medium text-sky-700">${LEAVE_TYPE_MAP[leave.leaveType] || leave.leaveType}</p>
                        <p class="text-sm text-gray-500">${startDate} ‡∏ñ‡∏∂‡∏á ${endDate}</p>
                    </div>
                </div>
                <p class="text-sm text-gray-700 mt-3 p-3 bg-gray-50 rounded-lg">${leave.reason}</p>
                
                <div class="flex justify-end gap-3 mt-4">
                    <button data-id="${docId}" class="reject-leave-btn text-sm font-semibold text-red-600 px-4 py-2 rounded-lg hover:bg-red-50">
                        ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                    </button>
                    <button data-id="${docId}" class="approve-leave-btn text-sm font-semibold text-white bg-green-500 px-4 py-2 rounded-lg hover:bg-green-600">
                        ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                    </button>
                </div>
            </div>
            `;
            listContainer.innerHTML += cardHTML;
        });

    } catch (error) {
        console.error("Error loading leave requests:", error);
        loadingMsg.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    }
}
    // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] --- 3. Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Approve/Reject ---
const leaveListContainer = document.getElementById('leave-approval-list');
if (leaveListContainer) {
    leaveListContainer.addEventListener('click', (event) => {
        const target = event.target; // ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
        const docId = target.dataset.id; // ‡∏î‡∏∂‡∏á ID ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°

        if (!docId) return; // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏õ‡∏∏‡πà‡∏° ‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡∏Å

        if (target.classList.contains('approve-leave-btn')) {
            // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            target.disabled = true; 
            target.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            handleLeaveApproval(docId, 'approved', target); 
        }

        if (target.classList.contains('reject-leave-btn')) {
            // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            target.disabled = true;
            target.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            handleLeaveApproval(docId, 'rejected', target);
        }
    });
}
    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    // [‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á] --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ---
// (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô index.html)
async function loadAllUsersForDropdown() {
    const summaryEmployeeSelect = document.getElementById('summary-employee-select');
    // [‡πÉ‡∏´‡∏°‡πà] ‡∏î‡∏∂‡∏á Select Box ‡∏Ç‡∏≠‡∏á‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡∏•‡∏≤
    const leaveHistoryUserSelect = document.getElementById('leave-history-user-filter');

    // [‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Select Box ‡∏ó‡∏±‡πâ‡∏á 3 ‡∏ï‡∏±‡∏ß
    if (editUserSelect.options.length > 1 && 
        summaryEmployeeSelect.options.length > 1 && 
        (leaveHistoryUserSelect && leaveHistoryUserSelect.options.length > 1)) return;

    try {
        const usersSnapshot = await db.collection('users').orderBy('fullName').get();
        editUserSelect.innerHTML = '<option value="">--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ---</option>';
        summaryEmployeeSelect.innerHTML = '<option value="">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
        // [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ Select Box ‡πÉ‡∏´‡∏°‡πà
        if (leaveHistoryUserSelect) {
            leaveHistoryUserSelect.innerHTML = '<option value="">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
        }

        usersSnapshot.forEach(doc => {
            const user = doc.data();
            const optionText = user.fullName || doc.id;
            const optionValue = doc.id;

            // (‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á editUserSelect ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            const optionEdit = document.createElement('option');
            optionEdit.value = optionValue;
            optionEdit.textContent = optionText;
            editUserSelect.appendChild(optionEdit);

            // (‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á summaryEmployeeSelect ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            const optionSummary = document.createElement('option');
            optionSummary.value = optionValue;
            optionSummary.textContent = optionText;
            summaryEmployeeSelect.appendChild(optionSummary);

            // [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏û‡∏¥‡πà‡∏° Option ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Select Box ‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡∏•‡∏≤
            if (leaveHistoryUserSelect) {
                const optionLeaveHistory = document.createElement('option');
                optionLeaveHistory.value = optionValue;
                optionLeaveHistory.textContent = optionText;
                leaveHistoryUserSelect.appendChild(optionLeaveHistory);
            }
        });
    } catch (error) {
        console.error("Error loading users:", error);
        editUserSelect.innerHTML = '<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</option>';
        summaryEmployeeSelect.innerHTML = '<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</option>';
        // [‡πÉ‡∏´‡∏°‡πà] ‡πÅ‡∏™‡∏î‡∏á Error ‡πÉ‡∏ô Select Box ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢
        if (leaveHistoryUserSelect) {
            leaveHistoryUserSelect.innerHTML = '<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</option>';
        }
    }
}

    async function loadLeaveHistory() {
    const listContainer = document.getElementById('leave-history-list');
    // FIX: ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á element ‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ
    let loadingMsg = document.getElementById('leave-history-loading-msg'); 
    
    if (!listContainer) {
        console.error("Leave history elements not found!");
        return;
    }

    // ‡∏´‡∏≤‡∏Å loadingMsg ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤) ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    if (!loadingMsg) {
        loadingMsg = document.createElement('p');
        loadingMsg.id = 'leave-history-loading-msg';
        loadingMsg.className = 'text-center text-gray-400 text-sm py-4';
    }

    listContainer.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤
    loadingMsg.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...';
    listContainer.appendChild(loadingMsg);

    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå
    const statusFilter = document.getElementById('leave-history-status-filter').value;
    const userFilter = document.getElementById('leave-history-user-filter').value;

    try {
        let query = db.collection('leave_requests');

        // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Query ‡∏ï‡∏≤‡∏°‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå
        if (statusFilter) {
            query = query.where('status', '==', statusFilter);
        }
        if (userFilter) {
            query = query.where('userId', '==', userFilter);
        }
        
        // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡πÉ‡∏ô Firestore ‡∏ñ‡πâ‡∏≤ Query ‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô)
        // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà filter ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° submittedAt
        if (!statusFilter || !userFilter) {
             query = query.orderBy('submittedAt', 'desc');
        }
        // (‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ filter 2 ‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Composite Index ‡πÉ‡∏ô Firebase)

        const querySnapshot = await query.get();

        if (querySnapshot.empty) {
            loadingMsg.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
            return;
        }

        listContainer.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î"

        querySnapshot.forEach(doc => {
            const leave = doc.data();
            const docId = doc.id;

            const startDate = leave.startDate.toDate().toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });
            const endDate = leave.endDate.toDate().toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });

            // 4. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            let statusText, statusColorClass;
            switch (leave.status) {
                case 'approved':
                    statusText = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß';
                    statusColorClass = 'bg-green-100 text-green-800';
                    break;
                case 'rejected':
                    statusText = '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                    statusColorClass = 'bg-red-100 text-red-800';
                    break;
                default:
                    statusText = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                    statusColorClass = 'bg-yellow-100 text-yellow-800';
            }

            const cardHTML = `
            <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                <div class="flex items-start gap-3">
                    <img src="${leave.userPhoto || 'https://placehold.co/100x100/E2E8F0/475569?text=User'}" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                    <div>
                        <div class="flex flex-wrap items-center gap-2 mb-1">
                            <p class="font-semibold">${leave.userName}</p>
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusColorClass}">${statusText}</span>
                        </div>
                        <p class="text-sm font-medium text-sky-700">${LEAVE_TYPE_MAP[leave.leaveType] || leave.leaveType}</p>
                        <p class="text-sm text-gray-500">${startDate} ‡∏ñ‡∏∂‡∏á ${endDate}</p>
                    </div>
                </div>
                <p class="text-sm text-gray-700 mt-3 p-3 bg-gray-50 rounded-lg whitespace-pre-wrap">${leave.reason}</p>
                ${leave.status !== 'pending' ? `<p class="text-xs text-gray-400 mt-2 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢: ${leave.approvedBy || 'N/A'}</p>` : ''}
            </div>
            `;
            listContainer.innerHTML += cardHTML;
        });

    } catch (error) {
        console.error("Error loading leave history:", error);
        loadingMsg.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
        // (‡∏ñ‡πâ‡∏≤ error ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Index, Firebase ‡∏à‡∏∞‡∏ö‡∏≠‡∏Å‡πÉ‡∏ô Console)
        if (error.code === 'failed-precondition') {
             loadingMsg.textContent = 'Error: ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡πÉ‡∏ô Firestore ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏µ‡πâ';
        }
    }
}

  // [‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á] --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Approve/Reject) ---
// (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô index.html)
// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Approve/Reject) ---
// (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô index.html)
// [‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á] --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Approve/Reject) ---
// (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
async function handleLeaveApproval(docId, newStatus, buttonElement) { 
    if (!docId) return;

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏î‡πâ‡∏ß‡∏¢ class ‡πÉ‡∏´‡∏°‡πà
    const cardElement = buttonElement.closest('.leave-request-card');

    // 1. ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏≤‡∏á‡∏•‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (cardElement) {
        cardElement.querySelectorAll('button').forEach(btn => btn.disabled = true);
        cardElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        cardElement.style.opacity = '0.5';
    } else {
        // Fallback (‡∏Å‡∏£‡∏ì‡∏µ selector ‡∏ú‡∏¥‡∏î)
        buttonElement.disabled = true;
    }

    try {
        // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Firestore (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        await db.collection('leave_requests').doc(docId).update({
            status: newStatus,
            approvedBy: currentUserData.fullName
        });
        
        showNotification(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${newStatus}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');

        // 3. ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏≠‡∏≠‡∏Å
        if (cardElement) {
            cardElement.style.opacity = '0';
            cardElement.style.transform = 'scale(0.95)';
            
            setTimeout(() => {
                cardElement.remove(); // ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DOM
                
                // 4. [FIX] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const listContainer = document.getElementById('leave-approval-list');
                if (listContainer && listContainer.children.length === 0) {
                    
                    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ p id="leave-loading-msg"
                    let loadingMsg = document.getElementById('leave-loading-msg');
                    
                    if (!loadingMsg) {
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î) ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
                        loadingMsg = document.createElement('p');
                        loadingMsg.id = 'leave-loading-msg';
                        loadingMsg.className = 'text-center text-gray-400 text-sm py-4';
                        listContainer.appendChild(loadingMsg);
                    }
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                    loadingMsg.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                }
            }, 300); // ‡∏£‡∏≠ animation 0.3s
        } else {
            // 3b. Fallback (‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠) ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            await loadPendingLeaveRequests(); 
        }

    } catch (error) {
        // 5. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
        console.error("Error updating leave status:", error);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï', 'error');

        // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        if (cardElement) {
            cardElement.querySelectorAll('button').forEach(btn => btn.disabled = false);
            cardElement.style.opacity = '1';
            cardElement.style.transform = 'scale(1)';
        } else {
            buttonElement.disabled = false;
        }
    }
}
    // 5. [‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏£‡∏ß‡∏° Report)
    async function openEditModal(docId, newUserId, newDateStr) {
        try {
            let record = {};
            let report = {};
            let checkinDate = null;
            let checkoutDate = null;
            let finalDocId = docId;

            if (docId) {
                // --- Case 1: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Logic ‡πÄ‡∏î‡∏¥‡∏°) ---
                const workRecordDoc = await db.collection('work_records').doc(docId).get();
                if (!workRecordDoc.exists) {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç");
                    return;
                }
                record = workRecordDoc.data();
                report = record.report || {};
                checkinDate = record.checkIn.timestamp.toDate();
                checkoutDate = record.checkOut ? record.checkOut.timestamp.toDate() : null;
            
            } else {
                // --- Case 2: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (Logic ‡πÉ‡∏´‡∏°‡πà) ---
                finalDocId = `${newUserId}_${newDateStr}`; // ‡∏ï‡∏±‡πâ‡∏á ID ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á
                
                // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 08:30 ‡πÅ‡∏•‡∏∞ 17:30 ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const defaultCheckin = new Date(`${newDateStr}T08:30:00`);
                const defaultCheckout = new Date(`${newDateStr}T17:30:00`);

                checkinDate = defaultCheckin;
                checkoutDate = defaultCheckout;
                
                // report ‡∏Å‡∏±‡∏ö record.checkIn.onSiteDetails ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô object ‡∏ß‡πà‡∏≤‡∏á
            }
            // --- ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Modal (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á 2 ‡∏Å‡∏£‡∏ì‡∏µ) ---
            editDocIdInput.value = finalDocId;
            editCheckinTimeInput.value = toLocalISOString(checkinDate);
            editCheckoutTimeInput.value = toLocalISOString(checkoutDate);
            editOnsiteDetailsInput.value = record.checkIn?.onSiteDetails || '';

            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Report
            if (report.workType) {
                editModalWorkTypeSelectedText.textContent = report.workType;
                editModalWorkTypeSelectedText.classList.remove('text-gray-500');
            } else {
                editModalWorkTypeSelectedText.textContent = '--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô ---';
                editModalWorkTypeSelectedText.classList.add('text-gray-500');
            }

            if (report.project) {
                editModalProjectSelectedText.textContent = report.project;
                editModalProjectSelectedText.classList.remove('text-gray-500');
            } else {
                editModalProjectSelectedText.textContent = '--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ---';
                editModalProjectSelectedText.classList.add('text-gray-500');
            }

            // Logic ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Duration
            editModalCustomTimeInputs.classList.add('hidden');
            const standardDurations = ['‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô (08:30 - 17:30)', '‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ (08:30 - 12:00)', '‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ö‡πà‡∏≤‡∏¢ (13:00 - 17:30)'];
            if (report.duration) {
                if (standardDurations.includes(report.duration)) {
                    editModalDurationSelectedText.textContent = report.duration;
                    editModalDurationSelectedText.classList.remove('text-gray-500');
                } else {
                    editModalDurationSelectedText.textContent = '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤';
                    editModalDurationSelectedText.classList.remove('text-gray-500');
                    editModalCustomTimeInputs.classList.remove('hidden');
                    const times = report.duration.split(' - ');
                    if (times.length === 2) {
                        editModalCustomTimeStartInput.value = times[0];
                        editModalCustomTimeEndInput.value = times[1];
                    } else {
                        editModalCustomTimeStartInput.value = '';
                        editModalCustomTimeEndInput.value = '';
                    }
                }
            } else {
                // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô"
                if (!docId) { 
                    editModalDurationSelectedText.textContent = '‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô (08:30 - 17:30)';
                    editModalDurationSelectedText.classList.remove('text-gray-500');
                } else {
                    editModalDurationSelectedText.textContent = '--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ ---';
                    editModalDurationSelectedText.classList.add('text-gray-500');
                }
                editModalCustomTimeStartInput.value = '';
                editModalCustomTimeEndInput.value = '';
            }

            editModal.classList.remove('hidden');

        } catch (error) {
            console.error("Error opening modal:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç");
        }
    }


});

</script>
</body>
</html>